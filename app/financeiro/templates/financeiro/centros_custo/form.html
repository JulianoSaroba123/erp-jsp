{% extends "base.html" %}

{% block title %}{% if centro %}Editar{% else %}Novo{% endif %} Centro de Custo{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('painel.index') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('financeiro.dashboard') }}">Financeiro</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('financeiro.listar_centros_custo') }}">Centros de Custo</a></li>
        <li class="breadcrumb-item active">{% if centro %}Editar{% else %}Novo{% endif %}</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <!-- Header -->
            <div class="mb-4">
                <h2>
                    <i class="fas fa-sitemap text-primary me-2"></i>
                    {% if centro %}Editar Centro de Custo{% else %}Novo Centro de Custo{% endif %}
                </h2>
                <p class="text-muted">Preencha os dados do centro de custo</p>
            </div>

            <!-- Formulário -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form method="POST" action="{% if centro %}{{ url_for('financeiro.atualizar_centro_custo', id=centro.id) }}{% else %}{{ url_for('financeiro.criar_centro_custo') }}{% endif %}">
                        
                        <!-- Identificação -->
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-id-card text-primary me-2"></i>Identificação
                        </h5>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="codigo" class="form-label">
                                    Código <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="codigo" name="codigo" 
                                       value="{% if centro %}{{ centro.codigo }}{% endif %}" 
                                       placeholder="Ex: DEPT-001" required>
                                <small class="text-muted">Código único de identificação</small>
                            </div>

                            <div class="col-md-8 mb-3">
                                <label for="nome" class="form-label">
                                    Nome <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="nome" name="nome" 
                                       value="{% if centro %}{{ centro.nome }}{% endif %}" 
                                       placeholder="Ex: Departamento Comercial" required>
                                <small class="text-muted">Nome descritivo do centro de custo</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="descricao" class="form-label">Descrição</label>
                            <textarea class="form-control" id="descricao" name="descricao" 
                                      rows="3" placeholder="Descrição detalhada do centro de custo">{% if centro %}{{ centro.descricao }}{% endif %}</textarea>
                        </div>

                        <!-- Classificação -->
                        <h5 class="border-bottom pb-2 mb-3 mt-4">
                            <i class="fas fa-tags text-primary me-2"></i>Classificação
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="tipo" class="form-label">Tipo</label>
                                <select class="form-select" id="tipo" name="tipo">
                                    <option value="">Selecione...</option>
                                    <option value="departamento" {% if centro and centro.tipo == 'departamento' %}selected{% endif %}>
                                        <i class="fas fa-building"></i> Departamento
                                    </option>
                                    <option value="projeto" {% if centro and centro.tipo == 'projeto' %}selected{% endif %}>
                                        <i class="fas fa-project-diagram"></i> Projeto
                                    </option>
                                    <option value="filial" {% if centro and centro.tipo == 'filial' %}selected{% endif %}>
                                        <i class="fas fa-map-marker-alt"></i> Filial
                                    </option>
                                    <option value="produto" {% if centro and centro.tipo == 'produto' %}selected{% endif %}>
                                        <i class="fas fa-box"></i> Produto/Serviço
                                    </option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="responsavel" class="form-label">Responsável</label>
                                <input type="text" class="form-control" id="responsavel" name="responsavel" 
                                       value="{% if centro %}{{ centro.responsavel }}{% endif %}" 
                                       placeholder="Nome do responsável">
                                <small class="text-muted">Gestor ou responsável pelo centro</small>
                            </div>
                        </div>

                        <!-- Hierarquia -->
                        {% if centros_pais %}
                        <div class="mb-3">
                            <label for="centro_pai_id" class="form-label">
                                <i class="fas fa-sitemap me-1"></i>Centro de Custo Pai (Hierarquia)
                            </label>
                            <select class="form-select" id="centro_pai_id" name="centro_pai_id">
                                <option value="">Nenhum (Centro Principal)</option>
                                {% for pai in centros_pais %}
                                <option value="{{ pai.id }}" {% if centro and centro.centro_pai_id == pai.id %}selected{% endif %}>
                                    {{ pai.codigo }} - {{ pai.nome }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Permite criar hierarquia de centros de custo</small>
                        </div>
                        {% endif %}

                        <!-- Orçamento -->
                        <h5 class="border-bottom pb-2 mb-3 mt-4">
                            <i class="fas fa-dollar-sign text-primary me-2"></i>Orçamento
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="orcamento_mensal" class="form-label">Orçamento Mensal</label>
                                <input type="text" class="form-control" id="orcamento_mensal" name="orcamento_mensal" 
                                       value="{% if centro and centro.orcamento_mensal %}{{ '{:,.2f}'.format(centro.orcamento_mensal).replace(',', 'X').replace('.', ',').replace('X', '.') }}{% else %}0,00{% endif %}" 
                                       placeholder="R$ 0,00">
                                <small class="text-muted">Valor máximo de despesas por mês</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <div class="alert alert-info mt-4">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Controle de Orçamento:</strong>
                                    <br><small>Sistema alertará quando atingir 80%, 90% e 100% do orçamento</small>
                                </div>
                            </div>
                        </div>

                        <!-- Botões -->
                        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                            <a href="{{ url_for('financeiro.listar_centros_custo') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                {% if centro %}Atualizar{% else %}Criar{% endif %} Centro de Custo
                            </button>
                        </div>

                    </form>
                </div>
            </div>

        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
// Formatação de valores monetários
document.getElementById('orcamento_mensal').addEventListener('blur', function() {
    let valor = this.value.replace(/\D/g, '');
    if (valor) {
        valor = (parseInt(valor) / 100).toFixed(2);
        valor = valor.replace('.', ',');
        valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
        this.value = valor;
    }
});

// Auto-gerar código baseado no nome
{% if not centro %}
document.getElementById('nome').addEventListener('blur', function() {
    const codigoInput = document.getElementById('codigo');
    if (!codigoInput.value) {
        const nome = this.value.toUpperCase();
        const palavras = nome.split(' ');
        let codigo = '';
        
        if (palavras.length > 1) {
            // Pega primeira letra de cada palavra
            codigo = palavras.slice(0, 3).map(p => p[0]).join('');
        } else {
            // Pega 3 primeiras letras
            codigo = nome.substring(0, 3);
        }
        
        // Adiciona número sequencial
        codigo += '-' + Math.floor(Math.random() * 900 + 100);
        codigoInput.value = codigo;
    }
});
{% endif %}
</script>
{% endblock %}
