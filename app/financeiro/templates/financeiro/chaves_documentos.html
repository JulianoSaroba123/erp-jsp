{% extends "base.html" %}

{% block title %}Chaves de Documentos - ERP JSP{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('painel.dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('financeiro.dashboard') }}">Financeiro</a></li>
<li class="breadcrumb-item active">Chaves de Documentos</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-key text-primary me-2"></i>Chaves de Documentos Fiscais</h2>
            <p class="text-muted mb-0">Gerencie chaves de acesso de NF-e, NFC-e e CT-e</p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNovaChave">
            <i class="fas fa-plus me-2"></i>Nova Chave
        </button>
    </div>

    <!-- Filtros -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Tipo de Documento</label>
                    <select class="form-select" id="filtroTipo">
                        <option value="">Todos</option>
                        <option value="nfe">NF-e</option>
                        <option value="nfce">NFC-e</option>
                        <option value="cte">CT-e</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Período</label>
                    <input type="date" class="form-control" id="filtroDataInicio">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Até</label>
                    <input type="date" class="form-control" id="filtroDataFim">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Buscar</label>
                    <input type="text" class="form-control" id="filtroBusca" placeholder="Chave, número, cliente...">
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Chaves -->
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Documentos Cadastrados</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="100">Tipo</th>
                            <th width="120">Número</th>
                            <th width="120">Série</th>
                            <th>Chave de Acesso</th>
                            <th>Cliente/Fornecedor</th>
                            <th width="120">Valor</th>
                            <th width="120">Data Emissão</th>
                            <th width="100" class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaChaves">
                        <tr>
                            <td colspan="8" class="text-center py-5 text-muted">
                                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                Nenhuma chave cadastrada.<br>
                                <small>Clique em "Nova Chave" para começar.</small>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Chave -->
<div class="modal fade" id="modalNovaChave" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-key me-2"></i>Nova Chave de Acesso</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNovaChave">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Tipo de Documento <span class="text-danger">*</span></label>
                            <select class="form-select" name="tipo" required>
                                <option value="">Selecione...</option>
                                <option value="nfe">NF-e (Nota Fiscal Eletrônica)</option>
                                <option value="nfce">NFC-e (Nota Fiscal Consumidor)</option>
                                <option value="cte">CT-e (Conhecimento de Transporte)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Número <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="numero" placeholder="Ex: 12345" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Série <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="serie" placeholder="Ex: 1" required>
                        </div>
                    </div>

                    <div class="row g-3 mt-2">
                        <div class="col-12">
                            <label class="form-label">Chave de Acesso (44 dígitos) <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="chave" maxlength="44" 
                                   placeholder="Ex: 35230512345678000123550010000123451234567890" required>
                            <small class="text-muted">Digite os 44 dígitos da chave sem espaços</small>
                        </div>
                    </div>

                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label class="form-label">Cliente/Fornecedor</label>
                            <input type="text" class="form-control" name="cliente" placeholder="Nome ou CNPJ/CPF">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Valor Total</label>
                            <input type="text" class="form-control" name="valor" placeholder="R$ 0,00">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Data Emissão <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="data_emissao" required>
                        </div>
                    </div>

                    <div class="row g-3 mt-2">
                        <div class="col-12">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" name="observacoes" rows="2" placeholder="Observações adicionais..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="salvarChave()">
                    <i class="fas fa-save me-2"></i>Salvar Chave
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function salvarChave() {
    const form = document.getElementById('formNovaChave');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Aqui você pode implementar a lógica de salvamento via AJAX
    alert('Funcionalidade em desenvolvimento!\n\nEsta tela permite cadastrar e gerenciar chaves de acesso de documentos fiscais (NF-e, NFC-e, CT-e).');
    
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalNovaChave'));
    modal.hide();
    
    // Limpar formulário
    form.reset();
}

// Validar chave de acesso (44 dígitos)
document.querySelector('input[name="chave"]').addEventListener('input', function(e) {
    this.value = this.value.replace(/\D/g, '').substring(0, 44);
});

// Formatar valor monetário
document.querySelector('input[name="valor"]').addEventListener('blur', function(e) {
    let valor = this.value.replace(/\D/g, '');
    if (valor) {
        valor = (parseInt(valor) / 100).toFixed(2);
        this.value = 'R$ ' + valor.replace('.', ',');
    }
});
</script>

<style>
.table th {
    font-weight: 600;
    font-size: 0.9rem;
    color: #495057;
}

.badge {
    font-size: 0.85rem;
    padding: 0.35rem 0.65rem;
}
</style>
{% endblock %}
