{% extends "base.html" %}

{% block title %}DRE - Demonstrativo de Resultados - ERP JSP{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('financeiro.dashboard') }}">Financeiro</a></li>
<li class="breadcrumb-item active">DRE</li>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-bar text-primary"></i> DRE - Demonstrativo de Resultados</h2>
    <div>
        <a href="{{ url_for('financeiro.exportar_dre_excel', ano=ano, mes=mes) }}" 
           class="btn btn-success">
            <i class="fas fa-file-excel"></i> Exportar Excel
        </a>
    </div>
</div>

<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Ano</label>
                <select name="ano" class="form-select">
                    {% for y in range(2020, 2030) %}
                    <option value="{{ y }}" {% if y == ano %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Mês (Opcional)</label>
                <select name="mes" class="form-select">
                    <option value="">Anual</option>
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if m == mes %}selected{% endif %}>
                        {{ ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][m-1] }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Comparar com</label>
                <select name="comparacao" class="form-select">
                    <option value="mensal" {% if comparacao == 'mensal' %}selected{% endif %}>Período Anterior</option>
                    <option value="anual" {% if comparacao == 'anual' %}selected{% endif %}>Ano Anterior</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-search"></i> Atualizar
                </button>
                <a href="{{ url_for('financeiro.dre') }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Limpar
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Cards de Indicadores -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6 class="card-title">Receita Líquida</h6>
                <h3 class="mb-0">R$ {{ "{:,.2f}".format(dre.receita_liquida).replace(',', '_').replace('.', ',').replace('_', '.') }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card {% if dre.lucro_bruto >= 0 %}bg-info{% else %}bg-danger{% endif %} text-white">
            <div class="card-body">
                <h6 class="card-title">Lucro Bruto</h6>
                <h3 class="mb-0">R$ {{ "{:,.2f}".format(dre.lucro_bruto).replace(',', '_').replace('.', ',').replace('_', '.') }}</h3>
                <small>Margem: {{ "{:.1f}".format(dre.margem_bruta) }}%</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card {% if dre.lucro_operacional >= 0 %}bg-warning{% else %}bg-danger{% endif %} text-white">
            <div class="card-body">
                <h6 class="card-title">Lucro Operacional</h6>
                <h3 class="mb-0">R$ {{ "{:,.2f}".format(dre.lucro_operacional).replace(',', '_').replace('.', ',').replace('_', '.') }}</h3>
                <small>Margem: {{ "{:.1f}".format(dre.margem_operacional) }}%</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card {% if dre.lucro_liquido >= 0 %}bg-primary{% else %}bg-danger{% endif %} text-white">
            <div class="card-body">
                <h6 class="card-title">Lucro Líquido</h6>
                <h3 class="mb-0">R$ {{ "{:,.2f}".format(dre.lucro_liquido).replace(',', '_').replace('.', ',').replace('_', '.') }}</h3>
                <small>Margem: {{ "{:.1f}".format(dre.margem_liquida) }}%</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- DRE Estruturado -->
    <div class="col-md-{% if dre_anterior %}6{% else %}12{% endif %} mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-file-invoice-dollar"></i> {{ titulo_periodo }}</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Descrição</th>
                            <th class="text-end">Valor (R$)</th>
                            <th class="text-end">% s/ Rec. Líq.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Receita Bruta -->
                        <tr>
                            <td><strong>RECEITA BRUTA</strong></td>
                            <td class="text-end text-success">
                                R$ {{ "{:,.2f}".format(dre.receita_bruta).replace(',', '_').replace('.', ',').replace('_', '.') }}
                            </td>
                            <td class="text-end">
                                {{ "{:.1f}%".format((dre.receita_bruta / dre.receita_liquida * 100) if dre.receita_liquida > 0 else 0) }}
                            </td>
                        </tr>
                        
                        <!-- Deduções -->
                        <tr>
                            <td>(-) Deduções</td>
                            <td class="text-end text-danger">
                                R$ {{ "{:,.2f}".format(dre.deducoes).replace(',', '_').replace('.', ',').replace('_', '.') }}
                            </td>
                            <td class="text-end">
                                {{ "{:.1f}%".format((dre.deducoes / dre.receita_liquida * 100) if dre.receita_liquida > 0 else 0) }}
                            </td>
                        </tr>
                        
                        <!-- Receita Líquida -->
                        <tr class="table-active">
                            <td><strong>RECEITA LÍQUIDA</strong></td>
                            <td class="text-end"><strong>R$ {{ "{:,.2f}".format(dre.receita_liquida).replace(',', '_').replace('.', ',').replace('_', '.') }}</strong></td>
                            <td class="text-end"><strong>100,0%</strong></td>
                        </tr>
                        
                        <tr><td colspan="3" class="p-1"></td></tr>
                        
                        <!-- Custos -->
                        <tr>
                            <td>(-) Custos</td>
                            <td class="text-end text-danger">
                                R$ {{ "{:,.2f}".format(dre.custos).replace(',', '_').replace('.', ',').replace('_', '.') }}
                            </td>
                            <td class="text-end">
                                {{ "{:.1f}%".format((dre.custos / dre.receita_liquida * 100) if dre.receita_liquida > 0 else 0) }}
                            </td>
                        </tr>
                        
                        <!-- Lucro Bruto -->
                        <tr class="table-info">
                            <td><strong>LUCRO BRUTO</strong></td>
                            <td class="text-end"><strong>R$ {{ "{:,.2f}".format(dre.lucro_bruto).replace(',', '_').replace('.', ',').replace('_', '.') }}</strong></td>
                            <td class="text-end"><strong>{{ "{:.1f}%".format(dre.margem_bruta) }}</strong></td>
                        </tr>
                        
                        <tr><td colspan="3" class="p-1"></td></tr>
                        
                        <!-- Despesas Operacionais -->
                        <tr>
                            <td>(-) Despesas Operacionais</td>
                            <td class="text-end text-danger">
                                R$ {{ "{:,.2f}".format(dre.despesas_operacionais).replace(',', '_').replace('.', ',').replace('_', '.') }}
                            </td>
                            <td class="text-end">
                                {{ "{:.1f}%".format((dre.despesas_operacionais / dre.receita_liquida * 100) if dre.receita_liquida > 0 else 0) }}
                            </td>
                        </tr>
                        
                        <!-- Lucro Operacional -->
                        <tr class="table-warning">
                            <td><strong>LUCRO OPERACIONAL</strong></td>
                            <td class="text-end"><strong>R$ {{ "{:,.2f}".format(dre.lucro_operacional).replace(',', '_').replace('.', ',').replace('_', '.') }}</strong></td>
                            <td class="text-end"><strong>{{ "{:.1f}%".format(dre.margem_operacional) }}</strong></td>
                        </tr>
                        
                        <tr><td colspan="3" class="p-1"></td></tr>
                        
                        <!-- Resultado Financeiro -->
                        <tr>
                            <td>(+) Receitas Financeiras</td>
                            <td class="text-end text-success">
                                R$ {{ "{:,.2f}".format(dre.receitas_financeiras).replace(',', '_').replace('.', ',').replace('_', '.') }}
                            </td>
                            <td class="text-end">
                                {{ "{:.1f}%".format((dre.receitas_financeiras / dre.receita_liquida * 100) if dre.receita_liquida > 0 else 0) }}
                            </td>
                        </tr>
                        <tr>
                            <td>(-) Despesas Financeiras</td>
                            <td class="text-end text-danger">
                                R$ {{ "{:,.2f}".format(dre.despesas_financeiras).replace(',', '_').replace('.', ',').replace('_', '.') }}
                            </td>
                            <td class="text-end">
                                {{ "{:.1f}%".format((dre.despesas_financeiras / dre.receita_liquida * 100) if dre.receita_liquida > 0 else 0) }}
                            </td>
                        </tr>
                        <tr class="table-secondary">
                            <td><strong>Resultado Financeiro</strong></td>
                            <td class="text-end"><strong>R$ {{ "{:,.2f}".format(dre.resultado_financeiro).replace(',', '_').replace('.', ',').replace('_', '.') }}</strong></td>
                            <td class="text-end">-</td>
                        </tr>
                        
                        <tr><td colspan="3" class="p-1"></td></tr>
                        
                        <!-- Lucro Líquido -->
                        <tr class="table-primary">
                            <td><strong>LUCRO LÍQUIDO</strong></td>
                            <td class="text-end"><strong>R$ {{ "{:,.2f}".format(dre.lucro_liquido).replace(',', '_').replace('.', ',').replace('_', '.') }}</strong></td>
                            <td class="text-end"><strong>{{ "{:.1f}%".format(dre.margem_liquida) }}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Comparação -->
    {% if dre_anterior %}
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-balance-scale"></i> Comparação: {{ titulo_comparacao }}</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Indicador</th>
                            <th class="text-end">Variação (R$)</th>
                            <th class="text-end">Variação (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key, label in [
                            ('receita_liquida', 'Receita Líquida'),
                            ('lucro_bruto', 'Lucro Bruto'),
                            ('lucro_operacional', 'Lucro Operacional'),
                            ('lucro_liquido', 'Lucro Líquido')
                        ] %}
                        <tr>
                            <td><strong>{{ label }}</strong></td>
                            <td class="text-end {% if variacoes[key].valor >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if variacoes[key].valor >= 0 %}+{% endif %}R$ {{ "{:,.2f}".format(variacoes[key].valor).replace(',', '_').replace('.', ',').replace('_', '.') }}
                            </td>
                            <td class="text-end {% if variacoes[key].percentual >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if variacoes[key].percentual >= 0 %}+{% endif %}{{ "{:.1f}%".format(variacoes[key].percentual) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <hr>
                
                <h6>Análise Comparativa</h6>
                <ul class="mb-0">
                    {% if variacoes.receita_liquida.percentual > 10 %}
                    <li class="text-success"><i class="fas fa-arrow-up"></i> Crescimento expressivo de receita ({{ "{:.1f}%".format(variacoes.receita_liquida.percentual) }})</li>
                    {% elif variacoes.receita_liquida.percentual < -10 %}
                    <li class="text-danger"><i class="fas fa-arrow-down"></i> Queda significativa de receita ({{ "{:.1f}%".format(variacoes.receita_liquida.percentual) }})</li>
                    {% endif %}
                    
                    {% if dre.margem_bruta > dre_anterior.margem_bruta %}
                    <li class="text-success"><i class="fas fa-check"></i> Melhoria na margem bruta</li>
                    {% elif dre.margem_bruta < dre_anterior.margem_bruta %}
                    <li class="text-warning"><i class="fas fa-exclamation"></i> Redução na margem bruta</li>
                    {% endif %}
                    
                    {% if dre.lucro_liquido > 0 and dre_anterior.lucro_liquido < 0 %}
                    <li class="text-success"><i class="fas fa-thumbs-up"></i> Retorno à lucratividade</li>
                    {% elif dre.lucro_liquido < 0 and dre_anterior.lucro_liquido > 0 %}
                    <li class="text-danger"><i class="fas fa-exclamation-triangle"></i> Período com prejuízo</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Evolução Mensal (se anual) -->
{% if not mes and dre_mensal %}
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Evolução Mensal {{ ano }}</h5>
    </div>
    <div class="card-body">
        <canvas id="chartEvolucao" height="60"></canvas>
    </div>
</div>

<div class="card">
    <div class="card-header bg-secondary text-white">
        <h5 class="mb-0"><i class="fas fa-table"></i> Tabela Mensal {{ ano }}</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead>
                    <tr>
                        <th>Mês</th>
                        <th class="text-end">Rec. Líquida</th>
                        <th class="text-end">Custos</th>
                        <th class="text-end">Desp. Oper.</th>
                        <th class="text-end">Lucro Bruto</th>
                        <th class="text-end">Lucro Líquido</th>
                        <th class="text-end">Margem Líq.</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mes_data in dre_mensal %}
                    <tr>
                        <td><strong>{{ mes_data.mes_nome }}</strong></td>
                        <td class="text-end">R$ {{ "{:,.0f}".format(mes_data.receita_liquida).replace(',', '.') }}</td>
                        <td class="text-end text-danger">R$ {{ "{:,.0f}".format(mes_data.custos).replace(',', '.') }}</td>
                        <td class="text-end text-danger">R$ {{ "{:,.0f}".format(mes_data.despesas_operacionais).replace(',', '.') }}</td>
                        <td class="text-end {% if mes_data.lucro_bruto >= 0 %}text-success{% else %}text-danger{% endif %}">
                            R$ {{ "{:,.0f}".format(mes_data.lucro_bruto).replace(',', '.') }}
                        </td>
                        <td class="text-end {% if mes_data.lucro_liquido >= 0 %}text-primary{% else %}text-danger{% endif %}">
                            <strong>R$ {{ "{:,.0f}".format(mes_data.lucro_liquido).replace(',', '.') }}</strong>
                        </td>
                        <td class="text-end">{{ "{:.1f}%".format(mes_data.margem_liquida) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-active">
                        <th>TOTAL</th>
                        <th class="text-end">R$ {{ "{:,.0f}".format(dre.receita_liquida).replace(',', '.') }}</th>
                        <th class="text-end">R$ {{ "{:,.0f}".format(dre.custos).replace(',', '.') }}</th>
                        <th class="text-end">R$ {{ "{:,.0f}".format(dre.despesas_operacionais).replace(',', '.') }}</th>
                        <th class="text-end">R$ {{ "{:,.0f}".format(dre.lucro_bruto).replace(',', '.') }}</th>
                        <th class="text-end"><strong>R$ {{ "{:,.0f}".format(dre.lucro_liquido).replace(',', '.') }}</strong></th>
                        <th class="text-end">{{ "{:.1f}%".format(dre.margem_liquida) }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const meses = {{ dre_mensal | map(attribute='mes_nome') | list | tojson }};
const receitaLiquida = {{ dre_mensal | map(attribute='receita_liquida') | list | tojson }};
const lucroLiquido = {{ dre_mensal | map(attribute='lucro_liquido') | list | tojson }};
const margemLiquida = {{ dre_mensal | map(attribute='margem_liquida') | list | tojson }};

const ctx = document.getElementById('chartEvolucao').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: meses,
        datasets: [
            {
                label: 'Receita Líquida',
                data: receitaLiquida,
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                yAxisID: 'y',
                tension: 0.4
            },
            {
                label: 'Lucro Líquido',
                data: lucroLiquido,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                yAxisID: 'y',
                tension: 0.4
            },
            {
                label: 'Margem Líquida (%)',
                data: margemLiquida,
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                yAxisID: 'y1',
                tension: 0.4
            }
        ]
    },
    options: {
        responsive: true,
        interaction: {
            mode: 'index',
            intersect: false
        },
        plugins: {
            legend: {
                position: 'top'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        let value = context.parsed.y;
                        if (label.includes('%')) {
                            return label + ': ' + value.toFixed(1) + '%';
                        } else {
                            return label + ': R$ ' + value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                        }
                    }
                }
            }
        },
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                ticks: {
                    callback: function(value) {
                        return 'R$ ' + value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    }
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                grid: {
                    drawOnChartArea: false
                },
                ticks: {
                    callback: function(value) {
                        return value.toFixed(0) + '%';
                    }
                }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}
