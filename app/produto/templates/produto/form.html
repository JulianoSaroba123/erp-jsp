{% extends "base.html" %}

{% block title %}
    {% if produto.id %}Editar Produto{% else %}Novo Produto{% endif %} - {{ super() }}
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('painel.dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('produto.listar') }}">Produtos</a></li>
        <li class="breadcrumb-item active">
            {% if produto.id %}Editar{% else %}Novo{% endif %}
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-box{% if not produto.id %}-plus{% else %}-edit{% endif %} me-2"></i>
                    {% if produto.id %}
                        Editar Produto: {{ produto.nome }}
                    {% else %}
                        Novo Produto
                    {% endif %}
                </h4>
            </div>
            
            <div class="card-body">
                <form method="POST" novalidate>
                    <!-- Dados Principais -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Dados Principais
                            </h6>
                        </div>
                        
                        <div class="col-md-8">
                            <label for="nome" class="form-label">Nome do Produto *</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="nome" 
                                   name="nome" 
                                   value="{{ produto.nome or '' }}" 
                                   required 
                                   maxlength="100">
                        </div>
                        
                        <div class="col-md-4">
                            <label for="status" class="form-label">Status *</label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="ativo" {% if produto.status == 'ativo' or not produto.id %}selected{% endif %}>
                                    Ativo
                                </option>
                                <option value="inativo" {% if produto.status == 'inativo' %}selected{% endif %}>
                                    Inativo
                                </option>
                                <option value="descontinuado" {% if produto.status == 'descontinuado' %}selected{% endif %}>
                                    Descontinuado
                                </option>
                            </select>
                        </div>
                        
                        <div class="col-md-12 mt-3">
                            <label for="descricao" class="form-label">Descri√ß√£o</label>
                            <textarea class="form-control" 
                                      id="descricao" 
                                      name="descricao" 
                                      rows="3" 
                                      maxlength="500">{{ produto.descricao or '' }}</textarea>
                            <small class="text-muted">M√°ximo 500 caracteres</small>
                        </div>
                    </div>
                    
                    <!-- C√≥digos e Identifica√ß√£o -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-barcode me-2"></i>
                                C√≥digos e Identifica√ß√£o
                            </h6>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="codigo" class="form-label">C√≥digo do Produto</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="codigo" 
                                   name="codigo" 
                                   value="{{ produto.codigo or '' }}"
                                   maxlength="50">
                            <small class="text-muted">Se n√£o informado, ser√° gerado automaticamente</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="codigo_barras" class="form-label">C√≥digo de Barras</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="codigo_barras" 
                                   name="codigo_barras" 
                                   value="{{ produto.codigo_barras or '' }}"
                                   maxlength="50">
                        </div>
                    </div>
                    
                    <!-- Categoria e Classifica√ß√£o -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-tags me-2"></i>
                                Categoria e Classifica√ß√£o
                            </h6>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="categoria" class="form-label">Categoria</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="categoria" 
                                   name="categoria" 
                                   value="{{ produto.categoria or '' }}"
                                   maxlength="50"
                                   list="categorias-list">
                            <datalist id="categorias-list">
                                <option value="Eletr√¥nicos">
                                <option value="Roupas">
                                <option value="Casa e Jardim">
                                <option value="Esportes">
                                <option value="Livros">
                                <option value="Alimenta√ß√£o">
                                <option value="Ferramentas">
                                <option value="Autom√≥veis">
                            </datalist>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="subcategoria" class="form-label">Subcategoria</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="subcategoria" 
                                   name="subcategoria" 
                                   value="{{ produto.subcategoria or '' }}"
                                   maxlength="50">
                        </div>
                        
                        <div class="col-md-6 mt-3">
                            <label for="marca" class="form-label">Marca</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="marca" 
                                   name="marca" 
                                   value="{{ produto.marca or '' }}"
                                   maxlength="50">
                        </div>
                        
                        <div class="col-md-6 mt-3">
                            <label for="modelo" class="form-label">Modelo</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="modelo" 
                                   name="modelo" 
                                   value="{{ produto.modelo or '' }}"
                                   maxlength="50">
                        </div>
                    </div>
                    
                    <!-- Medidas e Unidades -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-ruler me-2"></i>
                                Medidas e Unidades
                            </h6>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="unidade_medida" class="form-label">Unidade de Medida</label>
                            <select class="form-select" id="unidade_medida" name="unidade_medida">
                                <option value="UN" {% if produto.unidade_medida == 'UN' or not produto.id %}selected{% endif %}>
                                    Unidade (UN)
                                </option>
                                <option value="KG" {% if produto.unidade_medida == 'KG' %}selected{% endif %}>
                                    Quilograma (KG)
                                </option>
                                <option value="G" {% if produto.unidade_medida == 'G' %}selected{% endif %}>
                                    Grama (G)
                                </option>
                                <option value="L" {% if produto.unidade_medida == 'L' %}selected{% endif %}>
                                    Litro (L)
                                </option>
                                <option value="ML" {% if produto.unidade_medida == 'ML' %}selected{% endif %}>
                                    Mililitro (ML)
                                </option>
                                <option value="M" {% if produto.unidade_medida == 'M' %}selected{% endif %}>
                                    Metro (M)
                                </option>
                                <option value="CM" {% if produto.unidade_medida == 'CM' %}selected{% endif %}>
                                    Cent√≠metro (CM)
                                </option>
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="peso" class="form-label">Peso</label>
                            <div class="input-group">
                                <input type="number" 
                                       class="form-control" 
                                       id="peso" 
                                       name="peso" 
                                       value="{{ produto.peso or '' }}"
                                       step="0.001"
                                       min="0">
                                <span class="input-group-text">kg</span>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="dimensoes" class="form-label">Dimens√µes</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="dimensoes" 
                                   name="dimensoes" 
                                   value="{{ produto.dimensoes or '' }}"
                                   placeholder="Ex: 10x20x30 cm"
                                   maxlength="50">
                        </div>
                    </div>
                    
                    <!-- Pre√ßos -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-dollar-sign me-2"></i>
                                Pre√ßos
                            </h6>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="preco_custo" class="form-label">Pre√ßo de Custo *</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" 
                                       class="form-control" 
                                       id="preco_custo" 
                                       name="preco_custo" 
                                       value="{{ '%.2f'|format(produto.preco_custo|float) if produto.preco_custo else '' }}"
                                       placeholder="0,00"
                                       required>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="markup" class="form-label">Markup</label>
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control" 
                                       id="markup" 
                                       name="markup" 
                                       value="{{ '%.2f'|format(produto.markup|float) if produto.markup else '' }}"
                                       placeholder="0,00"
                                       required>
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">Percentual sobre o custo</small>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="preco_venda" class="form-label">Pre√ßo de Venda *</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" 
                                       class="form-control" 
                                       id="preco_venda" 
                                       name="preco_venda" 
                                       value="{{ '%.2f'|format(produto.preco_venda|float) if produto.preco_venda else '' }}"
                                       placeholder="0,00"
                                       required>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="margem_lucro" class="form-label">Margem de Lucro</label>
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control" 
                                       id="margem_lucro" 
                                       name="margem_lucro" 
                                       value="{{ '%.2f'|format(produto.margem_lucro|float) if produto.margem_lucro else '' }}"
                                       placeholder="0,00"
                                       readonly>
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">Calculada automaticamente</small>
                        </div>
                        
                        <div class="col-12 mt-3">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-info btn-sm" id="btn-calcular-preco-markup">
                                    <i class="fas fa-calculator me-1"></i>
                                    Calcular Pre√ßo por Markup
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm" id="btn-calcular-markup-preco">
                                    <i class="fas fa-percent me-1"></i>
                                    Calcular Markup por Pre√ßo
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estoque -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-warehouse me-2"></i>
                                Controle de Estoque
                            </h6>
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="controla_estoque" 
                                       name="controla_estoque" 
                                       value="1"
                                       {% if produto.controla_estoque or not produto.id %}checked{% endif %}>
                                <label class="form-check-label" for="controla_estoque">
                                    Controlar estoque deste produto
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-3" id="campos-estoque">
                            <label for="estoque_atual" class="form-label">Estoque Atual</label>
                            <input type="number" 
                                   class="form-control" 
                                   id="estoque_atual" 
                                   name="estoque_atual" 
                                   value="{{ produto.estoque_atual or 0 }}"
                                   min="0">
                        </div>
                        
                        <div class="col-md-3" id="campos-estoque-min">
                            <label for="estoque_minimo" class="form-label">Estoque M√≠nimo</label>
                            <input type="number" 
                                   class="form-control" 
                                   id="estoque_minimo" 
                                   name="estoque_minimo" 
                                   value="{{ produto.estoque_minimo or 0 }}"
                                   min="0">
                        </div>
                        
                        <div class="col-md-3" id="campos-estoque-max">
                            <label for="estoque_maximo" class="form-label">Estoque M√°ximo</label>
                            <input type="number" 
                                   class="form-control" 
                                   id="estoque_maximo" 
                                   name="estoque_maximo" 
                                   value="{{ produto.estoque_maximo or 0 }}"
                                   min="0">
                        </div>
                    </div>
                    
                    <!-- Observa√ß√µes -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-sticky-note me-2"></i>
                                Observa√ß√µes
                            </h6>
                        </div>
                        
                        <div class="col-12">
                            <label for="observacoes" class="form-label">Observa√ß√µes</label>
                            <textarea class="form-control" 
                                      id="observacoes" 
                                      name="observacoes" 
                                      rows="3" 
                                      maxlength="500">{{ produto.observacoes or '' }}</textarea>
                            <small class="text-muted">M√°ximo 500 caracteres</small>
                        </div>
                    </div>
                    
                    <!-- Bot√µes -->
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <a href="{{ url_for('produto.listar') }}" 
                                   class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>
                                    Voltar
                                </a>
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    {% if produto.id %}
                                        Atualizar Produto
                                    {% else %}
                                        Salvar Produto
                                    {% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('üöÄ JavaScript do produto carregando...');

document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ DOM carregado, iniciando configura√ß√£o...');
    
    // Elementos
    const precoCustoInput = document.getElementById('preco_custo');
    const precoVendaInput = document.getElementById('preco_venda');
    const markupInput = document.getElementById('markup');
    const margemLucroInput = document.getElementById('margem_lucro');
    const controlaEstoqueCheck = document.getElementById('controla_estoque');
    
    console.log('üîç Elementos encontrados:', {
        custo: !!precoCustoInput,
        venda: !!precoVendaInput,
        markup: !!markupInput,
        margem: !!margemLucroInput,
        estoque: !!controlaEstoqueCheck
    });
    
    // Fun√ß√£o para formatar n√∫mero (v√≠rgula para ponto)
    function parseNumber(value) {
        return parseFloat(value.replace(',', '.')) || 0;
    }
    
    // Fun√ß√£o para formatar para exibi√ß√£o (ponto para v√≠rgula)
    function formatDisplay(value) {
        return value.toFixed(2).replace('.', ',');
    }
    
    // Fun√ß√£o principal de c√°lculo
    function calcularPreco() {
        const custo = parseNumber(precoCustoInput.value);
        const markup = parseNumber(markupInput.value);
        
        console.log('üí∞ Calculando - Custo:', custo, 'Markup:', markup);
        
        if (custo > 0 && markup > 0) {
            const venda = custo * (1 + markup / 100);
            const margem = ((venda - custo) / custo) * 100;
            
            precoVendaInput.value = formatDisplay(venda);
            margemLucroInput.value = formatDisplay(margem);
            
            console.log('‚úÖ Resultado - Venda:', venda, 'Margem:', margem);
            console.log('üìù Campos atualizados - Venda:', precoVendaInput.value, 'Margem:', margemLucroInput.value);
        } else {
            console.log('‚ö†Ô∏è Valores insuficientes para c√°lculo');
        }
    }
    
    // Fun√ß√£o para calcular markup reverso
    function calcularMarkup() {
        const custo = parseNumber(precoCustoInput.value);
        const venda = parseNumber(precoVendaInput.value);
        
        console.log('üîÑ Calculando markup reverso - Custo:', custo, 'Venda:', venda);
        
        if (custo > 0 && venda > 0) {
            const markup = ((venda - custo) / custo) * 100;
            const margem = markup; // Markup e margem s√£o iguais neste contexto
            
            markupInput.value = formatDisplay(markup);
            margemLucroInput.value = formatDisplay(margem);
            
            console.log('‚úÖ Markup calculado:', markup);
        } else {
            console.log('‚ö†Ô∏è Valores insuficientes para calcular markup');
        }
    }
    
    // Event listeners com logs
    if (markupInput) {
        console.log('üéØ Configurando listeners do markup...');
        
        markupInput.addEventListener('input', function() {
            console.log('‚å®Ô∏è Markup input:', this.value);
            calcularPreco();
        });
        
        markupInput.addEventListener('blur', function() {
            console.log('üëÅÔ∏è Markup blur:', this.value);
            calcularPreco();
        });
        
        markupInput.addEventListener('change', function() {
            console.log('üîÑ Markup change:', this.value);
            calcularPreco();
        });
    }
    
    if (precoCustoInput) {
        console.log('üéØ Configurando listeners do custo...');
        
        precoCustoInput.addEventListener('input', function() {
            console.log('‚å®Ô∏è Custo input:', this.value);
            if (markupInput.value) {
                calcularPreco();
            }
        });
        
        precoCustoInput.addEventListener('blur', function() {
            console.log('üëÅÔ∏è Custo blur:', this.value);
            if (markupInput.value) {
                calcularPreco();
            }
        });
    }
    
    if (precoVendaInput) {
        precoVendaInput.addEventListener('blur', function() {
            console.log('üëÅÔ∏è Venda blur:', this.value);
            calcularMarkup();
        });
    }
    
    // Controle de estoque
    function toggleEstoque() {
        const controla = controlaEstoqueCheck.checked;
        const camposEstoque = document.querySelectorAll('#campos-estoque input, #campos-estoque-min input, #campos-estoque-max input');
        
        console.log('üì¶ Toggle estoque:', controla);
        
        camposEstoque.forEach(input => {
            input.disabled = !controla;
            if (!controla) input.value = '0';
        });
    }
    
    if (controlaEstoqueCheck) {
        controlaEstoqueCheck.addEventListener('change', toggleEstoque);
    }
    
    // Gera√ß√£o autom√°tica de c√≥digo
    const nomeInput = document.getElementById('nome');
    if (nomeInput) {
        nomeInput.addEventListener('blur', function() {
            const codigoInput = document.getElementById('codigo');
            if (codigoInput && !codigoInput.value.trim()) {
                const nome = this.value.trim();
                if (nome) {
                    let codigo = nome.toUpperCase()
                        .replace(/[√Å√Ä√Ç√É]/g, 'A')
                        .replace(/[√â√à√ä·∫º]/g, 'E')
                        .replace(/[√ç√å√éƒ®]/g, 'I')
                        .replace(/[√ì√í√î√ï]/g, 'O')
                        .replace(/[√ö√ô√õ≈®]/g, 'U')
                        .replace(/[^A-Z0-9]/g, '')
                        .substring(0, 10);
                    
                    codigoInput.value = codigo;
                    console.log('üè∑Ô∏è C√≥digo gerado:', codigo);
                }
            }
        });
    }
    
    // M√°scaras
    const codigoBarrasInput = document.getElementById('codigo_barras');
    if (codigoBarrasInput) {
        codigoBarrasInput.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '');
        });
    }
    
    const pesoInput = document.getElementById('peso');
    if (pesoInput) {
        pesoInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^\d\.]/g, '');
        });
    }
    
    // Bot√µes de c√°lculo
    const btnCalcularPreco = document.getElementById('btn-calcular-preco-markup');
    if (btnCalcularPreco) {
        btnCalcularPreco.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('üñ±Ô∏è Bot√£o calcular pre√ßo clicado');
            calcularPreco();
        });
    }
    
    const btnCalcularMarkup = document.getElementById('btn-calcular-markup-preco');
    if (btnCalcularMarkup) {
        btnCalcularMarkup.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('üñ±Ô∏è Bot√£o calcular markup clicado');
            calcularMarkup();
        });
    }
    
    // Inicializa√ß√£o
    toggleEstoque();
    if (nomeInput) nomeInput.focus();
    
    // Fun√ß√£o global para teste
    window.calcularPreco = calcularPreco;
    window.testarCalculo = function() {
        console.log('üß™ TESTE MANUAL INICIADO');
        console.log('üìä Valores atuais:');
        console.log('  - Custo:', precoCustoInput.value);
        console.log('  - Markup:', markupInput.value);
        console.log('  - Venda:', precoVendaInput.value);
        
        calcularPreco();
        
        console.log('üìä Valores ap√≥s c√°lculo:');
        console.log('  - Venda:', precoVendaInput.value);
        console.log('  - Margem:', margemLucroInput.value);
    };
    
    console.log('‚úÖ Configura√ß√£o conclu√≠da!');
    console.log('üí° Para testar, digite no console: window.testarCalculo()');
});
</script>
{% endblock %}