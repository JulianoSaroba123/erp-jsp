{% extends "base.html" %}

{% block title %}
{% if proposta %}Editar Proposta {{ proposta.codigo }}{% else %}Nova Proposta{% endif %}
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb bg-transparent mb-0">
        <li class="breadcrumb-item">
            <a href="{{ url_for('painel.dashboard') }}" class="text-decoration-none">
                <i class="fas fa-home"></i> Dashboard
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('proposta.listar_propostas') }}" class="text-decoration-none">
                <i class="fas fa-file-alt"></i> Propostas
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            {% if proposta %}Editar Proposta{% else %}Nova Proposta{% endif %}
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}

<!-- Estilos customizados para proposta -->
<style>
    .card {
        transition: all 0.3s ease;
    }
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .btn {
        transition: all 0.3s ease;
    }
    .btn:hover {
        transform: translateY(-1px);
    }
    .item-produto, .item-servico {
        transition: all 0.3s ease;
        border: 2px solid transparent !important;
    }
    .item-produto:hover, .item-servico:hover {
        border-color: #ffc107 !important;
        background-color: rgba(255, 193, 7, 0.1) !important;
    }
    .alert-info {
        background-color: rgba(13, 202, 240, 0.1);
        border-color: rgba(13, 202, 240, 0.3);
        color: #0dcaf0;
    }
    .form-control:focus, .form-select:focus {
        border-color: #ffc107;
        box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
    }
    .valor-destaque {
        font-size: 1.2em;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    .secao-titulo {
        background: linear-gradient(45deg, #212529, #343a40);
        border-radius: 8px;
        padding: 0.75rem 1rem;
    }
    .total-destaque {
        background: linear-gradient(45deg, #28a745, #20c997) !important;
        color: white !important;
        font-weight: bold !important;
        font-size: 1.1em !important;
        text-align: center !important;
        border: 2px solid #20c997 !important;
    }
    .item-servico {
        border-radius: 12px !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2) !important;
        margin-bottom: 1.5rem !important;
    }
    .fw-bold {
        font-weight: 600 !important;
    }
    .btn-grupo {
        gap: 0.5rem;
    }
    @media (max-width: 768px) {
        .btn-lg {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        .col-md-1 button {
            margin-top: 0.5rem;
        }
    }
</style>

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <!-- Header com Resumo -->
            <div class="card bg-gradient border-secondary mb-4" style="background: linear-gradient(135deg, #212529 0%, #343a40 100%);">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="text-white mb-1">
                                <i class="fas fa-file-alt text-warning me-2"></i>
                                {% if proposta %}
                                    Proposta {{ proposta.codigo }} - {{ proposta.titulo|truncate(50) }}
                                {% else %}
                                    Nova Proposta Comercial
                                {% endif %}
                            </h2>
                            <p class="text-muted mb-0">
                                {% if proposta %}
                                    Cliente: {{ proposta.cliente.nome if proposta.cliente else 'N/A' }} | 
                                    Status: <span class="badge bg-{{ proposta.status_cor }}">{{ proposta.status_formatado }}</span> | 
                                    Prioridade: <span class="badge bg-{{ proposta.prioridade_cor }}">{{ proposta.prioridade_formatada }}</span>
                                {% else %}
                                    Preencha os dados abaixo para criar uma nova proposta comercial
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            {% if proposta %}
                            <div class="text-white">
                                <h4 class="mb-1 valor-destaque">{{ "R$ %.2f"|format(proposta.valor_total|float) if proposta.valor_total else 'R$ 0,00' }}</h4>
                                <small class="text-muted">Valor Total da Proposta</small>
                                {% if proposta.valida_ate %}
                                <br><small class="text-warning">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    V√°lida at√© {{ proposta.valida_ate.strftime('%d/%m/%Y') }}
                                </small>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="text-center">
                                <i class="fas fa-plus-circle fa-3x text-success opacity-50"></i>
                                <br><small class="text-muted">Nova Proposta</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formul√°rio -->
            <form method="POST" class="needs-validation" novalidate>
                
                <!-- Dados B√°sicos -->
                <div class="card bg-dark border-secondary mb-4">
                    <div class="card-header bg-dark border-secondary">
                        <h5 class="mb-0 text-white">
                            <i class="fas fa-info-circle me-2"></i>Dados da Proposta
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="cliente_id" class="form-label text-white">Cliente *</label>
                                <select class="form-select bg-dark text-white border-secondary" name="cliente_id" required>
                                    <option value="">Selecione um cliente</option>
                                    {% for cliente in clientes %}
                                    <option value="{{ cliente.id }}" {% if proposta and proposta.cliente_id == cliente.id %}selected{% endif %}>
                                        {{ cliente.nome }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="titulo" class="form-label text-white">T√≠tulo *</label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" 
                                       name="titulo" value="{{ proposta.titulo if proposta else '' }}" 
                                       placeholder="Ex: Proposta para desenvolvimento de sistema" required>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="vendedor" class="form-label text-white">Vendedor/Respons√°vel</label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" 
                                       name="vendedor" value="{{ proposta.vendedor if proposta else '' }}" 
                                       placeholder="Nome do vendedor">
                            </div>
                            <div class="col-md-4">
                                <label for="data_emissao" class="form-label text-white">Data de Emiss√£o</label>
                                <input type="date" class="form-control bg-dark text-white border-secondary" name="data_emissao" value="{{ proposta.data_emissao.strftime('%Y-%m-%d') if proposta and proposta.data_emissao else '' }}">
                            </div>
                            <div class="col-md-4">
                                <label for="status" class="form-label text-white">Status</label>
                                <select class="form-select bg-dark text-white border-secondary" name="status">
                                    <option value="pendente" {% if not proposta or proposta.status == 'pendente' %}selected{% endif %}>Pendente</option>
                                    <option value="enviada" {% if proposta and proposta.status == 'enviada' %}selected{% endif %}>Enviada</option>
                                    <option value="aprovada" {% if proposta and proposta.status == 'aprovada' %}selected{% endif %}>Aprovada</option>
                                    <option value="rejeitada" {% if proposta and proposta.status == 'rejeitada' %}selected{% endif %}>Rejeitada</option>
                                    <option value="cancelada" {% if proposta and proposta.status == 'cancelada' %}selected{% endif %}>Cancelada</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="prioridade" class="form-label text-white">Prioridade</label>
                                <select class="form-select bg-dark text-white border-secondary" name="prioridade">
                                    <option value="baixa" {% if proposta and proposta.prioridade == 'baixa' %}selected{% endif %}>Baixa</option>
                                    <option value="normal" {% if not proposta or proposta.prioridade == 'normal' %}selected{% endif %}>Normal</option>
                                    <option value="alta" {% if proposta and proposta.prioridade == 'alta' %}selected{% endif %}>Alta</option>
                                    <option value="urgente" {% if proposta and proposta.prioridade == 'urgente' %}selected{% endif %}>Urgente</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <label for="descricao" class="form-label text-white">Descri√ß√£o do Projeto</label>
                                <textarea class="form-control bg-dark text-white border-secondary" 
                                          name="descricao" rows="4" 
                                          placeholder="Descreva detalhadamente o projeto, objetivos e requisitos...">{{ proposta.descricao if proposta else '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prazos e Estimativas -->
                <div class="card bg-dark border-secondary mb-4">
                    <div class="card-header bg-dark border-secondary">
                        <h5 class="mb-0 text-primary">
                            <i class="fas fa-clock me-2"></i>Prazos e Estimativas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="validade" class="form-label text-white">Validade (dias)</label>
                                <input type="number" class="form-control bg-dark text-white border-secondary" 
                                       name="validade" value="{{ proposta.validade if proposta else '30' }}" 
                                       min="1" max="365">
                            </div>
                            <div class="col-md-3">
                                <label for="prazo_execucao" class="form-label text-white">Prazo de Execu√ß√£o</label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" 
                                       name="prazo_execucao" value="{{ proposta.prazo_execucao if proposta else '' }}" 
                                       placeholder="Ex: 30 dias corridos">
                            </div>
                            <div class="col-md-3">
                                <label for="tempo_estimado" class="form-label text-white">Tempo Estimado</label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" 
                                       name="tempo_estimado" value="{{ proposta.tempo_estimado if proposta else '' }}" 
                                       placeholder="Ex: 120 horas">
                            </div>
                            <div class="col-md-3">
                                <label for="km_estimado" class="form-label text-white">KM Estimado (se aplic√°vel)</label>
                                <input type="number" class="form-control bg-dark text-white border-secondary" 
                                       name="km_estimado" value="{{ proposta.km_estimado if proposta else '' }}" 
                                       step="0.01" placeholder="0.00">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o Produtos -->
                <div class="card bg-dark border-secondary mb-4">
                    <div class="card-header bg-dark border-secondary d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-warning">
                            <i class="fas fa-box me-2"></i>Produtos
                        </h5>
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="adicionarProduto()">
                            <i class="fas fa-plus me-1"></i>Adicionar Produto
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="produtos-container">
                            <!-- Produtos ser√£o adicionados aqui -->
                        </div>
                        <div class="mt-3 p-3 bg-secondary rounded">
                            <h6 class="text-warning mb-0">
                                <i class="fas fa-calculator me-1"></i>
                                Subtotal Produtos: <span id="subtotal-produtos-display">R$ 0,00</span>
                            </h6>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o Servi√ßos -->
                <div class="card bg-dark border-secondary mb-4">
                    <div class="card-header bg-dark border-secondary d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-info">
                            <i class="fas fa-tools me-2"></i>Servi√ßos
                        </h5>
                        <div>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="adicionarServico()">
                                <i class="fas fa-plus me-1"></i>Adicionar Servi√ßo
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="servicos-container">
                            <!-- Servi√ßos ser√£o adicionados aqui -->
                        </div>
                        <div class="mt-3 p-3 bg-secondary rounded">
                            <h6 class="text-info mb-0">
                                <i class="fas fa-calculator me-1"></i>
                                Subtotal Servi√ßos: <span id="subtotal-servicos-display">R$ 0,00</span>
                            </h6>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o Valores -->
                <div class="card bg-dark border-secondary mb-4">
                    <div class="card-header bg-dark border-secondary">
                        <h5 class="mb-0 text-success">
                            <i class="fas fa-dollar-sign me-2"></i>Valores
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="valor_servicos" class="form-label text-white">
                                    <i class="fas fa-tools me-1"></i>Valor Servi√ßos
                                </label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" 
                                       id="valor_servicos" name="valor_servicos" 
                                       value="{{ "%.2f"|format(proposta.valor_servicos|float) if proposta and proposta.valor_servicos else '0.00' }}" 
                                       readonly>
                            </div>
                            <div class="col-md-3">
                                <label for="valor_produtos" class="form-label text-white">
                                    <i class="fas fa-box me-1"></i>Valor Produtos
                                </label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" 
                                       id="valor_produtos" name="valor_produtos" 
                                       value="{{ "%.2f"|format(proposta.valor_produtos|float) if proposta and proposta.valor_produtos else '0.00' }}" 
                                       readonly>
                            </div>
                            <div class="col-md-3">
                                <label for="desconto" class="form-label text-white">
                                    <i class="fas fa-percent me-1"></i>Desconto (%)
                                </label>
                                <input type="number" class="form-control bg-dark text-white border-secondary" 
                                       id="desconto" name="desconto" 
                                       value="{{ proposta.desconto if proposta else '0.00' }}" 
                                       step="0.01" min="0" max="100">
                            </div>
                            <div class="col-md-3">
                                <label for="valor_total" class="form-label text-white">
                                    <i class="fas fa-calculator me-1"></i>Valor Total
                                </label>
                                <input type="text" class="form-control bg-success text-white border-success fw-bold" 
                                       id="valor_total" name="valor_total" 
                                       value="{{ "R$ %.2f"|format(proposta.valor_total|float) if proposta and proposta.valor_total else 'R$ 0,00' }}" 
                                       readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Condi√ß√µes Comerciais -->
                <div class="card bg-dark border-secondary mb-4">
                    <div class="card-header bg-dark border-secondary">
                        <h5 class="mb-0 text-warning">
                            <i class="fas fa-handshake me-2"></i>Condi√ß√µes Comerciais
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="forma_pagamento" class="form-label text-white">Forma de Pagamento</label>
                                <select class="form-select bg-dark text-white border-secondary" name="forma_pagamento">
                                    <option value="a_vista" {% if not proposta or proposta.forma_pagamento == 'a_vista' %}selected{% endif %}>√Ä Vista</option>
                                    <option value="parcelado" {% if proposta and proposta.forma_pagamento == 'parcelado' %}selected{% endif %}>Parcelado</option>
                                    <option value="30_dias" {% if proposta and proposta.forma_pagamento == '30_dias' %}selected{% endif %}>30 Dias</option>
                                    <option value="30_60_dias" {% if proposta and proposta.forma_pagamento == '30_60_dias' %}selected{% endif %}>30/60 Dias</option>
                                    <option value="personalizado" {% if proposta and proposta.forma_pagamento == 'personalizado' %}selected{% endif %}>Personalizado</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-white">Entrada (R$)</label>
                                <input type="text" class="form-control money bg-dark text-white border-secondary" name="entrada" id="entrada" value="0,00">
                            </div>
                            <div class="col-md-6 mt-2">
                                <label class="form-label text-white">Parcelas</label>
                                <select class="form-select bg-dark text-white border-secondary" name="numero_parcelas" id="numero_parcelas">
                                    {% for i in range(1,13) %}
                                    <option value="{{ i }}">{{ i }}x</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12 mt-2 d-flex gap-2">
                                <button type="button" class="btn btn-outline-light" id="btnCalcularParcelas" onclick="calcularParcelas()">Calcular Parcelas</button>
                                <button type="button" class="btn btn-outline-secondary" id="btnAtualizarParcelas" onclick="calcularParcelas()">Atualizar</button>
                            </div>
                            <div class="col-12 mt-2" id="parcelas-container">
                                <!-- Parcelas da proposta ser√£o geradas aqui -->
                            </div>
                            <div class="col-md-6">
                                <label for="garantia" class="form-label text-white">Garantia</label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" 
                                       name="garantia" value="{{ proposta.garantia if proposta else '' }}" 
                                       placeholder="Ex: 12 meses contra defeitos de fabrica√ß√£o">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <label for="condicoes_pagamento" class="form-label text-white">Condi√ß√µes de Pagamento Detalhadas</label>
                                <textarea class="form-control bg-dark text-white border-secondary" 
                                          name="condicoes_pagamento" rows="3" 
                                          placeholder="Descreva as condi√ß√µes espec√≠ficas de pagamento, prazos, multas, etc...">{{ proposta.condicoes_pagamento if proposta else '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observa√ß√µes e Anexos -->
                <div class="card bg-dark border-secondary mb-4">
                    <div class="card-header bg-dark border-secondary">
                        <h5 class="mb-0 text-info">
                            <i class="fas fa-sticky-note me-2"></i>Observa√ß√µes e Informa√ß√µes Adicionais
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <label for="observacoes" class="form-label text-white">Observa√ß√µes Gerais</label>
                                <textarea class="form-control bg-dark text-white border-secondary" 
                                          name="observacoes" rows="4" 
                                          placeholder="Informa√ß√µes importantes, restri√ß√µes, requisitos especiais, etc...">{{ proposta.observacoes if proposta else '' }}</textarea>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-1"></i>Informa√ß√µes Importantes:</h6>
                                    <ul class="mb-0">
                                        <li>Esta proposta √© v√°lida pelos dias especificados acima</li>
                                        <li>Os valores apresentados incluem todos os impostos aplic√°veis</li>
                                        <li>Altera√ß√µes no escopo podem impactar prazo e valor</li>
                                        <li>O in√≠cio dos trabalhos est√° condicionado √† aprova√ß√£o desta proposta</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div class="card bg-dark border-secondary mb-4">
                    <div class="card-body text-center">
                        <div class="row justify-content-center">
                            <div class="col-auto">
                                <button type="submit" class="btn btn-success btn-lg me-3">
                                    <i class="fas fa-save me-2"></i>Salvar Proposta
                                </button>
                            </div>
                           
                            {% if proposta and proposta.id %}
                            <div class="col-auto">
                                <button type="button" class="btn btn-warning btn-lg me-3" onclick="window.open('{{ url_for('proposta.gerar_pdf', id=proposta.id) }}', '_blank')">
                                    <i class="fas fa-file-pdf me-2"></i>Gerar PDF
                                </button>
                            </div>
                           
                            {% endif %}
                            <div class="col-auto">
                                <a href="{{ url_for('proposta.listar_propostas') }}" class="btn btn-secondary btn-lg">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </a>
                            </div>
                        </div>
                        
                        {% if proposta and proposta.id %}
                        <div class="row justify-content-center mt-3">
                            <div class="col-auto">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Proposta criada em {{ proposta.data_criacao.strftime('%d/%m/%Y %H:%M') if proposta.data_criacao }}
                                    {% if proposta.data_atualizacao and proposta.data_atualizacao != proposta.data_criacao %}
                                    | √öltima atualiza√ß√£o: {{ proposta.data_atualizacao.strftime('%d/%m/%Y %H:%M') }}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- JavaScript MODO MESTRE - Vers√£o Limpa e Funcional -->
<script>
// ==============================================
// MODO MESTRE - JAVASCRIPT LIMPO E FUNCIONAL
// ==============================================

// Vari√°veis globais
window.contadorServicos = 0;
window.contadorProdutos = 0;
window.jsCarregado = true;

console.log('ÔøΩ MODO MESTRE - JavaScript iniciado!');

// Fun√ß√£o principal para adicionar servi√ßo
function adicionarServico() {
    console.log('‚ûï MODO MESTRE - Adicionando servi√ßo...');
    
    // Garantir que o container existe
    var container = document.getElementById('servicos-container');
    if (!container) {
        console.error('‚ùå Container de servi√ßos n√£o encontrado!');
        return;
    }
    
    // Incrementar contador de forma segura
    if (!window.contadorServicos) {
        window.contadorServicos = 0;
    }
    window.contadorServicos++;
    
    
    // Verificar se o ID j√° existe para evitar conflitos
    while (document.getElementById('servico-' + window.contadorServicos)) {
        console.warn('‚ö†Ô∏è ID servico-' + window.contadorServicos + ' j√° existe, incrementando...');
        window.contadorServicos++;
    }
    
    var servicoId = window.contadorServicos;
    console.log('üÜî Criando servi√ßo com ID:', servicoId);
    
    // HTML do servi√ßo com layout otimizado e eventos controlados
    var html = `
        <div class="row item-servico mb-3 border rounded p-3 bg-secondary" id="servico-${servicoId}">
            <div class="col-md-3">
                <label class="form-label text-white">Descri√ß√£o</label>
                <input type="text" class="form-control bg-dark text-white border-secondary" 
                       name="servico_descricao[]" placeholder="Ex: Instala√ß√£o el√©trica" required>
            </div>
            <div class="col-md-2">
                <label class="form-label text-white">Tipo</label>
                <select class="form-select bg-dark text-white border-secondary" name="servico_tipo[]">
                    <option value="hora">Hora</option>
                    <option value="dia">Dia</option>
                    <option value="fechado">Fechado</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label text-white">Quantidade</label>
                <input type="number" class="form-control bg-dark text-white border-secondary" 
                       name="servico_horas[]" value="1" step="0.01" min="0"
                       lang="en" inputmode="decimal"
                       oninput="calcularTotalServico(${servicoId})">
            </div>
            <div class="col-md-2">
                <label class="form-label text-white">Valor Unit</label>
                <input type="text" class="form-control bg-dark text-white border-secondary" 
                       name="servico_valor[]" placeholder="0,00" 
                       oninput="aplicarMascaraMonetaria(this); calcularTotalServico(${servicoId})" required>
            </div>
            <div class="col-md-2">
                <label class="form-label text-white">Valor Total</label>
                <input type="text" class="form-control bg-dark text-white border-secondary" 
                       name="servico_total[]" value="R$ 0,00" readonly>
            </div>
            <div class="col-md-1">
                <label class="form-label text-white">&nbsp;</label>
                <button type="button" class="btn btn-outline-danger d-block w-100" 
                        onclick="removerServico(${servicoId})" title="Remover servi√ßo">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    // Inserir o HTML no container
    container.insertAdjacentHTML('beforeend', html);
    console.log(`‚úÖ Servi√ßo ${servicoId} adicionado com sucesso!`);
    
    // Atualizar totais se n√£o estiver carregando dados existentes
    if (!window.carregandoDadosExistentes) {
        setTimeout(calcularTotaisGerais, 100);
    }

    return servicoId;
}

// Fun√ß√£o para adicionar produto
function adicionarProduto() {
    console.log('üì¶ MODO MESTRE - Adicionando produto...');
    
    window.contadorProdutos++;
    var container = document.getElementById('produtos-container');
    
    if (!container) {
        alert('‚ùå Container de produtos n√£o encontrado!');
        return;
    }
    
    // HTML do produto
    var html = '
        <div class="row item-produto mb-3 border rounded p-3 bg-secondary" id="produto-${window.contadorProdutos}">
            <div class="col-md-5">
                <label class="form-label text-white">Descri√ß√£o do Produto</label>
                <input type="text" class="form-control bg-dark text-white border-secondary" 
                       name="produto_descricao[]" placeholder="Ex: Licen√ßa de software" required>
            </div>
            <div class="col-md-2">
                <label class="form-label text-white">Quantidade</label>
                <input type="number" class="form-control bg-dark text-white border-secondary" 
                       name="produto_quantidade[]" value="1" min="1" step="0.01" 
                       oninput="calcularTotalProduto(${window.contadorProdutos})" required>
            </div>
            <div class="col-md-2">
                <label class="form-label text-white">Valor Unit.</label>
                <input type="text" class="form-control bg-dark text-white border-secondary" 
                       name="produto_valor[]" placeholder="0,00" 
                       oninput="aplicarMascaraMonetaria(this); calcularTotalProduto(${window.contadorProdutos})" required>
            </div>
            <div class="col-md-2">
                <label class="form-label text-white">Total</label>
                <input type="text" class="form-control bg-dark text-white border-secondary" 
                       name="produto_total[]" value="R$ 0,00" readonly>
            </div>
            <div class="col-md-1">
                <label class="form-label text-white">&nbsp;</label>
                <button type="button" class="btn btn-outline-danger d-block w-100" 
                        onclick="removerProduto(${window.contadorProdutos})" title="Remover produto">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', html);
    console.log(`‚úÖ Produto ${window.contadorProdutos} adicionado com sucesso!`);

    return window.contadorProdutos;
}

// Fun√ß√£o para remover servi√ßo
function removerServico(id) {
    var elemento = document.getElementById('servico-' + id);
    if (elemento) {
        elemento.remove();
        console.log(`üóëÔ∏è Servi√ßo ${id} removido`);
        calcularTotaisGerais();
    }
}

// Fun√ß√£o para remover produto
function removerProduto(id) {
    var elemento = document.getElementById('produto-' + id);
    if (elemento) {
        elemento.remove();
        console.log(`üóëÔ∏è Produto ${id} removido`);
        calcularTotaisGerais();
    }
}

// Fun√ß√£o para limpar todos os servi√ßos
function limparTodosServicos() {
    console.log('üßπ MODO MESTRE - Limpando TODOS os servi√ßos!');
    
    var container = document.getElementById('servicos-container');
    if (container) {
        var quantidade = container.querySelectorAll('.item-servico').length;
        container.innerHTML = '';
        window.contadorServicos = 0;
        console.log(`‚úÖ ${quantidade} servi√ßos removidos - container limpo!`);
        
        // Recalcular totais
        calcularTotaisGerais();
    }
    
    // For√ßar remo√ß√£o de qualquer item residual
    document.querySelectorAll('.item-servico').forEach(function(item) {
        item.remove();
        console.log('üóëÔ∏è Item residual removido');
    });
}

// Fun√ß√£o para carregar servi√ßos existentes (OTIMIZADA)
function carregarDadosExistentes() {
    console.log('üîÑ MODO MESTRE - Carregando dados existentes...');
    
    // PROTE√á√ÉO TRIPLA: Verificar m√∫ltiplas condi√ß√µes antes de carregar
    var servicosExistentes = document.querySelectorAll('#servicos-container .item-servico');
    if (servicosExistentes.length > 0) {
        console.log('‚ö†Ô∏è MODO MESTRE - Dados j√° carregados (' + servicosExistentes.length + ' servi√ßos), pulando duplica√ß√£o!');
        return;
    }
    
    // Verificar se j√° foi executado
    if (window.dadosExistentesCarregados) {
        console.log('‚ö†Ô∏è MODO MESTRE - Fun√ß√£o j√° executada, evitando reexecu√ß√£o!');
        return;
    }
    window.dadosExistentesCarregados = true;
    
    // DESABILITAR TODOS OS C√ÅLCULOS E EVENTOS DURANTE CARREGAMENTO
    window.carregandoDadosExistentes = true;
    console.log('üîí Todos os c√°lculos autom√°ticos desabilitados durante carregamento');
    
    // Garantir que contadores est√£o zerados
    window.contadorServicos = 0;
    window.contadorProdutos = 0;
    
    {% if proposta and proposta.itens_servico %}
        console.log('üìä Carregando {{ proposta.itens_servico|length }} servi√ßos do banco...');
        {% for item in proposta.itens_servico %}
            try {
                console.log('üìã Carregando servi√ßo {{ loop.index }}: {{ item.descricao|escapejs }}');
                var novoId = adicionarServico();
                
                // Aguardar DOM atualizar
                setTimeout(function() {
                    var ultimo = document.getElementById('servico-' + novoId) || document.querySelector('#servicos-container .item-servico:last-child');
                    if (ultimo) {
                        // Preencher com seguran√ßa
                        var descInput = ultimo.querySelector('input[name="servico_descricao[]"]');
                        var tipoSelect = ultimo.querySelector('select[name="servico_tipo[]"]');
                        var qtdInput = ultimo.querySelector('input[name="servico_horas[]"]');
                        var valorInput = ultimo.querySelector('input[name="servico_valor[]"]');
                        var totalInput = ultimo.querySelector('input[name="servico_total[]"]');
                        
                        if (descInput) descInput.value = '{{ item.descricao|escapejs }}';
                        if (tipoSelect) tipoSelect.value = '{{ (item.tipo_servico or "hora")|escapejs }}';
                        if (qtdInput) qtdInput.value = '{{ item.quantidade|default(0)|escapejs }}';
                        if (valorInput) valorInput.value = 'R$ {{ "%.2f"|format((item.valor_unitario|default(0))|float) }}';
                        if (totalInput) totalInput.value = 'R$ {{ "%.2f"|format((item.valor_total|default(0))|float) }}';
                        
                        console.log('‚úÖ Servi√ßo {{ loop.index }} carregado: {{ item.descricao|escapejs }}');
                    } else {
                        console.error('‚ùå N√£o foi poss√≠vel encontrar o √∫ltimo servi√ßo adicionado');
                    }
                }, 50);
            } catch (error) {
                console.error('‚ùå Erro ao carregar servi√ßo {{ loop.index }}:', error);
            }
        {% endfor %}
        
        // Aguardar todos os servi√ßos serem carregados antes de reabilitar
        setTimeout(function() {
            window.carregandoDadosExistentes = false;
            console.log('üîì C√°lculos autom√°ticos reabilitados ap√≥s carregamento completo');
            console.log('üìä Total de servi√ßos carregados: ' + document.querySelectorAll('#servicos-container .item-servico').length);
        }, 200);
        
    {% else %}
        console.log('‚ÑπÔ∏è Nenhum servi√ßo existente encontrado no banco');
        window.carregandoDadosExistentes = false;
    {% endif %}
}

// Inicializa√ß√£o OTIMIZADA quando a p√°gina carrega
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ MODO MESTRE - DOM carregado, verificando inicializa√ß√£o...');
    
    // PROTE√á√ÉO RIGOROSA CONTRA EXECU√á√ÉO M√öLTIPLA
    if (window.modoMestreJaInicializado) {
        console.log('‚ö†Ô∏è MODO MESTRE - J√° inicializado (' + new Date().toLocaleTimeString() + '), evitando duplica√ß√£o!');
        return;
    }
    
    // Marcar como inicializado IMEDIATAMENTE
    window.modoMestreJaInicializado = true;
    window.dadosExistentesCarregados = false;
    
    console.log('‚úÖ MODO MESTRE - Iniciando primeira execu√ß√£o...');
    
    // Configurar vari√°veis globais de controle
    window.carregandoDadosExistentes = false;
    window.contadorServicos = 0;
    window.contadorProdutos = 0;
    
    // Aguardar DOM estar completamente pronto
    setTimeout(function() {
        console.log('üîß Iniciando limpeza e configura√ß√£o dos containers...');
        
        // LIMPEZA RADICAL E SEGURA - REMOVER TODOS OS ITENS EXISTENTES
        var servicosContainer = document.getElementById('servicos-container');
        var produtosContainer = document.getElementById('produtos-container');
        
        if (servicosContainer) {
            var servicosAntigos = servicosContainer.querySelectorAll('.item-servico');
            console.log('üßπ Removendo ' + servicosAntigos.length + ' servi√ßos antigos...');
            servicosContainer.innerHTML = '';
            window.contadorServicos = 0;
        }
        
        if (produtosContainer) {
            var produtosAntigos = produtosContainer.querySelectorAll('.item-produto');
            console.log('üßπ Removendo ' + produtosAntigos.length + ' produtos antigos...');
            produtosContainer.innerHTML = '';
            window.contadorProdutos = 0;
        }
        
        // FOR√áAR remo√ß√£o de qualquer elemento residual em toda a p√°gina
        document.querySelectorAll('.item-servico, .item-produto').forEach(function(item, index) {
            console.log('üóëÔ∏è Removendo item residual ' + (index + 1) + ': ' + item.id);
            item.remove();
        });
        
        // Aguardar limpeza completa antes de carregar dados
        setTimeout(function() {
            console.log('‚ú® Limpeza conclu√≠da. Iniciando carregamento de dados existentes...');
            carregarDadosExistentes();
            
            // CONFIGURAR EVENTO DO DESCONTO ap√≥s carregamento
            setTimeout(function() {
                var descontoInput = document.getElementById('desconto');
                if (descontoInput) {
                    descontoInput.addEventListener('input', function() {
                        if (!window.carregandoDadosExistentes) {
                            console.log('üí∏ Desconto alterado para:', this.value + '%');
                            calcularTotaisGerais();
                        }
                    });
                    console.log('‚úÖ Evento de desconto configurado');
                } else {
                    console.log('‚ö†Ô∏è Campo desconto n√£o encontrado');
                }
                
                console.log('üéØ MODO MESTRE - Inicializa√ß√£o COMPLETAMENTE finalizada!');
            }, 300);
            
        }, 100);
    }, 500);
});

// FUN√á√ïES DE C√ÅLCULO ESSENCIAIS
function calcularTotaisGerais() {
    console.log('üí∞ Calculando totais gerais...');
    
    var totalProdutos = 0;
    var totalServicos = 0;
    
    // Calcular total de produtos
    var produtosTotais = document.querySelectorAll('input[name="produto_total[]"]');
    produtosTotais.forEach(function(input) {
        var valor = obterValorNumerico(input.value);
        totalProdutos += valor;
    });
    
    // Calcular total de servi√ßos
    var servicosTotais = document.querySelectorAll('input[name="servico_total[]"]');
    servicosTotais.forEach(function(input) {
        var valor = obterValorNumerico(input.value);
        totalServicos += valor;
    });
    
    // Atualizar displays de subtotais
    var subtotalProdutos = document.getElementById('subtotal-produtos-display');
    var subtotalServicos = document.getElementById('subtotal-servicos-display');
    
    if (subtotalProdutos) {
        subtotalProdutos.textContent = 'R$ ' + totalProdutos.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    if (subtotalServicos) {
        subtotalServicos.textContent = 'R$ ' + totalServicos.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Atualizar campos vis√≠veis com formata√ß√£o brasileira
    var valorProdutosInput = document.getElementById('valor_produtos');
    var valorServicosInput = document.getElementById('valor_servicos');
    
    if (valorProdutosInput) {
        valorProdutosInput.value = 'R$ ' + totalProdutos.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    if (valorServicosInput) {
        valorServicosInput.value = 'R$ ' + totalServicos.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Calcular desconto e valor final
    var descontoInput = document.getElementById('desconto');
    var desconto = parseFloat(descontoInput ? descontoInput.value : 0) || 0;
    
    var subtotal = totalProdutos + totalServicos;
    var valorDesconto = subtotal * (desconto / 100);
    var valorFinal = subtotal - valorDesconto;
    
    console.log(`üí∏ C√°lculo desconto: ${subtotal.toFixed(2)} - ${desconto}% (R$ ${valorDesconto.toFixed(2)}) = R$ ${valorFinal.toFixed(2)}`);
    
    // Atualizar valor total
    var valorTotalInput = document.getElementById('valor_total');
    if (valorTotalInput) {
        valorTotalInput.value = 'R$ ' + valorFinal.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    console.log('üìä Totais calculados:', {
        produtos: totalProdutos,
        servicos: totalServicos,
        desconto: desconto + '%',
        final: valorFinal
    });
}

// Fun√ß√£o para extrair valor num√©rico de string monet√°ria
function obterValorNumerico(valor) {
    if (!valor) return 0;
    
    // Remove R$, espa√ßos e substitui v√≠rgula por ponto
    var numeroLimpo = valor.toString()
        .replace('R$', '')
        .replace(/\s/g, '')
        .replace(/\./g, '')  // Remove pontos (milhares)
        .replace(',', '.');   // Substitui v√≠rgula por ponto
    
    return parseFloat(numeroLimpo) || 0;
}

// Fun√ß√£o para aplicar m√°scara monet√°ria
function aplicarMascaraMonetaria(input) {
    // PROTE√á√ÉO: N√£o aplicar m√°scara durante carregamento de dados existentes
    if (window.carregandoDadosExistentes) {
        console.log('üîí M√°scara bloqueada - carregando dados existentes');
        return;
    }
    
    var valor = input.value.replace(/\D/g, '');
    
    if (valor === '') {
        input.value = '';
        return;
    }
    
    // Converte para n√∫mero e divide por 100 para ter casas decimais
    valor = parseInt(valor) / 100;
    
    // Aplica formata√ß√£o brasileira
    input.value = 'R$ ' + valor.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Fun√ß√£o para calcular total de um servi√ßo espec√≠fico
function calcularTotalServico(id) {
    // PROTE√á√ÉO: N√£o calcular durante carregamento de dados existentes
    if (window.carregandoDadosExistentes) {
        console.log('üîí C√°lculo bloqueado - carregando dados existentes');
        return;
    }
    
    console.log('üßÆ Calculando total do servi√ßo:', id);
    
    var servico = document.getElementById('servico-' + id);
    if (!servico) {
        console.error('‚ùå Servi√ßo n√£o encontrado:', id);
        return;
    }
    
    var quantidadeInput = servico.querySelector('input[name="servico_horas[]"]');
    var valorInput = servico.querySelector('input[name="servico_valor[]"]');
    var totalInput = servico.querySelector('input[name="servico_total[]"]');
    
    if (quantidadeInput && valorInput && totalInput) {
        var quantidade = parseFloat(quantidadeInput.value) || 0;
        var valorUnitario = obterValorNumerico(valorInput.value);
        var total = quantidade * valorUnitario;
        
        totalInput.value = 'R$ ' + total.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        
        console.log(`üìä Servi√ßo ${id}: ${quantidade} √ó R$ ${valorUnitario.toFixed(2)} = R$ ${total.toFixed(2)}`);
        
        // Recalcular totais gerais
        calcularTotaisGerais();
    }
}

// Fun√ß√£o para calcular total de um produto espec√≠fico
function calcularTotalProduto(id) {
    // PROTE√á√ÉO: N√£o calcular durante carregamento de dados existentes
    if (window.carregandoDadosExistentes) {
        console.log('üîí C√°lculo bloqueado - carregando dados existentes');
        return;
    }
    
    console.log('üßÆ Calculando total do produto:', id);
    
    var produto = document.getElementById('produto-' + id);
    if (!produto) {
        console.error('‚ùå Produto n√£o encontrado:', id);
        return;
    }
    
    var quantidadeInput = produto.querySelector('input[name="produto_quantidade[]"]');
    var valorInput = produto.querySelector('input[name="produto_valor[]"]');
    var totalInput = produto.querySelector('input[name="produto_total[]"]');
    
    if (quantidadeInput && valorInput && totalInput) {
        var quantidade = parseFloat(quantidadeInput.value) || 0;
        var valorUnitario = obterValorNumerico(valorInput.value);
        var total = quantidade * valorUnitario;
        
        totalInput.value = 'R$ ' + total.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        
        console.log(`üìä Produto ${id}: ${quantidade} √ó R$ ${valorUnitario.toFixed(2)} = R$ ${total.toFixed(2)}`);
        
        // Recalcular totais gerais
        calcularTotaisGerais();
    }
}

console.log('üéØ MODO MESTRE - Script carregado com sucesso!');
</script>

{% endblock %}
