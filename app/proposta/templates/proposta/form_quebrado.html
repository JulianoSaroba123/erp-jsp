{% extends "base.html" %}

{% block title %}{% if proposta and proposta.id %}Editar{% else %}Nova{% endif %} Proposta - ERP JSP{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="h3 mb-0">
                        <i class="fas fa-file-contract text-primary me-2"></i>
                        {{ 'Editar Proposta' if proposta and proposta.id else 'Nova Proposta' }}
                    </h2>
                    {% if proposta and proposta.id %}
                        <p class="text-muted mb-0">
                            <strong>{{ proposta.codigo or proposta.numero }}</strong> - 
                            <span class="badge bg-{{ proposta.status_cor }} ms-1">{{ proposta.status_formatado }}</span>
                        </p>
                    {% endif %}
                </div>
                <div>
                    <a href="{{ url_for('proposta.listar_propostas') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar
                    </a>
                    {% if proposta and proposta.id %}
                        <a href="{{ url_for('proposta.visualizar_proposta', id=proposta.id) }}" class="btn btn-outline-info">
                            <i class="fas fa-eye me-2"></i>Visualizar
                        </a>
                        <a href="{{ url_for('proposta.gerar_pdf', id=proposta.id) }}" class="btn btn-outline-danger" target="_blank">
                            <i class="fas fa-file-pdf me-2"></i>PDF
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Formulário -->
    <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        <div class="row">
            <!-- Coluna Esquerda -->
            <div class="col-lg-8">
                
                <!-- Dados Básicos -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            Dados Básicos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cliente_id" class="form-label">
                                        <i class="fas fa-user me-1"></i>Cliente *
                                    </label>
                                    <select class="form-select" id="cliente_id" name="cliente_id" required>
                                        <option value="">Selecione o cliente</option>
                                        {% for cliente in clientes %}
                                            <option value="{{ cliente.id }}" 
                                                {{ 'selected' if proposta and proposta.cliente_id == cliente.id else '' }}>
                                                {{ cliente.nome }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div class="invalid-feedback">Cliente é obrigatório.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vendedor_responsavel" class="form-label">
                                        <i class="fas fa-user-tie me-1"></i>Vendedor Responsável
                                    </label>
                                    <input type="text" class="form-control" id="vendedor_responsavel" name="vendedor_responsavel" 
                                           value="{{ (proposta.vendedor if proposta else '') or '' }}" maxlength="100"
                                           placeholder="Nome do vendedor responsável">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="titulo" class="form-label">
                                <i class="fas fa-heading me-1"></i>Título *
                            </label>
                            <input type="text" class="form-control" id="titulo" name="titulo" 
                                   value="{{ (proposta.titulo if proposta else '') or '' }}" maxlength="200" required
                                   placeholder="Título da proposta">
                            <div class="invalid-feedback">Título é obrigatório.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="descricao" class="form-label">
                                <i class="fas fa-align-left me-1"></i>Descrição
                            </label>
                            <textarea class="form-control" id="descricao" name="descricao" rows="3" 
                                      placeholder="Descrição detalhada da proposta">{{ (proposta.descricao if proposta else '') or '' }}</textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="status" class="form-label">
                                        <i class="fas fa-flag me-1"></i>Status
                                    </label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="Pendente" {{ 'selected' if not proposta or proposta.status == 'Pendente' else '' }}>Pendente</option>
                                        <option value="Enviada" {{ 'selected' if proposta and proposta.status == 'Enviada' else '' }}>Enviada</option>
                                        <option value="Aprovada" {{ 'selected' if proposta and proposta.status == 'Aprovada' else '' }}>Aprovada</option>
                                        <option value="Rejeitada" {{ 'selected' if proposta and proposta.status == 'Rejeitada' else '' }}>Rejeitada</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="prioridade" class="form-label">
                                        <i class="fas fa-exclamation-circle me-1"></i>Prioridade
                                    </label>
                                    <select class="form-select" id="prioridade" name="prioridade">
                                        <option value="baixa" {{ 'selected' if proposta and proposta.prioridade == 'baixa' else '' }}>Baixa</option>
                                        <option value="normal" {{ 'selected' if not proposta or proposta.prioridade == 'normal' else '' }}>Normal</option>
                                        <option value="alta" {{ 'selected' if proposta and proposta.prioridade == 'alta' else '' }}>Alta</option>
                                        <option value="urgente" {{ 'selected' if proposta and proposta.prioridade == 'urgente' else '' }}>Urgente</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="data_validade" class="form-label">
                                        <i class="fas fa-calendar-times me-1"></i>Validade da Proposta
                                    </label>
                                    <input type="text" class="form-control" id="data_validade" name="data_validade" 
                                           value="{{ proposta.validade if proposta and proposta.validade else '' }}"
                                           placeholder="Ex: 30 dias">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estimativas -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-calculator text-info me-2"></i>
                            Estimativas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="km_estimado" class="form-label">
                                        <i class="fas fa-road me-1"></i>KM Estimado
                                    </label>
                                    <input type="number" class="form-control" id="km_estimado" name="km_estimado" 
                                           value="{{ proposta.km_estimado or '' }}" min="0"
                                           placeholder="Ex: 50">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="tempo_estimado" class="form-label">
                                        <i class="fas fa-clock me-1"></i>Tempo Estimado (horas)
                                    </label>
                                    <input type="number" class="form-control" id="tempo_estimado" name="tempo_estimado" 
                                           value="{{ proposta.tempo_estimado or '' }}" step="0.5" min="0"
                                           placeholder="Ex: 2.5">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="prazo_execucao" class="form-label">
                                        <i class="fas fa-calendar-alt me-1"></i>Prazo Execução (dias)
                                    </label>
                                    <input type="number" class="form-control" id="prazo_execucao" name="prazo_execucao" 
                                           value="{{ proposta.prazo_execucao or '' }}" min="1"
                                           placeholder="Ex: 5">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="garantia" class="form-label">
                                        <i class="fas fa-shield-alt me-1"></i>Garantia
                                    </label>
                                    <input type="text" class="form-control" id="garantia" name="garantia" 
                                           value="{{ proposta.garantia or '' }}"
                                           placeholder="Ex: 12 meses">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observações -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-sticky-note text-warning me-2"></i>
                            Observações
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="observacoes" class="form-label">
                                <i class="fas fa-comment me-1"></i>Observações Gerais
                            </label>
                            <textarea class="form-control" id="observacoes" name="observacoes" rows="4" 
                                      placeholder="Observações, instruções especiais, etc.">{{ proposta.observacoes or '' }}</textarea>
                        </div>
                    </div>
                </div>

                <!-- Produtos -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-box text-warning me-2"></i>
                            Produtos
                        </h5>
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="adicionarProduto()">
                            <i class="fas fa-plus me-1"></i>Adicionar Produto
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Busca Rápida de Produtos -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label">
                                    <i class="fas fa-search me-1"></i>Buscar Produto Cadastrado
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="busca-produto" 
                                       placeholder="Digite o nome ou código do produto..."
                                       autocomplete="off">
                                <div id="resultados-produto" class="dropdown-menu w-100" style="max-height: 300px; overflow-y: auto; z-index: 1050;"></div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="button" class="btn btn-outline-info w-100" onclick="limparBuscaProduto()">
                                    <i class="fas fa-eraser me-1"></i>Limpar
                                </button>
                            </div>
                        </div>
                        
                        <hr class="mb-3">
                        
                        <div id="produtos-container">
                            <!-- Produtos serão adicionados aqui via JavaScript -->
                        </div>
                        
                        <div class="mt-3 p-3 bg-dark border border-warning rounded">
                            <div class="row">
                                <div class="col-6">
                                    <strong class="text-light"><i class="fas fa-box me-1 text-warning"></i>Subtotal Produtos:</strong>
                                </div>
                                <div class="col-6 text-end">
                                    <span id="subtotal-produtos-display" class="fw-bold text-warning fs-5">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Serviços -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-tools text-info me-2"></i>
                            Serviços
                        </h5>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="adicionarServico()">
                            <i class="fas fa-plus me-1"></i>Adicionar Serviço
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="servicos-container">
                            <!-- Serviços serão adicionados aqui via JavaScript -->
                        </div>
                        
                        <div class="mt-3 p-3 bg-dark border border-info rounded">
                            <div class="row">
                                <div class="col-6">
                                    <strong class="text-light"><i class="fas fa-tools me-1 text-info"></i>Subtotal Serviços:</strong>
                                </div>
                                <div class="col-6 text-end">
                                    <span id="subtotal-servicos-display" class="fw-bold text-info fs-5">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Geral -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-calculator text-success me-2"></i>
                            Total Geral
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mt-3 p-3 bg-dark border border-success rounded">
                            <div class="row">
                                <div class="col-6">
                                    <strong class="text-light"><i class="fas fa-dollar-sign me-1 text-success"></i>Subtotal:</strong>
                                </div>
                                <div class="col-6 text-end">
                                    <span id="subtotal-display" class="fw-bold text-success fs-4">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Coluna Direita -->
            <div class="col-lg-4">

                <!-- Valores -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-dollar-sign text-success me-2"></i>
                            Valores
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="valor_servicos" class="form-label">
                                        <i class="fas fa-tools me-1"></i>Valor Serviços
                                    </label>
                                    <input type="text" class="form-control valor-moeda" id="valor_servicos" name="valor_servicos"
                                           value="{{ "%.2f"|format(proposta.valor_servicos|float) if proposta and proposta.valor_servicos else '0.00' }}"
                                           placeholder="0,00">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="valor_produtos" class="form-label">
                                        <i class="fas fa-box me-1"></i>Valor Produtos
                                    </label>
                                    <input type="text" class="form-control valor-moeda" id="valor_produtos" name="valor_produtos"
                                           value="{{ "%.2f"|format(proposta.valor_produtos|float) if proposta and proposta.valor_produtos else '0.00' }}"
                                           placeholder="0,00">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="valor_desconto" class="form-label">
                                        <i class="fas fa-percentage me-1"></i>Desconto
                                    </label>
                                    <input type="text" class="form-control valor-moeda" id="valor_desconto" name="valor_desconto"
                                           value="{{ "%.2f"|format(proposta.desconto|float) if proposta and proposta.desconto else '0.00' }}"
                                           placeholder="0,00">
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="valor_total" class="form-label">
                                        <i class="fas fa-calculator me-1"></i><strong>Valor Total</strong>
                                    </label>
                                    <input type="text" class="form-control fw-bold" id="valor_total" name="valor_total" readonly
                                           value="{{ "%.2f"|format(proposta.valor_total|float) if proposta and proposta.valor_total else '0.00' }}"
                                           style="background-color: #e9ecef; font-size: 1.1em;">
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-outline-primary w-100" onclick="calcularTotal()">
                            <i class="fas fa-calculator me-2"></i>Calcular Total
                        </button>
                    </div>
                </div>

                <!-- Condições de Pagamento -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-credit-card text-info me-2"></i>
                            Condições de Pagamento
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="condicao_pagamento" class="form-label">
                                <i class="fas fa-money-bill me-1"></i>Condição
                            </label>
                            <select class="form-select" id="condicao_pagamento" name="condicao_pagamento" onchange="toggleParcelas()">
                                <option value="a_vista" {{ 'selected' if not proposta or proposta.condicao_pagamento == 'a_vista' else '' }}>À Vista</option>
                                <option value="parcelado" {{ 'selected' if proposta and proposta.condicao_pagamento == 'parcelado' else '' }}>Parcelado</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="forma_pagamento" class="form-label">
                                <i class="fas fa-wallet me-1"></i>Forma de Pagamento
                            </label>
                            <select class="form-select" id="forma_pagamento" name="forma_pagamento">
                                <option value="">Selecione</option>
                                <option value="dinheiro" {{ 'selected' if proposta and proposta.forma_pagamento == 'dinheiro' else '' }}>Dinheiro</option>
                                <option value="cartao" {{ 'selected' if proposta and proposta.forma_pagamento == 'cartao' else '' }}>Cartão</option>
                                <option value="pix" {{ 'selected' if proposta and proposta.forma_pagamento == 'pix' else '' }}>PIX</option>
                                <option value="transferencia" {{ 'selected' if proposta and proposta.forma_pagamento == 'transferencia' else '' }}>Transferência</option>
                                <option value="boleto" {{ 'selected' if proposta and proposta.forma_pagamento == 'boleto' else '' }}>Boleto</option>
                            </select>
                        </div>

                        <div id="secao-parcelas" style="display: {{ 'block' if proposta and proposta.condicao_pagamento == 'parcelado' else 'none' }};">
                            <div class="mb-3">
                                <label for="numero_parcelas" class="form-label">
                                    <i class="fas fa-list-ol me-1"></i>Número de Parcelas
                                </label>
                                <input type="number" class="form-control" id="numero_parcelas" name="numero_parcelas" 
                                       value="{{ proposta.numero_parcelas or 1 }}" min="1" max="12">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ações -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cog me-2"></i>Ações
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>
                                {{ 'Atualizar' if proposta.id else 'Salvar' }} Proposta
                            </button>
                            
                            {% if proposta.id %}
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Status atual: <span class="badge bg-{{ proposta.status_cor }}">{{ proposta.status_formatado }}</span>
                                    </small>
                                </div>
                            {% endif %}
                            
                            <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='{{ url_for('proposta.listar_propostas') }}'">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </form>
</div>

<style>
/* Estilos para busca de produtos */
#resultados-produto {
    position: absolute;
    z-index: 1050;
    background: #ffffff;
    border: 2px solid #007bff;
    border-radius: 0.5rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 123, 255, 0.25);
    display: none;
    max-height: 300px;
    overflow-y: auto;
}

#resultados-produto.show {
    display: block;
}

#resultados-produto .dropdown-item {
    padding: 1rem;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
    color: #212529;
    background-color: #ffffff;
    transition: all 0.3s ease;
}

#resultados-produto .dropdown-item:hover {
    background-color: #007bff;
    color: #ffffff;
    transform: translateY(-1px);
}

#resultados-produto .dropdown-item:last-child {
    border-bottom: none;
}

#resultados-produto .dropdown-item .text-muted {
    color: #6c757d !important;
}

#resultados-produto .dropdown-item:hover .text-muted {
    color: rgba(255, 255, 255, 0.8) !important;
}

#resultados-produto .dropdown-item .text-success {
    color: #28a745 !important;
    font-weight: bold;
}

#resultados-produto .dropdown-item:hover .text-success {
    color: #90ee90 !important;
}

.busca-produto-container {
    position: relative;
}

/* Estilos para containers separados */
.item-produto, .item-servico {
    transition: all 0.3s ease;
}

.item-produto {
    border-left: 4px solid #ffc107;
}

.item-servico {
    border-left: 4px solid #17a2b8;
}

.item-produto:hover {
    box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
}

.item-servico:hover {
    box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
}
</style>

<script>
// ========================================
// TESTE SUPER BÁSICO - PROPOSTAS
// ========================================
console.log('🔥 JAVASCRIPT INICIADO!');

function adicionarProduto() {
    console.log('🛒 BOTÃO PRODUTO CLICADO!');
    alert('Botão produto funcionando!');
    return false;
}

function adicionarServico() {
    console.log('🛠️ BOTÃO SERVIÇO CLICADO!');
    alert('Botão serviço funcionando!');
    return false;
}

// Teste imediato
console.log('🧪 Script carregado completamente!');
</script>
{% endblock %}
    
    var container = document.getElementById('produtos-container');
    if (!container) {
        alert('Erro: Container de produtos não encontrado!');
        return;
    }
    
    var novoHTML = 
        '<div class="border rounded p-3 mb-3 item-produto" id="produto-' + contadorProdutos + '">' +
            '<div class="d-flex justify-content-between align-items-center mb-2">' +
                '<h6 class="mb-0"><i class="fas fa-box text-warning me-1"></i>Produto ' + contadorProdutos + '</h6>' +
                '<button type="button" class="btn btn-sm btn-outline-danger" onclick="removerProduto(' + contadorProdutos + ')">' +
                    '<i class="fas fa-trash"></i>' +
                '</button>' +
            '</div>' +
            '<div class="row">' +
                '<div class="col-md-6">' +
                    '<label class="form-label">Descrição</label>' +
                    '<input type="text" class="form-control" name="produto_descricao[]" placeholder="Descrição do produto" required>' +
                '</div>' +
                '<div class="col-md-2">' +
                    '<label class="form-label">Quantidade</label>' +
                    '<input type="number" class="form-control" name="produto_quantidade[]" value="1" min="1" step="0.01" oninput="calcularTotalProduto(' + contadorProdutos + ');" required>' +
                '</div>' +
                '<div class="col-md-2">' +
                    '<label class="form-label">Valor Unit.</label>' +
                    '<input type="text" class="form-control" name="produto_valor[]" placeholder="0,00" oninput="aplicarMascaraMonetaria(this); calcularTotalProduto(' + contadorProdutos + ');" required>' +
                '</div>' +
                '<div class="col-md-2">' +
                    '<label class="form-label">Total</label>' +
                    '<input type="text" class="form-control" name="produto_total[]" value="R$ 0,00" readonly>' +
                '</div>' +
            '</div>' +
        '</div>';
    
    container.insertAdjacentHTML('beforeend', novoHTML);
    
    // Adiciona event listeners para cálculo automático
    var novoProduto = document.getElementById('produto-' + contadorProdutos);
    var inputQuantidade = novoProduto.querySelector('input[name="produto_quantidade[]"]');
    var inputValor = novoProduto.querySelector('input[name="produto_valor[]"]');
    
    if (inputQuantidade) {
        inputQuantidade.addEventListener('input', function() {
            calcularTotalProduto(contadorProdutos);
        });
    }
    
    if (inputValor) {
        inputValor.addEventListener('input', function() {
            aplicarMascaraMonetaria(this);
            calcularTotalProduto(contadorProdutos);
        });
    }
    
    console.log('✅ Produto adicionado:', contadorProdutos);
}

function adicionarServico() {
    console.log('🔥 adicionarServico() chamada na proposta!');
    contadorServicos++;
    
    var container = document.getElementById('servicos-container');
    if (!container) {
        alert('Erro: Container de serviços não encontrado!');
        return;
    }
    
    var novoHTML = 
        '<div class="border rounded p-3 mb-3 item-servico" id="servico-' + contadorServicos + '">' +
            '<div class="d-flex justify-content-between align-items-center mb-2">' +
                '<h6 class="mb-0"><i class="fas fa-tools text-info me-1"></i>Serviço ' + contadorServicos + '</h6>' +
                '<button type="button" class="btn btn-sm btn-outline-danger" onclick="removerServico(' + contadorServicos + ')">' +
                    '<i class="fas fa-trash"></i>' +
                '</button>' +
            '</div>' +
            '<div class="row">' +
                '<div class="col-md-6">' +
                    '<label class="form-label">Descrição</label>' +
                    '<input type="text" class="form-control" name="servico_descricao[]" placeholder="Descrição do serviço" required>' +
                '</div>' +
                '<div class="col-md-2">' +
                    '<label class="form-label">Horas/Dias</label>' +
                    '<input type="number" class="form-control" name="servico_horas[]" value="0" step="0.25" min="0" oninput="calcularTotalServico(' + contadorServicos + ');">' +
                '</div>' +
                '<div class="col-md-2">' +
                    '<label class="form-label">Valor</label>' +
                    '<input type="text" class="form-control" name="servico_valor[]" placeholder="0,00" oninput="aplicarMascaraMonetaria(this); calcularTotalServico(' + contadorServicos + ');" required>' +
                '</div>' +
                '<div class="col-md-2">' +
                    '<label class="form-label">Total</label>' +
                    '<input type="text" class="form-control" name="servico_total[]" value="R$ 0,00" readonly>' +
                '</div>' +
            '</div>' +
        '</div>';
    
    container.insertAdjacentHTML('beforeend', novoHTML);
    
    // Adiciona event listeners para cálculo automático
    var novoServico = document.getElementById('servico-' + contadorServicos);
    var inputHoras = novoServico.querySelector('input[name="servico_horas[]"]');
    var inputValor = novoServico.querySelector('input[name="servico_valor[]"]');
    
    if (inputHoras) {
        inputHoras.addEventListener('input', function() {
            calcularTotalServico(contadorServicos);
        });
    }
    
    if (inputValor) {
        inputValor.addEventListener('input', function() {
            aplicarMascaraMonetaria(this);
            calcularTotalServico(contadorServicos);
        });
    }
    
    console.log('✅ Serviço adicionado:', contadorServicos);
}

function removerProduto(id) {
    var elemento = document.getElementById('produto-' + id);
    if (elemento) {
        elemento.remove();
        calcularTotaisGerais();
        console.log('✅ Produto removido:', id);
    }
}

function removerServico(id) {
    var elemento = document.getElementById('servico-' + id);
    if (elemento) {
        elemento.remove();
        calcularTotaisGerais();
        console.log('✅ Serviço removido:', id);
    }
}

// ========================================
// FUNÇÕES DE CÁLCULO E FORMATAÇÃO
// ========================================

function calcularTotalProduto(id) {
    console.log('💰 Calculando total do produto:', id);
    
    var produto = document.getElementById('produto-' + id);
    if (!produto) {
        console.error('❌ Produto não encontrado:', 'produto-' + id);
        return;
    }
    
    var inputQuantidade = produto.querySelector('input[name="produto_quantidade[]"]');
    var inputValor = produto.querySelector('input[name="produto_valor[]"]');
    var inputTotal = produto.querySelector('input[name="produto_total[]"]');
    
    console.log('🔍 Elementos encontrados:');
    console.log('- Quantidade:', !!inputQuantidade, inputQuantidade ? inputQuantidade.value : 'null');
    console.log('- Valor:', !!inputValor, inputValor ? inputValor.value : 'null');
    console.log('- Total:', !!inputTotal);
    
    if (inputQuantidade && inputValor && inputTotal) {
        var quantidade = parseFloat(inputQuantidade.value) || 0;
        var valor = parseMoney(inputValor.value) || 0;
        var total = quantidade * valor;
        
        inputTotal.value = formatMoney(total);
        console.log('📊 Produto', id, '- Qtd:', quantidade, 'Valor:', valor, 'Total:', total);
        
        calcularTotaisGerais();
    } else {
        console.error('❌ Alguns elementos não foram encontrados para produto', id);
    }
}

function calcularTotalServico(id) {
    console.log('💰 CALCULANDO SERVIÇO:', id);
    
    var servico = document.getElementById('servico-' + id);
    if (!servico) {
        console.error('❌ Serviço não encontrado:', 'servico-' + id);
        return;
    }
    
    var inputHoras = servico.querySelector('input[name="servico_horas[]"]');
    var inputValor = servico.querySelector('input[name="servico_valor[]"]');
    var inputTotal = servico.querySelector('input[name="servico_total[]"]');
    
    if (inputHoras && inputValor && inputTotal) {
        var horas = parseFloat(inputHoras.value) || 0;
        var valorStr = inputValor.value || '';
        var valor = parseMoney(valorStr);
        var total = horas * valor;
        
        console.log('🧮 CÁLCULO DIRETO:');
        console.log('- ID:', id);
        console.log('- Horas input value:', inputHoras.value, '→', horas);
        console.log('- Valor input value:', inputValor.value, '→', valor);
        console.log('- Multiplicação:', horas, '*', valor, '=', total);
        
        inputTotal.value = formatMoney(total);
        console.log('✅ Total definido:', inputTotal.value);
        
        calcularTotaisGerais();
    } else {
        console.error('❌ Inputs não encontrados:', {
            horas: !!inputHoras,
            valor: !!inputValor, 
            total: !!inputTotal
        });
    }
}

function calcularTotaisGerais() {
    console.log('🧮 Calculando totais gerais...');
    
    var totalProdutos = 0;
    var totalServicos = 0;
    
    // Soma produtos
    var produtosTotais = document.querySelectorAll('input[name="produto_total[]"]');
    produtosTotais.forEach(function(input) {
        var valor = parseMoney(input.value) || 0;
        totalProdutos += valor;
        console.log('📦 Produto total:', input.value, '→', valor);
    });
    
    // Soma serviços  
    var servicosTotais = document.querySelectorAll('input[name="servico_total[]"]');
    servicosTotais.forEach(function(input) {
        var valor = parseMoney(input.value) || 0;
        totalServicos += valor;
        console.log('🛠️ Serviço total:', input.value, '→', valor);
    });
    
    var subtotal = totalProdutos + totalServicos;
    
    console.log('💯 TOTAIS CALCULADOS:');
    console.log('- Produtos: R$', totalProdutos.toFixed(2));
    console.log('- Serviços: R$', totalServicos.toFixed(2));
    console.log('- Subtotal: R$', subtotal.toFixed(2));
    
    // ATUALIZA OS CAMPOS DA SEÇÃO VALORES
    var campoValorProdutos = document.getElementById('valor_produtos');
    var campoValorServicos = document.getElementById('valor_servicos');
    var campoValorTotal = document.getElementById('valor_total');
    
    if (campoValorProdutos) {
        campoValorProdutos.value = totalProdutos.toFixed(2);
        console.log('✅ Campo valor_produtos atualizado:', totalProdutos.toFixed(2));
    }
    
    if (campoValorServicos) {
        campoValorServicos.value = totalServicos.toFixed(2);
        console.log('✅ Campo valor_servicos atualizado:', totalServicos.toFixed(2));
    }
    
    if (campoValorTotal) {
        campoValorTotal.value = 'R$ ' + subtotal.toFixed(2).replace('.', ',');
        console.log('✅ Campo valor_total atualizado:', 'R$ ' + subtotal.toFixed(2).replace('.', ','));
    }
    
    // Atualiza displays visuais (spans) se existirem
    var displayProdutos = document.getElementById('subtotal-produtos-display');
    var displayServicos = document.getElementById('subtotal-servicos-display');
    var displaySubtotal = document.getElementById('subtotal-display');
    
    if (displayProdutos) {
        displayProdutos.textContent = formatMoney(totalProdutos);
    }
    
    if (displayServicos) {
        displayServicos.textContent = formatMoney(totalServicos);
    }
    
    if (displaySubtotal) {
        displaySubtotal.textContent = formatMoney(subtotal);
    }
}
    
    if (campoSubtotal) {
        campoSubtotal.value = formatMoney(subtotal);
    }
    
    if (campoTotal) {
        // Considera desconto se houver
        var desconto = 0;
        var campoDesconto = document.getElementById('desconto') || document.querySelector('input[name="desconto"]');
        if (campoDesconto) {
            desconto = parseMoney(campoDesconto.value) || 0;
        }
        
        var totalFinal = subtotal - desconto;
        campoTotal.value = formatMoney(totalFinal);
        console.log('- Total Final: R$', totalFinal.toFixed(2));
    }
}

function parseMoney(value) {
    if (!value) return 0;
    console.log('🔍 Parsing value:', value);
    
    // Converte para string e remove tudo exceto números, vírgulas e pontos
    var str = String(value);
    var cleaned = str.replace(/[^0-9.,]/g, '');
    console.log('🧹 Cleaned:', cleaned);
    
    // Se tem vírgula, assume formato brasileiro (500,00)
    if (cleaned.includes(',')) {
        // Remove pontos (separadores de milhares) e substitui vírgula por ponto (decimal)
        var numero = cleaned.replace(/\./g, '').replace(',', '.');
    } else {
        // Se não tem vírgula, é número direto
        var numero = cleaned;
    }
    
    var resultado = parseFloat(numero) || 0;
    console.log('💰 Parsed result:', resultado);
    return resultado;
}

function formatMoney(value) {
    if (isNaN(value)) value = 0;
    return 'R$ ' + value.toFixed(2).replace('.', ',');
}

function aplicarMascaraMonetaria(input) {
    // Salva posição do cursor
    var cursorPos = input.selectionStart;
    
    // Remove tudo que não é número
    var value = input.value.replace(/\D/g, '');
    
    if (value === '') {
        input.value = '';
        return;
    }
    
    // Converte para centavos e formata
    value = parseInt(value) || 0;
    value = (value / 100).toFixed(2);
    value = value.replace('.', ',');
    
    // Adiciona separadores de milhares
    value = value.replace(/(\d)(\d{3})(\d{3}),/g, '$1.$2.$3,');
    value = value.replace(/(\d)(\d{3}),/g, '$1.$2,');
    
    input.value = 'R$ ' + value;
    
    // Restaura posição do cursor (aproximada)
    var newPos = Math.min(cursorPos + 1, input.value.length);
    input.setSelectionRange(newPos, newPos);
}

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    console.log('✅ Funções de propostas carregadas!');
    
    // TESTE IMEDIATO DA FUNÇÃO PARSING
    console.log('🧪 TESTANDO PARSEMONEY:');
    console.log('parseMoney("R$ 500,00"):', parseMoney("R$ 500,00"));
    console.log('parseMoney("500,00"):', parseMoney("500,00"));
    console.log('parseMoney("500"):', parseMoney("500"));
    
    // Testa containers
    var containerProdutos = document.getElementById('produtos-container');
    var containerServicos = document.getElementById('servicos-container');
    
    console.log('Containers encontrados:');
    console.log('- Produtos:', !!containerProdutos);
    console.log('- Serviços:', !!containerServicos);
    
    // Testa botões
    var btnProduto = document.querySelector('button[onclick="adicionarProduto()"]');
    var btnServico = document.querySelector('button[onclick="adicionarServico()"]');
    
    console.log('Botões encontrados:');
    console.log('- Botão Produto:', !!btnProduto);
    console.log('- Botão Serviço:', !!btnServico);
    
    // TODO: Carregar dados existentes aqui quando estiver funcionando
    console.log('� Sistema básico funcionando - dados existentes serão carregados na próxima versão');
    
    // Adiciona listeners como backup
    if (btnProduto) {
        btnProduto.addEventListener('click', function(e) {
            console.log('🎯 Click no botão produto detectado via addEventListener!');
            e.preventDefault();
            adicionarProduto();
        }, false);
    }
    
    if (btnServico) {
        btnServico.addEventListener('click', function(e) {
            console.log('🎯 Click no botão serviço detectado via addEventListener!');
            e.preventDefault();
            adicionarServico();
        }, false);
    }
});

console.log('🎉 Script de propostas finalizado!');
</script>
{% endblock %}