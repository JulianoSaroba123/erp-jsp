{% extends "base.html" %}

{% block title %}
{% if proposta %}Editar Proposta {{ proposta.codigo }}{% else %}Nova Proposta{% endif %}
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb bg-transparent mb-0">
        <li class="breadcrumb-item">
            <a href="{{ url_for('painel.dashboard') }}" class="text-decoration-none">
                <i class="fas fa-home"></i> Dashboard
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('proposta.listar_propostas') }}" class="text-decoration-none">
                <i class="fas fa-file-contract"></i> Propostas
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <i class="fas fa-{% if proposta %}edit{% else %}plus{% endif %}"></i>
            {% if proposta %}Editar{% else %}Nova{% endif %}
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<style>
    /* Cores JSP Ciano - Form */
    .card.bg-dark {
        background: #1f2937 !important;
        border: 1px solid #374151 !important;
        border-radius: 12px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .card-header.bg-secondary,
    .card-header.bg-primary,
    .card-header.bg-success,
    .card-header.bg-warning,
    .card-header.bg-info {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%) !important;
        color: white !important;
        border: none !important;
        border-radius: 12px 12px 0 0 !important;
    }
    .card-header h5 {
        color: white !important;
        font-weight: 600 !important;
    }
    .btn-primary {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%) !important;
        border: none !important;
        color: white !important;
    }
    .btn-primary:hover {
        background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%) !important;
        box-shadow: 0 4px 8px rgba(6,182,212,0.3);
    }
    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
        border: none !important;
    }
    .btn-success:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%) !important;
    }
    .text-primary {
        color: #06b6d4 !important;
    }
    label.text-white {
        color: #f3f4f6 !important;
        font-weight: 500 !important;
    }
</style>

<div class="container-fluid">
    <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        
        <!-- INFORMAÇÕES BÁSICAS -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Informações Básicas</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label text-white">Cliente *</label>
                        <div class="input-group">
                            <select class="form-select bg-dark text-white border-secondary" name="cliente_id" id="cliente_select" required>
                                <option value="">Selecione um cliente</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}" 
                                        {% if proposta and proposta.cliente_id == cliente.id %}selected{% endif %}>
                                    {{ cliente.nome }}
                                </option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-info btn-sm px-3" type="button" id="btnAtualizarClientes" title="Atualizar lista de clientes">
                                <i class="fas fa-sync-alt me-1"></i>
                            </button>
                            <a href="{{ url_for('cliente.novo') }}" class="btn btn-success btn-sm px-3" title="Cadastrar novo cliente" target="_blank">
                                <i class="fas fa-plus me-1"></i>
                            </a>
                        </div>
                        <small class="text-muted">💡 Cadastrou um cliente novo? Clique no botão ↻ para atualizar a lista</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white">Título *</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               name="titulo" value="{{ proposta.titulo if proposta else '' }}" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Vendedor</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               name="vendedor" value="{{ proposta.vendedor if proposta else '' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Data Emissão</label>
                        <input type="date" class="form-control bg-dark text-white border-secondary" 
                               name="data_emissao" value="{{ proposta.data_emissao if proposta else today }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Validade (dias)</label>
                        <input type="number" class="form-control bg-dark text-white border-secondary" 
                               name="validade" value="{{ proposta.validade if proposta else 30 }}" min="1">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Status</label>
                        <select class="form-select bg-dark text-white border-secondary" name="status">
                            <option value="pendente" {% if not proposta or proposta.status == 'pendente' %}selected{% endif %}>Pendente</option>
                            <option value="aprovada" {% if proposta and proposta.status == 'aprovada' %}selected{% endif %}>Aprovada</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label text-white">Descrição</label>
                        <textarea class="form-control bg-dark text-white border-secondary" name="descricao" rows="3">{{ proposta.descricao if proposta else '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- SERVIÇOS -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-wrench"></i> Serviços</h5>
                <button type="button" class="btn btn-success btn-sm px-3" id="btnAdicionarServico">
                    <i class="fas fa-plus me-2"></i>Adicionar
                </button>
            </div>
            <div class="card-body">
                <!-- Cabeçalho dos campos -->
                <div class="row g-2 mb-2">
                    <div class="col-md-4">
                        <small class="text-muted">Descrição</small>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">Tipo</small>
                    </div>
                    <div class="col-md-1">
                        <small class="text-muted">Qtd</small>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">Valor Unit.</small>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">Total</small>
                    </div>
                    <div class="col-md-1">
                        <small class="text-muted">Ações</small>
                    </div>
                </div>
                
                <div id="servicosContainer">
                    {% if proposta and proposta.itens_servico %}
                        {% for servico in proposta.itens_servico %}
                        <div class="servico-item mb-3">
                            <div class="row g-2 align-items-center">
                                <div class="col-md-4">
                                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                                           name="servico_descricao[]" value="{{ servico.descricao }}" placeholder="Descrição do serviço" required>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select form-select-sm bg-dark text-white border-secondary" name="servico_tipo[]">
                                        <option value="hora" {% if servico.tipo_servico == 'hora' %}selected{% endif %}>Hora</option>
                                        <option value="dia" {% if servico.tipo_servico == 'dia' %}selected{% endif %}>Dia</option>
                                        <option value="fechado" {% if servico.tipo_servico == 'fechado' %}selected{% endif %}>Fechado</option>
                                    </select>
                                </div>
                                <div class="col-md-1">
                                    <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary servico-quantidade" 
                                           name="servico_horas[]" value="{{ servico.quantidade or 1 }}" step="0.25" min="0">
                                </div>
                                <div class="col-md-2">
                                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary servico-valor" 
                                           name="servico_valor[]" value="{{ '{:.2f}'.format(servico.valor_unitario or 0).replace('.', ',') }}" placeholder="0,00">
                                </div>
                                <div class="col-md-2">
                                    <input type="text" class="form-control form-control-sm bg-secondary text-white servico-total" 
                                           readonly value="R$ {{ '{:.2f}'.format((servico.quantidade or 0) * (servico.valor_unitario or 0)).replace('.', ',') }}">
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-outline-danger btn-sm w-100 btn-remover-servico">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- PRODUTOS -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-box"></i> Produtos</h5>
                <button type="button" class="btn btn-success btn-sm" id="btnAdicionarProduto">
                    <i class="fas fa-plus me-1"></i>Adicionar Produto
                </button>
            </div>
            <div class="card-body">
                <!-- Cabeçalho dos campos -->
                <div class="row g-2 mb-2">
                    <div class="col-md-5">
                        <small class="text-muted">Descrição</small>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">Quantidade</small>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">Valor Unit.</small>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">Total</small>
                    </div>
                    <div class="col-md-1">
                        <small class="text-muted">Ações</small>
                    </div>
                </div>
                
                <div id="produtosContainer">
                    {% if proposta and proposta.itens_produto %}
                        {% for produto in proposta.itens_produto %}
                        <div class="produto-item mb-3">
                            <div class="row g-2 align-items-center">
                                <div class="col-md-5">
                                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                                           name="produto_descricao[]" value="{{ produto.descricao }}" placeholder="Descrição do produto" required>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary produto-quantidade" 
                                           name="produto_quantidade[]" value="{{ produto.quantidade or 1 }}" step="1" min="0">
                                </div>
                                <div class="col-md-2">
                                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary produto-valor" 
                                           name="produto_valor[]" value="{{ '{:.2f}'.format(produto.valor_unitario or 0).replace('.', ',') }}" placeholder="0,00">
                                </div>
                                <div class="col-md-2">
                                    <input type="text" class="form-control form-control-sm bg-secondary text-white produto-total" 
                                           readonly value="R$ {{ '{:.2f}'.format((produto.quantidade or 0) * (produto.valor_unitario or 0)).replace('.', ',') }}">
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-outline-danger btn-sm w-100 btn-remover-produto">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- VALORES -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-calculator"></i> Valores</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label text-white">Serviços</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="valorServico" readonly 
                               value="{% if proposta %}R$ {{ '{:.2f}'.format(proposta.valor_servicos or 0).replace('.', ',') }}{% else %}R$ 0,00{% endif %}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Produtos</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="valorProdutos" readonly 
                               value="{% if proposta %}R$ {{ '{:.2f}'.format(proposta.valor_produtos or 0).replace('.', ',') }}{% else %}R$ 0,00{% endif %}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Desconto (%)</label>
                        <input type="number" class="form-control bg-dark text-white border-secondary" 
                               name="desconto" id="valorDesconto" value="{{ proposta.desconto if proposta else 0 }}" 
                               step="0.01" min="0" max="100">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white fw-bold">Total</label>
                        <input type="text" class="form-control bg-primary text-white fw-bold" id="valorTotal" readonly 
                               value="{% if proposta %}R$ {{ '{:.2f}'.format(proposta.valor_total or 0).replace('.', ',') }}{% else %}R$ 0,00{% endif %}">
                    </div>
                </div>
            </div>
        </div>

        <!-- FORMAS DE PAGAMENTO -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-credit-card"></i> Formas de Pagamento</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label text-white">Forma de Pagamento</label>
                        <select class="form-select bg-dark text-white border-secondary" name="forma_pagamento" id="formaPagamento">
                            <option value="">Selecione...</option>
                            <option value="a_vista" {% if proposta and proposta.forma_pagamento == 'a_vista' %}selected{% endif %}>À vista</option>
                            <option value="parcelado" {% if proposta and proposta.forma_pagamento == 'parcelado' %}selected{% endif %}>Parcelado</option>
                            <option value="prazo" {% if proposta and proposta.forma_pagamento == 'prazo' %}selected{% endif %}>A prazo</option>
                            <option value="cartao" {% if proposta and proposta.forma_pagamento == 'cartao' %}selected{% endif %}>Cartão</option>
                            <option value="pix" {% if proposta and proposta.forma_pagamento == 'pix' %}selected{% endif %}>PIX</option>
                            <option value="dinheiro" {% if proposta and proposta.forma_pagamento == 'dinheiro' %}selected{% endif %}>Dinheiro</option>
                            <option value="transferencia" {% if proposta and proposta.forma_pagamento == 'transferencia' %}selected{% endif %}>Transferência</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Entrada (%)</label>
                        <input type="number" class="form-control bg-dark text-white border-secondary" 
                               name="entrada" id="entrada" value="{{ proposta.entrada if proposta else 0 }}" 
                               step="0.01" min="0" max="100" placeholder="0,00">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Prazo de Execução</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               name="prazo_execucao" value="{{ proposta.prazo_execucao if proposta else '' }}" 
                               placeholder="Ex: 15 dias úteis">
                    </div>
                    
                    <!-- CAMPOS DE PARCELAMENTO (aparecem apenas quando forma = parcelado) -->
                    <div id="camposParcelamento" style="display: none;" class="col-12">
                        <div class="card bg-secondary bg-opacity-10 border-info mb-3">
                            <div class="card-header bg-info bg-opacity-25 text-white">
                                <h6 class="mb-0"><i class="fas fa-calendar-alt"></i> Configuração de Parcelamento</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label text-white">Número de Parcelas</label>
                                        <input type="number" class="form-control bg-dark text-white border-secondary" 
                                               name="numero_parcelas" id="numeroParcelas" 
                                               value="{{ proposta.numero_parcelas if proposta and proposta.numero_parcelas else 1 }}" 
                                               min="1" max="120" placeholder="Ex: 12">
                                        <small class="text-muted">Máximo 120 parcelas</small>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label text-white">Intervalo (dias)</label>
                                        <input type="number" class="form-control bg-dark text-white border-secondary" 
                                               name="intervalo_parcelas" id="intervaloParcelas" 
                                               value="{{ proposta.intervalo_parcelas if proposta and proposta.intervalo_parcelas else 30 }}" 
                                               min="1" max="365" placeholder="30">
                                        <small class="text-muted">Dias entre parcelas</small>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label text-white">1ª Parcela</label>
                                        <input type="date" class="form-control bg-dark text-white border-secondary" 
                                               name="data_primeira_parcela" id="dataPrimeiraParcela" 
                                               value="{{ proposta.data_primeira_parcela.strftime('%Y-%m-%d') if proposta and proposta.data_primeira_parcela else '' }}">
                                        <small class="text-muted">Vencimento da 1ª parcela</small>
                                    </div>
                                    <div class="col-md-3">
                                        <button type="button" class="btn btn-info w-100" id="btnVisualizarParcelas" style="margin-top: 31px;">
                                            <i class="fas fa-eye"></i> Visualizar Parcelas
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Preview das Parcelas -->
                                <div id="previewParcelas" class="mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-info-circle"></i> Preview do Parcelamento</h6>
                                        <div id="listaParcelas"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <label class="form-label text-white">Condições de Pagamento</label>
                        <textarea class="form-control bg-dark text-white border-secondary" name="condicoes_pagamento" rows="2" 
                                  placeholder="Descreva as condições específicas de pagamento...">{{ proposta.condicoes_pagamento if proposta else '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- OBSERVAÇÕES -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-sticky-note"></i> Observações e Informações Adicionais</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label text-white">Observações Gerais</label>
                        <textarea class="form-control bg-dark text-white border-secondary" name="observacoes" rows="4" 
                                  placeholder="Observações gerais da proposta...">{{ proposta.observacoes if proposta else '' }}</textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-white">Tempo Estimado</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               name="tempo_estimado" value="{{ proposta.tempo_estimado if proposta else '' }}" 
                               placeholder="Ex: 2 horas, 1 dia">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-white">KM Estimado</label>
                        <input type="number" class="form-control bg-dark text-white border-secondary" 
                               name="km_estimado" value="{{ proposta.km_estimado if proposta else '' }}" 
                               step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-white">Prioridade</label>
                        <select class="form-select bg-dark text-white border-secondary" name="prioridade">
                            <option value="baixa" {% if proposta and proposta.prioridade == 'baixa' %}selected{% endif %}>Baixa</option>
                            <option value="normal" {% if not proposta or proposta.prioridade == 'normal' %}selected{% endif %}>Normal</option>
                            <option value="alta" {% if proposta and proposta.prioridade == 'alta' %}selected{% endif %}>Alta</option>
                            <option value="urgente" {% if proposta and proposta.prioridade == 'urgente' %}selected{% endif %}>Urgente</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label text-white">Garantia</label>
                        <textarea class="form-control bg-dark text-white border-secondary" name="garantia" rows="3" 
                                  placeholder="Ex: Todos os serviços executados serão garantidos pelo período de 90 dias...">{{ proposta.garantia if proposta else '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- BOTÕES -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-8">
                        <button type="submit" class="btn btn-success btn-lg w-100">
                            <i class="fas fa-save me-2"></i>{% if proposta %}Atualizar{% else %}Criar{% endif %} Proposta
                        </button>
                    </div>
                    <div class="col-md-4">
                        <a href="{{ url_for('proposta.listar_propostas') }}" class="btn btn-outline-secondary btn-lg w-100">
                            <i class="fas fa-arrow-left me-2"></i>Cancelar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
console.log('🚀 Sistema de Proposta inicializado!');

document.addEventListener('DOMContentLoaded', function() {
    let servicoIndex = {{ (proposta.itens_servico|length) if proposta and proposta.itens_servico else 0 }};
    let produtoIndex = {{ (proposta.itens_produto|length) if proposta and proposta.itens_produto else 0 }};
    
    console.log('Índices iniciais:', { servicoIndex, produtoIndex });
    
    // Função para converter valor monetário para número
    function converterParaNumero(valor) {
        if (!valor) return 0;
        // Remove R$, espaços e pontos de milhar, depois troca vírgula por ponto
        let limpo = valor.toString()
            .replace('R$', '')
            .replace(/\s/g, '')
            .replace(/\./g, '')  // Remove pontos de milhar
            .replace(',', '.');   // Troca vírgula decimal por ponto
        return parseFloat(limpo) || 0;
    }
    
    // Função para formatar número para moeda brasileira
    function formatarMoeda(valor) {
        return 'R$ ' + parseFloat(valor).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
    
    // Função para calcular total de um item
    function calcularTotalItem(container) {
        const quantidade = container.querySelector('.servico-quantidade, .produto-quantidade');
        const valor = container.querySelector('.servico-valor, .produto-valor');
        const total = container.querySelector('.servico-total, .produto-total');
        
        if (quantidade && valor && total) {
            const qtd = converterParaNumero(quantidade.value);
            const vlr = converterParaNumero(valor.value);
            const totalCalculado = qtd * vlr;
            total.value = formatarMoeda(totalCalculado);
            console.log(`Calculado: ${qtd} x ${vlr} = ${totalCalculado}`);
        }
        
        calcularTotaisGerais();
    }
    
    // Função para calcular totais gerais
    function calcularTotaisGerais() {
        let totalServicos = 0;
        let totalProdutos = 0;
        
        // Somar serviços
        document.querySelectorAll('.servico-total').forEach(function(campo) {
            totalServicos += converterParaNumero(campo.value);
        });
        
        // Somar produtos
        document.querySelectorAll('.produto-total').forEach(function(campo) {
            totalProdutos += converterParaNumero(campo.value);
        });
        
        // Calcular desconto
        const desconto = converterParaNumero(document.getElementById('valorDesconto').value);
        const subtotal = totalServicos + totalProdutos;
        const valorDesconto = subtotal * (desconto / 100);
        const total = subtotal - valorDesconto;
        
        // Atualizar campos
        document.getElementById('valorServico').value = formatarMoeda(totalServicos);
        document.getElementById('valorProdutos').value = formatarMoeda(totalProdutos);
        document.getElementById('valorTotal').value = formatarMoeda(total);
        
        console.log('Totais calculados:', { totalServicos, totalProdutos, desconto, total });
    }
    
    // Adicionar Serviço
    document.getElementById('btnAdicionarServico').addEventListener('click', function() {
        console.log('Adicionando serviço...');
        
        const container = document.getElementById('servicosContainer');
        const div = document.createElement('div');
        div.className = 'servico-item mb-3';
        div.innerHTML = `
            <div class="row g-2 align-items-center">
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                           name="servico_descricao[]" placeholder="Descrição do serviço" required>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm bg-dark text-white border-secondary" name="servico_tipo[]">
                        <option value="hora">Hora</option>
                        <option value="dia">Dia</option>
                        <option value="fechado">Fechado</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary servico-quantidade" 
                           name="servico_horas[]" value="1" step="0.25" min="0">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary servico-valor" 
                           name="servico_valor[]" placeholder="0,00">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm bg-secondary text-white servico-total" 
                           readonly value="R$ 0,00">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm w-100 btn-remover-servico">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(div);
        servicoIndex++;
        console.log('Serviço adicionado! Total:', servicoIndex);
        
        // Adicionar eventos aos novos campos
        const novoItem = div;
        const qtdField = novoItem.querySelector('.servico-quantidade');
        const valorField = novoItem.querySelector('.servico-valor');
        
        qtdField.addEventListener('input', function() {
            calcularTotalItem(novoItem);
        });
        
        valorField.addEventListener('input', function() {
            calcularTotalItem(novoItem);
        });
    });
    
    // Adicionar Produto
    document.getElementById('btnAdicionarProduto').addEventListener('click', function() {
        console.log('Adicionando produto...');
        
        const container = document.getElementById('produtosContainer');
        const div = document.createElement('div');
        div.className = 'produto-item mb-3';
        div.innerHTML = `
            <div class="row g-2 align-items-center">
                <div class="col-md-5">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                           name="produto_descricao[]" placeholder="Descrição do produto" required>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary produto-quantidade" 
                           name="produto_quantidade[]" value="1" step="1" min="0">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary produto-valor" 
                           name="produto_valor[]" placeholder="0,00">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm bg-secondary text-white produto-total" 
                           readonly value="R$ 0,00">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm w-100 btn-remover-produto">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(div);
        produtoIndex++;
        console.log('Produto adicionado! Total:', produtoIndex);
        
        // Adicionar eventos aos novos campos
        const novoItem = div;
        const qtdField = novoItem.querySelector('.produto-quantidade');
        const valorField = novoItem.querySelector('.produto-valor');
        
        qtdField.addEventListener('input', function() {
            calcularTotalItem(novoItem);
        });
        
        valorField.addEventListener('input', function() {
            calcularTotalItem(novoItem);
        });
    });
    
    // Remover itens
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-remover-servico')) {
            if (confirm('Remover este serviço?')) {
                e.target.closest('.servico-item').remove();
                calcularTotaisGerais();
                console.log('Serviço removido');
            }
        }
        
        if (e.target.closest('.btn-remover-produto')) {
            if (confirm('Remover este produto?')) {
                e.target.closest('.produto-item').remove();
                calcularTotaisGerais();
                console.log('Produto removido');
            }
        }
    });
    
    // Adicionar eventos aos campos existentes
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('servico-quantidade') || 
            e.target.classList.contains('servico-valor') ||
            e.target.classList.contains('produto-quantidade') || 
            e.target.classList.contains('produto-valor')) {
            calcularTotalItem(e.target.closest('.servico-item, .produto-item'));
        }
        
        if (e.target.id === 'valorDesconto') {
            calcularTotaisGerais();
        }
    });
    
    // Calcular totais iniciais
    setTimeout(function() {
        calcularTotaisGerais();
    }, 100);
    
    console.log('✅ Sistema completo inicializado com cálculos!');
    
    // ===== FUNCIONALIDADE ATUALIZAR CLIENTES =====
    
    async function atualizarListaClientes() {
        const btnAtualizar = document.getElementById('btnAtualizarClientes');
        const selectCliente = document.getElementById('cliente_select');
        const clienteSelecionadoId = selectCliente.value;
        
        try {
            // Mostrar loading
            btnAtualizar.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btnAtualizar.disabled = true;
            
            // Buscar clientes atualizados
            const response = await fetch('/propostas/api/clientes');
            const data = await response.json();
            
            if (data.success) {
                // Limpar select
                selectCliente.innerHTML = '<option value="">Selecione um cliente</option>';
                
                // Adicionar clientes atualizados
                data.clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nome;
                    
                    // Manter seleção anterior se ainda existir
                    if (clienteSelecionadoId && cliente.id == clienteSelecionadoId) {
                        option.selected = true;
                    }
                    
                    selectCliente.appendChild(option);
                });
                
                // Feedback visual
                btnAtualizar.classList.add('btn-outline-success');
                btnAtualizar.classList.remove('btn-outline-info');
                setTimeout(() => {
                    btnAtualizar.classList.remove('btn-outline-success');
                    btnAtualizar.classList.add('btn-outline-info');
                }, 2000);
                
                console.log(`✅ Lista atualizada: ${data.total} clientes encontrados`);
                
                // Mostrar notificação
                if (data.total > 0) {
                    showToast(`Lista atualizada! ${data.total} clientes disponíveis`, 'success');
                } else {
                    showToast('Nenhum cliente ativo encontrado', 'warning');
                }
                
            } else {
                throw new Error(data.error || 'Erro desconhecido');
            }
            
        } catch (error) {
            console.error('❌ Erro ao atualizar clientes:', error);
            showToast('Erro ao atualizar lista de clientes', 'error');
            
            btnAtualizar.classList.add('btn-outline-danger');
            btnAtualizar.classList.remove('btn-outline-info');
            setTimeout(() => {
                btnAtualizar.classList.remove('btn-outline-danger');
                btnAtualizar.classList.add('btn-outline-info');
            }, 3000);
            
        } finally {
            // Restaurar botão
            btnAtualizar.innerHTML = '<i class="fas fa-sync-alt"></i>';
            btnAtualizar.disabled = false;
        }
    }
    
    function showToast(message, type = 'info') {
        // Criar toast simples
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'warning'} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;
        
        document.body.appendChild(toast);
        
        // Auto remover após 5 segundos
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }
    
    // Event listener para o botão atualizar
    document.getElementById('btnAtualizarClientes').addEventListener('click', atualizarListaClientes);
    
    console.log('✅ Funcionalidade de atualização de clientes carregada!');
    
    // ===== FUNCIONALIDADE DE PARCELAMENTO =====
    
    console.log('🔧 Inicializando funcionalidade de parcelamento...');
    
    const formaPagamento = document.getElementById('formaPagamento');
    const camposParcelamento = document.getElementById('camposParcelamento');
    const btnVisualizarParcelas = document.getElementById('btnVisualizarParcelas');
    const previewParcelas = document.getElementById('previewParcelas');
    const listaParcelas = document.getElementById('listaParcelas');
    
    console.log('Elementos encontrados:', {
        formaPagamento: !!formaPagamento,
        camposParcelamento: !!camposParcelamento,
        btnVisualizarParcelas: !!btnVisualizarParcelas,
        previewParcelas: !!previewParcelas,
        listaParcelas: !!listaParcelas
    });
    
    // Mostrar/ocultar campos de parcelamento
    function toggleCamposParcelamento() {
        if (formaPagamento && formaPagamento.value === 'parcelado') {
            if (camposParcelamento) camposParcelamento.style.display = 'block';
            console.log('✅ Campos de parcelamento exibidos');
        } else {
            if (camposParcelamento) camposParcelamento.style.display = 'none';
            // NÃO esconde o preview se usuário já calculou as parcelas
            // if (previewParcelas) previewParcelas.style.display = 'none';
            console.log('❌ Campos de parcelamento ocultados (preview mantido)');
        }
    }
    
    // Calcular e exibir preview das parcelas
    function calcularParcelas() {
        console.log('🔢 Calculando parcelas...');
        
        // Pega o valor total do campo
        const valorTotalInput = document.getElementById('valorTotal');
        if (!valorTotalInput) {
            console.error('❌ Campo valorTotal não encontrado!');
            alert('Erro: Campo de valor total não encontrado');
            return;
        }
        
        console.log('Valor Total Input:', valorTotalInput.value);
        
        const valorTotal = parseFloat(valorTotalInput.value.replace('R$ ', '').replace(/\./g, '').replace(',', '.')) || 0;
        const entrada = parseFloat(document.getElementById('entrada').value) || 0;
        const numeroParcelas = parseInt(document.getElementById('numeroParcelas').value) || 1;
        const intervalo = parseInt(document.getElementById('intervaloParcelas').value) || 30;
        const dataPrimeira = document.getElementById('dataPrimeiraParcela').value;
        
        console.log('Dados:', { valorTotal, entrada, numeroParcelas, intervalo, dataPrimeira });
        
        if (valorTotal <= 0) {
            console.warn('⚠️ Valor total é zero ou negativo');
            alert('Por favor, preencha os produtos/serviços primeiro para calcular o valor total');
            return;
        }
        
        if (!dataPrimeira) {
            console.warn('⚠️ Data da primeira parcela não informada');
            alert('Por favor, informe a data da primeira parcela');
            return;
        }
        
        // Calcula valores
        const valorEntrada = valorTotal * (entrada / 100);
        const valorRestante = valorTotal - valorEntrada;
        const valorParcela = valorRestante / numeroParcelas;
        
        // Monta HTML das parcelas
        let html = '<div class="table-responsive"><table class="table table-sm table-dark table-striped">';
        html += '<thead><tr><th>Parcela</th><th>Vencimento</th><th>Valor</th></tr></thead><tbody>';
        
        // Entrada
        if (valorEntrada > 0) {
            html += `<tr class="table-info">
                <td><strong>Entrada</strong></td>
                <td>${formatarData(dataPrimeira)}</td>
                <td><strong>R$ ${valorEntrada.toFixed(2).replace('.', ',')}</strong></td>
            </tr>`;
        }
        
        // Parcelas
        const dataBase = new Date(dataPrimeira + 'T00:00:00');
        let totalParcelas = valorEntrada;
        
        for (let i = 1; i <= numeroParcelas; i++) {
            // Calcula data de vencimento
            const dataVenc = new Date(dataBase);
            dataVenc.setDate(dataVenc.getDate() + (intervalo * i));
            
            // Ajusta última parcela para fechar valores
            let valorAtual = valorParcela;
            if (i === numeroParcelas) {
                valorAtual = valorTotal - totalParcelas;
            }
            totalParcelas += valorAtual;
            
            html += `<tr>
                <td>Parcela ${i}/${numeroParcelas}</td>
                <td>${formatarData(dataVenc.toISOString().split('T')[0])}</td>
                <td>R$ ${valorAtual.toFixed(2).replace('.', ',')}</td>
            </tr>`;
        }
        
        html += `<tr class="table-success">
            <td colspan="2"><strong>TOTAL</strong></td>
            <td><strong>R$ ${valorTotal.toFixed(2).replace('.', ',')}</strong></td>
        </tr>`;
        html += '</tbody></table></div>';
        
        // Resumo
        html += `<div class="mt-2">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i> 
                Entrada de <strong>R$ ${valorEntrada.toFixed(2).replace('.', ',')}</strong> + 
                ${numeroParcelas}x de <strong>R$ ${valorParcela.toFixed(2).replace('.', ',')}</strong> 
                (intervalo de ${intervalo} dias)
            </small>
        </div>`;
        
        console.log('📋 Preview gerado, exibindo...');
        listaParcelas.innerHTML = html;
        previewParcelas.style.setProperty('display', 'block', 'important');
        previewParcelas.setAttribute('data-keep-visible', 'true');
        console.log('✅ Parcelas calculadas e exibidas!');
        
        // Força scroll suave até o preview
        setTimeout(() => {
            previewParcelas.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
    }
    
    // Formatar data para exibição
    function formatarData(dataStr) {
        const data = new Date(dataStr + 'T00:00:00');
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const ano = data.getFullYear();
        return `${dia}/${mes}/${ano}`;
    }
    
    // Event listeners (com verificação se elementos existem)
    if (formaPagamento) {
        formaPagamento.addEventListener('change', toggleCamposParcelamento);
        console.log('✅ Event listener adicionado em formaPagamento');
    } else {
        console.warn('⚠️ formaPagamento não encontrado');
    }
    
    if (btnVisualizarParcelas) {
        btnVisualizarParcelas.addEventListener('click', function(event) {
            event.preventDefault(); // Previne submit do formulário
            event.stopPropagation(); // Previne propagação do evento
            console.log('🖱️ Botão Visualizar Parcelas clicado!');
            calcularParcelas();
            return false; // Segurança adicional
        });
        console.log('✅ Event listener adicionado em btnVisualizarParcelas');
    } else {
        console.warn('⚠️ btnVisualizarParcelas não encontrado');
    }
    
    // Inicializa no carregamento
    toggleCamposParcelamento();
    
    console.log('✅ Funcionalidade de parcelamento carregada!');
});
</script>
{% endblock %}