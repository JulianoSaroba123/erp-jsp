{% extends "base.html" %}

{% block title %}
{% if proposta %}Editar Proposta {{ proposta.codigo }}{% else %}Nova Proposta{% endif %}
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb bg-transparent mb-0">
        <li class="breadcrumb-item">
            <a href="{{ url_for('painel.dashboard') }}" class="text-decoration-none">
                <i class="fas fa-home"></i> Dashboard
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('proposta.listar_propostas') }}" class="text-decoration-none">
                <i class="fas fa-file-contract"></i> Propostas
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <i class="fas fa-{% if proposta %}edit{% else %}plus{% endif %}"></i>
            {% if proposta %}Editar{% else %}Nova{% endif %}
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        
        <!-- INFORMAÇÕES BÁSICAS -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Informações Básicas</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label text-white">Cliente *</label>
                        <div class="input-group">
                            <select class="form-select bg-dark text-white border-secondary" name="cliente_id" id="cliente_select" required>
                                <option value="">Selecione um cliente</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}" 
                                        {% if proposta and proposta.cliente_id == cliente.id %}selected{% endif %}>
                                    {{ cliente.nome }}
                                </option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-info btn-sm px-3" type="button" id="btnAtualizarClientes" title="Atualizar lista de clientes">
                                <i class="fas fa-sync-alt me-1"></i>
                            </button>
                            <a href="{{ url_for('cliente.novo') }}" class="btn btn-success btn-sm px-3" title="Cadastrar novo cliente" target="_blank">
                                <i class="fas fa-plus me-1"></i>
                            </a>
                        </div>
                        <small class="text-muted">💡 Cadastrou um cliente novo? Clique no botão ↻ para atualizar a lista</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white">Título *</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               name="titulo" value="{{ proposta.titulo if proposta else '' }}" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Vendedor</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               name="vendedor" value="{{ proposta.vendedor if proposta else '' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Data Emissão</label>
                        <input type="date" class="form-control bg-dark text-white border-secondary" 
                               name="data_emissao" value="{{ proposta.data_emissao if proposta else today }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Validade (dias)</label>
                        <input type="number" class="form-control bg-dark text-white border-secondary" 
                               name="validade" value="{{ proposta.validade if proposta else 30 }}" min="1">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Status</label>
                        <select class="form-select bg-dark text-white border-secondary" name="status">
                            <option value="pendente" {% if not proposta or proposta.status == 'pendente' %}selected{% endif %}>Pendente</option>
                            <option value="aprovada" {% if proposta and proposta.status == 'aprovada' %}selected{% endif %}>Aprovada</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label text-white">Descrição</label>
                        <textarea class="form-control bg-dark text-white border-secondary" name="descricao" rows="3">{{ proposta.descricao if proposta else '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- SERVIÇOS -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-wrench"></i> Serviços</h5>
                <button type="button" class="btn btn-success btn-sm px-3" id="btnAdicionarServico">
                    <i class="fas fa-plus me-2"></i>Adicionar
                </button>
            </div>
            <div class="card-body">
                <!-- Cabeçalho dos campos -->
                <div class="row g-2 mb-2">
                    <div class="col-md-4">
                        <small class="text-muted">Descrição</small>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">Tipo</small>
                    </div>
                    <div class="col-md-1">
                        <small class="text-muted">Qtd</small>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">Valor Unit.</small>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">Total</small>
                    </div>
                    <div class="col-md-1">
                        <small class="text-muted">Ações</small>
                    </div>
                </div>
                
                <div id="servicosContainer">
                    {% if proposta and proposta.itens_servico %}
                        {% for servico in proposta.itens_servico %}
                        <div class="servico-item mb-3">
                            <div class="row g-2 align-items-center">
                                <div class="col-md-4">
                                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                                           name="servico_descricao[]" value="{{ servico.descricao }}" placeholder="Descrição do serviço" required>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select form-select-sm bg-dark text-white border-secondary" name="servico_tipo[]">
                                        <option value="hora" {% if servico.tipo_servico == 'hora' %}selected{% endif %}>Hora</option>
                                        <option value="dia" {% if servico.tipo_servico == 'dia' %}selected{% endif %}>Dia</option>
                                        <option value="fechado" {% if servico.tipo_servico == 'fechado' %}selected{% endif %}>Fechado</option>
                                    </select>
                                </div>
                                <div class="col-md-1">
                                    <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary servico-quantidade" 
                                           name="servico_horas[]" value="{{ servico.quantidade or 1 }}" step="0.25" min="0">
                                </div>
                                <div class="col-md-2">
                                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary servico-valor" 
                                           name="servico_valor[]" value="{{ '{:.2f}'.format(servico.valor_unitario or 0).replace('.', ',') }}" placeholder="0,00">
                                </div>
                                <div class="col-md-2">
                                    <input type="text" class="form-control form-control-sm bg-secondary text-white servico-total" 
                                           readonly value="R$ {{ '{:.2f}'.format((servico.quantidade or 0) * (servico.valor_unitario or 0)).replace('.', ',') }}">
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-outline-danger btn-sm w-100 btn-remover-servico">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- PRODUTOS -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-box"></i> Produtos</h5>
                <button type="button" class="btn btn-success btn-sm" id="btnAdicionarProduto">
                    <i class="fas fa-plus me-1"></i>Adicionar Produto
                </button>
            </div>
            <div class="card-body">
                <!-- Cabeçalho dos campos -->
                <div class="row g-2 mb-2">
                    <div class="col-md-5">
                        <small class="text-muted">Descrição</small>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">Quantidade</small>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">Valor Unit.</small>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">Total</small>
                    </div>
                    <div class="col-md-1">
                        <small class="text-muted">Ações</small>
                    </div>
                </div>
                
                <div id="produtosContainer">
                    {% if proposta and proposta.itens_produto %}
                        {% for produto in proposta.itens_produto %}
                        <div class="produto-item mb-3">
                            <div class="row g-2 align-items-center">
                                <div class="col-md-5">
                                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                                           name="produto_descricao[]" value="{{ produto.descricao }}" placeholder="Descrição do produto" required>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary produto-quantidade" 
                                           name="produto_quantidade[]" value="{{ produto.quantidade or 1 }}" step="1" min="0">
                                </div>
                                <div class="col-md-2">
                                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary produto-valor" 
                                           name="produto_valor[]" value="{{ '{:.2f}'.format(produto.valor_unitario or 0).replace('.', ',') }}" placeholder="0,00">
                                </div>
                                <div class="col-md-2">
                                    <input type="text" class="form-control form-control-sm bg-secondary text-white produto-total" 
                                           readonly value="R$ {{ '{:.2f}'.format((produto.quantidade or 0) * (produto.valor_unitario or 0)).replace('.', ',') }}">
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-outline-danger btn-sm w-100 btn-remover-produto">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- VALORES -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-calculator"></i> Valores</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label text-white">Serviços</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="valorServico" readonly 
                               value="{% if proposta %}R$ {{ '{:.2f}'.format(proposta.valor_servicos or 0).replace('.', ',') }}{% else %}R$ 0,00{% endif %}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Produtos</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="valorProdutos" readonly 
                               value="{% if proposta %}R$ {{ '{:.2f}'.format(proposta.valor_produtos or 0).replace('.', ',') }}{% else %}R$ 0,00{% endif %}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Desconto (%)</label>
                        <input type="number" class="form-control bg-dark text-white border-secondary" 
                               name="desconto" id="valorDesconto" value="{{ proposta.desconto if proposta else 0 }}" 
                               step="0.01" min="0" max="100">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white fw-bold">Total</label>
                        <input type="text" class="form-control bg-primary text-white fw-bold" id="valorTotal" readonly 
                               value="{% if proposta %}R$ {{ '{:.2f}'.format(proposta.valor_total or 0).replace('.', ',') }}{% else %}R$ 0,00{% endif %}">
                    </div>
                </div>
            </div>
        </div>

        <!-- FORMAS DE PAGAMENTO -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-credit-card"></i> Formas de Pagamento</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label text-white">Forma de Pagamento</label>
                        <select class="form-select bg-dark text-white border-secondary" name="forma_pagamento">
                            <option value="">Selecione...</option>
                            <option value="a_vista" {% if proposta and proposta.forma_pagamento == 'a_vista' %}selected{% endif %}>À vista</option>
                            <option value="parcelado" {% if proposta and proposta.forma_pagamento == 'parcelado' %}selected{% endif %}>Parcelado</option>
                            <option value="prazo" {% if proposta and proposta.forma_pagamento == 'prazo' %}selected{% endif %}>A prazo</option>
                            <option value="cartao" {% if proposta and proposta.forma_pagamento == 'cartao' %}selected{% endif %}>Cartão</option>
                            <option value="pix" {% if proposta and proposta.forma_pagamento == 'pix' %}selected{% endif %}>PIX</option>
                            <option value="dinheiro" {% if proposta and proposta.forma_pagamento == 'dinheiro' %}selected{% endif %}>Dinheiro</option>
                            <option value="transferencia" {% if proposta and proposta.forma_pagamento == 'transferencia' %}selected{% endif %}>Transferência</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Entrada (%)</label>
                        <input type="number" class="form-control bg-dark text-white border-secondary" 
                               name="entrada" value="{{ proposta.entrada if proposta else 0 }}" 
                               step="0.01" min="0" max="100" placeholder="0,00">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Prazo de Execução</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               name="prazo_execucao" value="{{ proposta.prazo_execucao if proposta else '' }}" 
                               placeholder="Ex: 15 dias úteis">
                    </div>
                    <div class="col-12">
                        <label class="form-label text-white">Condições de Pagamento</label>
                        <textarea class="form-control bg-dark text-white border-secondary" name="condicoes_pagamento" rows="2" 
                                  placeholder="Descreva as condições específicas de pagamento...">{{ proposta.condicoes_pagamento if proposta else '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- OBSERVAÇÕES -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-sticky-note"></i> Observações e Informações Adicionais</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label text-white">Observações Gerais</label>
                        <textarea class="form-control bg-dark text-white border-secondary" name="observacoes" rows="4" 
                                  placeholder="Observações gerais da proposta...">{{ proposta.observacoes if proposta else '' }}</textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-white">Tempo Estimado</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               name="tempo_estimado" value="{{ proposta.tempo_estimado if proposta else '' }}" 
                               placeholder="Ex: 2 horas, 1 dia">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-white">KM Estimado</label>
                        <input type="number" class="form-control bg-dark text-white border-secondary" 
                               name="km_estimado" value="{{ proposta.km_estimado if proposta else '' }}" 
                               step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-white">Garantia</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               name="garantia" value="{{ proposta.garantia if proposta else '' }}" 
                               placeholder="Ex: 12 meses">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white">Prioridade</label>
                        <select class="form-select bg-dark text-white border-secondary" name="prioridade">
                            <option value="baixa" {% if proposta and proposta.prioridade == 'baixa' %}selected{% endif %}>Baixa</option>
                            <option value="normal" {% if not proposta or proposta.prioridade == 'normal' %}selected{% endif %}>Normal</option>
                            <option value="alta" {% if proposta and proposta.prioridade == 'alta' %}selected{% endif %}>Alta</option>
                            <option value="urgente" {% if proposta and proposta.prioridade == 'urgente' %}selected{% endif %}>Urgente</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- BOTÕES -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-8">
                        <button type="submit" class="btn btn-success btn-lg w-100">
                            <i class="fas fa-save me-2"></i>{% if proposta %}Atualizar{% else %}Criar{% endif %} Proposta
                        </button>
                    </div>
                    <div class="col-md-4">
                        <a href="{{ url_for('proposta.listar_propostas') }}" class="btn btn-outline-secondary btn-lg w-100">
                            <i class="fas fa-arrow-left me-2"></i>Cancelar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
console.log('🚀 Sistema de Proposta inicializado!');

document.addEventListener('DOMContentLoaded', function() {
    let servicoIndex = {{ (proposta.itens_servico|length) if proposta and proposta.itens_servico else 0 }};
    let produtoIndex = {{ (proposta.itens_produto|length) if proposta and proposta.itens_produto else 0 }};
    
    console.log('Índices iniciais:', { servicoIndex, produtoIndex });
    
    // Função para converter valor monetário para número
    function converterParaNumero(valor) {
        if (!valor) return 0;
        return parseFloat(valor.toString().replace(',', '.').replace(/[^\d.-]/g, '')) || 0;
    }
    
    // Função para formatar número para moeda brasileira
    function formatarMoeda(valor) {
        return 'R$ ' + parseFloat(valor).toFixed(2).replace('.', ',');
    }
    
    // Função para calcular total de um item
    function calcularTotalItem(container) {
        const quantidade = container.querySelector('.servico-quantidade, .produto-quantidade');
        const valor = container.querySelector('.servico-valor, .produto-valor');
        const total = container.querySelector('.servico-total, .produto-total');
        
        if (quantidade && valor && total) {
            const qtd = converterParaNumero(quantidade.value);
            const vlr = converterParaNumero(valor.value);
            const totalCalculado = qtd * vlr;
            total.value = formatarMoeda(totalCalculado);
            console.log(`Calculado: ${qtd} x ${vlr} = ${totalCalculado}`);
        }
        
        calcularTotaisGerais();
    }
    
    // Função para calcular totais gerais
    function calcularTotaisGerais() {
        let totalServicos = 0;
        let totalProdutos = 0;
        
        // Somar serviços
        document.querySelectorAll('.servico-total').forEach(function(campo) {
            totalServicos += converterParaNumero(campo.value);
        });
        
        // Somar produtos
        document.querySelectorAll('.produto-total').forEach(function(campo) {
            totalProdutos += converterParaNumero(campo.value);
        });
        
        // Calcular desconto
        const desconto = converterParaNumero(document.getElementById('valorDesconto').value);
        const subtotal = totalServicos + totalProdutos;
        const valorDesconto = subtotal * (desconto / 100);
        const total = subtotal - valorDesconto;
        
        // Atualizar campos
        document.getElementById('valorServico').value = formatarMoeda(totalServicos);
        document.getElementById('valorProdutos').value = formatarMoeda(totalProdutos);
        document.getElementById('valorTotal').value = formatarMoeda(total);
        
        console.log('Totais calculados:', { totalServicos, totalProdutos, desconto, total });
    }
    
    // Adicionar Serviço
    document.getElementById('btnAdicionarServico').addEventListener('click', function() {
        console.log('Adicionando serviço...');
        
        const container = document.getElementById('servicosContainer');
        const div = document.createElement('div');
        div.className = 'servico-item mb-3';
        div.innerHTML = `
            <div class="row g-2 align-items-center">
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                           name="servico_descricao[]" placeholder="Descrição do serviço" required>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm bg-dark text-white border-secondary" name="servico_tipo[]">
                        <option value="hora">Hora</option>
                        <option value="dia">Dia</option>
                        <option value="fechado">Fechado</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary servico-quantidade" 
                           name="servico_horas[]" value="1" step="0.25" min="0">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary servico-valor" 
                           name="servico_valor[]" placeholder="0,00">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm bg-secondary text-white servico-total" 
                           readonly value="R$ 0,00">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm w-100 btn-remover-servico">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(div);
        servicoIndex++;
        console.log('Serviço adicionado! Total:', servicoIndex);
        
        // Adicionar eventos aos novos campos
        const novoItem = div;
        const qtdField = novoItem.querySelector('.servico-quantidade');
        const valorField = novoItem.querySelector('.servico-valor');
        
        qtdField.addEventListener('input', function() {
            calcularTotalItem(novoItem);
        });
        
        valorField.addEventListener('input', function() {
            calcularTotalItem(novoItem);
        });
    });
    
    // Adicionar Produto
    document.getElementById('btnAdicionarProduto').addEventListener('click', function() {
        console.log('Adicionando produto...');
        
        const container = document.getElementById('produtosContainer');
        const div = document.createElement('div');
        div.className = 'produto-item mb-3';
        div.innerHTML = `
            <div class="row g-2 align-items-center">
                <div class="col-md-5">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                           name="produto_descricao[]" placeholder="Descrição do produto" required>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary produto-quantidade" 
                           name="produto_quantidade[]" value="1" step="1" min="0">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary produto-valor" 
                           name="produto_valor[]" placeholder="0,00">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm bg-secondary text-white produto-total" 
                           readonly value="R$ 0,00">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm w-100 btn-remover-produto">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(div);
        produtoIndex++;
        console.log('Produto adicionado! Total:', produtoIndex);
        
        // Adicionar eventos aos novos campos
        const novoItem = div;
        const qtdField = novoItem.querySelector('.produto-quantidade');
        const valorField = novoItem.querySelector('.produto-valor');
        
        qtdField.addEventListener('input', function() {
            calcularTotalItem(novoItem);
        });
        
        valorField.addEventListener('input', function() {
            calcularTotalItem(novoItem);
        });
    });
    
    // Remover itens
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-remover-servico')) {
            if (confirm('Remover este serviço?')) {
                e.target.closest('.servico-item').remove();
                calcularTotaisGerais();
                console.log('Serviço removido');
            }
        }
        
        if (e.target.closest('.btn-remover-produto')) {
            if (confirm('Remover este produto?')) {
                e.target.closest('.produto-item').remove();
                calcularTotaisGerais();
                console.log('Produto removido');
            }
        }
    });
    
    // Adicionar eventos aos campos existentes
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('servico-quantidade') || 
            e.target.classList.contains('servico-valor') ||
            e.target.classList.contains('produto-quantidade') || 
            e.target.classList.contains('produto-valor')) {
            calcularTotalItem(e.target.closest('.servico-item, .produto-item'));
        }
        
        if (e.target.id === 'valorDesconto') {
            calcularTotaisGerais();
        }
    });
    
    // Calcular totais iniciais
    setTimeout(function() {
        calcularTotaisGerais();
    }, 100);
    
    console.log('✅ Sistema completo inicializado com cálculos!');
    
    // ===== FUNCIONALIDADE ATUALIZAR CLIENTES =====
    
    async function atualizarListaClientes() {
        const btnAtualizar = document.getElementById('btnAtualizarClientes');
        const selectCliente = document.getElementById('cliente_select');
        const clienteSelecionadoId = selectCliente.value;
        
        try {
            // Mostrar loading
            btnAtualizar.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btnAtualizar.disabled = true;
            
            // Buscar clientes atualizados
            const response = await fetch('/propostas/api/clientes');
            const data = await response.json();
            
            if (data.success) {
                // Limpar select
                selectCliente.innerHTML = '<option value="">Selecione um cliente</option>';
                
                // Adicionar clientes atualizados
                data.clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nome;
                    
                    // Manter seleção anterior se ainda existir
                    if (clienteSelecionadoId && cliente.id == clienteSelecionadoId) {
                        option.selected = true;
                    }
                    
                    selectCliente.appendChild(option);
                });
                
                // Feedback visual
                btnAtualizar.classList.add('btn-outline-success');
                btnAtualizar.classList.remove('btn-outline-info');
                setTimeout(() => {
                    btnAtualizar.classList.remove('btn-outline-success');
                    btnAtualizar.classList.add('btn-outline-info');
                }, 2000);
                
                console.log(`✅ Lista atualizada: ${data.total} clientes encontrados`);
                
                // Mostrar notificação
                if (data.total > 0) {
                    showToast(`Lista atualizada! ${data.total} clientes disponíveis`, 'success');
                } else {
                    showToast('Nenhum cliente ativo encontrado', 'warning');
                }
                
            } else {
                throw new Error(data.error || 'Erro desconhecido');
            }
            
        } catch (error) {
            console.error('❌ Erro ao atualizar clientes:', error);
            showToast('Erro ao atualizar lista de clientes', 'error');
            
            btnAtualizar.classList.add('btn-outline-danger');
            btnAtualizar.classList.remove('btn-outline-info');
            setTimeout(() => {
                btnAtualizar.classList.remove('btn-outline-danger');
                btnAtualizar.classList.add('btn-outline-info');
            }, 3000);
            
        } finally {
            // Restaurar botão
            btnAtualizar.innerHTML = '<i class="fas fa-sync-alt"></i>';
            btnAtualizar.disabled = false;
        }
    }
    
    function showToast(message, type = 'info') {
        // Criar toast simples
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'warning'} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;
        
        document.body.appendChild(toast);
        
        // Auto remover após 5 segundos
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }
    
    // Event listener para o botão atualizar
    document.getElementById('btnAtualizarClientes').addEventListener('click', atualizarListaClientes);
    
    console.log('✅ Funcionalidade de atualização de clientes carregada!');
});
</script>
{% endblock %}