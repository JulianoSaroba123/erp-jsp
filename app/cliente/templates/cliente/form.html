{% extends "base.html" %}

{% block title %}
    {% if cliente.id %}Editar Cliente{% else %}Novo Cliente{% endif %} - {{ super() }}
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('painel.dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('cliente.listar') }}">Clientes</a></li>
        <li class="breadcrumb-item active">
            {% if cliente.id %}Editar{% else %}Novo{% endif %}
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-lg-10 col-xl-11">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-user{% if not cliente.id %}-plus{% else %}-edit{% endif %} me-2"></i>
                    {% if cliente.id %}
                        Editar Cliente: {{ cliente.nome }}
                    {% else %}
                        Novo Cliente
                    {% endif %}
                </h4>
            </div>
            
            <div class="card-body">
                <form method="POST" novalidate>
                    <!-- Dados Principais -->
                    <div class="form-section">
                        <h6 class="section-title">
                            <i class="fas fa-id-card me-2"></i>
                            Dados Principais
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-2">
                                <label for="tipo" class="form-label">Tipo *</label>
                                <select class="form-select" id="tipo" name="tipo" required>
                                    <option value="PF" {% if cliente.tipo == 'PF' %}selected{% endif %}>
                                        Pessoa F√≠sica
                                    </option>
                                    <option value="PJ" {% if cliente.tipo == 'PJ' %}selected{% endif %}>
                                        Pessoa Jur√≠dica
                                    </option>
                                </select>
                            </div>
                            
                            <!-- Campos que mudam conforme o tipo -->
                            <div class="col-md-10">
                                <!-- Para Pessoa F√≠sica -->
                                <div id="campos-pf" style="display: none;">
                                    <label for="nome" class="form-label">Nome Completo *</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="nome" 
                                           name="nome" 
                                           value="{{ cliente.nome or '' }}" 
                                           maxlength="150"
                                           required>
                                </div>
                                
                                <!-- Para Pessoa Jur√≠dica -->
                                <div id="campos-pj" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="nome_fantasia" class="form-label">Nome Fantasia *</label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="nome_fantasia" 
                                                   name="nome_fantasia" 
                                                   value="{{ cliente.nome_fantasia or '' }}"
                                                   maxlength="150">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="razao_social" class="form-label">Raz√£o Social</label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="razao_social" 
                                                   name="razao_social" 
                                                   value="{{ cliente.razao_social or '' }}"
                                                   maxlength="200">
                                        </div>
                                    </div>
                                    
                                    <!-- Campo hidden para nome principal em PJ -->
                                    <input type="hidden" 
                                           id="nome_hidden" 
                                           name="nome" 
                                           value="{{ cliente.nome or '' }}">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campos adicionais PF -->
                        <div id="extras-pf" class="row mt-3" style="display: none;">
                            <div class="col-md-3">
                                <label for="data_nascimento" class="form-label">Data Nascimento</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="data_nascimento" 
                                       name="data_nascimento" 
                                       value="{{ cliente.data_nascimento or '' }}">
                            </div>
                            <div class="col-md-3">
                                <label for="genero" class="form-label">G√™nero</label>
                                <select class="form-select" id="genero" name="genero">
                                    <option value="">Selecione...</option>
                                    <option value="Masculino" {% if cliente.genero == 'Masculino' %}selected{% endif %}>Masculino</option>
                                    <option value="Feminino" {% if cliente.genero == 'Feminino' %}selected{% endif %}>Feminino</option>
                                    <option value="Outro" {% if cliente.genero == 'Outro' %}selected{% endif %}>Outro</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="estado_civil" class="form-label">Estado Civil</label>
                                <select class="form-select" id="estado_civil" name="estado_civil">
                                    <option value="">Selecione...</option>
                                    <option value="Solteiro" {% if cliente.estado_civil == 'Solteiro' %}selected{% endif %}>Solteiro(a)</option>
                                    <option value="Casado" {% if cliente.estado_civil == 'Casado' %}selected{% endif %}>Casado(a)</option>
                                    <option value="Divorciado" {% if cliente.estado_civil == 'Divorciado' %}selected{% endif %}>Divorciado(a)</option>
                                    <option value="Viuvo" {% if cliente.estado_civil == 'Viuvo' %}selected{% endif %}>Vi√∫vo(a)</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="profissao" class="form-label">Profiss√£o</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="profissao" 
                                       name="profissao" 
                                       value="{{ cliente.profissao or '' }}"
                                       maxlength="100">
                            </div>
                        </div>
                        
                        <!-- Campos adicionais PJ -->
                        <div id="extras-pj" class="row mt-3" style="display: none;">
                            <div class="col-md-6">
                                <label for="data_fundacao" class="form-label">Data Funda√ß√£o</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="data_fundacao" 
                                       name="data_fundacao" 
                                       value="{{ cliente.data_fundacao or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="porte_empresa" class="form-label">Porte</label>
                                <select class="form-select" id="porte_empresa" name="porte_empresa">
                                    <option value="">Selecione...</option>
                                    <option value="MEI" {% if cliente.porte_empresa == 'MEI' %}selected{% endif %}>MEI</option>
                                    <option value="ME" {% if cliente.porte_empresa == 'ME' %}selected{% endif %}>Microempresa</option>
                                    <option value="EPP" {% if cliente.porte_empresa == 'EPP' %}selected{% endif %}>Pequeno Porte</option>
                                    <option value="Medio" {% if cliente.porte_empresa == 'Medio' %}selected{% endif %}>M√©dio Porte</option>
                                    <option value="Grande" {% if cliente.porte_empresa == 'Grande' %}selected{% endif %}>Grande</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mt-3">
                                <label for="segmento" class="form-label">Segmento</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="segmento" 
                                       name="segmento" 
                                       value="{{ cliente.segmento or '' }}"
                                       placeholder="Ex: Tecnologia, Com√©rcio..."
                                       maxlength="100">
                            </div>
                            <div class="col-md-6 mt-3">
                                <label for="site" class="form-label">Website</label>
                                <input type="url" 
                                       class="form-control" 
                                       id="site" 
                                       name="site" 
                                       value="{{ cliente.site or '' }}"
                                       placeholder="https://..."
                                       maxlength="200">
                            </div>
                        </div>
                        
                        <!-- Classifica√ß√£o e Origem -->
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="classificacao" class="form-label">Classifica√ß√£o</label>
                                <select class="form-select" id="classificacao" name="classificacao">
                                    <option value="A" {% if cliente.classificacao == 'A' %}selected{% endif %}>
                                        üü¢ Classe A - Premium
                                    </option>
                                    <option value="B" {% if cliente.classificacao == 'B' %}selected{% endif %}>
                                        üü° Classe B - Padr√£o
                                    </option>
                                    <option value="C" {% if cliente.classificacao == 'C' %}selected{% endif %}>
                                        üî¥ Classe C - B√°sico
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="origem" class="form-label">Como nos conheceu</label>
                                <select class="form-select" id="origem" name="origem">
                                    <option value="">Selecione...</option>
                                    <option value="Indicacao" {% if cliente.origem == 'Indicacao' %}selected{% endif %}>Indica√ß√£o</option>
                                    <option value="Google" {% if cliente.origem == 'Google' %}selected{% endif %}>Google</option>
                                    <option value="Facebook" {% if cliente.origem == 'Facebook' %}selected{% endif %}>Facebook</option>
                                    <option value="Instagram" {% if cliente.origem == 'Instagram' %}selected{% endif %}>Instagram</option>
                                    <option value="Site" {% if cliente.origem == 'Site' %}selected{% endif %}>Site</option>
                                    <option value="Telemarketing" {% if cliente.origem == 'Telemarketing' %}selected{% endif %}>Telemarketing</option>
                                    <option value="Outros" {% if cliente.origem == 'Outros' %}selected{% endif %}>Outros</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="ativo" {% if cliente.status == 'ativo' %}selected{% endif %}>‚úÖ Ativo</option>
                                    <option value="inativo" {% if cliente.status == 'inativo' %}selected{% endif %}>‚è∏Ô∏è Inativo</option>
                                    <option value="bloqueado" {% if cliente.status == 'bloqueado' %}selected{% endif %}>üö´ Bloqueado</option>
                                    <option value="suspenso" {% if cliente.status == 'suspenso' %}selected{% endif %}>‚è≥ Suspenso</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Documentos -->
                    <div class="form-section">
                        <h6 class="section-title">
                            <i class="fas fa-file-alt me-2"></i>
                            Documentos
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label for="cpf_cnpj" class="form-label">
                                    <span id="label-documento">CPF/CNPJ</span> *
                                </label>
                                <div class="input-group">
                                    <input type="text"
                                           class="form-control"
                                           id="cpf_cnpj"
                                           name="cpf_cnpj"
                                           value="{{ cliente.cpf_cnpj or '' }}"
                                           placeholder="000.000.000-00"
                                           required>
                                    <button type="button" 
                                            class="btn btn-outline-primary" 
                                            id="btn-consultar-cnpj"
                                            title="Consultar CNPJ automaticamente">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Para CNPJ, clique no bot√£o para busca autom√°tica</small>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="rg_ie" class="form-label">
                                    <span id="label-rg">RG/IE</span>
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="rg_ie" 
                                       name="rg_ie" 
                                       value="{{ cliente.rg_ie or '' }}"
                                       maxlength="20">
                            </div>
                        </div>
                        
                        <!-- Inscri√ß√£o Municipal (apenas para PJ) -->
                        <div class="row mt-3">
                            <div class="col-md-6" id="campo-im" style="display: none;">
                                <label for="im" class="form-label">Inscri√ß√£o Municipal</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="im" 
                                       name="im" 
                                       value="{{ cliente.im or '' }}"
                                       maxlength="20">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contato -->
                    <div class="form-section">
                        <h6 class="section-title">
                            <i class="fas fa-phone me-2"></i>
                            Contato Principal
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email Principal</label>
                                <input type="email" 
                                       class="form-control" 
                                       id="email" 
                                       name="email" 
                                       value="{{ cliente.email or '' }}"
                                       maxlength="150">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="email_financeiro" class="form-label">Email Financeiro</label>
                                <input type="email" 
                                       class="form-control" 
                                       id="email_financeiro" 
                                       name="email_financeiro" 
                                       value="{{ cliente.email_financeiro or '' }}"
                                       placeholder="Email para cobran√ßas"
                                       maxlength="150">
                            </div>
                            
                            <div class="col-md-4">
                                <label for="telefone" class="form-label">Telefone</label>
                                <input type="tel" 
                                       class="form-control" 
                                       id="telefone" 
                                       name="telefone" 
                                       value="{{ cliente.telefone or '' }}"
                                       placeholder="(11) 1234-5678">
                            </div>
                            
                            <div class="col-md-4">
                                <label for="celular" class="form-label">Celular</label>
                                <input type="tel" 
                                       class="form-control" 
                                       id="celular" 
                                       name="celular" 
                                       value="{{ cliente.celular or '' }}"
                                       placeholder="(11) 99999-9999">
                            </div>
                            
                            <div class="col-md-4">
                                <label for="whatsapp" class="form-label">
                                    <i class="fab fa-whatsapp text-success"></i> WhatsApp
                                </label>
                                <input type="tel" 
                                       class="form-control" 
                                       id="whatsapp" 
                                       name="whatsapp" 
                                       value="{{ cliente.whatsapp or '' }}"
                                       placeholder="(11) 99999-9999">
                            </div>
                        </div>
                        
                        <!-- Contato Comercial -->
                        <div class="mt-4">
                            <h6 class="text-muted border-bottom pb-2">
                                <i class="fas fa-handshake me-2"></i>
                                Contato Comercial
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="contato_nome" class="form-label">Nome do Respons√°vel</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="contato_nome" 
                                           name="contato_nome" 
                                           value="{{ cliente.contato_nome or '' }}"
                                           maxlength="100">
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="contato_cargo" class="form-label">Cargo</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="contato_cargo" 
                                           name="contato_cargo" 
                                           value="{{ cliente.contato_cargo or '' }}"
                                           placeholder="Ex: Gerente, Diretor..."
                                           maxlength="100">
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="contato_telefone" class="form-label">Telefone do Contato</label>
                                    <input type="tel" 
                                           class="form-control" 
                                           id="contato_telefone" 
                                           name="contato_telefone" 
                                           value="{{ cliente.contato_telefone or '' }}"
                                           placeholder="(11) 99999-9999">
                                </div>
                                
                                <div class="col-md-12 mt-3">
                                    <label for="contato_email" class="form-label">Email do Contato</label>
                                    <input type="email" 
                                           class="form-control" 
                                           id="contato_email" 
                                           name="contato_email" 
                                           value="{{ cliente.contato_email or '' }}"
                                           maxlength="150">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Endere√ßo -->
                    <div class="form-section">
                        <h6 class="section-title">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            Endere√ßo
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="cep" class="form-label">CEP</label> 
                                <div class="input-group">
                                    <input type="text"
                                           class="form-control"
                                           id="cep"
                                           name="cep"
                                           value="{{ cliente.cep or '' }}"
                                           placeholder="00000-000">
                                    <button type="button" 
                                            class="btn btn-outline-primary" 
                                            id="btn-consultar-cep"
                                            title="Consultar CEP automaticamente">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Clique no bot√£o para busca autom√°tica</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="endereco" class="form-label">Endere√ßo</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="endereco" 
                                       name="endereco" 
                                       value="{{ cliente.endereco or '' }}"
                                       maxlength="200">
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <label for="numero" class="form-label">N√∫mero</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="numero" 
                                       name="numero" 
                                       value="{{ cliente.numero or '' }}"
                                       maxlength="10">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="complemento" class="form-label">Complemento</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="complemento" 
                                       name="complemento" 
                                       value="{{ cliente.complemento or '' }}"
                                       maxlength="50">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="bairro" class="form-label">Bairro</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="bairro" 
                                       name="bairro" 
                                       value="{{ cliente.bairro or '' }}"
                                       maxlength="50">
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <label for="cidade" class="form-label">Cidade</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="cidade" 
                                       name="cidade" 
                                       value="{{ cliente.cidade or '' }}"
                                       maxlength="50">
                            </div>
                            
                            <div class="col-md-2 mb-3">
                                <label for="estado" class="form-label">UF</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="estado" 
                                       name="estado" 
                                       value="{{ cliente.estado or '' }}"
                                       maxlength="2"
                                       style="text-transform: uppercase;">
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <label for="pais" class="form-label">Pa√≠s</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="pais" 
                                       name="pais" 
                                       value="{{ cliente.pais or 'Brasil' }}"
                                       maxlength="50">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configura√ß√µes Financeiras -->
                    <div class="form-section">
                        <h6 class="section-title">
                            <i class="fas fa-money-bill me-2"></i>
                            Configura√ß√µes Financeiras
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label for="limite_credito" class="form-label">Limite de Cr√©dito</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" 
                                           class="form-control" 
                                           id="limite_credito" 
                                           name="limite_credito" 
                                           value="{{ cliente.limite_credito or 0 }}"
                                           min="0"
                                           step="0.01">
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="forma_pagamento_padrao" class="form-label">Forma Pagamento Padr√£o</label>
                                <select class="form-select" id="forma_pagamento_padrao" name="forma_pagamento_padrao">
                                    <option value="">Selecione...</option>
                                    <option value="Dinheiro" {% if cliente.forma_pagamento_padrao == 'Dinheiro' %}selected{% endif %}>Dinheiro</option>
                                    <option value="PIX" {% if cliente.forma_pagamento_padrao == 'PIX' %}selected{% endif %}>PIX</option>
                                    <option value="Cartao_Debito" {% if cliente.forma_pagamento_padrao == 'Cartao_Debito' %}selected{% endif %}>Cart√£o D√©bito</option>
                                    <option value="Cartao_Credito" {% if cliente.forma_pagamento_padrao == 'Cartao_Credito' %}selected{% endif %}>Cart√£o Cr√©dito</option>
                                    <option value="Boleto" {% if cliente.forma_pagamento_padrao == 'Boleto' %}selected{% endif %}>Boleto</option>
                                    <option value="Transferencia" {% if cliente.forma_pagamento_padrao == 'Transferencia' %}selected{% endif %}>Transfer√™ncia</option>
                                    <option value="Cheque" {% if cliente.forma_pagamento_padrao == 'Cheque' %}selected{% endif %}>Cheque</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mt-3">
                                <label for="prazo_pagamento_padrao" class="form-label">Prazo Pagamento (dias)</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="prazo_pagamento_padrao" 
                                       name="prazo_pagamento_padrao" 
                                       value="{{ cliente.prazo_pagamento_padrao or 30 }}"
                                       min="0"
                                       max="365">
                            </div>
                            
                            <div class="col-md-6 mt-3">
                                <label for="desconto_padrao" class="form-label">Desconto Padr√£o (%)</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="desconto_padrao" 
                                       name="desconto_padrao" 
                                       value="{{ cliente.desconto_padrao or 0 }}"
                                       min="0"
                                       max="100"
                                       step="0.01">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Observa√ß√µes -->
                    <div class="form-section">
                        <h6 class="section-title">
                            <i class="fas fa-sticky-note me-2"></i>
                            Observa√ß√µes
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label for="observacoes" class="form-label">Observa√ß√µes Gerais</label>
                                <textarea class="form-control" 
                                          id="observacoes" 
                                          name="observacoes" 
                                          rows="4"
                                          placeholder="Informa√ß√µes adicionais sobre o cliente...">{{ cliente.observacoes or '' }}</textarea>
                                <small class="text-muted">Vis√≠vel em relat√≥rios e documentos</small>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="observacoes_internas" class="form-label">
                                    <i class="fas fa-lock me-1"></i>
                                    Observa√ß√µes Internas
                                </label>
                                <textarea class="form-control" 
                                          id="observacoes_internas" 
                                          name="observacoes_internas" 
                                          rows="4"
                                          placeholder="Anota√ß√µes internas sobre o cliente...">{{ cliente.observacoes_internas or '' }}</textarea>
                                <small class="text-muted">Apenas para uso interno - n√£o aparece em relat√≥rios</small>
                            </div>
                            
                            <!-- Motivo de bloqueio (s√≥ aparece se status = bloqueado) -->
                            <div class="col-12 mt-3" id="campo-motivo-bloqueio" style="display: none;">
                                <label for="motivo_bloqueio" class="form-label text-danger">
                                    <i class="fas fa-ban me-1"></i>
                                    Motivo do Bloqueio
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="motivo_bloqueio" 
                                       name="motivo_bloqueio" 
                                       value="{{ cliente.motivo_bloqueio or '' }}"
                                       placeholder="Explique o motivo do bloqueio..."
                                       maxlength="200">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bot√µes -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                                <a href="{{ url_for('cliente.listar') }}" class="btn btn-outline-secondary btn-lg">
                                    <i class="fas fa-arrow-left me-2"></i>
                                    Voltar
                                </a>
                                
                                <button type="submit" class="btn btn-primary btn-lg px-5">
                                    <i class="fas fa-save me-2"></i>
                                    {% if cliente.id %}Atualizar Cliente{% else %}Salvar Cliente{% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tipoSelect = document.getElementById('tipo');
        const cpfCnpjInput = document.getElementById('cpf_cnpj');
        const labelDocumento = document.getElementById('label-documento');
        const labelRg = document.getElementById('label-rg');
        
        // Atualiza labels baseado no tipo
        function atualizarLabels() {
            const btnCnpj = document.getElementById('btn-consultar-cnpj');
            const camposPF = document.getElementById('campos-pf');
            const camposPJ = document.getElementById('campos-pj');
            const extrasPF = document.getElementById('extras-pf');
            const extrasPJ = document.getElementById('extras-pj');
            const campoIM = document.getElementById('campo-im');
            
            if (tipoSelect.value === 'PF') {
                labelDocumento.textContent = 'CPF';
                labelRg.textContent = 'RG';
                cpfCnpjInput.placeholder = '000.000.000-00';
                
                // Mostra campos PF, esconde PJ
                camposPF.style.display = 'block';
                camposPJ.style.display = 'none';
                extrasPF.style.display = 'flex';
                extrasPJ.style.display = 'none';
                campoIM.style.display = 'none';
                
                // Esconde o bot√£o de consulta CNPJ para pessoa f√≠sica
                btnCnpj.style.display = 'none';
                
                // Campo nome √© obrigat√≥rio para PF
                document.getElementById('nome').required = true;
                document.getElementById('nome_fantasia').required = false;
                
            } else {
                labelDocumento.textContent = 'CNPJ';
                labelRg.textContent = 'Inscri√ß√£o Estadual';
                cpfCnpjInput.placeholder = '00.000.000/0000-00';
                
                // Mostra campos PJ, esconde PF
                camposPF.style.display = 'none';
                camposPJ.style.display = 'block';
                extrasPF.style.display = 'none';
                extrasPJ.style.display = 'flex';
                campoIM.style.display = 'block';
                
                // Mostra o bot√£o de consulta CNPJ para pessoa jur√≠dica
                btnCnpj.style.display = 'inline-block';
                
                // Nome fantasia √© obrigat√≥rio para PJ
                document.getElementById('nome').required = false;
                document.getElementById('nome_fantasia').required = true;
                
                // Sincroniza nome fantasia com campo nome hidden
                sincronizarNomePJ();
            }
        }
        
        // Sincroniza nome fantasia com campo nome para PJ
        function sincronizarNomePJ() {
            const nomeFantasia = document.getElementById('nome_fantasia');
            const nomeHidden = document.getElementById('nome_hidden');
            
            // Atualiza o nome hidden quando nome fantasia mudar
            nomeFantasia.addEventListener('input', function() {
                nomeHidden.value = this.value;
            });
            
            // Se j√° tem valor, sincroniza
            if (nomeFantasia.value && !nomeHidden.value) {
                nomeHidden.value = nomeFantasia.value;
            }
        }
        
        // Controla exibi√ß√£o do motivo de bloqueio
        function controleMotivoBoqueio() {
            const status = document.getElementById('status').value;
            const campoMotivo = document.getElementById('campo-motivo-bloqueio');
            
            if (status === 'bloqueado') {
                campoMotivo.style.display = 'block';
                document.getElementById('motivo_bloqueio').required = true;
            } else {
                campoMotivo.style.display = 'none';
                document.getElementById('motivo_bloqueio').required = false;
                document.getElementById('motivo_bloqueio').value = '';
            }
        }
        
        // M√°scara para documento
        function mascaraDocumento(value, tipo) {
            value = value.replace(/\D/g, '');
            
            if (tipo === 'PF') {
                // CPF: 000.000.000-00
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            } else {
                // CNPJ: 00.000.000/0000-00
                value = value.replace(/(\d{2})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1/$2');
                value = value.replace(/(\d{4})(\d{1,2})$/, '$1-$2');
            }
            
            return value;
        }
        
        // M√°scara para CEP
        function mascaraCep(value) {
            value = value.replace(/\D/g, '');
            value = value.replace(/(\d{5})(\d)/, '$1-$2');
            return value;
        }
        
        // M√°scara para telefone
        function mascaraTelefone(value) {
            value = value.replace(/\D/g, '');
            if (value.length <= 10) {
                value = value.replace(/(\d{2})(\d)/, '($1) $2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
            } else {
                value = value.replace(/(\d{2})(\d)/, '($1) $2');
                value = value.replace(/(\d{5})(\d)/, '$1-$2');
            }
            return value;
        }
        
        // Event listeners
        tipoSelect.addEventListener('change', atualizarLabels);
        document.getElementById('status').addEventListener('change', controleMotivoBoqueio);
        
        cpfCnpjInput.addEventListener('input', function() {
            this.value = mascaraDocumento(this.value, tipoSelect.value);
        });
        
        document.getElementById('cep').addEventListener('input', function() {
            this.value = mascaraCep(this.value);
        });
        
        document.getElementById('telefone').addEventListener('input', function() {
            this.value = mascaraTelefone(this.value);
        });
        
        document.getElementById('celular').addEventListener('input', function() {
            this.value = mascaraTelefone(this.value);
        });
        
        document.getElementById('whatsapp').addEventListener('input', function() {
            this.value = mascaraTelefone(this.value);
        });
        
        document.getElementById('contato_telefone').addEventListener('input', function() {
            this.value = mascaraTelefone(this.value);
        });
        
        // Estado em mai√∫sculo
        document.getElementById('estado').addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });

        // Consulta CNPJ automatica
        document.getElementById('btn-consultar-cnpj').addEventListener('click', function() {
            // Verifica se √© pessoa jur√≠dica
            if (tipoSelect.value !== 'PJ') {
                alert('A consulta autom√°tica est√° dispon√≠vel apenas para Pessoa Jur√≠dica (CNPJ)');
                return;
            }
            
            const cnpj = document.getElementById('cpf_cnpj').value;
            const cnpjLimpo = cnpj.replace(/\D/g, '');
            
            if (cnpjLimpo.length !== 14) {
                alert('CNPJ deve ter 14 digitos');
                return;
            }
            
            // Mostra loading
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            this.disabled = true;
            
            fetch(`/cliente/api/consultar-cnpj/${cnpjLimpo}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Preenche os campos com os dados retornados
                        if (data.data.fantasia) {
                            document.getElementById('nome_fantasia').value = data.data.fantasia;
                        }
                        if (data.data.nome) {
                            // Se n√£o tem fantasia, usa o nome como fantasia
                            if (!data.data.fantasia && document.getElementById('nome_fantasia').value === '') {
                                document.getElementById('nome_fantasia').value = data.data.nome;
                            }
                            document.getElementById('razao_social').value = data.data.nome;
                        }
                        
                        // Preenche contatos
                        if (data.data.email) {
                            document.getElementById('email').value = data.data.email;
                        }
                        if (data.data.telefone) {
                            document.getElementById('telefone').value = data.data.telefone;
                        }
                        
                        // Preenche endereco completo
                        const endereco = data.data.endereco;
                        if (endereco) {
                            if (endereco.cep) {
                                document.getElementById('cep').value = mascaraCep(endereco.cep);
                            }
                            if (endereco.logradouro) {
                                document.getElementById('endereco').value = endereco.logradouro;
                            }
                            if (endereco.numero) {
                                document.getElementById('numero').value = endereco.numero;
                            }
                            if (endereco.complemento) {
                                document.getElementById('complemento').value = endereco.complemento;
                            }
                            if (endereco.bairro) {
                                document.getElementById('bairro').value = endereco.bairro;
                            }
                            if (endereco.cidade) {
                                document.getElementById('cidade').value = endereco.cidade;
                            }
                            if (endereco.uf) {
                                document.getElementById('estado').value = endereco.uf.toUpperCase();
                            }
                        }
                        
                        // Aplica mascaras nos campos preenchidos
                        if (document.getElementById('telefone').value) {
                            document.getElementById('telefone').value = mascaraTelefone(document.getElementById('telefone').value);
                        }
                        
                        // Define o pa√≠s como Brasil
                        document.getElementById('pais').value = 'Brasil';
                        
                        alert('‚úÖ Dados da empresa carregados com sucesso!\n\nüìã Dados preenchidos:\n' +
                              '‚Ä¢ Nome/Raz√£o Social\n' +
                              '‚Ä¢ Nome Fantasia\n' + 
                              '‚Ä¢ Email e Telefone\n' +
                              '‚Ä¢ Endere√ßo completo');
                    } else {
                        alert('‚ùå Erro: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao consultar CNPJ. Tente novamente.');
                })
                .finally(() => {
                    // Remove loading
                    this.innerHTML = '<i class="fas fa-search"></i>';
                    this.disabled = false;
                });
        });
        
        // Consulta CEP automatica
        document.getElementById('btn-consultar-cep').addEventListener('click', function() {
            const cep = document.getElementById('cep').value;
            const cepLimpo = cep.replace(/\D/g, '');
            
            if (cepLimpo.length !== 8) {
                alert('CEP deve ter 8 digitos');
                return;
            }
            
            // Mostra loading
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            this.disabled = true;
            
            fetch(`/cliente/api/consultar-cep/${cepLimpo}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Preenche os campos de endereco
                        document.getElementById('endereco').value = data.data.logradouro || '';
                        document.getElementById('bairro').value = data.data.bairro || '';
                        document.getElementById('cidade').value = data.data.cidade || '';
                        document.getElementById('estado').value = data.data.uf || '';
                        
                        // Aplica mascara do CEP
                        document.getElementById('cep').value = mascaraCep(data.data.cep || cep);
                        
                        alert('Endereco carregado com sucesso!');
                    } else {
                        alert('Erro: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao consultar CEP. Tente novamente.');
                })
                .finally(() => {
                    // Remove loading
                    this.innerHTML = '<i class="fas fa-search"></i>';
                    this.disabled = false;
                });
        });

        // Inicializa
        atualizarLabels();
        controleMotivoBoqueio();

        // Foco no campo correto baseado no tipo
        if (tipoSelect.value === 'PF') {
            document.getElementById('nome').focus();
        } else {
            document.getElementById('nome_fantasia').focus();
        }
    });
</script>
{% endblock %}