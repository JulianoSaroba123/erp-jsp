{% extends 'base.html' %}

{% block title %}Configurações do Sistema{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 text-white">Configurações do Sistema</h1>
            <p class="text-muted">Defina os dados da empresa, endereço, bancários e preferências do sistema.</p>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" action="{{ url_for('configuracao.editar') }}">
        <div class="row">
            <div class="col-lg-8">
                <!-- Identificação -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <strong>01 - Identificação da Empresa</strong>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nome Fantasia *</label>
                                <input type="text" name="nome_fantasia" class="form-control" required placeholder="Nome Fantasia" value="{{ configuracao.nome_fantasia or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Razão Social</label>
                                <input type="text" name="razao_social" class="form-control" placeholder="Razão Social" value="{{ configuracao.razao_social or '' }}">
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-4">
                                <label class="form-label">CNPJ *</label>
                                <div class="input-group">
                                    <input type="text" name="cnpj" id="cnpj_input" class="form-control" placeholder="00.000.000/0000-00" value="{{ configuracao.cnpj or '' }}">
                                    <button type="button" class="btn btn-outline-secondary" id="btn_lookup_cnpj">Buscar</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Inscrição Estadual</label>
                                <input type="text" name="inscricao_estadual" class="form-control" value="{{ configuracao.inscricao_estadual or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Telefone</label>
                                <input type="text" name="telefone" class="form-control" value="{{ configuracao.telefone or '' }}">
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-4">
                                <label class="form-label">E-mail</label>
                                <input type="email" name="email" class="form-control" placeholder="contato@empresa.com" value="{{ configuracao.email or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Site</label>
                                <input type="text" name="site" class="form-control" placeholder="https://www.seusite.com" value="{{ configuracao.site or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Logotipo</label>
                                <input type="file" name="logo" class="form-control">
                                {% if configuracao.logo %}
                                <div class="mt-2">
                                    <img src="/{{ configuracao.logo }}" alt="logo" style="max-height:80px;">
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Endereço -->
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <strong>02 - Endereço</strong>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">CEP</label>
                                <div class="input-group">
                                    <input type="text" name="cep" id="cep_input" class="form-control" value="{{ configuracao.cep or '' }}" placeholder="00000-000">
                                    <button type="button" class="btn btn-outline-secondary" id="btn_lookup_cep">Buscar</button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Logradouro</label>
                                <input type="text" name="logradouro" id="logradouro" class="form-control" value="{{ configuracao.logradouro or '' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Número</label>
                                <input type="text" name="numero" class="form-control" value="{{ configuracao.numero or '' }}">
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-4">
                                <label class="form-label">Bairro</label>
                                <input type="text" name="bairro" id="bairro" class="form-control" value="{{ configuracao.bairro or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Cidade</label>
                                <input type="text" name="cidade" id="cidade" class="form-control" value="{{ configuracao.cidade or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">UF</label>
                                <input type="text" name="uf" id="uf" class="form-control" value="{{ configuracao.uf or '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bancários -->
                <div class="card mb-3">
                    <div class="card-header bg-secondary text-white">
                        <strong>03 - Dados Bancários</strong>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Banco</label>
                                <input type="text" name="banco" class="form-control" value="{{ configuracao.banco or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Agência</label>
                                <input type="text" name="agencia" class="form-control" value="{{ configuracao.agencia or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Conta</label>
                                <input type="text" name="conta" class="form-control" value="{{ configuracao.conta or '' }}">
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-12">
                                <label class="form-label">PIX</label>
                                <input type="text" name="pix" class="form-control" value="{{ configuracao.pix or '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Textos Institucionais -->
                <div class="card mb-3">
                    <div class="card-header bg-dark text-white">
                        <strong>04 - Textos Institucionais</strong>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Missão</label>
                            <textarea name="missao" class="form-control" rows="3">{{ configuracao.missao or '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Visão</label>
                            <textarea name="visao" class="form-control" rows="2">{{ configuracao.visao or '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valores</label>
                            <textarea name="valores" class="form-control" rows="2">{{ configuracao.valores or '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Frase de Assinatura</label>
                            <input type="text" name="frase_assinatura" class="form-control" value="{{ configuracao.frase_assinatura or '' }}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Preferências do Sistema -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <strong>05 - Preferências do Sistema</strong>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Tema</label>
                            <select name="tema" class="form-select">
                                <option value="claro" {% if configuracao.tema == 'claro' %}selected{% endif %}>Claro</option>
                                <option value="escuro" {% if configuracao.tema == 'escuro' %}selected{% endif %}>Escuro</option>
                                <option value="futurista" {% if configuracao.tema == 'futurista' %}selected{% endif %}>Futurista</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cor Principal (Hex)</label>
                            <input type="text" name="cor_principal" class="form-control" value="{{ configuracao.cor_principal or '#00aaff' }}">
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="exibir_logo_em_pdfs" id="exibir_logo_em_pdfs" {% if configuracao.exibir_logo_em_pdfs %}checked{% endif %}>
                            <label class="form-check-label" for="exibir_logo_em_pdfs">Exibir logo em PDFs</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="exibir_rodape_padrao" id="exibir_rodape_padrao" {% if configuracao.exibir_rodape_padrao %}checked{% endif %}>
                            <label class="form-check-label" for="exibir_rodape_padrao">Exibir rodapé padrão</label>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body d-grid">
                        <button type="submit" class="btn btn-success">Salvar Configurações</button>
                        <a href="{{ url_for('painel.dashboard') }}" class="btn btn-secondary">Cancelar</a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Funções simples para lookup CEP/CNPJ
async function buscarCNPJ() {
    const cnpj = document.getElementById('cnpj_input').value;
    if (!cnpj) return alert('Informe o CNPJ');
    const res = await fetch(`/configuracao/lookup/cnpj?cnpj=${encodeURIComponent(cnpj)}`);
    if (!res.ok) return alert('Erro ao consultar CNPJ');
    const data = await res.json();
    // Mapear campos básicos quando disponíveis
    if (data.razao_social) document.querySelector('input[name="razao_social"]').value = data.razao_social;
    if (data.telefone) document.querySelector('input[name="telefone"]').value = data.telefone;
    if (data.email) document.querySelector('input[name="email"]').value = data.email;
}

document.getElementById('btn_lookup_cnpj').addEventListener('click', buscarCNPJ);

async function buscarCEP() {
    const cep = document.getElementById('cep_input').value;
    if (!cep) return alert('Informe o CEP');
    const res = await fetch(`/configuracao/lookup/cep?cep=${encodeURIComponent(cep)}`);
    if (!res.ok) return alert('Erro ao consultar CEP');
    const data = await res.json();
    if (data.erro) return alert('CEP não encontrado');
    document.getElementById('logradouro').value = data.logradouro || '';
    document.getElementById('bairro').value = data.bairro || '';
    document.getElementById('cidade').value = data.localidade || '';
    document.getElementById('uf').value = data.uf || '';
}

document.getElementById('btn_lookup_cep').addEventListener('click', buscarCEP);
</script>
{% endblock %}
