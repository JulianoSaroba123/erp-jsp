{% extends 'base.html' %}

{% block title %}Configura√ß√µes do Sistema{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 text-white">Configura√ß√µes do Sistema</h1>
            <p class="text-muted">Defina os dados da empresa, endere√ßo, banc√°rios e prefer√™ncias do sistema.</p>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" action="{{ url_for('configuracao.editar') }}">
        <div class="row">
            <div class="col-lg-8">
                <!-- Identifica√ß√£o -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <strong>01 - Identifica√ß√£o da Empresa</strong>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nome Fantasia *</label>
                                <input type="text" name="nome_fantasia" class="form-control" required placeholder="Nome Fantasia" value="{{ configuracao.nome_fantasia or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Raz√£o Social</label>
                                <input type="text" name="razao_social" class="form-control" placeholder="Raz√£o Social" value="{{ configuracao.razao_social or '' }}">
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-4">
                                <label class="form-label">CNPJ *</label>
                                <div class="input-group">
                                    <input type="text" name="cnpj" id="cnpj_input" class="form-control" placeholder="00.000.000/0000-00" value="{{ configuracao.cnpj or '' }}">
                                    <button type="button" class="btn btn-outline-secondary" id="btn_lookup_cnpj">Buscar</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Inscri√ß√£o Estadual</label>
                                <input type="text" name="inscricao_estadual" class="form-control" value="{{ configuracao.inscricao_estadual or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Telefone</label>
                                <input type="text" name="telefone" class="form-control" value="{{ configuracao.telefone or '' }}">
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-4">
                                <label class="form-label">E-mail</label>
                                <input type="email" name="email" class="form-control" placeholder="contato@empresa.com" value="{{ configuracao.email or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Site</label>
                                <input type="text" name="site" class="form-control" placeholder="https://www.seusite.com" value="{{ configuracao.site or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Logotipo</label>
                                <input type="file" name="logo" class="form-control">
                                {% if configuracao.logo %}
                                <div class="mt-2">
                                    <img src="/{{ configuracao.logo }}" alt="logo" style="max-height:80px;">
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Endere√ßo -->
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <strong>02 - Endere√ßo</strong>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">CEP</label>
                                <div class="input-group">
                                    <input type="text" name="cep" id="cep_input" class="form-control" value="{{ configuracao.cep or '' }}" placeholder="00000-000">
                                    <button type="button" class="btn btn-outline-secondary" id="btn_lookup_cep">Buscar</button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Logradouro</label>
                                <input type="text" name="logradouro" id="logradouro" class="form-control" value="{{ configuracao.logradouro or '' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">N√∫mero</label>
                                <input type="text" name="numero" class="form-control" value="{{ configuracao.numero or '' }}">
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-4">
                                <label class="form-label">Bairro</label>
                                <input type="text" name="bairro" id="bairro" class="form-control" value="{{ configuracao.bairro or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Cidade</label>
                                <input type="text" name="cidade" id="cidade" class="form-control" value="{{ configuracao.cidade or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">UF</label>
                                <input type="text" name="uf" id="uf" class="form-control" value="{{ configuracao.uf or '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Banc√°rios -->
                <div class="card mb-3">
                    <div class="card-header bg-secondary text-white">
                        <strong>03 - Dados Banc√°rios</strong>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Banco</label>
                                <input type="text" name="banco" class="form-control" value="{{ configuracao.banco or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ag√™ncia</label>
                                <input type="text" name="agencia" class="form-control" value="{{ configuracao.agencia or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Conta</label>
                                <input type="text" name="conta" class="form-control" value="{{ configuracao.conta or '' }}">
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-12">
                                <label class="form-label">PIX</label>
                                <input type="text" name="pix" class="form-control" value="{{ configuracao.pix or '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Textos Institucionais -->
                <div class="card mb-3">
                    <div class="card-header bg-dark text-white">
                        <strong>04 - Textos Institucionais</strong>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Miss√£o</label>
                            <textarea name="missao" class="form-control" rows="3">{{ configuracao.missao or '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Vis√£o</label>
                            <textarea name="visao" class="form-control" rows="2">{{ configuracao.visao or '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valores</label>
                            <textarea name="valores" class="form-control" rows="2">{{ configuracao.valores or '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Frase de Assinatura</label>
                            <input type="text" name="frase_assinatura" class="form-control" value="{{ configuracao.frase_assinatura or '' }}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Prefer√™ncias do Sistema -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <strong>05 - Prefer√™ncias do Sistema</strong>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Tema</label>
                            <select name="tema" class="form-select">
                                <option value="claro" {% if configuracao.tema == 'claro' %}selected{% endif %}>Claro</option>
                                <option value="escuro" {% if configuracao.tema == 'escuro' %}selected{% endif %}>Escuro</option>
                                <option value="futurista" {% if configuracao.tema == 'futurista' %}selected{% endif %}>Futurista</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cor Principal (Hex)</label>
                            <input type="text" name="cor_principal" class="form-control" value="{{ configuracao.cor_principal or '#00aaff' }}">
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="exibir_logo_em_pdfs" id="exibir_logo_em_pdfs" {% if configuracao.exibir_logo_em_pdfs %}checked{% endif %}>
                            <label class="form-check-label" for="exibir_logo_em_pdfs">Exibir logo em PDFs</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="exibir_rodape_padrao" id="exibir_rodape_padrao" {% if configuracao.exibir_rodape_padrao %}checked{% endif %}>
                            <label class="form-check-label" for="exibir_rodape_padrao">Exibir rodap√© padr√£o</label>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body d-grid">
                        <button type="submit" class="btn btn-success">Salvar Configura√ß√µes</button>
                        <a href="{{ url_for('painel.dashboard') }}" class="btn btn-secondary">Cancelar</a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Fun√ß√µes aprimoradas para lookup CEP/CNPJ com melhor tratamento de erros
async function buscarCNPJ() {
    const cnpjInput = document.getElementById('cnpj_input');
    const cnpj = cnpjInput.value.trim();
    
    console.log('üîç Buscando CNPJ:', cnpj);
    
    if (!cnpj) {
        alert('Informe o CNPJ');
        return;
    }
    
    // Validar se tem pelo menos 11 d√≠gitos
    const cnpjLimpo = cnpj.replace(/\D/g, '');
    if (cnpjLimpo.length < 11) {
        alert('CNPJ deve ter pelo menos 11 d√≠gitos');
        return;
    }
    
    try {
        // Mostrar loading
        const btn = document.getElementById('btn_lookup_cnpj');
        const originalText = btn.textContent;
        btn.textContent = '‚è≥';
        btn.disabled = true;
        
        const url = `/configuracao/lookup/cnpj?cnpj=${encodeURIComponent(cnpj)}`;
        console.log('üì° URL da requisi√ß√£o:', url);
        
        const res = await fetch(url);
        console.log('üìä Status da resposta:', res.status);
        
        if (!res.ok) {
            const errorText = await res.text();
            console.error('‚ùå Erro na resposta:', errorText);
            throw new Error(`Erro ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        console.log('üìÑ Dados recebidos:', data);
        
        // Mapear campos b√°sicos quando dispon√≠veis
        if (data.razao_social) {
            document.querySelector('input[name="razao_social"]').value = data.razao_social;
            console.log('‚úÖ Raz√£o Social preenchida:', data.razao_social);
        }
        
        if (data.nome_fantasia) {
            document.querySelector('input[name="nome_fantasia"]').value = data.nome_fantasia;
            console.log('‚úÖ Nome Fantasia preenchido:', data.nome_fantasia);
        }
        
        if (data.ddd_telefone_1) {
            const telefone = `(${data.ddd_telefone_1}) ${data.telefone_1}`;
            document.querySelector('input[name="telefone"]').value = telefone;
            console.log('‚úÖ Telefone preenchido:', telefone);
        }
        
        if (data.email) {
            document.querySelector('input[name="email"]').value = data.email;
            console.log('‚úÖ Email preenchido:', data.email);
        }
        
        // Preencher endere√ßo se dispon√≠vel
        if (data.logradouro) {
            document.querySelector('input[name="logradouro"]').value = data.logradouro;
            console.log('‚úÖ Logradouro preenchido:', data.logradouro);
        }
        
        if (data.bairro) {
            document.querySelector('input[name="bairro"]').value = data.bairro;
            console.log('‚úÖ Bairro preenchido:', data.bairro);
        }
        
        if (data.municipio) {
            document.querySelector('input[name="cidade"]').value = data.municipio;
            console.log('‚úÖ Cidade preenchida:', data.municipio);
        }
        
        if (data.uf) {
            document.querySelector('input[name="uf"]').value = data.uf;
            console.log('‚úÖ UF preenchida:', data.uf);
        }
        
        if (data.cep) {
            document.querySelector('input[name="cep"]').value = data.cep;
            console.log('‚úÖ CEP preenchido:', data.cep);
        }
        
        alert('‚úÖ Dados da empresa preenchidos com sucesso!');
        
    } catch (error) {
        console.error('‚ùå Erro ao buscar CNPJ:', error);
        alert(`Erro ao consultar CNPJ: ${error.message}`);
    } finally {
        // Restaurar bot√£o
        const btn = document.getElementById('btn_lookup_cnpj');
        btn.textContent = 'Buscar';
        btn.disabled = false;
    }
}

async function buscarCEP() {
    const cepInput = document.getElementById('cep_input');
    const cep = cepInput.value.trim();
    
    console.log('üîç Buscando CEP:', cep);
    
    if (!cep) {
        alert('Informe o CEP');
        return;
    }
    
    // Validar se tem pelo menos 8 d√≠gitos
    const cepLimpo = cep.replace(/\D/g, '');
    if (cepLimpo.length !== 8) {
        alert('CEP deve ter 8 d√≠gitos');
        return;
    }
    
    try {
        // Mostrar loading
        const btn = document.getElementById('btn_lookup_cep');
        const originalText = btn.textContent;
        btn.textContent = '‚è≥';
        btn.disabled = true;
        
        const url = `/configuracao/lookup/cep?cep=${encodeURIComponent(cep)}`;
        console.log('üì° URL da requisi√ß√£o:', url);
        
        const res = await fetch(url);
        console.log('üìä Status da resposta:', res.status);
        
        if (!res.ok) {
            const errorText = await res.text();
            console.error('‚ùå Erro na resposta:', errorText);
            throw new Error(`Erro ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        console.log('üìÑ Dados recebidos:', data);
        
        if (data.erro) {
            alert('CEP n√£o encontrado');
            return;
        }
        
        // Preencher campos de endere√ßo
        if (data.logradouro) {
            document.getElementById('logradouro').value = data.logradouro;
            console.log('‚úÖ Logradouro preenchido:', data.logradouro);
        }
        
        if (data.bairro) {
            document.getElementById('bairro').value = data.bairro;
            console.log('‚úÖ Bairro preenchido:', data.bairro);
        }
        
        if (data.localidade) {
            document.getElementById('cidade').value = data.localidade;
            console.log('‚úÖ Cidade preenchida:', data.localidade);
        }
        
        if (data.uf) {
            document.getElementById('uf').value = data.uf;
            console.log('‚úÖ UF preenchida:', data.uf);
        }
        
        alert('‚úÖ Endere√ßo preenchido com sucesso!');
        
    } catch (error) {
        console.error('‚ùå Erro ao buscar CEP:', error);
        alert(`Erro ao consultar CEP: ${error.message}`);
    } finally {
        // Restaurar bot√£o
        const btn = document.getElementById('btn_lookup_cep');
        btn.textContent = 'Buscar';
        btn.disabled = false;
    }
}

// Registrar eventos quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Sistema de busca CNPJ/CEP carregado');
    
    const btnCNPJ = document.getElementById('btn_lookup_cnpj');
    const btnCEP = document.getElementById('btn_lookup_cep');
    
    if (btnCNPJ) {
        btnCNPJ.addEventListener('click', buscarCNPJ);
        console.log('‚úÖ Event listener CNPJ registrado');
    } else {
        console.error('‚ùå Bot√£o CNPJ n√£o encontrado');
    }
    
    if (btnCEP) {
        btnCEP.addEventListener('click', buscarCEP);
        console.log('‚úÖ Event listener CEP registrado');
    } else {
        console.error('‚ùå Bot√£o CEP n√£o encontrado');
    }
});
</script>
{% endblock %}
