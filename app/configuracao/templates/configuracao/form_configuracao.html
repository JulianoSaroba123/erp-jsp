{% extends 'base.html' %}

{% block title %}Configura√ß√µes do Sistema - {{ super() }}{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('painel.dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item active">Configura√ß√µes</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-lg-10 col-xl-11">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Configura√ß√µes do Sistema
                </h4>
            </div>

            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" action="{{ url_for('configuracao.editar') }}">
                    <!-- Identifica√ß√£o -->
                    <div class="form-section">
                        <h6 class="section-title">
                            <i class="fas fa-building me-2"></i>
                            01 - Identifica√ß√£o da Empresa
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label"><i class="fas fa-star text-warning me-1"></i>Nome Fantasia *</label>
                                <input type="text" name="nome_fantasia" class="form-control" required placeholder="Nome Fantasia" value="{{ configuracao.nome_fantasia or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><i class="fas fa-building me-1"></i>Raz√£o Social</label>
                                <input type="text" name="razao_social" class="form-control" placeholder="Raz√£o Social" value="{{ configuracao.razao_social or '' }}">
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-id-card me-1"></i>CNPJ *</label>
                                <div class="input-group">
                                    <input type="text" name="cnpj" id="cnpj_input" class="form-control" placeholder="00.000.000/0000-00" value="{{ configuracao.cnpj or '' }}">
                                    <button type="button" class="btn btn-outline-primary" id="btn_lookup_cnpj"><i class="fas fa-search me-1"></i>Buscar</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-file-alt me-1"></i>Inscri√ß√£o Estadual</label>
                                <input type="text" name="inscricao_estadual" class="form-control" value="{{ configuracao.inscricao_estadual or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-phone me-1"></i>Telefone</label>
                                <input type="text" name="telefone" class="form-control" value="{{ configuracao.telefone or '' }}">
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-envelope me-1"></i>E-mail</label>
                                <input type="email" name="email" class="form-control" placeholder="contato@empresa.com" value="{{ configuracao.email or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-globe me-1"></i>Site</label>
                                <input type="text" name="site" class="form-control" placeholder="https://www.seusite.com" value="{{ configuracao.site or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-image me-1"></i>Logotipo</label>
                                <input type="file" name="logo" class="form-control" accept="image/png,image/jpeg,image/jpg,image/gif">
                                {% if configuracao.logo_base64 %}
                                <div class="mt-2 text-center">
                                    <img src="data:image/png;base64,{{ configuracao.logo_base64 }}" alt="Logo atual" class="img-thumbnail" style="max-height:100px;">
                                    <p class="text-success small mt-1 mb-0"><i class="fas fa-check-circle"></i> Logo configurada</p>
                                </div>
                                {% elif configuracao.logo %}
                                <div class="mt-2 text-center">
                                    <img src="{{ url_for('configuracao.uploaded_file', filename=configuracao.logo.split('/')[-1]) }}" alt="Logo atual" class="img-thumbnail" style="max-height:100px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <p class="text-warning small mt-1 mb-0" style="display:none;"><i class="fas fa-exclamation-triangle"></i> Arquivo n√£o encontrado - fa√ßa novo upload</p>
                                    <p class="text-info small mt-1 mb-0"><i class="fas fa-info-circle"></i> Arquivo: {{ configuracao.logo.split('/')[-1] }}</p>
                                </div>
                                {% else %}
                                <div class="mt-2 text-center">
                                    <div class="border rounded p-3 bg-light">
                                        <i class="fas fa-image fa-3x text-muted mb-2"></i>
                                        <p class="text-muted small mb-0">Nenhuma logo configurada</p>
                                        <p class="text-muted small mb-0">Fa√ßa upload de uma imagem</p>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Endere√ßo -->
                    <div class="form-section">
                        <h6 class="section-title">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            02 - Endere√ßo
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label"><i class="fas fa-map-pin me-1"></i>CEP</label>
                                <div class="input-group">
                                    <input type="text" name="cep" id="cep_input" class="form-control" value="{{ configuracao.cep or '' }}" placeholder="00000-000">
                                    <button type="button" class="btn btn-outline-primary" id="btn_lookup_cep"><i class="fas fa-search me-1"></i>Buscar</button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><i class="fas fa-road me-1"></i>Logradouro</label>
                                <input type="text" name="logradouro" id="logradouro" class="form-control" value="{{ configuracao.logradouro or '' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label"><i class="fas fa-hashtag me-1"></i>N√∫mero</label>
                                <input type="text" name="numero" class="form-control" value="{{ configuracao.numero or '' }}">
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-map me-1"></i>Bairro</label>
                                <input type="text" name="bairro" id="bairro" class="form-control" value="{{ configuracao.bairro or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-city me-1"></i>Cidade</label>
                                <input type="text" name="cidade" id="cidade" class="form-control" value="{{ configuracao.cidade or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-flag me-1"></i>UF</label>
                                <input type="text" name="uf" id="uf" class="form-control" value="{{ configuracao.uf or '' }}" maxlength="2">
                            </div>
                        </div>
                    </div>

                    <!-- Banc√°rios -->
                    <div class="form-section">
                        <h6 class="section-title">
                            <i class="fas fa-university me-2"></i>
                            03 - Dados Banc√°rios
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-landmark me-1"></i>Banco</label>
                                <input type="text" name="banco" class="form-control" value="{{ configuracao.banco or '' }}" placeholder="Nome do banco">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-code-branch me-1"></i>Ag√™ncia</label>
                                <input type="text" name="agencia" class="form-control" value="{{ configuracao.agencia or '' }}" placeholder="0000">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-wallet me-1"></i>Conta</label>
                                <input type="text" name="conta" class="form-control" value="{{ configuracao.conta or '' }}" placeholder="00000-0">
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-12">
                                <label class="form-label"><i class="fas fa-qrcode me-1"></i>PIX</label>
                                <input type="text" name="pix" class="form-control" value="{{ configuracao.pix or '' }}" placeholder="Chave PIX">
                            </div>
                        </div>
                    </div>

                    <!-- Textos Institucionais -->
                    <div class="form-section">
                        <h6 class="section-title">
                            <i class="fas fa-align-left me-2"></i>
                            04 - Textos Institucionais
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label"><i class="fas fa-bullseye me-1"></i>Miss√£o</label>
                                <textarea name="missao" class="form-control" rows="3" placeholder="Miss√£o da empresa">{{ configuracao.missao or '' }}</textarea>
                            </div>
                        </div>
                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label class="form-label"><i class="fas fa-eye me-1"></i>Vis√£o</label>
                                <textarea name="visao" class="form-control" rows="3" placeholder="Vis√£o da empresa">{{ configuracao.visao or '' }}</textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><i class="fas fa-heart me-1"></i>Valores</label>
                                <textarea name="valores" class="form-control" rows="3" placeholder="Valores da empresa">{{ configuracao.valores or '' }}</textarea>
                            </div>
                        </div>
                        <div class="row g-3 mt-3">
                            <div class="col-md-12">
                                <label class="form-label"><i class="fas fa-quote-right me-1"></i>Frase de Assinatura</label>
                                <input type="text" name="frase_assinatura" class="form-control" value="{{ configuracao.frase_assinatura or '' }}" placeholder="Frase de impacto">
                            </div>
                        </div>
                    </div>

                    <!-- Prefer√™ncias do Sistema -->
                    <div class="form-section">
                        <h6 class="section-title">
                            <i class="fas fa-palette me-2"></i>
                            05 - Prefer√™ncias do Sistema
                        </h6>
                        
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-paint-brush me-1"></i>Tema</label>
                                <select name="tema" class="form-select">
                                    <option value="claro" {% if configuracao.tema == 'claro' %}selected{% endif %}>‚òÄÔ∏è Claro</option>
                                    <option value="escuro" {% if configuracao.tema == 'escuro' %}selected{% endif %}>üåô Escuro</option>
                                    <option value="futurista" {% if configuracao.tema == 'futurista' %}selected{% endif %}>üöÄ Futurista</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-fill-drip me-1"></i>Cor Principal (Hex)</label>
                                <input type="text" name="cor_principal" class="form-control" value="{{ configuracao.cor_principal or '#00aaff' }}" placeholder="#00aaff">
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-toggle-on me-1"></i>Op√ß√µes de Exibi√ß√£o</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="exibir_logo_em_pdfs" id="exibir_logo_em_pdfs" {% if configuracao.exibir_logo_em_pdfs %}checked{% endif %}>
                                    <label class="form-check-label" for="exibir_logo_em_pdfs">
                                        <i class="fas fa-file-pdf me-1"></i>Exibir logo em PDFs
                                    </label>
                                </div>
                                
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" name="exibir_rodape_padrao" id="exibir_rodape_padrao" {% if configuracao.exibir_rodape_padrao %}checked{% endif %}>
                                    <label class="form-check-label" for="exibir_rodape_padrao">
                                        <i class="fas fa-shoe-prints me-1"></i>Exibir rodap√© padr√£o
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bot√µes de A√ß√£o -->
                    <div class="form-section text-end">
                        <a href="{{ url_for('painel.dashboard') }}" class="btn btn-secondary me-2">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-2"></i>Salvar Configura√ß√µes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Fun√ß√µes aprimoradas para lookup CEP/CNPJ com melhor tratamento de erros
async function buscarCNPJ() {
    const cnpjInput = document.getElementById('cnpj_input');
    const cnpj = cnpjInput.value.trim();
    
    console.log('üîç Buscando CNPJ:', cnpj);
    
    if (!cnpj) {
        alert('Informe o CNPJ');
        return;
    }
    
    // Validar se tem pelo menos 11 d√≠gitos
    const cnpjLimpo = cnpj.replace(/\D/g, '');
    if (cnpjLimpo.length < 11) {
        alert('CNPJ deve ter pelo menos 11 d√≠gitos');
        return;
    }
    
    try {
        // Mostrar loading
        const btn = document.getElementById('btn_lookup_cnpj');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        
        const url = `/configuracao/lookup/cnpj?cnpj=${encodeURIComponent(cnpj)}`;
        console.log('üì° URL da requisi√ß√£o:', url);
        
        const res = await fetch(url);
        console.log('üìä Status da resposta:', res.status);
        
        if (!res.ok) {
            const errorText = await res.text();
            console.error('‚ùå Erro na resposta:', errorText);
            throw new Error(`Erro ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        console.log('üìÑ Dados recebidos:', data);
        
        // Mapear campos b√°sicos quando dispon√≠veis
        if (data.razao_social) {
            document.querySelector('input[name="razao_social"]').value = data.razao_social;
            console.log('‚úÖ Raz√£o Social preenchida:', data.razao_social);
        }
        
        if (data.nome_fantasia) {
            document.querySelector('input[name="nome_fantasia"]').value = data.nome_fantasia;
            console.log('‚úÖ Nome Fantasia preenchido:', data.nome_fantasia);
        }
        
        if (data.ddd_telefone_1) {
            const telefone = `(${data.ddd_telefone_1}) ${data.telefone_1}`;
            document.querySelector('input[name="telefone"]').value = telefone;
            console.log('‚úÖ Telefone preenchido:', telefone);
        }
        
        if (data.email) {
            document.querySelector('input[name="email"]').value = data.email;
            console.log('‚úÖ Email preenchido:', data.email);
        }
        
        // Preencher endere√ßo se dispon√≠vel
        if (data.logradouro) {
            document.querySelector('input[name="logradouro"]').value = data.logradouro;
            console.log('‚úÖ Logradouro preenchido:', data.logradouro);
        }
        
        if (data.bairro) {
            document.querySelector('input[name="bairro"]').value = data.bairro;
            console.log('‚úÖ Bairro preenchido:', data.bairro);
        }
        
        if (data.municipio) {
            document.querySelector('input[name="cidade"]').value = data.municipio;
            console.log('‚úÖ Cidade preenchida:', data.municipio);
        }
        
        if (data.uf) {
            document.querySelector('input[name="uf"]').value = data.uf;
            console.log('‚úÖ UF preenchida:', data.uf);
        }
        
        if (data.cep) {
            document.querySelector('input[name="cep"]').value = data.cep;
            console.log('‚úÖ CEP preenchido:', data.cep);
        }
        
        alert('‚úÖ Dados da empresa preenchidos com sucesso!');
        
    } catch (error) {
        console.error('‚ùå Erro ao buscar CNPJ:', error);
        alert(`Erro ao consultar CNPJ: ${error.message}`);
    } finally {
        // Restaurar bot√£o
        const btn = document.getElementById('btn_lookup_cnpj');
        btn.innerHTML = '<i class="fas fa-search me-1"></i>Buscar';
        btn.disabled = false;
    }
}

async function buscarCEP() {
    const cepInput = document.getElementById('cep_input');
    const cep = cepInput.value.trim();
    
    console.log('üîç Buscando CEP:', cep);
    
    if (!cep) {
        alert('Informe o CEP');
        return;
    }
    
    // Validar se tem pelo menos 8 d√≠gitos
    const cepLimpo = cep.replace(/\D/g, '');
    if (cepLimpo.length !== 8) {
        alert('CEP deve ter 8 d√≠gitos');
        return;
    }
    
    try {
        // Mostrar loading
        const btn = document.getElementById('btn_lookup_cep');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        
        const url = `/configuracao/lookup/cep?cep=${encodeURIComponent(cep)}`;
        console.log('üì° URL da requisi√ß√£o:', url);
        
        const res = await fetch(url);
        console.log('üìä Status da resposta:', res.status);
        
        if (!res.ok) {
            const errorText = await res.text();
            console.error('‚ùå Erro na resposta:', errorText);
            throw new Error(`Erro ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        console.log('üìÑ Dados recebidos:', data);
        
        if (data.erro) {
            alert('CEP n√£o encontrado');
            return;
        }
        
        // Preencher campos de endere√ßo
        if (data.logradouro) {
            document.getElementById('logradouro').value = data.logradouro;
            console.log('‚úÖ Logradouro preenchido:', data.logradouro);
        }
        
        if (data.bairro) {
            document.getElementById('bairro').value = data.bairro;
            console.log('‚úÖ Bairro preenchido:', data.bairro);
        }
        
        if (data.localidade) {
            document.getElementById('cidade').value = data.localidade;
            console.log('‚úÖ Cidade preenchida:', data.localidade);
        }
        
        if (data.uf) {
            document.getElementById('uf').value = data.uf;
            console.log('‚úÖ UF preenchida:', data.uf);
        }
        
        alert('‚úÖ Endere√ßo preenchido com sucesso!');
        
    } catch (error) {
        console.error('‚ùå Erro ao buscar CEP:', error);
        alert(`Erro ao consultar CEP: ${error.message}`);
    } finally {
        // Restaurar bot√£o
        const btn = document.getElementById('btn_lookup_cep');
        btn.innerHTML = '<i class="fas fa-search me-1"></i>Buscar';
        btn.disabled = false;
    }
}

// Registrar eventos quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Sistema de busca CNPJ/CEP carregado');
    
    const btnCNPJ = document.getElementById('btn_lookup_cnpj');
    const btnCEP = document.getElementById('btn_lookup_cep');
    
    if (btnCNPJ) {
        btnCNPJ.addEventListener('click', buscarCNPJ);
        console.log('‚úÖ Event listener CNPJ registrado');
    } else {
        console.error('‚ùå Bot√£o CNPJ n√£o encontrado');
    }
    
    if (btnCEP) {
        btnCEP.addEventListener('click', buscarCEP);
        console.log('‚úÖ Event listener CEP registrado');
    } else {
        console.error('‚ùå Bot√£o CEP n√£o encontrado');
    }
});
</script>
{% endblock %}
