{% extends 'base.html' %}

{% block title %}Placas Solares - Catálogo{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('energia_solar.dashboard') }}">Energia Solar</a></li>
<li class="breadcrumb-item active">Placas Solares</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-ciano mb-1"><i class="fas fa-solar-panel me-2"></i>Placas Solares</h2>
            <p class="text-muted mb-0">Catálogo de placas fotovoltaicas</p>
        </div>
        <button class="btn btn-ciano" data-bs-toggle="modal" data-bs-target="#modalCRUD" onclick="abrirModalCriar()">
            <i class="fas fa-plus me-2"></i>Nova Placa
        </button>
    </div>

    <!-- Lista de Placas -->
    {% if placas_obj %}
    <div class="row g-4">
        {% for placa in placas_obj %}
        <div class="col-lg-4 col-md-6">
            <div class="card bg-dark border-ciano h-100">
                <div class="card-header bg-gradient-ciano d-flex justify-content-between">
                    <h6 class="mb-0">{{ placa.modelo }}</h6>
                    <span class="badge bg-success">Ativo</span>
                </div>
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="fas fa-industry me-2"></i>{{ placa.fabricante }}</h6>
                    <h3 class="text-amarelo mb-3">{{ placa.potencia }} Wp</h3>
                    
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <div class="text-center p-2 rounded" style="background: rgba(6, 182, 212, 0.1);">
                                <small class="text-muted d-block">Eficiência</small>
                                <strong class="text-ciano">{{ "%.1f"|format(placa.eficiencia) }}%</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-2 rounded" style="background: rgba(251, 191, 36, 0.1);">
                                <small class="text-muted d-block">Células</small>
                                <strong class="text-amarelo">{{ placa.num_celulas }}</strong>
                            </div>
                        </div>
                    </div>

                    <div class="text-center p-2 rounded mb-3" style="background: rgba(16, 185, 129, 0.1);">
                        <small class="text-muted d-block">Preço de Venda</small>
                        <strong class="text-verde fs-5">R$ {{ "%.2f"|format(placa.preco_venda) }}</strong>
                        <small class="text-muted d-block">R$ {{ "%.2f"|format(placa.preco_venda / placa.potencia) }}/Wp</small>
                    </div>
                    
                    {% if placa.datasheet %}
                    <div class="text-center mb-2">
                        {% if placa.datasheet.endswith(('.jpg', '.jpeg', '.png', '.webp')) %}
                            <a href="{{ placa.datasheet }}" target="_blank" class="btn btn-sm btn-outline-info w-100">
                                <i class="fas fa-image me-1"></i>Ver Imagem Técnica
                            </a>
                        {% else %}
                            <a href="{{ placa.datasheet }}" target="_blank" class="btn btn-sm btn-outline-danger w-100">
                                <i class="fas fa-file-pdf me-1"></i>Ver Datasheet PDF
                            </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-transparent border-top">
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-info flex-grow-1" onclick="visualizarPlaca({{ placa.id }})">
                            <i class="fas fa-eye me-1"></i>Ver
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editarPlaca({{ placa.id }})">
                            <i class="fas fa-edit me-1"></i>Editar
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="excluirPlaca({{ placa.id }}, '{{ placa.modelo }}')">
                            <i class="fas fa-trash me-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>Nenhuma placa cadastrada. Clique em "Nova Placa" para começar.
    </div>
    {% endif %}
</div>

<!-- Modal CRUD (Criar/Visualizar/Editar) -->
<div class="modal fade" id="modalCRUD" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark border-ciano">
            <div class="modal-header bg-gradient-ciano">
                <h5 class="modal-title" id="modalTitulo"><i class="fas fa-solar-panel me-2"></i>Placa Solar</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Abas de Navegação -->
                <ul class="nav nav-tabs mb-4" id="crudTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-criar" data-bs-toggle="tab" data-bs-target="#criar" type="button">
                            <i class="fas fa-plus me-2"></i>Criar Novo
                        </button>
                    </li>
                    <li class="nav-item" role="presentation" id="li-visualizar" style="display:none;">
                        <button class="nav-link" id="tab-visualizar" data-bs-toggle="tab" data-bs-target="#visualizar" type="button">
                            <i class="fas fa-eye me-2"></i>Visualizar
                        </button>
                    </li>
                    <li class="nav-item" role="presentation" id="li-editar" style="display:none;">
                        <button class="nav-link" id="tab-editar" data-bs-toggle="tab" data-bs-target="#editar" type="button">
                            <i class="fas fa-edit me-2"></i>Editar
                        </button>
                    </li>
                </ul>

                <!-- Conteúdo das Abas -->
                <div class="tab-content" id="crudTabsContent">
                    <!-- ABA: CRIAR -->
                    <div class="tab-pane fade show active" id="criar" role="tabpanel">
                        <form method="POST" action="{{ url_for('energia_solar.placa_criar') }}" id="formCriar" enctype="multipart/form-data">
                            {% include 'energia_solar/_form_placa.html' %}
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-success"><i class="fas fa-save me-2"></i>Salvar</button>
                            </div>
                        </form>
                    </div>

                    <!-- ABA: VISUALIZAR -->
                    <div class="tab-pane fade" id="visualizar" role="tabpanel">
                        <div id="conteudoVisualizar">
                            <p class="text-center text-muted">Carregando...</p>
                        </div>
                    </div>

                    <!-- ABA: EDITAR -->
                    <div class="tab-pane fade" id="editar" role="tabpanel">
                        <form method="POST" id="formEditar" enctype="multipart/form-data">
                            <div id="conteudoEditar">
                                <p class="text-center text-muted">Carregando...</p>
                            </div>
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-warning"><i class="fas fa-save me-2"></i>Atualizar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Dados das placas (JSON)
const placasData = {{ placas|tojson|safe }};

// Abrir modal para CRIAR
function abrirModalCriar() {
    document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-plus me-2"></i>Nova Placa Solar';
    document.getElementById('li-visualizar').style.display = 'none';
    document.getElementById('li-editar').style.display = 'none';
    document.getElementById('tab-criar').click();
    document.getElementById('formCriar').reset();
}

// VISUALIZAR placa
function visualizarPlaca(id) {
    const placa = placasData.find(p => p.id === id);
    if (!placa) return;

    document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-eye me-2"></i>Visualizar Placa';
    document.getElementById('li-visualizar').style.display = 'block';
    document.getElementById('li-editar').style.display = 'block';

    document.getElementById('conteudoVisualizar').innerHTML = `
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card bg-dark border-info">
                    <div class="card-header bg-gradient-info"><h6 class="mb-0">Informações Básicas</h6></div>
                    <div class="card-body">
                        <p><strong>Fabricante:</strong> ${placa.fabricante}</p>
                        <p><strong>Modelo:</strong> ${placa.modelo}</p>
                        <p><strong>Potência:</strong> ${placa.potencia} Wp</p>
                        <p><strong>Eficiência:</strong> ${placa.eficiencia}%</p>
                        <p><strong>Células:</strong> ${placa.num_celulas}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-dark border-success">
                    <div class="card-header bg-gradient-success"><h6 class="mb-0">Dimensões e Garantias</h6></div>
                    <div class="card-body">
                        <p><strong>Dimensões:</strong> ${placa.comprimento} × ${placa.largura} × ${placa.espessura} mm</p>
                        <p><strong>Garantia Produto:</strong> ${placa.garantia_produto} anos</p>
                        <p><strong>Garantia Desempenho:</strong> ${placa.garantia_desempenho} anos</p>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card bg-dark border-warning">
                    <div class="card-header bg-gradient-warning text-dark"><h6 class="mb-0">Precificação</h6></div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <p><strong>Preço de Venda:</strong> <span class="text-success fs-4">R$ ${placa.preco_venda.toFixed(2)}</span></p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Preço de Custo:</strong> R$ ${placa.preco_custo ? placa.preco_custo.toFixed(2) : '0.00'}</p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Preço/Watt:</strong> R$ ${(placa.preco_venda / placa.potencia).toFixed(2)}/Wp</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    const modal = new bootstrap.Modal(document.getElementById('modalCRUD'));
    modal.show();
    document.getElementById('tab-visualizar').click();
}

// EDITAR placa
async function editarPlaca(id) {
    try {
        // Buscar dados da placa
        const response = await fetch(`/energia-solar/placas/editar/${id}`);
        const placa = await response.json();
        
        // DEBUG: Ver dados recebidos
        console.log('Dados da placa recebidos:', placa);
        
        // Preencher formulário de edição
        const formHtml = `
            <input type="hidden" name="placa_id" value="${placa.id}">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Modelo *</label>
                    <input type="text" class="form-control" name="modelo" value="${placa.modelo}" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Fabricante *</label>
                    <input type="text" class="form-control" name="fabricante" value="${placa.fabricante}" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Potência (W) *</label>
                    <input type="number" step="0.01" class="form-control" name="potencia" value="${placa.potencia}" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Preço de Venda (R$) *</label>
                    <input type="number" step="0.01" class="form-control" name="preco_venda" value="${placa.preco_venda}" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Eficiência (%)</label>
                    <input type="number" step="0.1" class="form-control" name="eficiencia" value="${placa.eficiencia || ''}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Número de Células</label>
                    <input type="number" class="form-control" name="num_celulas" value="${placa.num_celulas || ''}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Preço de Custo (R$)</label>
                    <input type="number" step="0.01" class="form-control" name="preco_custo" value="${placa.preco_custo !== null && placa.preco_custo !== undefined ? placa.preco_custo : ''}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Comprimento (mm)</label>
                    <input type="number" step="0.1" class="form-control" name="comprimento" value="${placa.comprimento !== null && placa.comprimento !== undefined ? placa.comprimento : ''}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Largura (mm)</label>
                    <input type="number" step="0.1" class="form-control" name="largura" value="${placa.largura !== null && placa.largura !== undefined ? placa.largura : ''}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Espessura (mm)</label>
                    <input type="number" step="0.1" class="form-control" name="espessura" value="${placa.espessura !== null && placa.espessura !== undefined ? placa.espessura : ''}">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Garantia do Produto (anos)</label>
                    <input type="number" class="form-control" name="garantia_produto" value="${placa.garantia_produto || 12}">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Garantia de Desempenho (anos)</label>
                    <input type="number" class="form-control" name="garantia_desempenho" value="${placa.garantia_desempenho || 25}">
                </div>
                <div class="col-md-12 mt-3">
                    <label class="form-label">
                        <i class="fas fa-file-pdf text-danger me-2"></i>Datasheet (PDF ou Imagem)
                    </label>
                    ${placa.datasheet ? `<div class="alert alert-info mb-2"><i class="fas fa-info-circle me-2"></i>Arquivo atual: ${placa.datasheet.split('/').pop()}</div>` : ''}
                    <ul class="nav nav-tabs mb-2" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" type="button" data-bs-toggle="tab" data-bs-target="#upload-edit">
                                <i class="fas fa-upload me-1"></i>Upload Novo
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" type="button" data-bs-toggle="tab" data-bs-target="#link-edit">
                                <i class="fas fa-link me-1"></i>Link Externo
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="upload-edit">
                            <input type="file" class="form-control" name="datasheet_file" accept=".pdf,.jpg,.jpeg,.png,.webp">
                            <small class="text-muted">Deixe vazio para manter o arquivo atual</small>
                        </div>
                        <div class="tab-pane fade" id="link-edit">
                            <input type="url" class="form-control" name="datasheet_url" value="${placa.datasheet && !placa.datasheet.startsWith('/static/') ? placa.datasheet : ''}" placeholder="https://exemplo.com/datasheet.pdf">
                            <small class="text-muted">Cole o link direto do datasheet</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Inserir no formulário
        document.getElementById('conteudoEditar').innerHTML = formHtml;
        
        // Atualizar action do form
        document.getElementById('formEditar').action = `/energia-solar/placas/editar/${id}`;
        
        // Mostrar aba de edição
        document.getElementById('li-editar').style.display = 'block';
        document.getElementById('tab-editar').click();
        
        // Abrir modal
        const modal = new bootstrap.Modal(document.getElementById('modalCRUD'));
        modal.show();
        
    } catch (error) {
        console.error('Erro ao carregar placa:', error);
        alert('Erro ao carregar dados da placa!');
    }
}

// EXCLUIR placa
function excluirPlaca(id, modelo) {
    if (confirm(`Tem certeza que deseja excluir a placa "${modelo}"?`)) {
        fetch(`/energia-solar/placas/excluir/${id}`, {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Erro ao excluir placa!');
            }
        });
    }
}

// Preview de imagem ao selecionar arquivo
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('datasheet_file');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('preview-datasheet');
            
            if (file) {
                // Verificar tamanho
                if (file.size > 5 * 1024 * 1024) {
                    preview.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Arquivo muito grande! Máximo 5MB.</div>';
                    e.target.value = '';
                    return;
                }
                
                // Mostrar preview se for imagem
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML = `
                            <div class="text-center">
                                <img src="${e.target.result}" class="img-thumbnail" style="max-height: 200px;">
                                <p class="text-muted mt-2">${file.name} (${(file.size / 1024).toFixed(1)} KB)</p>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-file-pdf me-2"></i>${file.name} (${(file.size / 1024).toFixed(1)} KB)
                        </div>
                    `;
                }
            } else {
                preview.innerHTML = '';
            }
        });
    }
});
</script>
{% endblock %}
