{% extends 'base.html' %}

{% block title %}Inversores Solares - Catálogo{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('energia_solar.dashboard') }}">Energia Solar</a></li>
<li class="breadcrumb-item active">Inversores Solares</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-roxo mb-1"><i class="fas fa-microchip me-2"></i>Inversores Solares</h2>
            <p class="text-muted mb-0">Catálogo de inversores fotovoltaicos</p>
        </div>
        <button class="btn btn-roxo" data-bs-toggle="modal" data-bs-target="#modalCRUD" onclick="abrirModalCriar()">
            <i class="fas fa-plus me-2"></i>Novo Inversor
        </button>
    </div>

    <!-- Lista de Inversores -->
    {% if inversores_obj %}
    <div class="row g-4">
        {% for inversor in inversores_obj %}
        <div class="col-lg-4 col-md-6">
            <div class="card bg-dark border-roxo h-100">
                <div class="card-header bg-gradient-roxo d-flex justify-content-between">
                    <h6 class="mb-0">{{ inversor.modelo }}</h6>
                    <span class="badge bg-success">Ativo</span>
                </div>
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="fas fa-industry me-2"></i>{{ inversor.fabricante }}</h6>
                    <h3 class="text-amarelo mb-2">{{ inversor.potencia_nominal }} kW</h3>
                    <p class="text-muted mb-3"><i class="fas fa-bolt me-2"></i>{{ inversor.tipo }} - {{ inversor.fases }}</p>
                    
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <div class="text-center p-2 rounded" style="background: rgba(139, 92, 246, 0.1);">
                                <small class="text-muted d-block">Eficiência</small>
                                <strong class="text-roxo">{{ "%.1f"|format(inversor.eficiencia_maxima if inversor.eficiencia_maxima else 97.0) }}%</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-2 rounded" style="background: rgba(6, 182, 212, 0.1);">
                                <small class="text-muted d-block">MPPTs</small>
                                <strong class="text-ciano">{{ inversor.num_mppt }}</strong>
                            </div>
                        </div>
                    </div>

                    <div class="text-center p-2 rounded mb-3" style="background: rgba(16, 185, 129, 0.1);">
                        <small class="text-muted d-block">Preço de Venda</small>
                        <strong class="text-verde fs-5">R$ {{ "%.2f"|format(inversor.preco_venda) }}</strong>
                        <small class="text-muted d-block">R$ {{ "%.2f"|format(inversor.preco_venda / inversor.potencia_nominal) }}/kW</small>
                    </div>
                    
                    {% if inversor.datasheet %}
                    <div class="text-center mb-2">
                        {% set arquivos = inversor.datasheet.split(';') %}
                        {% for arquivo in arquivos %}
                            {% if arquivo.strip() %}
                                <div class="d-flex gap-1 mb-1">
                                    {% if arquivo.endswith(('.jpg', '.jpeg', '.png', '.webp')) %}
                                        <a href="{{ arquivo }}" target="_blank" class="btn btn-sm btn-outline-info flex-grow-1">
                                            <i class="fas fa-image me-1"></i>Imagem {{ loop.index }}
                                        </a>
                                    {% else %}
                                        <a href="{{ arquivo }}" target="_blank" class="btn btn-sm btn-outline-danger flex-grow-1">
                                            <i class="fas fa-file-pdf me-1"></i>PDF {{ loop.index }}
                                        </a>
                                    {% endif %}
                                    <button onclick="excluirDatasheet({{ inversor.id }}, {{ loop.index0 }}, 'inversor')" class="btn btn-sm btn-outline-danger" title="Excluir arquivo">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-transparent border-top">
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-info flex-grow-1" onclick="visualizarInversor({{ inversor.id }})">
                            <i class="fas fa-eye me-1"></i>Ver
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editarInversor({{ inversor.id }})">
                            <i class="fas fa-edit me-1"></i>Editar
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="excluirInversor({{ inversor.id }}, '{{ inversor.modelo }}')">
                            <i class="fas fa-trash me-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>Nenhum inversor cadastrado. Clique em "Novo Inversor" para começar.
    </div>
    {% endif %}
</div>

<!-- Modal CRUD -->
<div class="modal fade" id="modalCRUD" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark border-roxo">
            <div class="modal-header bg-gradient-roxo">
                <h5 class="modal-title" id="modalTitulo"><i class="fas fa-microchip me-2"></i>Inversor Solar</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Abas -->
                <ul class="nav nav-tabs mb-4" id="crudTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-criar" data-bs-toggle="tab" data-bs-target="#criar" type="button">
                            <i class="fas fa-plus me-2"></i>Criar Novo
                        </button>
                    </li>
                    <li class="nav-item" role="presentation" id="li-visualizar" style="display:none;">
                        <button class="nav-link" id="tab-visualizar" data-bs-toggle="tab" data-bs-target="#visualizar" type="button">
                            <i class="fas fa-eye me-2"></i>Visualizar
                        </button>
                    </li>
                    <li class="nav-item" role="presentation" id="li-editar" style="display:none;">
                        <button class="nav-link" id="tab-editar" data-bs-toggle="tab" data-bs-target="#editar" type="button">
                            <i class="fas fa-edit me-2"></i>Editar
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="crudTabsContent">
                    <!-- CRIAR -->
                    <div class="tab-pane fade show active" id="criar" role="tabpanel">
                        <form method="POST" action="{{ url_for('energia_solar.inversor_criar') }}" id="formCriar" enctype="multipart/form-data">
                            {% include 'energia_solar/_form_inversor.html' %}
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-success"><i class="fas fa-save me-2"></i>Salvar</button>
                            </div>
                        </form>
                    </div>

                    <!-- VISUALIZAR -->
                    <div class="tab-pane fade" id="visualizar" role="tabpanel">
                        <div id="conteudoVisualizar">
                            <p class="text-center text-muted">Carregando...</p>
                        </div>
                    </div>

                    <!-- EDITAR -->
                    <div class="tab-pane fade" id="editar" role="tabpanel">
                        <form method="POST" id="formEditar" enctype="multipart/form-data">
                            <div id="conteudoEditar">
                                <p class="text-center text-muted">Carregando...</p>
                            </div>
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-warning"><i class="fas fa-save me-2"></i>Atualizar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const inversoresData = {{ inversores|tojson|safe }};

function abrirModalCriar() {
    document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-plus me-2"></i>Novo Inversor Solar';
    document.getElementById('li-visualizar').style.display = 'none';
    document.getElementById('li-editar').style.display = 'none';
    document.getElementById('tab-criar').click();
    document.getElementById('formCriar').reset();
}

function visualizarInversor(id) {
    const inv = inversoresData.find(i => i.id === id);
    if (!inv) return;

    document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-eye me-2"></i>Visualizar Inversor';
    document.getElementById('li-visualizar').style.display = 'block';
    document.getElementById('li-editar').style.display = 'block';

    document.getElementById('conteudoVisualizar').innerHTML = `
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card bg-dark border-info">
                    <div class="card-header bg-gradient-info"><h6 class="mb-0">Informações Básicas</h6></div>
                    <div class="card-body">
                        <p><strong>Fabricante:</strong> ${inv.fabricante}</p>
                        <p><strong>Modelo:</strong> ${inv.modelo}</p>
                        <p><strong>Tipo:</strong> ${inv.tipo}</p>
                        <p><strong>Fases:</strong> ${inv.fases}</p>
                        <p><strong>Potência Nominal:</strong> ${inv.potencia_nominal} kW</p>
                        <p><strong>Potência Máxima:</strong> ${inv.potencia_maxima || 'N/A'} kW</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-dark border-warning">
                    <div class="card-header bg-gradient-warning text-dark"><h6 class="mb-0">Especificações Técnicas</h6></div>
                    <div class="card-body">
                        <p><strong>Eficiência Máxima:</strong> ${inv.eficiencia_maxima || 'N/A'}%</p>
                        <p><strong>Número de MPPTs:</strong> ${inv.num_mppt}</p>
                        <p><strong>Strings por MPPT:</strong> ${inv.strings_por_mppt || 'N/A'}</p>
                        <p><strong>Tensão Entrada:</strong> ${inv.tensao_entrada_min || 'N/A'} - ${inv.tensao_entrada_max || 'N/A'} V</p>
                        <p><strong>Garantia:</strong> ${inv.garantia_anos} anos</p>
                        <p><strong>Grau Proteção:</strong> ${inv.grau_protecao || 'N/A'}</p>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card bg-dark border-success">
                    <div class="card-header bg-gradient-success"><h6 class="mb-0">Precificação</h6></div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <p><strong>Preço de Venda:</strong> <span class="text-success fs-4">R$ ${inv.preco_venda.toFixed(2)}</span></p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Preço de Custo:</strong> R$ ${inv.preco_custo ? inv.preco_custo.toFixed(2) : '0.00'}</p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Preço/kW:</strong> R$ ${(inv.preco_venda / inv.potencia_nominal).toFixed(2)}/kW</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    const modal = new bootstrap.Modal(document.getElementById('modalCRUD'));
    modal.show();
    document.getElementById('tab-visualizar').click();
}

function editarInversor(id) {
    fetch(`/energia-solar/inversores/editar/${id}`)
        .then(response => response.json())
        .then(inv => {
            // Preencher formulário de edição
            const formHtml = `
                <input type="hidden" name="inversor_id" value="${inv.id}">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Fabricante *</label>
                        <input type="text" class="form-control" name="fabricante" value="${inv.fabricante}" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Modelo *</label>
                        <input type="text" class="form-control" name="modelo" value="${inv.modelo}" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Tipo *</label>
                        <select class="form-select" name="tipo" required>
                            <option value="On-Grid" ${inv.tipo === 'On-Grid' ? 'selected' : ''}>On-Grid</option>
                            <option value="Off-Grid" ${inv.tipo === 'Off-Grid' ? 'selected' : ''}>Off-Grid</option>
                            <option value="Híbrido" ${inv.tipo === 'Híbrido' ? 'selected' : ''}>Híbrido</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Potência Nominal (kW) *</label>
                        <input type="number" step="0.01" class="form-control" name="potencia_nominal" value="${inv.potencia_nominal}" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Fases *</label>
                        <select class="form-select" name="fases" required>
                            <option value="Monofásico" ${inv.fases === 'Monofásico' ? 'selected' : ''}>Monofásico</option>
                            <option value="Bifásico" ${inv.fases === 'Bifásico' ? 'selected' : ''}>Bifásico</option>
                            <option value="Trifásico" ${inv.fases === 'Trifásico' ? 'selected' : ''}>Trifásico</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Número de MPPTs</label>
                        <input type="number" class="form-control" name="num_mppt" value="${inv.num_mppt || 2}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Eficiência Máxima (%)</label>
                        <input type="number" step="0.1" class="form-control" name="eficiencia_maxima" value="${inv.eficiencia_maxima || ''}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Preço de Venda (R$) *</label>
                        <input type="number" step="0.01" class="form-control" name="preco_venda" value="${inv.preco_venda}" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Garantia (anos)</label>
                        <input type="number" class="form-control" name="garantia_anos" value="${inv.garantia_anos || 5}">
                    </div>
                    <div class="col-md-12 mt-3">
                        <label class="form-label"><i class="fas fa-file-pdf text-danger me-2"></i>Datasheet</label>
                        ${inv.datasheet ? `<div class="alert alert-info mb-2"><i class="fas fa-info-circle me-2"></i>Arquivo atual: ${inv.datasheet.split('/').pop()}</div>` : ''}
                        <ul class="nav nav-tabs mb-2">
                            <li class="nav-item"><button class="nav-link active" type="button" data-bs-toggle="tab" data-bs-target="#upload-edit-inv"><i class="fas fa-upload me-1"></i>Upload Novo</button></li>
                            <li class="nav-item"><button class="nav-link" type="button" data-bs-toggle="tab" data-bs-target="#link-edit-inv"><i class="fas fa-link me-1"></i>Link Externo</button></li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="upload-edit-inv">
                                <input type="file" class="form-control" name="datasheet_file" accept=".pdf,.jpg,.jpeg,.png,.webp" multiple>
                                <small class="text-muted">Você pode selecionar múltiplos arquivos</small>
                                <small class="text-muted">Deixe vazio para manter o arquivo atual</small>
                            </div>
                            <div class="tab-pane fade" id="link-edit-inv">
                                <input type="url" class="form-control" name="datasheet_url" value="${inv.datasheet && !inv.datasheet.startsWith('/static/') ? inv.datasheet : ''}" placeholder="https://exemplo.com/datasheet.pdf">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('conteudoEditar').innerHTML = formHtml;
            document.getElementById('formEditar').action = `/energia-solar/inversores/editar/${id}`;
            document.getElementById('li-editar').style.display = 'block';
            document.getElementById('tab-editar').click();
            
            const modal = new bootstrap.Modal(document.getElementById('modalCRUD'));
            modal.show();
        })
        .catch(error => {
            console.error('Erro ao carregar inversor:', error);
            alert('Erro ao carregar dados do inversor!');
        });
}

function excluirInversor(id, modelo) {
    if (confirm(`Tem certeza que deseja excluir o inversor "${modelo}"?`)) {
        fetch(`/energia-solar/inversores/excluir/${id}`, {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Erro ao excluir inversor!');
            }
        });
    }
}

// Função para excluir datasheet individual
async function excluirDatasheet(id, index, tipo) {
    if (!confirm('Tem certeza que deseja excluir este arquivo?')) {
        return;
    }
    
    try {
        const response = await fetch(`/energia-solar/inversores/datasheet/excluir/${id}/${index}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Erro ao excluir arquivo');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao excluir arquivo');
    }
}
</script>
{% endblock %}
