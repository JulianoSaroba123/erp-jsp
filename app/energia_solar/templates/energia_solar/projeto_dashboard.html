{% extends 'base.html' %}

{% block title %}Dashboard - Projeto #{{ projeto.id }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('energia_solar.dashboard') }}">Energia Solar</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('energia_solar.projetos_listar') }}">Projetos</a></li>
<li class="breadcrumb-item active">Dashboard #{{ projeto.id }}</li>
{% endblock %}

{% block content %}
<style>
/* Tabela normal simples sem bordas coloridas */
#tabelaCustosOrcamento {
    font-size: 0.85rem;
}

#tabelaCustosOrcamento thead th {
    background: #f8f9fa;
    color: #495057;
    font-weight: 600;
    font-size: 0.8rem;
    padding: 0.3rem 0.4rem;
    border: 1px solid #dee2e6 !important;
}

#tabelaCustosOrcamento tbody td {
    border: 1px solid #dee2e6 !important;
    padding: 0;
    vertical-align: middle;
}

#tabelaCustosOrcamento input,
#tabelaCustosOrcamento input[type="text"],
#tabelaCustosOrcamento input[type="number"] {
    width: 100%;
    border: none !important;
    border-radius: 0 !important;
    padding: 0.2rem 0.4rem;
    font-size: 0.85rem;
    background: transparent;
    box-shadow: none !important;
}

#tabelaCustosOrcamento input:focus,
#tabelaCustosOrcamento input[type="text"]:focus,
#tabelaCustosOrcamento input[type="number"]:focus {
    outline: none !important;
    background: #fff;
    border: none !important;
    box-shadow: none !important;
}

#tabelaCustosOrcamento .text-end {
    text-align: right;
}

#tabelaCustosOrcamento .text-center {
    text-align: center;
}

#tabelaCustosOrcamento .bg-light {
    background: #f8f9fa;
    padding: 0.2rem 0.4rem;
}

@media (max-width: 768px) {
    #tabelaCustosOrcamento {
        font-size: 0.8rem;
    }
    
    #tabelaCustosOrcamento input {
        font-size: 0.8rem;
    }
    
    #tabelaCustosOrcamento thead th {
        font-size: 0.75rem;
        padding: 0.4rem;
    }
}

.dashboard-header {
    background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);
    padding: 2rem;
    border-radius: 16px;
    margin-bottom: 2rem;
    box-shadow: 0 8px 16px rgba(8, 145, 178, 0.3);
}

.kpi-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: all 0.3s;
    border-left: 4px solid #06b6d4;
    height: 100%;
    display: flex;
    flex-direction: column;
    min-height: 200px;
}

.kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.12);
}

.kpi-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    margin-bottom: 1rem;
}

.kpi-value {
    font-size: 2rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.25rem;
}

.kpi-label {
    color: #94a3b8;
    font-size: 0.875rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
}

.action-button {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s;
    border: none;
}

.action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.toolbar {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.info-row {
    display: flex;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #334155;
}

.info-row:last-child {
    border-bottom: none;
}

.info-label {
    color: #cbd5e1;
    font-weight: 600;
    min-width: 150px;
    font-size: 0.95rem;
}

.info-value {
    color: #f1f5f9;
    font-weight: 600;
    font-size: 1rem;
}

.card-body {
    background: #1e293b;
    border-radius: 0 0 8px 8px;
}

.card {
    border: none;
    overflow: hidden;
}
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h2 class="text-white mb-2">
                    <i class="fas fa-solar-panel me-2"></i>
                    Projeto #{{ projeto.id }}
                </h2>
                <h4 class="text-white opacity-90">{{ projeto.nome_cliente }}</h4>
                <p class="text-white opacity-75 mb-0">
                    <i class="fas fa-map-marker-alt me-2"></i>
                    {{ projeto.cidade }}/{{ projeto.estado }}
                </p>
            </div>
            <div class="col-md-6 text-end">
                <!-- Status Badges -->
                <div class="mb-3">
                    {% set status_orc = projeto.status_orcamento if projeto.status_orcamento else 'pendente' %}
                    {% if status_orc == 'aprovado' %}
                        <span class="status-badge bg-success text-white me-2">
                            <i class="fas fa-check-circle me-2"></i>ORÇAMENTO APROVADO
                        </span>
                    {% elif status_orc == 'em_analise' %}
                        <span class="status-badge bg-warning text-dark me-2">
                            <i class="fas fa-clock me-2"></i>EM ANÁLISE
                        </span>
                    {% else %}
                        <span class="status-badge bg-secondary text-white me-2">
                            <i class="fas fa-hourglass-start me-2"></i>ORÇAMENTO PENDENTE
                        </span>
                    {% endif %}
                    
                    <span class="status-badge bg-{{ 'success' if projeto.status == 'aprovado' else 'warning' if projeto.status == 'rascunho' else 'info' }} text-white">
                        {{ projeto.status.upper() if projeto.status else 'RASCUNHO' }}
                    </span>
                </div>
                
                {% if projeto.previsao_entrega %}
                <p class="text-white mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Previsão: {{ projeto.previsao_entrega.strftime('%d/%m/%Y') if projeto.previsao_entrega else 'Não definida' }}
                </p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-4">
        <!-- Capacidade -->
        <div class="col-md-3">
            <div class="kpi-card">
                <div class="kpi-icon bg-gradient-primary text-white">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="kpi-value">{{ "%.2f"|format(projeto.potencia_kwp or 0) }} kWp</div>
                <div class="kpi-label">Capacidade do Sistema</div>
                <small class="text-muted">{{ projeto.qtd_placas or 0 }} módulos solares</small>
            </div>
        </div>

        <!-- Consumo -->
        <div class="col-md-3">
            <div class="kpi-card" style="border-left-color: #f59e0b;">
                <div class="kpi-icon text-white" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="kpi-value">{{ "%.0f"|format(projeto.consumo_kwh_mes or 0) }} kWh</div>
                <div class="kpi-label">Consumo Mensal</div>
                <small class="text-muted">{{ "%.0f"|format((projeto.consumo_kwh_mes or 0) * 12) }} kWh/ano</small>
            </div>
        </div>

        <!-- Economia -->
        <div class="col-md-3">
            <div class="kpi-card" style="border-left-color: #10b981;">
                <div class="kpi-icon text-white" style="background: linear-gradient(135deg, #10b981, #34d399);">
                    <i class="fas fa-piggy-bank"></i>
                </div>
                <div class="kpi-value">R$ {{ "{:,.0f}".format(economia_mensal).replace(',', '.') }}</div>
                <div class="kpi-label">Economia Mensal</div>
                <small class="text-muted">R$ {{ "{:,.0f}".format(economia_anual).replace(',', '.') }}/ano</small>
            </div>
        </div>

        <!-- Valor -->
        <div class="col-md-3">
            <div class="kpi-card" style="border-left-color: #8b5cf6;">
                <div class="kpi-icon text-white" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa);">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="kpi-value">R$ {{ "{:,.2f}".format(projeto.valor_venda or 0).replace(',', 'X').replace('.', ',').replace('X', '.') }}</div>
                <div class="kpi-label">Valor do Projeto</div>
                <small class="text-muted">Payback: {{ "%.1f"|format(projeto.payback_anos or 0) }} anos</small>
            </div>
        </div>
    </div>

    <!-- Botões de Ação -->
    <div class="toolbar mb-4">
        <div class="d-flex flex-wrap gap-2 align-items-center">
            {% if projeto.cliente_id %}
            <a href="{{ url_for('cliente.editar', id=projeto.cliente_id) }}" 
               class="btn btn-primary action-button">
                <i class="fas fa-user-edit me-2"></i>Editar Cliente
            </a>
            {% else %}
            <a href="{{ url_for('cliente.novo') }}" 
               class="btn btn-primary action-button">
                <i class="fas fa-user-plus me-2"></i>Cadastrar Cliente
            </a>
            {% endif %}
            
            <button class="btn btn-info action-button text-white"
                    data-bs-toggle="modal" 
                    data-bs-target="#modalDadosTecnicos">
                <i class="fas fa-solar-panel me-2"></i>Dados Técnicos
            </button>
            
            <button class="btn btn-success action-button" 
                    data-bs-toggle="modal" 
                    data-bs-target="#modalDadosFinanceiros">
                <i class="fas fa-dollar-sign me-2"></i>Dados Financeiros
            </button>
            
            <button class="btn btn-warning action-button text-dark"
                    data-bs-toggle="modal" 
                    data-bs-target="#modalOrcamento">
                <i class="fas fa-edit me-2"></i>Editar Orçamento
            </button>
            
            <button class="btn btn-purple action-button text-white" 
                    style="background: linear-gradient(135deg, #8b5cf6, #a78bfa);"
                    data-bs-toggle="modal" 
                    data-bs-target="#modalFinanciamento">
                <i class="fas fa-credit-card me-2"></i>Financiamento
            </button>
            
            <button class="btn btn-secondary action-button"
                    data-bs-toggle="modal" 
                    data-bs-target="#modalChavesDocumentos">
                <i class="fas fa-key me-2"></i>Chaves de Documentos
            </button>
            
            <div class="ms-auto">
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-tools me-2"></i>Ferramentas
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#"><i class="fas fa-file-pdf me-2"></i>Gerar Proposta PDF</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-table me-2"></i>Tabela 12 Anos</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-chart-bar me-2"></i>Tabela 25 Anos</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-file-word me-2"></i>Gerar Documento</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Informações Detalhadas -->
    <div class="row g-4">
        <!-- Dados do Sistema -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Dados do Sistema</h5>
                </div>
                <div class="card-body">
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-solar-panel me-2"></i>Módulos:</span>
                        <span class="info-value">{{ projeto.qtd_placas or 0 }} x {{ placa.modelo if placa else 'N/D' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-microchip me-2"></i>Inversor:</span>
                        <span class="info-value">{{ projeto.qtd_inversores or 0 }} x {{ inversor.modelo if inversor else 'N/D' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-bolt me-2"></i>Conexão:</span>
                        <span class="info-value">
                            {% if projeto.tipo_instalacao == 'monofasica' %}Monofásico
                            {% elif projeto.tipo_instalacao == 'bifasica' %}Bifásico
                            {% elif projeto.tipo_instalacao == 'trifasica' %}Trifásico
                            {% elif projeto.circuito %}{{ projeto.circuito }}
                            {% else %}Não definido{% endif %}
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-ruler-combined me-2"></i>Área Necessária:</span>
                        <span class="info-value">{{ "%.2f"|format(projeto.area_necessaria or 0) }} m²</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-sun me-2"></i>Produção Estimada:</span>
                        <span class="info-value">{{ "%.0f"|format((projeto.potencia_kwp or 0) * 1300) }} kWh/ano</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dados Comerciais -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Dados Comerciais</h5>
                </div>
                <div class="card-body">
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-hand-holding-usd me-2"></i>Valor de Venda:</span>
                        <span class="info-value text-success">R$ {{ "{:,.2f}".format(projeto.valor_venda or 0).replace(',', 'X').replace('.', ',').replace('X', '.') }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-calculator me-2"></i>Custo do Projeto:</span>
                        <span class="info-value">R$ {{ "{:,.2f}".format(projeto.custo_total or 0).replace(',', 'X').replace('.', ',').replace('X', '.') }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-percentage me-2"></i>Margem de Lucro:</span>
                        <span class="info-value text-primary">{{ "%.1f"|format(((projeto.valor_venda or 0) - (projeto.custo_total or 0)) / (projeto.custo_total or 1) * 100) }}%</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-clock me-2"></i>Payback:</span>
                        <span class="info-value">{{ "%.1f"|format(projeto.payback_anos or 0) }} anos</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-calendar-check me-2"></i>Data de Criação:</span>
                        <span class="info-value">{{ projeto.data_criacao.strftime('%d/%m/%Y') if projeto.data_criacao else 'N/D' }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Modal Dados Técnicos -->
<div class="modal fade" id="modalDadosTecnicos" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('energia_solar.projeto_salvar_dados_tecnicos', projeto_id=projeto.id) }}" onsubmit="handleSalvarDadosTecnicos(event)">
                <div class="modal-header" style="background: linear-gradient(135deg, #17a2b8, #20c997);">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-solar-panel me-2"></i>Dados Técnicos
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Sub-Abas -->
                    <ul class="nav nav-tabs mb-4" id="dadosTecnicosTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tab-dados-iniciais" data-bs-toggle="tab" data-bs-target="#dadosIniciais" type="button">
                                <i class="fas fa-info-circle me-1"></i>1. Dados iniciais
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-metodo" data-bs-toggle="tab" data-bs-target="#metodo" type="button">
                                <i class="fas fa-calculator me-1"></i>2. Método
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-ajustes" data-bs-toggle="tab" data-bs-target="#ajustes" type="button">
                                <i class="fas fa-sliders-h me-1"></i>3. Ajustes
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-demais" data-bs-toggle="tab" data-bs-target="#demaisInfo" type="button">
                                <i class="fas fa-info me-1"></i>4. Demais Informações
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Aba 1: Dados iniciais -->
                        <div class="tab-pane fade show active" id="dadosIniciais">
                            <!-- Seleção de Cliente -->
                            <div class="card mb-3 border-primary">
                                <div class="card-body bg-light">
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-8">
                                            <label class="form-label fw-bold mb-1">
                                                <i class="fas fa-user me-2 text-primary"></i>VINCULAR CLIENTE AO PROJETO
                                            </label>
                                            <select class="form-select" id="select_cliente" name="cliente_id" onchange="selecionarCliente(this.value)">
                                                <option value="">Selecione um cliente...</option>
                                                {% if clientes_disponiveis %}
                                                    {% for c in clientes_disponiveis %}
                                                    <option value="{{ c.id }}" 
                                                            data-cidade="{{ c.cidade or '' }}"
                                                            data-estado="{{ c.estado or '' }}"
                                                            {% if projeto.cliente_id == c.id %}selected{% endif %}>
                                                        {{ c.nome }} - {{ c.cidade or 'Sem cidade' }}/{{ c.estado or 'UF' }}
                                                    </option>
                                                    {% endfor %}
                                                {% endif %}
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <a href="{{ url_for('cliente.novo') }}" target="_blank" class="btn btn-success w-100">
                                                <i class="fas fa-plus me-2"></i>Novo Cliente
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <label class="form-label fw-bold">CIDADE:</label>
                                    <input type="text" class="form-control" id="campo_cidade" name="cidade" value="{{ projeto.cidade or '' }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label fw-bold">ESTADO:</label>
                                    <input type="text" class="form-control" id="campo_estado" name="estado" value="{{ projeto.estado or '' }}">
                                </div>
                            </div>

                            <h6 class="text-primary border-bottom pb-2 mb-3">INSTALAÇÃO</h6>
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">LATITUDE</label>
                                    <input type="number" step="0.00001" class="form-control" id="campo_latitude" name="latitude" value="{{ projeto.latitude or '' }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">LONGITUDE</label>
                                    <input type="number" step="0.00001" class="form-control" id="campo_longitude" name="longitude" value="{{ projeto.longitude or '' }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">IRRADIAÇÃO SOLAR (kWh/m².dia)</label>
                                    <input type="number" step="0.01" class="form-control" name="irradiacao_solar" value="{{ projeto.irradiacao_solar or '' }}">
                                </div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">TIPO DE CONEXÃO</label>
                                    <select class="form-select" id="tipo_instalacao_aba1" name="tipo_instalacao">
                                        <option value="monofasica" {% if projeto.tipo_instalacao == 'monofasica' %}selected{% endif %}>MONOFÁSICA</option>
                                        <option value="bifasica" {% if projeto.tipo_instalacao == 'bifasica' %}selected{% endif %}>BIFÁSICA</option>
                                        <option value="trifasica" {% if projeto.tipo_instalacao == 'trifasica' %}selected{% endif %}>TRIFÁSICA</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">PERDA DE REND. (%)</label>
                                    <input type="number" step="0.1" class="form-control" name="perdas_sistema" value="{{ "%.0f"|format((projeto.perdas_sistema or 0.2) * 100) }}">
                                    <small class="text-muted">Valor em porcentagem (ex: 20)</small>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">CONSUMO MÉDIO MENSAL (kWh)</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" class="form-control" id="consumo_kwh_mes" name="consumo_kwh_mes" value="{{ projeto.consumo_kwh_mes or '' }}">
                                        <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalHistoricoConsumo" title="Calcular consumo">
                                            <i class="fas fa-calculator"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">Clique no botão para calcular</small>
                                </div>
                            </div>

                            <!-- Seção: Múltiplas Unidades Consumidoras -->
                            <div class="mt-4 p-3" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border-left: 4px solid #28a745;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h6 class="mb-1 fw-bold" style="color: #28a745;">
                                            <i class="fas fa-building me-2"></i>MÚLTIPLAS UNIDADES CONSUMIDORAS
                                        </h6>
                                        <small style="color: #495057; font-weight: 500;">Adicione todas as residências/empresas que farão parte do sistema</small>
                                    </div>
                                    <button type="button" class="btn btn-success btn-sm" onclick="abrirModalAdicionarUnidade()">
                                        <i class="fas fa-plus me-1"></i>ADICIONAR UNIDADE
                                    </button>
                                </div>
                                
                                <!-- Lista de Unidades Adicionadas -->
                                <div id="listaUnidades" class="mt-3">
                                    <!-- Será preenchido via JavaScript -->
                                </div>
                                
                                <!-- Resumo do Consumo Total -->
                                <div class="mt-3 p-2" style="background: white; border-radius: 8px; border: 2px dashed #28a745;">
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <small class="d-block fw-bold" style="color: #495057;">TOTAL DE UNIDADES</small>
                                            <strong id="totalUnidades" style="color: #28a745; font-size: 1.2rem;">0</strong>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="d-block fw-bold" style="color: #495057;">CONSUMO TOTAL (kWh/mês)</small>
                                            <strong id="consumoTotalUnidades" style="color: #007bff; font-size: 1.2rem;">0.00</strong>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="d-block fw-bold" style="color: #495057;">CONSUMO MÉDIO POR UNIDADE</small>
                                            <strong id="consumoMedioPorUnidade" style="color: #212529; font-size: 1.2rem;">0.00</strong>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="d-block fw-bold" style="color: #495057;">SISTEMA DIMENSIONADO PARA</small>
                                            <strong id="consumoParaDimensionamento" style="color: #28a745; font-size: 1.2rem;">0 kWh</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Aba 2: Método -->
                        <div class="tab-pane fade" id="metodo">
                            <!-- Resultado do Cálculo no Topo -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label class="fw-bold text-muted small">CAPACIDADE DO SISTEMA</label>
                                    <h4 class="text-primary mb-0" id="potencia_display">{{ "%.2f"|format(projeto.potencia_kwp or 0) }} kWp</h4>
                                </div>
                                <div class="col-md-6">
                                    <label class="fw-bold text-muted small">GERAÇÃO MENSAL MÉDIA</label>
                                    <h4 class="text-success mb-0" id="geracao_display">{{ "%.2f"|format(projeto.geracao_estimada_mes or 0) }} kWh</h4>
                                </div>
                            </div>

                            <h6 class="text-primary border-bottom pb-2 mb-3">MÉTODO DE DIMENSIONAMENTO</h6>
                            
                            <!-- Escolha do Método -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="modo_equipamento" id="modo_placas" value="individual" onchange="alterarMetodoDimensionamento('individual')" {% if projeto.modo_equipamento != 'kit' %}checked{% endif %}>
                                        <label class="btn btn-outline-primary" for="modo_placas">
                                            <i class="fas fa-solar-panel me-2"></i>PLACAS SOLARES
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="modo_equipamento" id="modo_kit" value="kit" onchange="alterarMetodoDimensionamento('kit')" {% if projeto.modo_equipamento == 'kit' %}checked{% endif %}>
                                        <label class="btn btn-outline-success" for="modo_kit">
                                            <i class="fas fa-box me-2"></i>KIT FOTOVOLTAICO
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Formulário: Placas Solares -->
                            <div id="form_placas" style="display: {% if projeto.modo_equipamento != 'kit' %}block{% else %}none{% endif %};">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">PLACA ESCOLHIDA <span class="text-danger">*</span></label>
                                        <select class="form-select" id="placa_id" name="placa_id" onchange="calcularPotenciaPlacas()">
                                            <option value="">Selecione uma placa...</option>
                                            {% for p in placas_disponiveis %}
                                            <option value="{{ p.id }}" 
                                                    data-potencia="{{ p.potencia }}"
                                                    data-modelo="{{ p.modelo }}"
                                                    data-fabricante="{{ p.fabricante }}"
                                                    data-largura="{{ p.largura or 992 }}"
                                                    data-comprimento="{{ p.comprimento or 1650 }}"
                                                    {% if projeto.placa_id == p.id %}selected{% endif %}>
                                                {{ p.modelo }} / {{ p.fabricante }} / {{ p.potencia }}W
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">QUANTIDADE DE PLACAS <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" id="qtd_placas_input" name="qtd_placas" value="{{ projeto.qtd_placas or 0 }}" min="1" oninput="calcularPotenciaPlacas()">
                                    </div>
                                </div>
                            </div>

                            <!-- Formulário: Kit Fotovoltaico -->
                            <div id="form_kit" style="display: {% if projeto.modo_equipamento == 'kit' %}block{% else %}none{% endif %};">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">SELECIONE O KIT <span class="text-danger">*</span></label>
                                        <select class="form-select" id="kit_id" name="kit_id" onchange="calcularPotenciaKit()">
                                            <option value="">Selecione um kit...</option>
                                            {% for k in kits_disponiveis %}
                                            <option value="{{ k.id }}"
                                                    data-potencia="{{ k.potencia_kwp }}"
                                                    data-qtd-placas="{{ k.qtd_placas }}"
                                                    data-placa-id="{{ k.placa_id }}"
                                                    data-descricao="{{ k.descricao }}"
                                                    {% if projeto.kit_id == k.id %}selected{% endif %}>
                                                {{ k.descricao }} - {{ k.potencia_kwp }} kWp ({{ k.qtd_placas }} placas)
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Seção PLACAS SOLARES (sempre visível) -->
                            <h6 class="text-primary border-bottom pb-2 mb-3">PLACAS SOLARES</h6>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="fw-bold text-muted small">QTD.</label>
                                    <div class="border rounded p-2 bg-light">
                                        <span id="qtd_placas_display" class="text-dark fw-bold">{{ projeto.qtd_placas or 0 }}</span>
                                        <button type="button" class="btn btn-sm btn-link p-0 ms-2" onclick="incrementarPlacas(-1)">
                                            <i class="fas fa-minus-circle text-danger"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-link p-0 ms-1" onclick="incrementarPlacas(1)">
                                            <i class="fas fa-plus-circle text-success"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="fw-bold text-muted small">PLACA ESCOLHIDA</label>
                                    <div class="border rounded p-2 bg-light">
                                        <span id="placa_info_display" class="text-dark">
                                            {% if placa %}
                                            {{ placa.modelo }} / {{ placa.fabricante }} / {{ placa.potencia }}W
                                            {% else %}-{% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Campo PERDA DE EFICIÊNCIA ANUAL -->
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">PERDA DE EFICIÊNCIA ANUAL (%) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="perda_eficiencia_anual" name="perda_eficiencia_anual" value="{{ projeto.perda_eficiencia_anual or 0.8 }}" min="0" max="100" step="0.1">
                                </div>
                            </div>
                        </div>

                        <!-- Aba 3: Ajustes -->
                        <div class="tab-pane fade" id="ajustes">
                            <!-- INVERSORES -->
                            <h6 class="text-primary mb-3"><i class="fas fa-microchip me-2"></i>INVERSORES</h6>
                            
                            <div class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <label class="fw-bold text-muted small">POTÊNCIA MÍNIMA</label>
                                    <div class="border rounded p-3 bg-light">
                                        <h5 class="text-dark mb-0" id="potencia_minima_inversor">{{ "%.2f"|format((projeto.potencia_kwp or 0) * 0.8) }} kW</h5>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="usar_micro_inversor" name="usar_micro_inversor" {% if projeto.usar_micro_inversor %}checked{% endif %}>
                                        <label class="form-check-label fw-bold" for="usar_micro_inversor">
                                            USAR MICRO INVERSOR
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <label class="fw-bold text-muted small d-block">&nbsp;</label>
                                    <button type="button" class="btn btn-success" onclick="buscarInversor()">
                                        <i class="fas fa-search me-2"></i>BUSCAR
                                    </button>
                                </div>
                            </div>

                            <div class="row g-3 mb-4">
                                <div class="col-md-8">
                                    <label class="form-label fw-bold">INVERSOR <span class="text-danger">*</span></label>
                                    <select class="form-select" id="inversor_id" name="inversor_id" onchange="atualizarInfoInversor()">
                                        <option value="">Selecione um inversor...</option>
                                        {% for inv in inversores_disponiveis %}
                                        <option value="{{ inv.id }}"
                                                data-modelo="{{ inv.modelo }}"
                                                data-fabricante="{{ inv.fabricante }}"
                                                data-potencia="{{ inv.potencia }}"
                                                {% if projeto.inversor_id == inv.id %}selected{% endif %}>
                                            {{ inv.fabricante }} / {{ inv.modelo }} / {{ inv.potencia }} kW
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">QTD. <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="qtd_inversores" name="qtd_inversores" value="{{ projeto.qtd_inversores or 1 }}" min="1">
                                </div>
                            </div>

                            <!-- ÁREA DE INSTALAÇÃO -->
                            <h6 class="text-primary mb-3"><i class="fas fa-ruler-combined me-2"></i>ÁREA DE INSTALAÇÃO</h6>
                            
                            <!-- Card: Distribuição das Placas -->
                            <div class="card mb-3" style="border-left: 4px solid #3b82f6;">
                                <div class="card-header bg-light">
                                    <strong>DISTRIBUIÇÃO DAS PLACAS</strong>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">LINHAS DE PLACAS <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control form-control-lg" id="linhas_placas" name="linhas_placas" value="{{ projeto.linhas_placas or 1 }}" min="1" oninput="atualizarLayoutVisual()">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">COLUNAS DE PLACAS <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control form-control-lg" id="colunas_placas" name="colunas_placas" value="{{ projeto.colunas_placas or 1 }}" min="1" oninput="atualizarLayoutVisual()">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">ÁREA NECESSÁRIA (M²)</label>
                                            <input type="text" class="form-control form-control-lg bg-light" id="area_total_display" value="{{ '%.2f'|format(projeto.largura_area * projeto.comprimento_area if projeto.largura_area and projeto.comprimento_area else 0) }}" readonly>
                                            <!-- Campos hidden para salvar largura e comprimento -->
                                            <input type="hidden" name="largura_area" id="largura_area" value="{{ projeto.largura_area or 0 }}">
                                            <input type="hidden" name="comprimento_area" id="comprimento_area" value="{{ projeto.comprimento_area or 0 }}">
                                        </div>
                                    </div>

                                    <!-- Visualização do Layout -->
                                    <div class="border rounded p-4" style="background: linear-gradient(135deg, #0f172a, #1e293b); border: 2px solid #06b6d4 !important;">
                                        <h6 class="text-info mb-3">
                                            <i class="fas fa-eye me-2"></i>Visualização do Layout
                                        </h6>
                                        <div class="bg-dark rounded p-4 text-center" style="min-height: 200px; display: flex; align-items: center; justify-content: center; border: 1px solid #334155;">
                                            <div id="layout_preview">
                                                <div id="layout_grid" class="d-inline-flex flex-wrap justify-content-center gap-2 mb-3" style="max-width: 600px;">
                                                    <!-- Grid será gerado por JavaScript -->
                                                </div>
                                                <p class="text-info mb-0" id="layout_info">
                                                    <strong><span id="total_modulos">{{ projeto.qtd_placas or 0 }}</span> módulos</strong> organizados em 
                                                    <strong><span id="info_linhas">{{ projeto.linhas_placas or 1 }}</span> linhas × <span id="info_colunas">{{ projeto.colunas_placas or 1 }}</span> colunas</strong>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Card: Área de Instalação Calculada -->
                            <div class="card mb-3" style="border-left: 4px solid #10b981;">
                                <div class="card-header bg-light">
                                    <strong>DIMENSÕES DA ÁREA</strong>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">ORIENTAÇÃO <span class="text-danger">*</span></label>
                                            <select class="form-select form-select-lg" id="orientacao" name="orientacao" onchange="atualizarLayoutVisual()">
                                                <option value="RETRATO" {% if projeto.orientacao == 'RETRATO' %}selected{% endif %}>RETRATO</option>
                                                <option value="PAISAGEM" {% if projeto.orientacao == 'PAISAGEM' %}selected{% endif %}>PAISAGEM</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="fw-bold text-muted small">LARGURA</label>
                                            <div class="border rounded p-3 bg-light">
                                                <h5 class="text-success mb-0" id="largura_display">{{ "%.2f"|format(projeto.largura_area or 0) }} m</h5>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="fw-bold text-muted small">COMPRIMENTO</label>
                                            <div class="border rounded p-3 bg-light">
                                                <h5 class="text-success mb-0" id="comprimento_display">{{ "%.2f"|format(projeto.comprimento_area or 0) }} m</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Aba 4: Demais Informações -->
                        <div class="tab-pane fade" id="demaisInfo">
                            <!-- LEI 14.300 -->
                            <h6 class="text-primary mb-3"><i class="fas fa-file-contract me-2"></i>LEI 14.300</h6>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">ANO DE INSTALAÇÃO <span class="text-danger">*</span></label>
                                    <select class="form-select form-select-lg" name="lei_14300_ano">
                                        {% for ano in range(2022, 2033) %}
                                        <option value="{{ ano }}" {% if projeto.lei_14300_ano == ano %}selected{% endif %}>{{ ano }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">SIMULTANEIDADE (%)</label>
                                    <input type="number" step="0.1" class="form-control form-control-lg" name="simultaneidade" value="{{ projeto.simultaneidade or 35 }}">
                                </div>
                            </div>

                            <!-- PADRÃO DE ENTRADA -->
                            <h6 class="text-primary mb-3"><i class="fas fa-bolt me-2"></i>PADRÃO DE ENTRADA</h6>
                            <div class="card mb-4" style="border-left: 4px solid #8b5cf6;">
                                <div class="card-header bg-light">
                                    <strong>CONFIGURAÇÃO DO PADRÃO</strong>
                                </div>
                                <div class="card-body">
                                    <div class="row g-2 align-items-end">
                                        <div class="col-12 col-md-2">
                                            <label class="form-label fw-bold small">TIPO DE ENTRADA <span class="text-danger">*</span></label>
                                            <select class="form-select" name="tipo_entrada" id="tipo_entrada">
                                                <option value="monofasico" {% if (projeto.tipo_instalacao == 'monofasica') or (projeto.qtd_fases == 1 and not projeto.tipo_instalacao) %}selected{% endif %}>MONOFÁSICO</option>
                                                <option value="bifasico" {% if (projeto.tipo_instalacao == 'bifasica') or (projeto.qtd_fases == 2 and not projeto.tipo_instalacao) %}selected{% endif %}>BIFÁSICO</option>
                                                <option value="trifasico" {% if (projeto.tipo_instalacao == 'trifasica') or (projeto.qtd_fases == 3 and not projeto.tipo_instalacao) %}selected{% endif %}>TRIFÁSICO</option>
                                            </select>
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <label class="form-label fw-bold small">DISJ. GERAL (A) <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" name="disjuntor_ca" value="{{ projeto.disjuntor_ca or '63' }}" placeholder="Ex: 20, 32, 63" oninput="atualizarDiagramaUnifilar()">
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <label class="form-label fw-bold small">FASE-QTD</label>
                                            <input type="number" class="form-control bg-light" id="qtd_fases" name="qtd_fases" value="{{ projeto.qtd_fases or 2 }}" readonly>
                                        </div>
                                        <div class="col-12 col-md-3">
                                            <label class="form-label fw-bold small">FASE-BITOLA (MM²)</label>
                                            <select class="form-select" name="cabo_fase_bitola" onchange="atualizarDiagramaUnifilar()">
                                                <option value="4" {% if projeto.cabo_fase_bitola == '4' %}selected{% endif %}>4 mm²</option>
                                                <option value="6" {% if projeto.cabo_fase_bitola == '6' %}selected{% endif %}>6 mm²</option>
                                                <option value="10" {% if projeto.cabo_fase_bitola == '10' %}selected{% endif %}>10 mm²</option>
                                                <option value="16" {% if projeto.cabo_fase_bitola == '16' or not projeto.cabo_fase_bitola %}selected{% endif %}>16 mm²</option>
                                                <option value="25" {% if projeto.cabo_fase_bitola == '25' %}selected{% endif %}>25 mm²</option>
                                            </select>
                                        </div>
                                        <div class="col-12 col-md-3">
                                            <label class="form-label fw-bold small">NEUTRO-BITOLA (MM²)</label>
                                            <select class="form-select" name="cabo_neutro_bitola">
                                                <option value="4" {% if projeto.cabo_neutro_bitola == '4' %}selected{% endif %}>4 mm²</option>
                                                <option value="6" {% if projeto.cabo_neutro_bitola == '6' %}selected{% endif %}>6 mm²</option>
                                                <option value="10" {% if projeto.cabo_neutro_bitola == '10' %}selected{% endif %}>10 mm²</option>
                                                <option value="16" {% if projeto.cabo_neutro_bitola == '16' or not projeto.cabo_neutro_bitola %}selected{% endif %}>16 mm²</option>
                                                <option value="25" {% if projeto.cabo_neutro_bitola == '25' %}selected{% endif %}>25 mm²</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-6 col-md-3">
                                            <label class="form-label fw-bold">ATERRAMENTO - QTD</label>
                                            <input type="number" class="form-control form-control-lg" name="qtd_terra" value="{{ projeto.qtd_terra or 1 }}" min="1">
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <label class="form-label fw-bold">ATERRAMENTO - BITOLA (MM²)</label>
                                            <select class="form-select form-select-lg" name="cabo_terra_bitola">
                                                <option value="4" {% if projeto.cabo_terra_bitola == '4' %}selected{% endif %}>4 mm²</option>
                                                <option value="6" {% if projeto.cabo_terra_bitola == '6' %}selected{% endif %}>6 mm²</option>
                                                <option value="10" {% if projeto.cabo_terra_bitola == '10' %}selected{% endif %}>10 mm²</option>
                                                <option value="16" {% if projeto.cabo_terra_bitola == '16' or not projeto.cabo_terra_bitola %}selected{% endif %}>16 mm²</option>
                                                <option value="25" {% if projeto.cabo_terra_bitola == '25' %}selected{% endif %}>25 mm²</option>
                                            </select>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <label class="form-label fw-bold">OBSERVAÇÕES DO PADRÃO</label>
                                            <input type="text" class="form-control form-control-lg" name="padrao_observacoes" value="{{ projeto.padrao_observacoes or '' }}" placeholder="Ex: Padrão aéreo, cabo de alumínio">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- STRING BOX - PROTEÇÕES -->
                            <h6 class="text-primary mb-3"><i class="fas fa-shield-alt me-2"></i>STRING BOX - PROTEÇÕES</h6>
                            <div class="card mb-4" style="border-left: 4px solid #f59e0b;">
                                <div class="card-header bg-light">
                                    <strong>PROTEÇÃO CC (CORRENTE CONTÍNUA)</strong>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">TIPO DE PROTEÇÃO</label>
                                            <select class="form-select" id="protecao_cc_tipo" name="protecao_cc_tipo" onchange="atualizarDiagramaUnifilar()">
                                                <option value="">Selecione...</option>
                                                <option value="fusivel" {% if projeto.protecao_cc_tipo == 'fusivel' %}selected{% endif %}>Fusível</option>
                                                <option value="disjuntor" {% if projeto.protecao_cc_tipo == 'disjuntor' %}selected{% endif %}>Disjuntor CC</option>
                                                <option value="seccionador" {% if projeto.protecao_cc_tipo == 'seccionador' %}selected{% endif %}>Seccionador</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">CORRENTE NOMINAL (A)</label>
                                            <input type="text" class="form-control" name="protecao_cc_corrente" value="{{ projeto.protecao_cc_corrente or '' }}" placeholder="Ex: 10, 15, 20" oninput="atualizarDiagramaUnifilar()">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-4" style="border-left: 4px solid #10b981;">
                                <div class="card-header bg-light">
                                    <strong>PROTEÇÃO CA (CORRENTE ALTERNADA)</strong>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">TIPO DE PROTEÇÃO</label>
                                            <select class="form-select" id="protecao_ca_tipo" name="protecao_ca_tipo" onchange="atualizarDiagramaUnifilar()">
                                                <option value="">Selecione...</option>
                                                <option value="disjuntor" {% if projeto.protecao_ca_tipo == 'disjuntor' %}selected{% endif %}>Disjuntor CA</option>
                                                <option value="dps" {% if projeto.protecao_ca_tipo == 'dps' %}selected{% endif %}>DPS (Protetor de Surto)</option>
                                                <option value="ambos" {% if projeto.protecao_ca_tipo == 'ambos' %}selected{% endif %}>Disjuntor + DPS</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">CORRENTE NOMINAL (A)</label>
                                            <input type="text" class="form-control" name="protecao_ca_corrente" value="{{ projeto.protecao_ca_corrente or '' }}" placeholder="Ex: 20, 32, 40" oninput="atualizarDiagramaUnifilar()">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- CABOS -->
                            <h6 class="text-primary mb-3"><i class="fas fa-plug me-2"></i>CABOS</h6>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">CABO CA - BITOLA (MM²)</label>
                                    <select class="form-select form-select-lg" name="cabo_ca" onchange="atualizarDiagramaUnifilar()">
                                        <option value="4" {% if projeto.cabo_ca == '4' %}selected{% endif %}>4 mm²</option>
                                        <option value="6" {% if projeto.cabo_ca == '6' %}selected{% endif %}>6 mm²</option>
                                        <option value="10" {% if projeto.cabo_ca == '10' %}selected{% endif %}>10 mm²</option>
                                        <option value="16" {% if projeto.cabo_ca == '16' or not projeto.cabo_ca %}selected{% endif %}>16 mm²</option>
                                        <option value="25" {% if projeto.cabo_ca == '25' %}selected{% endif %}>25 mm²</option>
                                    </select>
                                    <small class="text-muted">Usado para Fase, Neutro e Aterramento</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">CABO CC - BITOLA (MM²)</label>
                                    <select class="form-select form-select-lg" name="cabo_cc" onchange="atualizarDiagramaUnifilar()">
                                        <option value="4" {% if projeto.cabo_cc == '4' %}selected{% endif %}>4 mm²</option>
                                        <option value="6" {% if projeto.cabo_cc == '6' or not projeto.cabo_cc %}selected{% endif %}>6 mm²</option>
                                        <option value="10" {% if projeto.cabo_cc == '10' %}selected{% endif %}>10 mm²</option>
                                        <option value="16" {% if projeto.cabo_cc == '16' %}selected{% endif %}>16 mm²</option>
                                        <option value="25" {% if projeto.cabo_cc == '25' %}selected{% endif %}>25 mm²</option>
                                    </select>
                                </div>
                            </div>

                            <!-- DIAGRAMA UNIFILAR -->
                            <h6 class="text-primary mb-3"><i class="fas fa-project-diagram me-2"></i>DIAGRAMA UNIFILAR</h6>
                            <div class="card" style="border-left: 4px solid #8b5cf6; background: linear-gradient(135deg, #0f172a, #1e293b);">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-center justify-content-between position-relative">
                                        <!-- Linha conectora -->
                                        <div class="position-absolute w-100" style="top: 50%; left: 0; height: 3px; background: linear-gradient(90deg, #3b82f6, #f59e0b, #10b981, #06b6d4, #8b5cf6); z-index: 0;"></div>
                                        
                                        <!-- Card 1: Módulos -->
                                        <div class="text-center position-relative" style="z-index: 1; flex: 1;">
                                            <div class="border rounded p-2" style="background: linear-gradient(135deg, #3b82f6, #2563eb); border: 2px solid #60a5fa !important; min-height: 100px; display: flex; flex-direction: column; justify-content: center;">
                                                <i class="fas fa-solar-panel fa-lg text-white mb-1"></i>
                                                <div class="text-white fw-bold small">MÓDULOS FV</div>
                                                <small class="text-white" style="font-size: 0.7rem;" id="diagrama_qtd_placas">{{ projeto.qtd_placas or 0 }} placas</small>
                                            </div>
                                        </div>

                                        <!-- Conector 1 -->
                                        <div class="text-center position-relative" style="z-index: 1; flex: 0 0 60px;">
                                            <div class="text-warning" style="font-size: 0.65rem;">
                                                Cabo CC: <span id="diagrama_cabo_cc">{{ projeto.cabo_cc or '6' }}mm²</span>
                                            </div>
                                            <div class="text-warning"><i class="fas fa-exchange-alt"></i></div>
                                        </div>

                                        <!-- Card 2: String Box CC -->
                                        <div class="text-center position-relative" style="z-index: 1; flex: 1;">
                                            <div class="border rounded p-2" style="background: linear-gradient(135deg, #f59e0b, #d97706); border: 2px solid #fbbf24 !important; min-height: 100px; display: flex; flex-direction: column; justify-content: center;">
                                                <i class="fas fa-shield-alt fa-lg text-white mb-1"></i>
                                                <div class="text-white fw-bold small">STRING BOX CC</div>
                                                <small class="text-white" style="font-size: 0.7rem;">
                                                    <div id="diagrama_protecao_cc">{{ projeto.protecao_cc_tipo|upper or 'N/A' }}</div>
                                                    <div id="diagrama_protecao_cc_corrente">{{ projeto.protecao_cc_corrente or '-' }}A</div>
                                                </small>
                                            </div>
                                        </div>

                                        <!-- Conector 2 -->
                                        <div class="text-center position-relative" style="z-index: 1; flex: 0 0 80px;">
                                            <div class="text-success" style="font-size: 0.65rem; line-height: 1.2;">
                                                Cabo CA<br>
                                                <span id="diagrama_cabo_ca">{{ projeto.cabo_ca or '16' }}mm²</span>
                                            </div>
                                            <div class="text-success"><i class="fas fa-exchange-alt"></i></div>
                                        </div>

                                        <!-- Card 3: Inversor -->
                                        <div class="text-center position-relative" style="z-index: 1; flex: 1;">
                                            <div class="border rounded p-2" style="background: linear-gradient(135deg, #10b981, #059669); border: 2px solid #34d399 !important; min-height: 100px; display: flex; flex-direction: column; justify-content: center;">
                                                <i class="fas fa-microchip fa-lg text-white mb-1"></i>
                                                <div class="text-white fw-bold small">INVERSOR</div>
                                                <small class="text-white" style="font-size: 0.65rem;">
                                                    <div id="diagrama_inversor" style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin: 0 auto;">{{ inversor.modelo[:15] if inversor else 'N/A' }}</div>
                                                    <div id="diagrama_qtd_inversores">{{ projeto.qtd_inversores or 1 }}x</div>
                                                </small>
                                            </div>
                                        </div>

                                        <!-- Conector 3 -->
                                        <div class="text-center position-relative" style="z-index: 1; flex: 0 0 80px;">
                                            <div class="text-cyan" style="font-size: 0.65rem; line-height: 1.2;">
                                                Cabo CA<br>
                                                <span id="diagrama_cabo_ca_2">{{ projeto.cabo_ca or '16' }}mm²</span>
                                            </div>
                                            <div class="text-cyan"><i class="fas fa-exchange-alt"></i></div>
                                        </div>

                                        <!-- Card 4: Proteção CA -->
                                        <div class="text-center position-relative" style="z-index: 1; flex: 1;">
                                            <div class="border rounded p-2" style="background: linear-gradient(135deg, #06b6d4, #0891b2); border: 2px solid #22d3ee !important; min-height: 100px; display: flex; flex-direction: column; justify-content: center;">
                                                <i class="fas fa-shield-alt fa-lg text-white mb-1"></i>
                                                <div class="text-white fw-bold small">PROTEÇÃO CA</div>
                                                <small class="text-white" style="font-size: 0.7rem;">
                                                    <div id="diagrama_protecao_ca">{{ projeto.protecao_ca_tipo|upper or 'N/A' }}</div>
                                                    <div id="diagrama_protecao_ca_corrente">{{ projeto.protecao_ca_corrente or '-' }}A</div>
                                                </small>
                                            </div>
                                        </div>

                                        <!-- Conector 4 -->
                                        <div class="text-center position-relative" style="z-index: 1; flex: 0 0 90px;">
                                            <div class="text-purple" style="font-size: 0.65rem; line-height: 1.2;">
                                                Rede Entrada<br>
                                                <span id="diagrama_cabo_entrada">{{ projeto.cabo_fase_bitola or '16' }}mm²</span>
                                            </div>
                                            <div class="text-purple"><i class="fas fa-exchange-alt fa-rotate-90"></i></div>
                                        </div>

                                        <!-- Card 5: Quadro -->
                                        <div class="text-center position-relative" style="z-index: 1; flex: 1;">
                                            <div class="border rounded p-2" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: 2px solid #a78bfa !important; min-height: 100px; display: flex; flex-direction: column; justify-content: center;">
                                                <i class="fas fa-th fa-lg text-white mb-1"></i>
                                                <div class="text-white fw-bold small">QUADRO</div>
                                                <small class="text-white" style="font-size: 0.7rem;">
                                                    <div id="diagrama_disjuntor">{{ projeto.disjuntor_ca or '63' }}A</div>
                                                </small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Legenda -->
                                    <div class="mt-3 pt-2 border-top border-secondary text-center">
                                        <small class="text-info">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Diagrama atualizado automaticamente com os dados do projeto
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Campo hidden para enviar dados das unidades consumidoras -->
                <input type="hidden" id="unidades_consumidoras_json" name="unidades_consumidoras_json" value="">
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-2"></i>Salvar Dados Técnicos
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Dados Financeiros -->
<div class="modal fade" id="modalDadosFinanceiros" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('energia_solar.projeto_salvar_dados_financeiros', projeto_id=projeto.id) }}" id="formDadosFinanceiros" onsubmit="handleSalvarDadosFinanceiros(event)">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-dollar-sign me-2"></i>Dados Financeiros e Lei 14.300/2022
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Concessionária -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-bolt me-2"></i>Concessionária de Energia
                            </h6>
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    Selecione a Concessionária
                                    <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="concessionaria_id" name="concessionaria_id" required>
                                    <option value="">Escolha uma concessionária...</option>
                                    {% for conc in concessionarias %}
                                    <option value="{{ conc.id }}" 
                                            data-te="{{ conc.te }}"
                                            data-tusd="{{ conc.tusd }}"
                                            data-pis="{{ conc.pis }}"
                                            data-cofins="{{ conc.cofins }}"
                                            data-icms="{{ conc.icms }}"
                                            data-tarifa-total="{{ conc.tarifa_total }}"
                                            data-tarifa-final="{{ conc.tarifa_final }}"
                                            {% if projeto.concessionaria_id == conc.id %}selected{% endif %}>
                                        {{ conc.nome }} - {{ conc.regiao }} ({{ "%.4f"|format(conc.tarifa_final) }} R$/kWh)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Tarifas Auto-populadas -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h6 class="text-info mb-3">
                                <i class="fas fa-calculator me-2"></i>Tarifas e Impostos
                            </h6>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">TE (Tarifa de Energia)</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control" id="te_display" readonly>
                                <span class="input-group-text">/kWh</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">TUSD (Tarifa de Distribuição)</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control" id="tusd_display" readonly>
                                <span class="input-group-text">/kWh</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Tarifa Total (sem impostos)</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control bg-light fw-bold" id="tarifa_total_display" readonly>
                                <span class="input-group-text">/kWh</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Impostos Totais</label>
                            <div class="input-group">
                                <input type="text" class="form-control bg-warning" id="impostos_display" readonly>
                                <span class="input-group-text">%</span>
                            </div>
                            <input type="hidden" name="impostos_percentual" id="impostos_percentual">
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label class="form-label">PIS</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="pis_display" readonly>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">COFINS</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="cofins_display" readonly>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">ICMS</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="icms_display" readonly>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tarifa Final e Economia -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="alert alert-success">
                                <h5 class="mb-3">
                                    <i class="fas fa-hand-holding-usd me-2"></i>Resumo Financeiro
                                </h5>
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Tarifa Final (com impostos)</label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-success text-white">R$</span>
                                            <input type="text" class="form-control fw-bold fs-4" name="tarifa_final" id="tarifa_final" readonly>
                                            <span class="input-group-text bg-success text-white">/kWh</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Consumo Mensal do Cliente</label>
                                        <div class="input-group input-group-lg">
                                            <input type="text" class="form-control fw-bold fs-4" value="{{ '%.0f'|format(projeto.consumo_kwh_mes or 0) }}" readonly>
                                            <span class="input-group-text bg-primary text-white">kWh</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Economia Anual Prevista</label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-warning">R$</span>
                                            <input type="text" class="form-control fw-bold fs-4 bg-warning" name="economia_anual_prevista" id="economia_anual_prevista" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-2"></i>Salvar Dados Financeiros
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Auto-populate ao selecionar concessionária
document.getElementById('concessionaria_id').addEventListener('change', function() {
    const selected = this.options[this.selectedIndex];
    
    if (selected.value) {
        // Pegar dados da concessionária
        const te = parseFloat(selected.dataset.te);
        const tusd = parseFloat(selected.dataset.tusd);
        const pis = parseFloat(selected.dataset.pis);
        const cofins = parseFloat(selected.dataset.cofins);
        const icms = parseFloat(selected.dataset.icms);
        const tarifaTotal = parseFloat(selected.dataset.tarifaTotal);
        const tarifaFinal = parseFloat(selected.dataset.tarifaFinal);
        
        // Preencher campos
        document.getElementById('te_display').value = te.toFixed(4);
        document.getElementById('tusd_display').value = tusd.toFixed(4);
        document.getElementById('tarifa_total_display').value = tarifaTotal.toFixed(4);
        document.getElementById('pis_display').value = pis.toFixed(2);
        document.getElementById('cofins_display').value = cofins.toFixed(2);
        document.getElementById('icms_display').value = icms.toFixed(2);
        
        // Impostos totais
        const impostosTotal = pis + cofins + icms;
        document.getElementById('impostos_display').value = impostosTotal.toFixed(2);
        document.getElementById('impostos_percentual').value = impostosTotal.toFixed(2);
        
        // Tarifa final
        document.getElementById('tarifa_final').value = tarifaFinal.toFixed(4);
        
        // Calcular economia anual
        const consumoMensal = {{ projeto.consumo_kwh_mes or 0 }};
        const economiaMensal = consumoMensal * tarifaFinal;
        const economiaAnual = economiaMensal * 12;
        
        document.getElementById('economia_anual_prevista').value = economiaAnual.toFixed(2).replace('.', ',');
        
    } else {
        // Limpar campos
        document.getElementById('te_display').value = '';
        document.getElementById('tusd_display').value = '';
        document.getElementById('tarifa_total_display').value = '';
        document.getElementById('pis_display').value = '';
        document.getElementById('cofins_display').value = '';
        document.getElementById('icms_display').value = '';
        document.getElementById('impostos_display').value = '';
        document.getElementById('tarifa_final').value = '';
        document.getElementById('economia_anual_prevista').value = '';
    }
});

// Carregar dados ao abrir o modal se já tiver concessionária selecionada
document.getElementById('modalDadosFinanceiros').addEventListener('show.bs.modal', function() {
    const selectConc = document.getElementById('concessionaria_id');
    if (selectConc.value) {
        selectConc.dispatchEvent(new Event('change'));
    }
});

// Handler para salvar dados financeiros e recarregar página
function handleSalvarDadosFinanceiros(event) {
    event.preventDefault();
    const form = event.target;
    
    fetch(form.action, {
        method: 'POST',
        body: new FormData(form)
    })
    .then(response => {
        if (response.ok) {
            // Recarregar a página para atualizar os dados
            window.location.reload();
        } else {
            alert('Erro ao salvar dados financeiros');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar dados financeiros');
    });
}
</script>

<!-- Modal Orçamento -->
<div class="modal fade" id="modalOrcamento" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-white border-bottom border-primary border-3">
                <h5 class="modal-title text-dark fw-bold">
                    <i class="fas fa-edit me-2 text-primary"></i>EDITAR ORÇAMENTO
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-2 p-md-4 bg-light">
                <!-- Campos Obrigatórios -->
                <div class="alert alert-danger mb-3" style="border-left: 4px solid #dc3545;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>CAMPOS OBRIGATÓRIOS</strong>
                </div>

                <!-- Impostos -->
                <div class="row mb-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label text-muted small">IMPOSTOS (%)</label>
                        <input type="number" class="form-control" id="impostos_orcamento" value="4" step="0.01" onchange="recalcularOrcamento()">
                    </div>
                </div>

                <!-- Título Custos -->
                <h6 class="mb-3 text-primary fw-bold">CUSTOS</h6>
                <div class="d-flex gap-2 mb-3">
                    <button class="btn btn-success" onclick="adicionarItemOrcamento()" title="Adicionar item">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-secondary" title="Remover item selecionado">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="btn btn-danger" title="Limpar seleção">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-sm" id="tabelaCustosOrcamento">
                        <thead>
                            <tr>
                                <th>DESCRIÇÃO</th>
                                <th width="80">QTD.</th>
                                <th width="60">UND.</th>
                                <th width="120">VALOR UNIT.</th>
                                <th width="110">VALOR TOTAL</th>
                                <th width="100">LUCRO %</th>
                                <th width="100">TIPO</th>
                                <th width="100">AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody id="itensOrcamento">
                            <!-- Itens serão adicionados via JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Resumo do Orçamento -->
                <div class="card mt-4 border-0 shadow-sm">
                    <div class="card-body bg-white">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label text-muted small">CUSTO TOTAL</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" class="form-control fw-bold" id="totalCusto" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-muted small">LUCRO TOTAL</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" class="form-control fw-bold text-success" id="totalLucro" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-muted small">MARGEM MÉDIA</label>
                                <div class="input-group">
                                    <input type="text" class="form-control fw-bold" id="margemMedia" readonly>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-muted small">VALOR DE VENDA</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white">R$</span>
                                    <input type="text" class="form-control fw-bold fs-5 bg-primary text-white" id="totalFaturamento" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-white border-top">
                <button type="button" class="btn btn-primary btn-lg px-5" onclick="salvarOrcamento()">
                    <i class="fas fa-check me-2"></i>CONCLUIR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Custo -->
<div class="modal fade" id="modalEditarCusto" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">EDITAR CUSTO</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger mb-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>CAMPOS OBRIGATÓRIOS</strong>
                </div>
                
                <input type="hidden" id="editItemId">
                
                <div class="mb-3">
                    <label class="form-label">DESCRIÇÃO <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="editDescricao" required>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">QTD. <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="editQtd" step="0.01" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">UNIDADE DE MEDIDA <span class="text-danger">*</span></label>
                        <select class="form-select" id="editUnd" required>
                            <option value="UN">UN - Unidade</option>
                            <option value="PC">PC - Peça</option>
                            <option value="CJ">CJ - Conjunto</option>
                            <option value="KIT">KIT - Kit</option>
                            <option value="M">M - Metro</option>
                            <option value="M²">M² - Metro Quadrado</option>
                            <option value="M³">M³ - Metro Cúbico</option>
                            <option value="KG">KG - Quilograma</option>
                            <option value="L">L - Litro</option>
                            <option value="H">H - Hora</option>
                            <option value="DIA">DIA - Dia</option>
                            <option value="MÊS">MÊS - Mês</option>
                            <option value="%">% - Percentual</option>
                            <option value="KWH">KWH - Quilowatt-hora</option>
                            <option value="KWP">KWP - Quilowatt-pico</option>
                            <option value="SVC">SVC - Serviço</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">PREÇO UNITÁRIO (R$) <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="editValorUnit" step="0.01" required>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">FATURAMENTO <span class="text-danger">*</span></label>
                        <select class="form-select" id="editTipo">
                            <option value="EMPRESA">EMPRESA</option>
                            <option value="PARCEIRO">PARCEIRO</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">LUCRO (%) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="editLucro" step="0.01" required>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="salvarEdicaoCusto()">
                    <i class="fas fa-check me-2"></i>EDITAR
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Dados do orçamento
let itensOrcamento = [];

// Carregar itens ao abrir modal
document.getElementById('modalOrcamento').addEventListener('show.bs.modal', function() {
    carregarItensOrcamento();
});

// Formatar número como moeda brasileira
function formatarMoeda(valor) {
    return parseFloat(valor).toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

// Remover formatação ao focar no input
function removerFormatacao(input) {
    const valor = input.value.replace(/\./g, '').replace(',', '.');
    input.value = parseFloat(valor) || 0;
    input.type = 'number';
    input.step = '0.01';
}

// Aplicar formatação ao sair do input
function aplicarFormatacao(input, itemId) {
    const valor = parseFloat(input.value) || 0;
    input.type = 'text';
    input.value = formatarMoeda(valor);
    atualizarItem(itemId, 'valorUnit', valor);
}

// Carregar itens do orçamento
function carregarItensOrcamento() {
    itensOrcamento = [
        {id: 1, descricao: 'KIT GERADOR ENERGIA SOLAR 10,53 KWP - INVERSOR CRESCER', qtd: 1, und: 'UND', valorUnit: 14548.85, lucro: 0, tipo: 'EMPRESA'},
        {id: 2, descricao: 'COMISSÃO DE VENDEDORA', qtd: 1, und: '0,1', valorUnit: 1454.90, lucro: 0, tipo: 'EMPRESA'},
        {id: 3, descricao: 'COMISSÃO DE INDICAÇÃO', qtd: 1, und: '0,03', valorUnit: 872.00, lucro: 0, tipo: 'EMPRESA'},
        {id: 4, descricao: 'COMISSÃO DE VENDA', qtd: 1, und: '0,05', valorUnit: 0.00, lucro: 0, tipo: 'EMPRESA'},
        {id: 5, descricao: 'DESCONTO ESTADUAL', qtd: 1, und: '0,06', valorUnit: 0.00, lucro: 0, tipo: 'EMPRESA'},
        {id: 6, descricao: 'DESCONTO MUNICIPAL', qtd: 1, und: '0,02', valorUnit: 261.00, lucro: 0, tipo: 'EMPRESA'},
        {id: 7, descricao: 'DESCONTO PARA FECHAMENTO', qtd: 1, und: '0,03', valorUnit: 0.00, lucro: 0, tipo: 'EMPRESA'},
        {id: 8, descricao: 'DESLOCAMENTO', qtd: 1, und: 'UND', valorUnit: 80.00, lucro: 0, tipo: 'EMPRESA'},
        {id: 9, descricao: 'INSTALAÇÃO DOS MÓDULOS', qtd: 18, und: 'UND', valorUnit: 90.00, lucro: 5, tipo: 'EMPRESA'},
        {id: 10, descricao: 'INSTALAÇÃO INVERSORES', qtd: 1, und: 'UND', valorUnit: 90.00, lucro: 5, tipo: 'EMPRESA'},
        {id: 11, descricao: 'MATERIAL CA', qtd: 1, und: 'KIT', valorUnit: 1500.00, lucro: 3, tipo: 'EMPRESA'},
        {id: 12, descricao: 'PROJETO', qtd: 1, und: 'UND', valorUnit: 200.00, lucro: 0, tipo: 'EMPRESA'},
        {id: 13, descricao: 'TRT', qtd: 1, und: 'UND', valorUnit: 150.00, lucro: 5, tipo: 'EMPRESA'}
    ];
    
    renderizarItensOrcamento();
    recalcularOrcamento();
}

// Renderizar tabela
function renderizarItensOrcamento() {
    const tbody = document.getElementById('itensOrcamento');
    tbody.innerHTML = '';
    
    itensOrcamento.forEach((item, index) => {
        const valorTotal = item.qtd * item.valorUnit;
        const lucroValor = valorTotal * (item.lucro / 100);
        const faturamento = valorTotal + lucroValor;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="${item.descricao}" onchange="atualizarItem(${item.id}, 'descricao', this.value)"></td>
            <td><input type="number" class="text-end" value="${item.qtd}" onchange="atualizarItem(${item.id}, 'qtd', this.value)"></td>
            <td><input type="text" class="text-center" value="${item.und}" onchange="atualizarItem(${item.id}, 'und', this.value)"></td>
            <td><input type="text" class="text-end" value="${formatarMoeda(item.valorUnit)}" onfocus="removerFormatacao(this)" onblur="aplicarFormatacao(this, ${item.id})"></td>
            <td class="text-end bg-light">R$ ${formatarMoeda(valorTotal)}</td>
            <td><input type="number" class="text-end" value="${item.lucro.toFixed(2)}" step="0.01" onchange="atualizarItem(${item.id}, 'lucro', this.value)"></td>
            <td class="text-center bg-light">${item.tipo}</td>
            <td class="text-center">
                <button class="btn btn-sm btn-warning me-1" onclick="abrirModalEdicao(${item.id})" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="excluirItem(${item.id})" title="Excluir">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Atualizar item
function atualizarItem(id, campo, valor) {
    const item = itensOrcamento.find(i => i.id === id);
    if (item) {
        if (campo === 'qtd' || campo === 'valorUnit' || campo === 'lucro') {
            item[campo] = parseFloat(valor) || 0;
        } else {
            item[campo] = valor;
        }
        renderizarItensOrcamento();
        recalcularOrcamento();
    }
}

// Adicionar novo item
function adicionarItemOrcamento() {
    const novoId = Math.max(...itensOrcamento.map(i => i.id)) + 1;
    itensOrcamento.push({
        id: novoId,
        descricao: 'Novo Item',
        qtd: 1,
        und: 'UND',
        valorUnit: 0,
        lucro: 0,
        tipo: 'EMPRESA'
    });
    renderizarItensOrcamento();
    recalcularOrcamento();
}

// Recalcular orçamento
function recalcularOrcamento() {
    let custoTotal = 0;
    let lucroTotal = 0;
    let faturamentoTotal = 0;
    
    itensOrcamento.forEach(item => {
        const valorTotal = item.qtd * item.valorUnit;
        const lucroValor = valorTotal * (item.lucro / 100);
        const faturamento = valorTotal + lucroValor;
        
        custoTotal += valorTotal;
        lucroTotal += lucroValor;
        faturamentoTotal += faturamento;
    });
    
    const margemMedia = custoTotal > 0 ? (lucroTotal / custoTotal) * 100 : 0;
    
    document.getElementById('totalCusto').value = formatarMoeda(custoTotal);
    document.getElementById('totalLucro').value = formatarMoeda(lucroTotal);
    document.getElementById('margemMedia').value = margemMedia.toFixed(2);
    document.getElementById('totalFaturamento').value = formatarMoeda(faturamentoTotal);
}

// Abrir modal de edição
function abrirModalEdicao(itemId) {
    const item = itensOrcamento.find(i => i.id === itemId);
    if (!item) return;
    
    document.getElementById('editItemId').value = item.id;
    document.getElementById('editDescricao').value = item.descricao;
    document.getElementById('editQtd').value = item.qtd;
    document.getElementById('editUnd').value = item.und;
    document.getElementById('editValorUnit').value = item.valorUnit.toFixed(2);
    document.getElementById('editLucro').value = item.lucro.toFixed(2);
    document.getElementById('editTipo').value = item.tipo;
    
    new bootstrap.Modal(document.getElementById('modalEditarCusto')).show();
}

// Salvar edição
function salvarEdicaoCusto() {
    const itemId = parseInt(document.getElementById('editItemId').value);
    const item = itensOrcamento.find(i => i.id === itemId);
    
    if (item) {
        item.descricao = document.getElementById('editDescricao').value;
        item.qtd = parseFloat(document.getElementById('editQtd').value) || 0;
        item.und = document.getElementById('editUnd').value;
        item.valorUnit = parseFloat(document.getElementById('editValorUnit').value) || 0;
        item.lucro = parseFloat(document.getElementById('editLucro').value) || 0;
        item.tipo = document.getElementById('editTipo').value;
        
        renderizarItensOrcamento();
        recalcularOrcamento();
        bootstrap.Modal.getInstance(document.getElementById('modalEditarCusto')).hide();
    }
}

// Excluir item
function excluirItem(itemId) {
    if (confirm('Tem certeza que deseja excluir este item?')) {
        itensOrcamento = itensOrcamento.filter(i => i.id !== itemId);
        renderizarItensOrcamento();
        recalcularOrcamento();
    }
}

// Salvar orçamento
function salvarOrcamento() {
    alert('Orçamento salvo com sucesso!');
    bootstrap.Modal.getInstance(document.getElementById('modalOrcamento')).hide();
}
</script>

<!-- Modal Histórico de Consumo -->
<div class="modal fade" id="modalHistoricoConsumo" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                <h5 class="modal-title text-white">
                    <i class="fas fa-chart-line me-2"></i>Calcular Consumo Médio Mensal
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Seleção do Método -->
                <div class="mb-4">
                    <h6 class="text-primary mb-3">Escolha o método de cálculo:</h6>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-primary w-100 btn-metodo-consumo active" id="btnMetodoDireto" onclick="selecionarMetodoConsumo('direto')">
                                <i class="fas fa-keyboard d-block mb-2" style="font-size: 2rem;"></i>
                                <strong>Valor Direto</strong>
                                <small class="d-block text-muted">Inserir kWh/mês</small>
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-primary w-100 btn-metodo-consumo" id="btnMetodoHistorico" onclick="selecionarMetodoConsumo('historico')">
                                <i class="fas fa-calendar-alt d-block mb-2" style="font-size: 2rem;"></i>
                                <strong>Histórico 12 Meses</strong>
                                <small class="d-block text-muted">Calcular média</small>
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-primary w-100 btn-metodo-consumo" id="btnMetodoConta" onclick="selecionarMetodoConsumo('conta')">
                                <i class="fas fa-dollar-sign d-block mb-2" style="font-size: 2rem;"></i>
                                <strong>Valor da Conta</strong>
                                <small class="d-block text-muted">Converter R$ → kWh</small>
                            </button>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <!-- Formulário 1: Valor Direto -->
                <div id="formValorDireto" style="display: block;">
                    <h6 class="text-primary mb-3"><i class="fas fa-keyboard me-2"></i>Informar Consumo Direto</h6>
                    <div class="row">
                        <div class="col-md-8 offset-md-2">
                            <label class="form-label fw-bold">Consumo Médio Mensal (kWh)</label>
                            <input type="number" class="form-control form-control-lg text-center" id="consumo_direto" step="0.01" placeholder="Ex: 269.08">
                            <small class="text-muted">Digite o consumo médio mensal em kWh</small>
                            <div class="mt-3">
                                <button type="button" class="btn btn-primary w-100" onclick="aplicarValorDireto()">
                                    <i class="fas fa-check me-2"></i>Aplicar Valor
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulário 2: Histórico 12 Meses -->
                <div id="formHistorico12Meses" style="display: none;">
                    <h6 class="text-primary mb-3"><i class="fas fa-calendar-alt me-2"></i>Histórico de Consumo (12 Meses)</h6>
                    <p class="text-muted small">Preencha o consumo de cada mês em kWh. A média será calculada automaticamente.</p>
                    
                    <div class="row g-2">
                        <div class="col-md-3 col-6">
                            <label class="form-label"><strong>JAN</strong></label>
                            <div class="input-group">
                                <input type="number" class="form-control consumo-mes" id="consumo_jan" placeholder="1100" oninput="atualizarMediaPreview()">
                                <span class="input-group-text">kWh</span>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="form-label"><strong>FEV</strong></label>
                            <div class="input-group">
                                <input type="number" class="form-control consumo-mes" id="consumo_fev" placeholder="1252" oninput="atualizarMediaPreview()">
                                <span class="input-group-text">kWh</span>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="form-label"><strong>MAR</strong></label>
                            <div class="input-group">
                                <input type="number" class="form-control consumo-mes" id="consumo_mar" placeholder="1425" oninput="atualizarMediaPreview()">
                                <span class="input-group-text">kWh</span>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="form-label"><strong>ABR</strong></label>
                            <div class="input-group">
                                <input type="number" class="form-control consumo-mes" id="consumo_abr" placeholder="1272" oninput="atualizarMediaPreview()">
                                <span class="input-group-text">kWh</span>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="form-label"><strong>MAI</strong></label>
                            <div class="input-group">
                                <input type="number" class="form-control consumo-mes" id="consumo_mai" placeholder="1092" oninput="atualizarMediaPreview()">
                                <span class="input-group-text">kWh</span>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="form-label"><strong>JUN</strong></label>
                            <div class="input-group">
                                <input type="number" class="form-control consumo-mes" id="consumo_jun" placeholder="1056" oninput="atualizarMediaPreview()">
                                <span class="input-group-text">kWh</span>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="form-label"><strong>JUL</strong></label>
                            <div class="input-group">
                                <input type="number" class="form-control consumo-mes" id="consumo_jul" placeholder="860" oninput="atualizarMediaPreview()">
                                <span class="input-group-text">kWh</span>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="form-label"><strong>AGO</strong></label>
                            <div class="input-group">
                                <input type="number" class="form-control consumo-mes" id="consumo_ago" placeholder="1152" oninput="atualizarMediaPreview()">
                                <span class="input-group-text">kWh</span>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="form-label"><strong>SET</strong></label>
                            <div class="input-group">
                                <input type="number" class="form-control consumo-mes" id="consumo_set" placeholder="1116" oninput="atualizarMediaPreview()">
                                <span class="input-group-text">kWh</span>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="form-label"><strong>OUT</strong></label>
                            <div class="input-group">
                                <input type="number" class="form-control consumo-mes" id="consumo_out" placeholder="1068" oninput="atualizarMediaPreview()">
                                <span class="input-group-text">kWh</span>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="form-label"><strong>NOV</strong></label>
                            <div class="input-group">
                                <input type="number" class="form-control consumo-mes" id="consumo_nov" placeholder="1208" oninput="atualizarMediaPreview()">
                                <span class="input-group-text">kWh</span>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="form-label"><strong>DEZ</strong></label>
                            <div class="input-group">
                                <input type="number" class="form-control consumo-mes" id="consumo_dez" placeholder="1092" oninput="atualizarMediaPreview()">
                                <span class="input-group-text">kWh</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campo de Preview da Média -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-primary">
                                <i class="fas fa-chart-line me-2"></i>MÉDIA CALCULADA
                            </label>
                            <div class="input-group input-group-lg">
                                <input type="text" class="form-control text-center fw-bold" id="media_preview" value="0,00" readonly style="font-size: 1.5rem; background: #f0f9ff; color: #0891b2; border: 2px solid #06b6d4;">
                                <span class="input-group-text bg-primary text-white fw-bold">kWh/mês</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-muted">
                                <i class="fas fa-hashtag me-2"></i>MESES PREENCHIDOS
                            </label>
                            <div class="input-group input-group-lg">
                                <input type="text" class="form-control text-center fw-bold" id="meses_preenchidos" value="0" readonly style="font-size: 1.5rem; background: #f8fafc; color: #64748b; border: 2px solid #cbd5e1;">
                                <span class="input-group-text bg-secondary text-white fw-bold">de 12</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary w-100" onclick="calcularMediaHistorico()">
                            <i class="fas fa-calculator me-2"></i>Calcular Média e Aplicar
                        </button>
                    </div>
                </div>

                <!-- Formulário 3: Valor da Conta -->
                <div id="formValorConta" style="display: none;">
                    <h6 class="text-primary mb-3"><i class="fas fa-dollar-sign me-2"></i>Calcular a partir do Valor da Conta</h6>
                    <p class="text-muted small">Informe o valor médio da conta de luz. O consumo será calculado automaticamente.</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Valor Médio da Conta (R$)</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">R$</span>
                                <input type="number" class="form-control" id="valor_conta_luz" step="0.01" placeholder="250.00">
                            </div>
                            <small class="text-muted">Valor médio mensal da conta de energia</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Tarifa Estimada (R$/kWh)</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">R$</span>
                                <input type="number" class="form-control" id="tarifa_estimada" step="0.01" value="0.85" placeholder="0.85">
                            </div>
                            <small class="text-muted">Valor médio da tarifa na sua região</small>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Cálculo:</strong> Consumo (kWh) = Valor da Conta (R$) ÷ Tarifa (R$/kWh)
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary w-100" onclick="calcularConsumoDeValor()">
                            <i class="fas fa-calculator me-2"></i>Calcular e Aplicar
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Adicionar Unidade Consumidora -->
<div class="modal fade" id="modalAdicionarUnidade" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745, #20c997);">
                <h5 class="modal-title text-white">
                    <i class="fas fa-building me-2"></i>
                    <span id="tituloModalUnidade">Adicionar Unidade Consumidora</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Informações da Unidade -->
                <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>Dados da Unidade</h6>
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Identificação/Nome <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="unidade_nome" placeholder="Ex: Casa Principal, Apartamento 101">
                        <small class="text-muted">Nome para identificar esta unidade</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Número da UC</label>
                        <input type="text" class="form-control" id="unidade_numero_uc" placeholder="Ex: 12345678">
                        <small class="text-muted">Número da Unidade Consumidora (opcional)</small>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label fw-bold">Endereço</label>
                        <input type="text" class="form-control" id="unidade_endereco" placeholder="Ex: Rua das Flores, 123">
                        <small class="text-muted">Endereço da unidade (opcional)</small>
                    </div>
                </div>

                <!-- Consumos (Faturas) -->
                <h6 class="text-primary mb-3">
                    <i class="fas fa-file-invoice-dollar me-2"></i>Histórico de Consumo
                </h6>
                
                <!-- Botões para escolher modo -->
                <div class="btn-group w-100 mb-3" role="group">
                    <input type="radio" class="btn-check" name="modo_consumo_unidade" id="modo_faturas" value="faturas" checked onchange="alterarModoConsumoUnidade('faturas')">
                    <label class="btn btn-outline-primary" for="modo_faturas">
                        <i class="fas fa-file-invoice me-2"></i>3 FATURAS
                    </label>
                    <input type="radio" class="btn-check" name="modo_consumo_unidade" id="modo_12meses" value="12meses" onchange="alterarModoConsumoUnidade('12meses')">
                    <label class="btn btn-outline-success" for="modo_12meses">
                        <i class="fas fa-calendar-alt me-2"></i>12 MESES
                    </label>
                </div>

                <!-- Modo: 3 Faturas -->
                <div id="consumo_faturas" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            Fatura 1 (kWh) <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="unidade_consumo1" step="0.01" min="0" placeholder="Digite o consumo">
                            <span class="input-group-text">kWh</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Fatura 2 (kWh)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="unidade_consumo2" step="0.01" min="0" placeholder="Digite o consumo">
                            <span class="input-group-text">kWh</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Fatura 3 (kWh)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="unidade_consumo3" step="0.01" min="0" placeholder="Digite o consumo">
                            <span class="input-group-text">kWh</span>
                        </div>
                    </div>
                </div>

                <!-- Modo: 12 Meses -->
                <div id="consumo_12meses" class="row g-3" style="display: none;">
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-bold">JAN</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="unidade_mes_01" step="0.01" min="0" placeholder="0">
                            <span class="input-group-text">kWh</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-bold">FEV</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="unidade_mes_02" step="0.01" min="0" placeholder="0">
                            <span class="input-group-text">kWh</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-bold">MAR</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="unidade_mes_03" step="0.01" min="0" placeholder="0">
                            <span class="input-group-text">kWh</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-bold">ABR</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="unidade_mes_04" step="0.01" min="0" placeholder="0">
                            <span class="input-group-text">kWh</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-bold">MAI</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="unidade_mes_05" step="0.01" min="0" placeholder="0">
                            <span class="input-group-text">kWh</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-bold">JUN</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="unidade_mes_06" step="0.01" min="0" placeholder="0">
                            <span class="input-group-text">kWh</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-bold">JUL</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="unidade_mes_07" step="0.01" min="0" placeholder="0">
                            <span class="input-group-text">kWh</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-bold">AGO</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="unidade_mes_08" step="0.01" min="0" placeholder="0">
                            <span class="input-group-text">kWh</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-bold">SET</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="unidade_mes_09" step="0.01" min="0" placeholder="0">
                            <span class="input-group-text">kWh</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-bold">OUT</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="unidade_mes_10" step="0.01" min="0" placeholder="0">
                            <span class="input-group-text">kWh</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-bold">NOV</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="unidade_mes_11" step="0.01" min="0" placeholder="0">
                            <span class="input-group-text">kWh</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-bold">DEZ</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="unidade_mes_12" step="0.01" min="0" placeholder="0">
                            <span class="input-group-text">kWh</span>
                        </div>
                    </div>
                </div>

                <!-- Preview da Média -->
                <div class="mt-3 p-3" id="previewMediaUnidade" style="display: none; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 8px; border-left: 4px solid #28a745;">
                    <div class="row text-center">
                        <div class="col-md-6">
                            <small class="d-block fw-bold" style="color: #2e7d32;">
                                <i class="fas fa-file-invoice me-1"></i>MEDIÇÕES INFORMADAS
                            </small>
                            <strong id="qtdFaturas" style="font-size: 1.8rem; color: #1b5e20;">0</strong>
                        </div>
                        <div class="col-md-6">
                            <small class="d-block fw-bold" style="color: #2e7d32;">
                                <i class="fas fa-calculator me-1"></i>CONSUMO MÉDIO CALCULADO
                            </small>
                            <strong id="mediaUnidade" style="font-size: 1.8rem; color: #1b5e20;">0.00 kWh/mês</strong>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="salvarUnidadeConsumidora()">
                    <i class="fas fa-save me-2"></i>Salvar Unidade
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Financiamento -->
<div class="modal fade" id="modalFinanciamento" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa);">
                <h5 class="modal-title text-white"><i class="fas fa-credit-card me-2"></i>Simulação de Financiamento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-edit text-primary me-2"></i>Dados do Financiamento</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Valor a Financiar (R$)</label>
                                    <input type="number" class="form-control" id="valor_financiado" step="0.01" min="0" value="{{ projeto.valor_venda or 0 }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Número de Meses</label>
                                    <select class="form-select" id="n_meses">
                                        <option value="12">12 meses (1 ano)</option>
                                        <option value="24">24 meses (2 anos)</option>
                                        <option value="36" selected>36 meses (3 anos)</option>
                                        <option value="48">48 meses (4 anos)</option>
                                        <option value="60">60 meses (5 anos)</option>
                                        <option value="72">72 meses (6 anos)</option>
                                        <option value="84">84 meses (7 anos)</option>
                                        <option value="96">96 meses (8 anos)</option>
                                        <option value="120">120 meses (10 anos)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Taxa de Juros Mensal (%)</label>
                                    <input type="number" class="form-control" id="juros_mensal" step="0.01" min="0" max="10" value="1.5">
                                    <small class="text-muted">Exemplo: 1.5% ao mês (≈ 19.6% ao ano)</small>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="incluir_em_pdf">
                                    <label class="form-check-label" for="incluir_em_pdf">
                                        Incluir informações de financiamento no PDF
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-calculator text-success me-2"></i>Resultado da Simulação</h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-3">
                                    <div class="row">
                                        <div class="col-12 mb-2">
                                            <strong>Valor da Parcela:</strong>
                                            <h4 class="text-primary mb-0" id="resultado_parcela">R$ 0,00</h4>
                                        </div>
                                    </div>
                                </div>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Valor Financiado:</strong></td>
                                        <td class="text-end" id="resultado_valor_financiado">R$ 0,00</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Número de Parcelas:</strong></td>
                                        <td class="text-end" id="resultado_n_parcelas">-</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Taxa de Juros:</strong></td>
                                        <td class="text-end" id="resultado_taxa_juros">-</td>
                                    </tr>
                                    <tr class="table-light">
                                        <td><strong>Total a Pagar:</strong></td>
                                        <td class="text-end fw-bold" id="resultado_total_pagar">R$ 0,00</td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>Total de Juros:</strong></td>
                                        <td class="text-end fw-bold" id="resultado_total_juros">R$ 0,00</td>
                                    </tr>
                                </table>
                                <div class="alert alert-secondary mb-0">
                                    <small><i class="fas fa-info-circle me-1"></i> Simulação calculada pelo sistema Price (parcelas fixas)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-success" onclick="salvarFinanciamento()">
                    <i class="fas fa-save me-2"></i>Salvar Simulação
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Financiamento - Cálculo e Salvar
let dadosFinanciamentoCarregados = false;

// Carregar dados do financiamento quando abrir modal
document.getElementById('modalFinanciamento').addEventListener('show.bs.modal', function () {
    if (!dadosFinanciamentoCarregados) {
        carregarDadosFinanciamento();
        dadosFinanciamentoCarregados = true;
    }
});

// Calcular em tempo real
document.getElementById('valor_financiado').addEventListener('input', calcularFinanciamento);
document.getElementById('n_meses').addEventListener('change', calcularFinanciamento);
document.getElementById('juros_mensal').addEventListener('input', calcularFinanciamento);

function calcularFinanciamento() {
    const valorFinanciado = parseFloat(document.getElementById('valor_financiado').value) || 0;
    const nMeses = parseInt(document.getElementById('n_meses').value) || 0;
    const jurosMensal = parseFloat(document.getElementById('juros_mensal').value) || 0;
    
    if (valorFinanciado <= 0 || nMeses <= 0 || jurosMensal < 0) {
        limparResultados();
        return;
    }
    
    // Fórmula PRICE: PMT = PV * (i * (1+i)^n) / ((1+i)^n - 1)
    const i = jurosMensal / 100; // Taxa em decimal
    let valorParcela;
    
    if (i === 0) {
        // Sem juros
        valorParcela = valorFinanciado / nMeses;
    } else {
        const fator = Math.pow(1 + i, nMeses);
        valorParcela = valorFinanciado * (i * fator) / (fator - 1);
    }
    
    const totalPagar = valorParcela * nMeses;
    const totalJuros = totalPagar - valorFinanciado;
    
    // Exibir resultados
    document.getElementById('resultado_parcela').textContent = formatarMoeda(valorParcela);
    document.getElementById('resultado_valor_financiado').textContent = formatarMoeda(valorFinanciado);
    document.getElementById('resultado_n_parcelas').textContent = nMeses + ' meses';
    document.getElementById('resultado_taxa_juros').textContent = jurosMensal.toFixed(2) + '% a.m.';
    document.getElementById('resultado_total_pagar').textContent = formatarMoeda(totalPagar);
    document.getElementById('resultado_total_juros').textContent = formatarMoeda(totalJuros);
}

function limparResultados() {
    document.getElementById('resultado_parcela').textContent = 'R$ 0,00';
    document.getElementById('resultado_valor_financiado').textContent = 'R$ 0,00';
    document.getElementById('resultado_n_parcelas').textContent = '-';
    document.getElementById('resultado_taxa_juros').textContent = '-';
    document.getElementById('resultado_total_pagar').textContent = 'R$ 0,00';
    document.getElementById('resultado_total_juros').textContent = 'R$ 0,00';
}

function carregarDadosFinanciamento() {
    fetch(`/energia-solar/projeto/${projetoId}/financiamento/buscar`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.financiamento) {
                const fin = data.financiamento;
                document.getElementById('valor_financiado').value = fin.valor_financiado || 0;
                document.getElementById('n_meses').value = fin.n_meses || 36;
                document.getElementById('juros_mensal').value = fin.juros_mensal || 1.5;
                document.getElementById('incluir_em_pdf').checked = fin.incluir_em_pdf || false;
                calcularFinanciamento();
            } else {
                // Usar valor_venda do projeto como padrão
                calcularFinanciamento();
            }
        })
        .catch(error => {
            console.error('Erro ao carregar financiamento:', error);
            calcularFinanciamento();
        });
}

function salvarFinanciamento() {
    const valorFinanciado = parseFloat(document.getElementById('valor_financiado').value) || 0;
    const nMeses = parseInt(document.getElementById('n_meses').value) || 0;
    const jurosMensal = parseFloat(document.getElementById('juros_mensal').value) || 0;
    const incluirEmPdf = document.getElementById('incluir_em_pdf').checked;
    
    if (valorFinanciado <= 0) {
        alert('Informe o valor a financiar');
        return;
    }
    
    if (nMeses <= 0) {
        alert('Selecione o número de meses');
        return;
    }
    
    // Calcular parcela
    const i = jurosMensal / 100;
    let valorParcela;
    
    if (i === 0) {
        valorParcela = valorFinanciado / nMeses;
    } else {
        const fator = Math.pow(1 + i, nMeses);
        valorParcela = valorFinanciado * (i * fator) / (fator - 1);
    }
    
    const totalPagar = valorParcela * nMeses;
    const totalJuros = totalPagar - valorFinanciado;
    
    const dados = {
        valor_financiado: valorFinanciado,
        n_meses: nMeses,
        juros_mensal: jurosMensal,
        valor_parcela: valorParcela,
        total_pagar: totalPagar,
        total_juros: totalJuros,
        incluir_em_pdf: incluirEmPdf
    };
    
    fetch(`/energia-solar/projeto/${projetoId}/financiamento/salvar`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Simulação de financiamento salva com sucesso!');
            bootstrap.Modal.getInstance(document.getElementById('modalFinanciamento')).hide();
        } else {
            alert('❌ Erro: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('❌ Erro ao salvar financiamento');
    });
}

// ========================================
// MODAL HISTÓRICO DE CONSUMO
// ========================================
function selecionarMetodoConsumo(metodo) {
    // Esconder todos os formulários
    document.getElementById('formValorDireto').style.display = 'none';
    document.getElementById('formHistorico12Meses').style.display = 'none';
    document.getElementById('formValorConta').style.display = 'none';
    
    // Remover classe active de todos os botões
    document.querySelectorAll('.btn-metodo-consumo').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    
    // Mostrar o formulário selecionado e ativar botão
    if (metodo === 'direto') {
        document.getElementById('formValorDireto').style.display = 'block';
        document.getElementById('btnMetodoDireto').classList.add('active', 'btn-primary');
        document.getElementById('btnMetodoDireto').classList.remove('btn-outline-primary');
    } else if (metodo === 'historico') {
        document.getElementById('formHistorico12Meses').style.display = 'block';
        document.getElementById('btnMetodoHistorico').classList.add('active', 'btn-primary');
        document.getElementById('btnMetodoHistorico').classList.remove('btn-outline-primary');
    } else if (metodo === 'conta') {
        document.getElementById('formValorConta').style.display = 'block';
        document.getElementById('btnMetodoConta').classList.add('active', 'btn-primary');
        document.getElementById('btnMetodoConta').classList.remove('btn-outline-primary');
    }
}

function atualizarMediaPreview() {
    const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
    let soma = 0;
    let count = 0;
    
    meses.forEach(mes => {
        const valor = parseFloat(document.getElementById(`consumo_${mes}`).value) || 0;
        if (valor > 0) {
            soma += valor;
            count++;
        }
    });
    
    const media = count > 0 ? soma / count : 0;
    
    // Atualizar campos
    document.getElementById('media_preview').value = media.toFixed(2).replace('.', ',');
    document.getElementById('meses_preenchidos').value = count;
    
    // Mudar cor do campo de média baseado na quantidade de meses
    const campoMedia = document.getElementById('media_preview');
    if (count === 0) {
        campoMedia.style.background = '#f8fafc';
        campoMedia.style.color = '#94a3b8';
        campoMedia.style.borderColor = '#cbd5e1';
    } else if (count < 6) {
        campoMedia.style.background = '#fef3c7';
        campoMedia.style.color = '#d97706';
        campoMedia.style.borderColor = '#f59e0b';
    } else if (count < 12) {
        campoMedia.style.background = '#dbeafe';
        campoMedia.style.color = '#1d4ed8';
        campoMedia.style.borderColor = '#3b82f6';
    } else {
        campoMedia.style.background = '#d1fae5';
        campoMedia.style.color = '#047857';
        campoMedia.style.borderColor = '#10b981';
    }
}

function calcularMediaHistorico() {
    const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
    let soma = 0;
    let count = 0;
    
    meses.forEach(mes => {
        const valor = parseFloat(document.getElementById(`consumo_${mes}`).value) || 0;
        if (valor > 0) {
            soma += valor;
            count++;
        }
    });
    
    const media = count > 0 ? soma / count : 0;
    document.getElementById('consumo_kwh_mes').value = media.toFixed(2);
    
    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById('modalHistoricoConsumo')).hide();
}

function aplicarValorDireto() {
    const valor = parseFloat(document.getElementById('consumo_direto').value) || 0;
    if (valor > 0) {
        document.getElementById('consumo_kwh_mes').value = valor.toFixed(2);
        bootstrap.Modal.getInstance(document.getElementById('modalHistoricoConsumo')).hide();
    } else {
        alert('Por favor, insira um valor válido');
    }
}

function calcularConsumoDeValor() {
    const valorConta = parseFloat(document.getElementById('valor_conta_luz').value) || 0;
    const tarifaKwh = parseFloat(document.getElementById('tarifa_estimada').value) || 0.85;
    
    if (valorConta > 0 && tarifaKwh > 0) {
        const consumoEstimado = valorConta / tarifaKwh;
        document.getElementById('consumo_kwh_mes').value = consumoEstimado.toFixed(2);
        bootstrap.Modal.getInstance(document.getElementById('modalHistoricoConsumo')).hide();
    } else {
        alert('Por favor, preencha o valor da conta e a tarifa');
    }
}

function formatarMoeda(valor) {
    return 'R$ ' + valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

// Alternar entre método de placas individuais e kit
function alterarMetodoDimensionamento(modo) {
    const formPlacas = document.getElementById('form_placas');
    const formKit = document.getElementById('form_kit');
    
    if (modo === 'individual') {
        formPlacas.style.display = 'block';
        formKit.style.display = 'none';
        calcularPotenciaPlacas();
    } else {
        formPlacas.style.display = 'none';
        formKit.style.display = 'block';
        calcularPotenciaKit();
    }
}

// Incrementar/decrementar quantidade de placas
function incrementarPlacas(delta) {
    const qtdInput = document.getElementById('qtd_placas_input');
    const qtdAtual = parseInt(qtdInput.value) || 0;
    const novaQtd = Math.max(0, qtdAtual + delta);
    qtdInput.value = novaQtd;
    
    // Atualizar display
    document.getElementById('qtd_placas_display').textContent = novaQtd;
    
    // Recalcular potência
    const modoKit = document.getElementById('modo_kit').checked;
    if (modoKit) {
        calcularPotenciaKit();
    } else {
        calcularPotenciaPlacas();
    }
}

// Calcular potência baseado em placas individuais
function calcularPotenciaPlacas() {
    const selectPlaca = document.getElementById('placa_id');
    const qtdInput = document.getElementById('qtd_placas_input');
    const qtdPlacas = parseInt(qtdInput.value) || 0;
    
    if (!selectPlaca.value || qtdPlacas === 0) {
        atualizarDisplays(0, 0, '-', 0);
        return;
    }
    
    const option = selectPlaca.options[selectPlaca.selectedIndex];
    const potenciaPlaca = parseFloat(option.dataset.potencia) || 0;
    const modeloPlaca = `${option.dataset.modelo} / ${option.dataset.fabricante} / ${potenciaPlaca}W`;
    
    // Cálculo: (Quantidade × Potência da Placa em W) / 1000 = kWp
    const potenciaKWp = (qtdPlacas * potenciaPlaca) / 1000;
    
    // Estimativa de geração mensal (kWp × 4.5h de sol × 30 dias × 0.8 de eficiência)
    const geracaoMes = potenciaKWp * 4.5 * 30 * 0.8;
    
    atualizarDisplays(potenciaKWp, geracaoMes, modeloPlaca, qtdPlacas);
}

// Calcular potência baseado em kit fotovoltaico
function calcularPotenciaKit() {
    const selectKit = document.getElementById('kit_id');
    
    if (!selectKit.value) {
        atualizarDisplays(0, 0, '-', 0);
        return;
    }
    
    const option = selectKit.options[selectKit.selectedIndex];
    const potenciaKWp = parseFloat(option.dataset.potencia) || 0;
    const qtdPlacas = parseInt(option.dataset.qtdPlacas) || 0;
    
    // Atualizar input de quantidade
    const qtdInput = document.getElementById('qtd_placas_input');
    qtdInput.value = qtdPlacas;
    
    // 🆕 SELECIONAR PLACA ANTES DE CONFIGURAR LAYOUT
    const placaId = option.dataset.placaId;
    let placaInfo = '-';
    if (placaId) {
        const selectPlaca = document.getElementById('placa_id');
        const placaOption = Array.from(selectPlaca.options).find(opt => opt.value === placaId);
        if (placaOption) {
            // Selecionar a placa no SELECT
            selectPlaca.value = placaId;
            console.log(`   🔧 Placa selecionada automaticamente: ${placaOption.dataset.modelo}`);
            
            placaInfo = `${placaOption.dataset.modelo} / ${placaOption.dataset.fabricante} / ${placaOption.dataset.potencia}W`;
        }
    }
    
    // 🆕 CONFIGURAR LAYOUT AUTOMATICAMENTE (DEPOIS de selecionar a placa)
    configurarLayoutAutomatico(qtdPlacas, placaId);
    
    // Estimativa de geração mensal (kWp × 4.5h de sol × 30 dias × 0.8 de eficiência)
    const geracaoMes = potenciaKWp * 4.5 * 30 * 0.8;
    
    atualizarDisplays(potenciaKWp, geracaoMes, placaInfo, qtdPlacas);
}

// Atualizar todos os displays de uma vez
function atualizarDisplays(potenciaKWp, geracaoMes, placaInfo, qtdPlacas) {
    document.getElementById('potencia_display').textContent = potenciaKWp.toFixed(2) + ' kWp';
    document.getElementById('geracao_display').textContent = geracaoMes.toFixed(2) + ' kWh';
    document.getElementById('placa_info_display').textContent = placaInfo;
    document.getElementById('qtd_placas_display').textContent = qtdPlacas;
    
    // Atualizar potência mínima do inversor (80% da potência do sistema)
    const potenciaMinima = potenciaKWp * 0.8;
    const elemPotenciaMin = document.getElementById('potencia_minima_inversor');
    if (elemPotenciaMin) {
        elemPotenciaMin.textContent = potenciaMinima.toFixed(2) + ' kW';
    }
}

// 🆕 Configurar layout automaticamente com base na quantidade de placas
function configurarLayoutAutomatico(qtdPlacas, placaId) {
    console.log(`🔧 Configurando layout automático: ${qtdPlacas} placas`);
    
    if (!qtdPlacas || qtdPlacas <= 0) {
        return;
    }
    
    // Calcular melhor distribuição (preferência por mais colunas que linhas)
    let linhas = 1;
    let colunas = qtdPlacas;
    
    // Otimizar para layouts mais compactos
    // Ex: 6 placas → 1x6 | 8 placas → 2x4 | 12 placas → 2x6 ou 3x4
    if (qtdPlacas >= 8) {
        linhas = 2;
        colunas = Math.ceil(qtdPlacas / 2);
    }
    if (qtdPlacas >= 15) {
        linhas = 3;
        colunas = Math.ceil(qtdPlacas / 3);
    }
    if (qtdPlacas >= 24) {
        linhas = 4;
        colunas = Math.ceil(qtdPlacas / 4);
    }
    
    // Atualizar campos de linhas e colunas
    const linhasInput = document.getElementById('linhas_placas');
    const colunasInput = document.getElementById('colunas_placas');
    
    if (linhasInput) linhasInput.value = linhas;
    if (colunasInput) colunasInput.value = colunas;
    
    console.log(`   📐 Layout configurado: ${linhas} linhas x ${colunas} colunas`);
    
    // Buscar dimensões da placa para calcular área
    if (placaId) {
        const selectPlaca = document.getElementById('placa_id');
        const placaOption = Array.from(selectPlaca.options).find(opt => opt.value === placaId);
        
        console.log(`   🔍 Buscando placa ID: ${placaId}`);
        
        if (placaOption) {
            const largura = parseFloat(placaOption.dataset.largura) || 992; // mm
            const comprimento = parseFloat(placaOption.dataset.comprimento) || 1650; // mm
            
            console.log(`   📏 Dimensões da placa: ${largura}mm x ${comprimento}mm`);
            
            // Converter para metros
            const larguraM = largura / 1000;
            const comprimentoM = comprimento / 1000;
            
            // Calcular área total (com 10cm de espaçamento)
            const espacamento = 0.10;
            const larguraTotal = (colunas * larguraM) + ((colunas - 1) * espacamento);
            const comprimentoTotal = (linhas * comprimentoM) + ((linhas - 1) * espacamento);
            const areaTotal = larguraTotal * comprimentoTotal;
            
            // Atualizar display de área
            const areaDisplay = document.getElementById('area_total_display');
            if (areaDisplay) {
                areaDisplay.value = areaTotal.toFixed(2);
            }
            
            // Atualizar campos hidden para salvar no banco
            const larguraHidden = document.getElementById('largura_area');
            const comprimentoHidden = document.getElementById('comprimento_area');
            if (larguraHidden) larguraHidden.value = larguraTotal.toFixed(2);
            if (comprimentoHidden) comprimentoHidden.value = comprimentoTotal.toFixed(2);
            
            console.log(`   📏 Área calculada: ${areaTotal.toFixed(2)} m² (${larguraTotal.toFixed(2)}m x ${comprimentoTotal.toFixed(2)}m)`);
        }
    }
    
    // Atualizar visualização do layout
    if (typeof atualizarLayoutVisual === 'function') {
        atualizarLayoutVisual();
    }
}

// Buscar inversor adequado baseado na potência
function buscarInversor() {
    const selectPlaca = document.getElementById('placa_id');
    const qtdInput = document.getElementById('qtd_placas_input');
    const qtdPlacas = parseInt(qtdInput.value) || 0;
    
    if (!selectPlaca.value || qtdPlacas === 0) {
        alert('Selecione uma placa e quantidade antes de buscar o inversor');
        return;
    }
    
    const option = selectPlaca.options[selectPlaca.selectedIndex];
    const potenciaPlaca = parseFloat(option.dataset.potencia) || 0;
    const potenciaKWp = (qtdPlacas * potenciaPlaca) / 1000;
    const potenciaMinima = potenciaKWp * 0.8;
    
    // Buscar primeiro inversor com potência >= mínima
    const selectInversor = document.getElementById('inversor_id');
    let inversorEncontrado = false;
    
    for (let i = 0; i < selectInversor.options.length; i++) {
        const opt = selectInversor.options[i];
        const potInversor = parseFloat(opt.dataset.potencia);
        
        if (potInversor >= potenciaMinima) {
            selectInversor.selectedIndex = i;
            inversorEncontrado = true;
            break;
        }
    }
    
    if (!inversorEncontrado) {
        alert(`Nenhum inversor encontrado com potência >= ${potenciaMinima.toFixed(2)} kW`);
    } else {
        atualizarInfoInversor();
    }
}

// Atualizar informações do inversor selecionado
function atualizarInfoInversor() {
    // Placeholder - pode adicionar lógica adicional se necessário
}

// Atualizar visualização do layout e calcular área de instalação
function atualizarLayoutVisual() {
    console.log('🎨 === INICIANDO atualizarLayoutVisual() ===');
    
    const selectPlaca = document.getElementById('placa_id');
    const orientacao = document.getElementById('orientacao').value;
    const linhas = parseInt(document.getElementById('linhas_placas').value) || 1;
    const colunas = parseInt(document.getElementById('colunas_placas').value) || 1;
    
    console.log(`   📊 Parâmetros: ${linhas} linhas × ${colunas} colunas, orientação: ${orientacao}`);
    console.log(`   🔍 Placa selecionada: ${selectPlaca ? selectPlaca.value : 'NULO'}`);
    
    // Atualizar informações do texto
    const totalModulos = linhas * colunas;
    document.getElementById('total_modulos').textContent = totalModulos;
    document.getElementById('info_linhas').textContent = linhas;
    document.getElementById('info_colunas').textContent = colunas;
    
    // Gerar grid visual
    const layoutGrid = document.getElementById('layout_grid');
    layoutGrid.innerHTML = '';
    
    // Criar grid de placas
    for (let i = 1; i <= totalModulos; i++) {
        const modulo = document.createElement('div');
        modulo.className = 'border rounded d-flex align-items-center justify-content-center';
        modulo.style.cssText = `
            width: 60px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            font-weight: bold;
            font-size: 12px;
            border: 2px solid #60a5fa !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        `;
        modulo.textContent = i;
        layoutGrid.appendChild(modulo);
        
        // Quebrar linha após cada linha completa
        if (i % colunas === 0 && i < totalModulos) {
            const br = document.createElement('div');
            br.style.width = '100%';
            br.style.height = '0';
            layoutGrid.appendChild(br);
        }
    }
    
    // Calcular dimensões da área
    if (!selectPlaca || !selectPlaca.value) {
        console.log('⚠️ Nenhuma placa selecionada');
        document.getElementById('largura_display').textContent = '0.00 m';
        document.getElementById('comprimento_display').textContent = '0.00 m';
        document.getElementById('area_total_display').value = '0.00';
        return;
    }
    
    // Obter dimensões reais da placa selecionada (em milímetros no banco)
    const option = selectPlaca.options[selectPlaca.selectedIndex];
    let larguraPlacaMM = parseFloat(option.dataset.largura) || 992; // mm
    let comprimentoPlacaMM = parseFloat(option.dataset.comprimento) || 1650; // mm
    
    console.log(`📏 Placa: ${option.text}`);
    console.log(`📏 Dimensões originais: ${larguraPlacaMM}mm × ${comprimentoPlacaMM}mm`);
    
    // Converter para metros
    let larguraPlaca = larguraPlacaMM / 1000;
    let comprimentoPlaca = comprimentoPlacaMM / 1000;
    
    // Inverter dimensões se orientação for PAISAGEM
    if (orientacao === 'PAISAGEM') {
        [larguraPlaca, comprimentoPlaca] = [comprimentoPlaca, larguraPlaca];
        console.log(`🔄 Orientação PAISAGEM: ${larguraPlaca}m × ${comprimentoPlaca}m`);
    }
    
    // Calcular área total (adicionar 10cm de espaçamento entre placas)
    const espacamento = 0.10;
    const largura = (colunas * larguraPlaca) + ((colunas - 1) * espacamento);
    const comprimento = (linhas * comprimentoPlaca) + ((linhas - 1) * espacamento);
    const areaTotal = largura * comprimento;
    
    console.log(`📐 Layout: ${linhas} linhas × ${colunas} colunas`);
    console.log(`📏 Área total: ${largura.toFixed(2)}m × ${comprimento.toFixed(2)}m = ${areaTotal.toFixed(2)}m²`);
    
    // Atualizar elementos de display (H5)
    document.getElementById('largura_display').textContent = largura.toFixed(2) + ' m';
    document.getElementById('comprimento_display').textContent = comprimento.toFixed(2) + ' m';
    document.getElementById('area_total_display').value = areaTotal.toFixed(2);
    
    // Atualizar campos hidden para salvar no banco
    document.getElementById('largura_area').value = largura.toFixed(2);
    document.getElementById('comprimento_area').value = comprimento.toFixed(2);
    
    console.log('✅ Área atualizada com sucesso!');
}

// Manter compatibilidade com código antigo
function calcularAreaInstalacao() {
    atualizarLayoutVisual();
}

// Atualizar diagrama unifilar em tempo real
function atualizarDiagramaUnifilar() {
    // Atualizar cabos
    const caboCC = document.querySelector('select[name="cabo_cc"]');
    const caboCA = document.querySelector('select[name="cabo_ca"]');
    const caboFase = document.querySelector('select[name="cabo_fase_bitola"]');
    
    if (caboCC && document.getElementById('diagrama_cabo_cc')) {
        document.getElementById('diagrama_cabo_cc').textContent = caboCC.value + 'mm²';
    }
    
    if (caboCA && document.getElementById('diagrama_cabo_ca')) {
        document.getElementById('diagrama_cabo_ca').textContent = caboCA.value + 'mm²';
        // Atualizar também o segundo cabo CA
        const diagramaCaboCA2 = document.getElementById('diagrama_cabo_ca_2');
        if (diagramaCaboCA2) {
            diagramaCaboCA2.textContent = caboCA.value + 'mm²';
        }
    }
    
    // Atualizar cabo de entrada da rede (usa cabo de fase)
    if (caboFase && document.getElementById('diagrama_cabo_entrada')) {
        document.getElementById('diagrama_cabo_entrada').textContent = caboFase.value + 'mm²';
    }
    
    // Atualizar proteções
    const protecaoCCTipo = document.querySelector('select[name="protecao_cc_tipo"]');
    const protecaoCCCorrente = document.querySelector('input[name="protecao_cc_corrente"]');
    const protecaoCATipo = document.querySelector('select[name="protecao_ca_tipo"]');
    const protecaoCACorrente = document.querySelector('input[name="protecao_ca_corrente"]');
    
    if (protecaoCCTipo && document.getElementById('diagrama_protecao_cc')) {
        const texto = protecaoCCTipo.options[protecaoCCTipo.selectedIndex].text || 'N/A';
        document.getElementById('diagrama_protecao_cc').textContent = texto.toUpperCase();
    }
    
    if (protecaoCCCorrente && document.getElementById('diagrama_protecao_cc_corrente')) {
        document.getElementById('diagrama_protecao_cc_corrente').textContent = (protecaoCCCorrente.value || '-') + 'A';
    }
    
    if (protecaoCATipo && document.getElementById('diagrama_protecao_ca')) {
        const texto = protecaoCATipo.options[protecaoCATipo.selectedIndex].text || 'N/A';
        document.getElementById('diagrama_protecao_ca').textContent = texto.toUpperCase();
    }
    
    if (protecaoCACorrente && document.getElementById('diagrama_protecao_ca_corrente')) {
        document.getElementById('diagrama_protecao_ca_corrente').textContent = (protecaoCACorrente.value || '-') + 'A';
    }
    
    // Atualizar disjuntor
    const disjuntor = document.querySelector('input[name="disjuntor_ca"]');
    if (disjuntor && document.getElementById('diagrama_disjuntor')) {
        document.getElementById('diagrama_disjuntor').textContent = (disjuntor.value || '63') + 'A';
    }
}

// Handler para salvar dados técnicos e recarregar página
function handleSalvarDadosTecnicos(event) {
    event.preventDefault();
    const form = event.target;
    
    // Adicionar dados das unidades consumidoras ao campo hidden
    const unidadesJSON = JSON.stringify(unidadesConsumidoras);
    document.getElementById('unidades_consumidoras_json').value = unidadesJSON;
    
    // DEBUG: Verificar valor do tipo_entrada antes de enviar
    const tipoEntradaField = form.querySelector('[name="tipo_entrada"]');
    console.log('🔍 ENVIANDO tipo_entrada:', tipoEntradaField ? tipoEntradaField.value : 'CAMPO NÃO ENCONTRADO');
    console.log('🔍 Todos os campos name=tipo_entrada:', form.querySelectorAll('[name="tipo_entrada"]').length);
    
    fetch(form.action, {
        method: 'POST',
        body: new FormData(form)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Recarregar a página para atualizar os cards
            window.location.reload();
        } else {
            alert('Erro ao salvar dados técnicos: ' + (data.message || 'Erro desconhecido'));
            console.error('❌ Erro:', data);
        }
    })
    .catch(error => {
        console.error('❌ Erro:', error);
        alert('Erro ao salvar dados técnicos: ' + error.message);
    });
}

// ========================================
// SISTEMA DE MÚLTIPLAS UNIDADES CONSUMIDORAS
// ========================================

// Array para armazenar as unidades
let unidadesConsumidoras = [];
let unidadeEditandoId = null;

// Abrir modal para adicionar unidade
window.abrirModalAdicionarUnidade = function() {
    try {
        console.log('🔍 Abrindo modal de unidade consumidora...');
        unidadeEditandoId = null;
        
        // Limpar título
        const tituloElement = document.getElementById('tituloModalUnidade');
        if (tituloElement) tituloElement.textContent = 'Adicionar Unidade Consumidora';
        
        // Limpar campos básicos
        const nomeEl = document.getElementById('unidade_nome');
        const numeroUcEl = document.getElementById('unidade_numero_uc');
        const enderecoEl = document.getElementById('unidade_endereco');
        if (nomeEl) nomeEl.value = '';
        if (numeroUcEl) numeroUcEl.value = '';
        if (enderecoEl) enderecoEl.value = '';
        
        // Limpar modo faturas
        for (let i = 1; i <= 3; i++) {
            const el = document.getElementById('unidade_consumo' + i);
            if (el) el.value = '';
        }
        
        // Limpar modo 12 meses
        for (let i = 1; i <= 12; i++) {
            const mes = i < 10 ? '0' + i : '' + i;
            const el = document.getElementById('unidade_mes_' + mes);
            if (el) el.value = '';
        }
        
        // Resetar para modo faturas
        const modoFaturasEl = document.getElementById('modo_faturas');
        if (modoFaturasEl) modoFaturasEl.checked = true;
        alterarModoConsumoUnidade('faturas');
        
        // Esconder preview
        const previewEl = document.getElementById('previewMediaUnidade');
        if (previewEl) previewEl.style.display = 'none';
        
        const modalElement = document.getElementById('modalAdicionarUnidade');
        if (!modalElement) {
            console.error('❌ Modal modalAdicionarUnidade não encontrado!');
            alert('Erro: Modal não encontrado. Recarregue a página.');
            return;
        }
        
        console.log('✅ Modal encontrado, abrindo...');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    } catch (error) {
        console.error('❌ Erro ao abrir modal:', error);
        alert('Erro ao abrir modal: ' + error.message);
    }
}

// Alternar modo de consumo (3 faturas ou 12 meses)
window.alterarModoConsumoUnidade = function(modo) {
    const faturasDiv = document.getElementById('consumo_faturas');
    const mesesDiv = document.getElementById('consumo_12meses');
    
    if (modo === 'faturas') {
        if (faturasDiv) faturasDiv.style.display = 'flex';
        if (mesesDiv) mesesDiv.style.display = 'none';
    } else {
        if (faturasDiv) faturasDiv.style.display = 'none';
        if (mesesDiv) mesesDiv.style.display = 'flex';
    }
    
    calcularMediaUnidade();
}

// Calcular média dos consumos da unidade
window.calcularMediaUnidade = function() {
    try {
        // Verificar qual modo está ativo
        const modoFaturas = document.getElementById('modo_faturas');
        const modo12Meses = document.getElementById('modo_12meses');
        
        let valores = [];
        
        if (modoFaturas && modoFaturas.checked) {
            // Modo: 3 Faturas
            for (let i = 1; i <= 3; i++) {
                const el = document.getElementById('unidade_consumo' + i);
                if (el) {
                    const valor = parseFloat(el.value) || 0;
                    if (valor > 0) valores.push(valor);
                }
            }
        } else if (modo12Meses && modo12Meses.checked) {
            // Modo: 12 Meses
            for (let i = 1; i <= 12; i++) {
                const mes = i < 10 ? '0' + i : '' + i;
                const el = document.getElementById('unidade_mes_' + mes);
                if (el) {
                    const valor = parseFloat(el.value) || 0;
                    if (valor > 0) valores.push(valor);
                }
            }
        }
        
        const qtdMedicoes = valores.length;
        const mediaUnidade = qtdMedicoes > 0 ? valores.reduce((a, b) => a + b, 0) / qtdMedicoes : 0;
        
        const previewEl = document.getElementById('previewMediaUnidade');
        const qtdFaturasEl = document.getElementById('qtdFaturas');
        const mediaUnidadeEl = document.getElementById('mediaUnidade');
        
        if (qtdMedicoes > 0 && previewEl && qtdFaturasEl && mediaUnidadeEl) {
            previewEl.style.display = 'block';
            qtdFaturasEl.textContent = qtdMedicoes;
            mediaUnidadeEl.textContent = mediaUnidade.toFixed(2) + ' kWh/mês';
        } else if (previewEl) {
            previewEl.style.display = 'none';
        }
        
        return mediaUnidade;
    } catch (error) {
        console.error('Erro ao calcular média:', error);
        return 0;
    }
}

// Salvar unidade consumidora
window.salvarUnidadeConsumidora = function() {
    try {
        const nome = document.getElementById('unidade_nome').value.trim();
        const numeroUC = document.getElementById('unidade_numero_uc').value.trim();
        const endereco = document.getElementById('unidade_endereco').value.trim();
        
        if (!nome) {
            alert('⚠️ Informe o nome/identificação da unidade');
            return;
        }
        
        // Coletar valores baseado no modo ativo
        const modoFaturas = document.getElementById('modo_faturas');
        let valores = [];
        
        if (modoFaturas && modoFaturas.checked) {
            // Modo: 3 Faturas
            for (let i = 1; i <= 3; i++) {
                const el = document.getElementById('unidade_consumo' + i);
                if (el) {
                    const valor = parseFloat(el.value) || 0;
                    if (valor > 0) valores.push(valor);
                }
            }
        } else {
            // Modo: 12 Meses
            for (let i = 1; i <= 12; i++) {
                const mes = i < 10 ? '0' + i : '' + i;
                const el = document.getElementById('unidade_mes_' + mes);
                if (el) {
                    const valor = parseFloat(el.value) || 0;
                    if (valor > 0) valores.push(valor);
                }
            }
        }
        
        if (valores.length === 0) {
            alert('⚠️ Informe pelo menos 1 medição de consumo');
            return;
        }
        
        const mediaConsumo = valores.reduce((a, b) => a + b, 0) / valores.length;
        
        const unidade = {
            id: unidadeEditandoId || Date.now(),
            nome: nome,
            numeroUC: numeroUC,
            endereco: endereco,
            consumos: valores,
            mediaConsumo: mediaConsumo,
            modo: modoFaturas && modoFaturas.checked ? 'faturas' : '12meses'
        };
        
        if (unidadeEditandoId) {
            // Editar unidade existente
            const index = unidadesConsumidoras.findIndex(u => u.id === unidadeEditandoId);
            if (index !== -1) {
                unidadesConsumidoras[index] = unidade;
            }
        } else {
            // Adicionar nova unidade
            unidadesConsumidoras.push(unidade);
        }
        
        atualizarListaUnidades();
        
        const modalElement = document.getElementById('modalAdicionarUnidade');
        if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) modal.hide();
        }
    } catch (error) {
        console.error('Erro ao salvar unidade:', error);
        alert('Erro ao salvar unidade: ' + error.message);
    }
    
    atualizarListaUnidades();
    bootstrap.Modal.getInstance(document.getElementById('modalAdicionarUnidade')).hide();
}

// Atualizar lista de unidades na interface
function atualizarListaUnidades() {
    const listaContainer = document.getElementById('listaUnidades');
    
    if (unidadesConsumidoras.length === 0) {
        listaContainer.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Nenhuma unidade adicionada. Clique em <strong>"ADICIONAR UNIDADE"</strong> para começar.
            </div>
        `;
    } else {
        let html = '<div class="row g-2">';
        
        unidadesConsumidoras.forEach((unidade, index) => {
            html += `
                <div class="col-md-12">
                    <div class="card shadow-sm">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1" style="color: #28a745;">
                                        <i class="fas fa-building me-2"></i>${unidade.nome}
                                    </h6>
                                    <div class="row mt-2">
                                        <div class="col-md-3">
                                            <small class="text-muted d-block">Nº UC</small>
                                            <strong>${unidade.numeroUC || 'Não informado'}</strong>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted d-block">Endereço</small>
                                            <strong>${unidade.endereco || 'Não informado'}</strong>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted d-block">Medições informadas</small>
                                            <strong>${unidade.consumos.length} mês(es)</strong>
                                        </div>
                                        <div class="col-md-2">
                                            <small class="text-muted d-block">Média de Consumo</small>
                                            <strong style="color: #007bff;">${unidade.mediaConsumo.toFixed(2)} kWh</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="btn-group ms-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editarUnidade(${unidade.id})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="removerUnidade(${unidade.id})" title="Remover">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        listaContainer.innerHTML = html;
    }
    
    atualizarResumoUnidades();
}

// Atualizar resumo (totais)
function atualizarResumoUnidades() {
    const totalUnidades = unidadesConsumidoras.length;
    const consumoTotal = unidadesConsumidoras.reduce((sum, u) => sum + u.mediaConsumo, 0);
    const consumoMedio = totalUnidades > 0 ? consumoTotal / totalUnidades : 0;
    
    document.getElementById('totalUnidades').textContent = totalUnidades;
    document.getElementById('consumoTotalUnidades').textContent = consumoTotal.toFixed(2);
    document.getElementById('consumoMedioPorUnidade').textContent = consumoMedio.toFixed(2);
    document.getElementById('consumoParaDimensionamento').textContent = consumoTotal.toFixed(2) + ' kWh';
    
    // Atualizar campo de consumo mensal principal
    const campoConsumo = document.getElementById('consumo_kwh_mes');
    if (campoConsumo && totalUnidades > 0) {
        campoConsumo.value = consumoTotal.toFixed(2);
    }
}

// Editar unidade
window.editarUnidade = function(id) {
    try {
        const unidade = unidadesConsumidoras.find(u => u.id === id);
        if (!unidade) return;
        
        unidadeEditandoId = id;
        
        const tituloEl = document.getElementById('tituloModalUnidade');
        if (tituloEl) tituloEl.textContent = 'Editar Unidade Consumidora';
        
        const nomeEl = document.getElementById('unidade_nome');
        const numeroUcEl = document.getElementById('unidade_numero_uc');
        const enderecoEl = document.getElementById('unidade_endereco');
        
        if (nomeEl) nomeEl.value = unidade.nome;
        if (numeroUcEl) numeroUcEl.value = unidade.numeroUC || '';
        if (enderecoEl) enderecoEl.value = unidade.endereco || '';
        
        // Definir modo correto
        if (unidade.modo === '12meses' && unidade.consumos.length > 3) {
            const modo12El = document.getElementById('modo_12meses');
            if (modo12El) modo12El.checked = true;
            alterarModoConsumoUnidade('12meses');
            
            // Preencher 12 meses
            for (let i = 0; i < unidade.consumos.length && i < 12; i++) {
                const mes = (i + 1) < 10 ? '0' + (i + 1) : '' + (i + 1);
                const el = document.getElementById('unidade_mes_' + mes);
                if (el) el.value = unidade.consumos[i];
            }
        } else {
            const modoFaturasEl = document.getElementById('modo_faturas');
            if (modoFaturasEl) modoFaturasEl.checked = true;
            alterarModoConsumoUnidade('faturas');
            
            // Preencher até 3 faturas
            for (let i = 0; i < Math.min(3, unidade.consumos.length); i++) {
                const el = document.getElementById('unidade_consumo' + (i + 1));
                if (el) el.value = unidade.consumos[i];
            }
        }
        
        calcularMediaUnidade();
        
        const modalElement = document.getElementById('modalAdicionarUnidade');
        if (modalElement) {
            new bootstrap.Modal(modalElement).show();
        }
    } catch (error) {
        console.error('Erro ao editar unidade:', error);
        alert('Erro ao editar unidade: ' + error.message);
    }
}

// Remover unidade
window.removerUnidade = function(id) {
    if (confirm('❌ Tem certeza que deseja remover esta unidade?')) {
        unidadesConsumidoras = unidadesConsumidoras.filter(u => u.id !== id);
        atualizarListaUnidades();
    }
}

// ========================================
// FIM DO SISTEMA DE UNIDADES CONSUMIDORAS
// ========================================

// Inicializar cálculos ao carregar a página
window.addEventListener('DOMContentLoaded', function() {
    // Carregar unidades consumidoras salvas no banco
    {% if unidades_consumidoras_json %}
    const unidadesSalvas = {{ unidades_consumidoras_json | tojson }};
    if (unidadesSalvas && unidadesSalvas.length > 0) {
        unidadesConsumidoras = unidadesSalvas.map(u => ({
            id: u.id,
            nome: u.nome,
            numeroUC: u.numero_uc || '',
            endereco: u.endereco || '',
            modo: u.modo_consumo || 'faturas',
            consumos: u.consumos || [],
            mediaConsumo: u.media_consumo || 0
        }));
        atualizarListaUnidades();
        atualizarResumoUnidades();
    }
    {% endif %}
    
    // Inicializar lista de unidades consumidoras
    atualizarListaUnidades();
    
    // 🆕 Se um kit já estiver selecionado, calcular potência e layout
    const kitSelect = document.getElementById('kit_id');
    if (kitSelect && kitSelect.value) {
        console.log('🔄 Kit pré-selecionado detectado, recalculando...');
        calcularPotenciaKit();
    }
    
    // Calcular área de instalação e gerar preview do layout se os campos estiverem preenchidos
    const linhas = document.getElementById('linhas_placas');
    const colunas = document.getElementById('colunas_placas');
    if (linhas && colunas && linhas.value && colunas.value) {
        atualizarLayoutVisual();
    }
    
    // Listener para atualizar qtd_fases automaticamente
    const tipoEntrada = document.getElementById('tipo_entrada');
    if (tipoEntrada) {
        tipoEntrada.addEventListener('change', function() {
            const qtdFases = document.getElementById('qtd_fases');
            if (qtdFases) {
                if (this.value === 'monofasico') {
                    qtdFases.value = 1;
                } else if (this.value === 'bifasico') {
                    qtdFases.value = 2;
                } else if (this.value === 'trifasico') {
                    qtdFases.value = 3;
                } else {
                    qtdFases.value = '';
                }
            }
        });
    }
    
    // Sincronizar tipo de instalação da Aba 1 (Dados Iniciais) com Aba 4 (Demais Informações)
    const tipoInstalacaoAba1 = document.getElementById('tipo_instalacao_aba1');
    if (tipoInstalacaoAba1 && tipoEntrada) {
        // Sincronizar de Aba 1 → Aba 4
        tipoInstalacaoAba1.addEventListener('change', function() {
            console.log('🔄 Sincronizando tipo de instalação: Aba 1 → Aba 4');
            if (this.value === 'monofasica') {
                tipoEntrada.value = 'monofasico';
            } else if (this.value === 'bifasica') {
                tipoEntrada.value = 'bifasico';
            } else if (this.value === 'trifasica') {
                tipoEntrada.value = 'trifasico';
            }
            // Disparar evento change no tipo_entrada para atualizar qtd_fases
            tipoEntrada.dispatchEvent(new Event('change'));
        });
        
        // Sincronizar de Aba 4 → Aba 1 (caso usuário mude na Aba 4)
        tipoEntrada.addEventListener('change', function() {
            console.log('🔄 Sincronizando tipo de entrada: Aba 4 → Aba 1');
            if (this.value === 'monofasico') {
                tipoInstalacaoAba1.value = 'monofasica';
            } else if (this.value === 'bifasico') {
                tipoInstalacaoAba1.value = 'bifasica';
            } else if (this.value === 'trifasico') {
                tipoInstalacaoAba1.value = 'trifasica';
            }
        });
    }
    
    // Adicionar event listeners para calcular média automaticamente
    // 3 Faturas
    for (let i = 1; i <= 3; i++) {
        const input = document.getElementById('unidade_consumo' + i);
        if (input) {
            input.addEventListener('input', function() {
                if (window.calcularMediaUnidade) {
                    window.calcularMediaUnidade();
                }
            });
        }
    }
    
    // 12 Meses
    for (let i = 1; i <= 12; i++) {
        const mes = i < 10 ? '0' + i : '' + i;
        const input = document.getElementById('unidade_mes_' + mes);
        if (input) {
            input.addEventListener('input', function() {
                if (window.calcularMediaUnidade) {
                    window.calcularMediaUnidade();
                }
            });
        }
    }

    // AUTO-PREENCHIMENTO ao vincular cliente
    {% if projeto.cliente_id %}
    carregarDadosCliente({{ projeto.cliente_id }});
    {% endif %}
});

// Função chamada quando seleciona cliente no dropdown
function selecionarCliente(clienteId) {
    if (clienteId) {
        carregarDadosCliente(clienteId);
    }
}

// Função para carregar dados do cliente automaticamente
async function carregarDadosCliente(clienteId) {
    try {
        const response = await fetch(`/energia-solar/api/cliente/${clienteId}`);
        if (!response.ok) throw new Error('Erro ao buscar dados do cliente');
        
        const dados = await response.json();
        
        // Preencher campos (sempre sobrescreve para manter sincronizado com o cliente)
        const campoCidade = document.getElementById('campo_cidade');
        if (campoCidade) {
            campoCidade.value = dados.cidade || '';
        }
        
        const campoEstado = document.getElementById('campo_estado');
        if (campoEstado) {
            campoEstado.value = dados.estado || '';
            
            // Buscar irradiação automática se estado foi preenchido
            if (dados.estado) {
                try {
                    const respIrr = await fetch(`/energia-solar/api/irradiacao/${dados.estado}`);
                    const dadosIrr = await respIrr.json();
                    const campoIrradiacao = document.querySelector('input[name="irradiacao_solar"]');
                    if (campoIrradiacao && !campoIrradiacao.value) {
                        campoIrradiacao.value = dadosIrr.irradiacao;
                    }
                } catch (e) {
                    console.error('Erro ao buscar irradiação:', e);
                }
            }
        }
        
        // Preencher latitude e longitude se disponíveis
        const campoLatitude = document.getElementById('campo_latitude');
        const campoLongitude = document.getElementById('campo_longitude');
        
        if (dados.latitude && dados.longitude) {
            // Cliente tem lat/long cadastrados
            if (campoLatitude) {
                campoLatitude.value = dados.latitude;
                console.log('✅ Latitude preenchida:', dados.latitude);
            }
            if (campoLongitude) {
                campoLongitude.value = dados.longitude;
                console.log('✅ Longitude preenchida:', dados.longitude);
            }
        } else if (dados.cidade && dados.estado) {
            // Tentar buscar lat/long via API de geolocalização
            console.log('🔍 Buscando coordenadas para:', `${dados.cidade}, ${dados.estado}`);
            try {
                const geoUrl = `https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(dados.cidade)}&state=${encodeURIComponent(dados.estado)}&country=Brazil&format=json&limit=1`;
                const geoResp = await fetch(geoUrl);
                const geoData = await geoResp.json();
                
                if (geoData && geoData.length > 0) {
                    const lat = parseFloat(geoData[0].lat).toFixed(5);
                    const lon = parseFloat(geoData[0].lon).toFixed(5);
                    
                    if (campoLatitude && !campoLatitude.value) {
                        campoLatitude.value = lat;
                        console.log('✅ Latitude obtida via geolocalização:', lat);
                    }
                    if (campoLongitude && !campoLongitude.value) {
                        campoLongitude.value = lon;
                        console.log('✅ Longitude obtida via geolocalização:', lon);
                    }
                } else {
                    console.log('⚠️ Coordenadas não encontradas para esta cidade');
                }
            } catch (e) {
                console.error('⚠️ Erro ao buscar coordenadas:', e);
            }
        } else {
            console.log('⚠️ Latitude/Longitude não disponível e cidade/estado insuficientes');
        }
        
        console.log('✅ Dados do cliente carregados:', dados.nome);
    } catch (error) {
        console.error('❌ Erro ao carregar dados do cliente:', error);
    }
}
</script>
{% endblock %}
