{% extends 'base.html' %}

{% block title %}Kits Solares - Catálogo{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0" style="background: transparent;">
        <li class="breadcrumb-item"><a href="{{ url_for('painel.dashboard') }}"><i class="fas fa-home"></i></a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('energia_solar.dashboard') }}">Energia Solar</a></li>
        <li class="breadcrumb-item active">Kits Solares</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header com Botão -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-ciano mb-1"><i class="fas fa-boxes-stacked me-2"></i>Kits Solares</h2>
            <p class="text-muted mb-0">Gerencie kits completos prontos para orçamento</p>
        </div>
        <button class="btn btn-ciano" data-bs-toggle="modal" data-bs-target="#modalNovoKit">
            <i class="fas fa-plus me-2"></i>Novo Kit
        </button>
    </div>

    <!-- Estatísticas -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card bg-dark border-ciano">
                <div class="card-body text-center">
                    <i class="fas fa-boxes-stacked fa-2x text-ciano mb-2"></i>
                    <h3 class="text-ciano mb-0">{{ kits|length }}</h3>
                    <small class="text-muted">Kits Cadastrados</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-verde">
                <div class="card-body text-center">
                    <i class="fas fa-solar-panel fa-2x text-verde mb-2"></i>
                    <h3 class="text-verde mb-0">{{ placas|length }}</h3>
                    <small class="text-muted">Placas Disponíveis</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-amarelo">
                <div class="card-body text-center">
                    <i class="fas fa-microchip fa-2x text-amarelo mb-2"></i>
                    <h3 class="text-amarelo mb-0">{{ inversores|length }}</h3>
                    <small class="text-muted">Inversores Disponíveis</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-roxo">
                <div class="card-body text-center">
                    <i class="fas fa-bolt fa-2x text-roxo mb-2"></i>
                    <h3 class="text-roxo mb-0">{{ "%.2f"|format(kits|sum(attribute='potencia_kwp')) }}</h3>
                    <small class="text-muted">kWp Total</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Kits -->
    {% if kits %}
    <div class="row g-4">
        {% for kit in kits %}
        <div class="col-md-6 col-lg-4">
            <div class="card bg-dark border-ciano h-100">
                <div class="card-header bg-gradient-ciano">
                    <h5 class="mb-0">
                        <i class="fas fa-box-open me-2"></i>{{ kit.fabricante }}
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Descrição -->
                    <h6 class="text-ciano mb-3">{{ kit.descricao }}</h6>
                    
                    <!-- Potência -->
                    <div class="alert alert-info mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-bolt me-2"></i>Potência do Kit</span>
                            <strong class="fs-5">{{ "%.2f"|format(kit.potencia_kwp) }} kWp</strong>
                        </div>
                    </div>

                    <!-- Componentes -->
                    <div class="border-top pt-3 mb-3">
                        <h6 class="text-verde mb-2"><i class="fas fa-solar-panel me-2"></i>Placas Solares</h6>
                        <div class="ps-3">
                            <div class="mb-1"><strong>{{ kit.placa.modelo }}</strong></div>
                            <small class="text-muted d-block">{{ kit.placa.fabricante }}</small>
                            <small class="text-muted d-block">{{ kit.placa.potencia }}W × {{ kit.qtd_placas }} unidades</small>
                        </div>
                    </div>

                    <div class="border-top pt-3 mb-3">
                        <h6 class="text-amarelo mb-2"><i class="fas fa-microchip me-2"></i>Inversores</h6>
                        <div class="ps-3">
                            <div class="mb-1"><strong>{{ kit.inversor.modelo }}</strong></div>
                            <small class="text-muted d-block">{{ kit.inversor.fabricante }}</small>
                            <small class="text-muted d-block">{{ kit.inversor.potencia_nominal }}kW × {{ kit.qtd_inversores }} unidades</small>
                        </div>
                    </div>

                    <!-- Outras Informações -->
                    {% if kit.outras_informacoes %}
                    <div class="border-top pt-3 mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-2"></i>Outros Itens</h6>
                        <small class="text-muted" style="white-space: pre-line;">{{ kit.outras_informacoes }}</small>
                    </div>
                    {% endif %}

                    <!-- Preço -->
                    <div class="border-top pt-3">
                        <div class="text-center p-3 rounded" style="background: rgba(16, 185, 129, 0.1);">
                            <small class="text-muted d-block mb-1">Preço do Kit</small>
                            <strong class="text-verde fs-4">R$ {{ "%.2f"|format(kit.preco) }}</strong>
                            <small class="text-muted d-block mt-1">R$ {{ "%.2f"|format(kit.preco / kit.potencia_kwp) }}/Wp</small>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-top">
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-ciano flex-grow-1" onclick="alert('Função de edição em desenvolvimento')">
                            <i class="fas fa-edit me-1"></i>Editar
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="excluirKit({{ kit.id }}, '{{ kit.descricao }}')">
                            <i class="fas fa-trash me-1"></i>Excluir
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        Nenhum kit cadastrado. Clique em "Novo Kit" para começar.
    </div>
    {% endif %}
</div>

<!-- Modal Novo Kit -->
<div class="modal fade" id="modalNovoKit" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-ciano">
            <form method="POST" action="{{ url_for('energia_solar.kit_criar') }}" id="formNovoKit">
                <div class="modal-header bg-gradient-ciano">
                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Novo Kit Solar</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Seção 1: Identificação -->
                    <div class="mb-4">
                        <div class="bg-gradient-roxo p-2 rounded mb-3">
                            <h6 class="mb-0"><i class="fas fa-tag me-2"></i>Identificação do Kit</h6>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Fabricante *</label>
                                <input type="text" class="form-control" name="fabricante" placeholder="Ex: NEOSOLAR" required>
                                <small class="text-muted">Fabricante ou marca do kit</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Potência (kWp) *</label>
                                <input type="number" step="0.01" class="form-control" name="potencia_kwp" placeholder="0.46" required>
                                <small class="text-muted">Potência total do kit em kWp</small>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Descrição do Kit *</label>
                                <input type="text" class="form-control" name="descricao" placeholder="KIT GERADOR ENERGIA SOLAR 0,46 KWP - MICROINVERSOR..." required>
                                <small class="text-muted">Descrição completa do kit</small>
                            </div>
                        </div>
                    </div>

                    <!-- Seção 2: Placas Solares -->
                    <div class="mb-4">
                        <div class="bg-gradient-verde p-2 rounded mb-3">
                            <h6 class="mb-0"><i class="fas fa-solar-panel me-2"></i>Placas Solares</h6>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Selecione a Placa *</label>
                                <select class="form-select" name="placa_id" required>
                                    <option value="">Escolha uma placa...</option>
                                    {% for placa in placas %}
                                    <option value="{{ placa.id }}">{{ placa.fabricante }} / {{ placa.modelo }} / {{ placa.potencia }} Wp</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Modelo de placa solar</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Quantidade *</label>
                                <input type="number" class="form-control" name="qtd_placas" value="1" min="1" required>
                                <small class="text-muted">Unidades no kit</small>
                            </div>
                        </div>
                    </div>

                    <!-- Seção 3: Inversores -->
                    <div class="mb-4">
                        <div class="bg-gradient-amarelo p-2 rounded mb-3">
                            <h6 class="mb-0 text-dark"><i class="fas fa-microchip me-2"></i>Inversores</h6>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Selecione o Inversor *</label>
                                <select class="form-select" name="inversor_id" required>
                                    <option value="">Escolha um inversor...</option>
                                    {% for inversor in inversores %}
                                    <option value="{{ inversor.id }}">{{ inversor.fabricante }} / {{ inversor.modelo }} / {{ inversor.potencia_nominal }} kW</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Modelo de inversor</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Quantidade *</label>
                                <input type="number" class="form-control" name="qtd_inversores" value="1" min="1" required>
                                <small class="text-muted">Unidades no kit</small>
                            </div>
                        </div>
                    </div>

                    <!-- Seção 4: Outros Componentes -->
                    <div class="mb-4">
                        <div class="bg-gradient-ciano p-2 rounded mb-3">
                            <h6 class="mb-0"><i class="fas fa-tools me-2"></i>Outros Componentes</h6>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Outras Informações</label>
                            <textarea class="form-control" name="outras_informacoes" rows="4" placeholder="CONECTOR CA&#10;CONECTOR END CAP FÊMEA (TAMPA FINAL)&#10;STRING BOX..."></textarea>
                            <small class="text-muted">Liste outros componentes inclusos (cabos, conectores, etc.)</small>
                        </div>
                    </div>

                    <!-- Seção 5: Precificação -->
                    <div class="mb-3">
                        <div class="bg-gradient-warning p-2 rounded mb-3">
                            <h6 class="mb-0 text-dark"><i class="fas fa-dollar-sign me-2"></i>Precificação</h6>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Preço do Kit (R$) *</label>
                            <input type="number" step="0.01" class="form-control" name="preco" placeholder="0.00" required>
                            <small class="text-muted">Preço total do kit completo</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-ciano">
                        <i class="fas fa-save me-2"></i>Salvar Kit
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Validação do formulário
document.getElementById('formNovoKit').addEventListener('submit', function(e) {
    const potencia = parseFloat(document.querySelector('[name="potencia_kwp"]').value);
    const preco = parseFloat(document.querySelector('[name="preco"]').value);
    
    if (potencia <= 0) {
        e.preventDefault();
        alert('A potência deve ser maior que zero!');
        return false;
    }
    
    if (preco <= 0) {
        e.preventDefault();
        alert('O preço deve ser maior que zero!');
        return false;
    }
});

// Excluir kit
function excluirKit(id, descricao) {
    if (confirm(`Tem certeza que deseja excluir o kit "${descricao}"?`)) {
        fetch(`/energia-solar/kits/excluir/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Erro ao excluir kit!');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao excluir kit!');
        });
    }
}
</script>
{% endblock %}
