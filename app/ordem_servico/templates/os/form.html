{% extends "base.html" %}

{% block title %}
{% if ordem %}Editar OS {{ ordem.numero }}{% else %}Nova Ordem de Servi√ßo{% endif %}
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb bg-transparent mb-0">
        <li class="breadcrumb-item">
            <a href="{{ url_for('painel.dashboard') }}" class="text-decoration-none text-light">
                <i class="fas fa-home"></i> Dashboard
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('ordem_servico.listar') }}" class="text-decoration-none text-light">
                <i class="fas fa-tools"></i> Ordens de Servi√ßo
            </a>
        </li>
        <li class="breadcrumb-item active text-warning" aria-current="page">
            <i class="fas fa-{% if ordem %}edit{% else %}plus{% endif %}"></i>
            {% if ordem %}Editar OS #{{ ordem.numero }}{% else %}Nova OS{% endif %}
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        
        <!-- INFORMA√á√ïES B√ÅSICAS -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Informa√ß√µes B√°sicas</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label text-white">Cliente *</label>
                        <select class="form-select bg-dark text-white border-secondary" name="cliente_id" required>
                            <option value="">Selecione um cliente</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}" 
                                    {% if ordem and ordem.cliente_id == cliente.id %}selected{% endif %}>
                                {{ cliente.nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-white">Equipamento *</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               name="equipamento" value="{{ ordem.equipamento if ordem else '' }}" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-white">Data Prevista</label>
                        <input type="date" class="form-control bg-dark text-white border-secondary" 
                               name="data_prevista" value="{{ ordem.data_prevista if ordem else '' }}">
                    </div>
                    <div class="col-12">
                        <label class="form-label text-white">Descri√ß√£o do Problema</label>
                        <textarea class="form-control bg-dark text-white border-secondary" name="descricao" rows="3">{{ ordem.descricao if ordem else '' }}</textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label text-white">Observa√ß√µes T√©cnicas</label>
                        <textarea class="form-control bg-dark text-white border-secondary" name="observacoes" rows="3">{{ ordem.observacoes if ordem else '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- SERVI√áOS -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-wrench"></i> Servi√ßos Realizados</h5>
                <button type="button" class="btn btn-outline-light btn-sm" id="btnAdicionarServico">
                    <i class="fas fa-plus me-1"></i>Adicionar
                </button>
            </div>
            <div class="card-body">
                <!-- Cabe√ßalho dos campos -->
                <div class="row g-2 mb-2">
                    <div class="col-md-3"><small class="text-muted">Descri√ß√£o</small></div>
                    <div class="col-md-2"><small class="text-muted">Tipo</small></div>
                    <div class="col-md-2"><small class="text-muted">Quantidade</small></div>
                    <div class="col-md-2"><small class="text-muted">Valor Unit.</small></div>
                    <div class="col-md-2"><small class="text-muted">Total</small></div>
                    <div class="col-md-1"><small class="text-muted">A√ß√µes</small></div>
                </div>
                
                <!-- Container para servi√ßos din√¢micos -->
                <div id="servicosContainer">
                    {% if ordem and ordem.servicos %}
                        {% for servico in ordem.servicos %}
                            <div class="servico-item mb-3">
                                <div class="row g-2 align-items-center">
                                    <div class="col-md-3">
                                        <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                                               name="servico_descricao[]" value="{{ servico.descricao }}" placeholder="Descri√ß√£o do servi√ßo" required>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select form-select-sm bg-dark text-white border-secondary" name="servico_tipo[]">
                                            <option value="Servi√ßo Fechado" {% if servico.tipo_servico == 'fechado' %}selected{% endif %}>üéØ Servi√ßo Fechado</option>
                                            <option value="Hora T√©cnica" {% if servico.tipo_servico == 'hora' %}selected{% endif %}>‚è±Ô∏è Hora T√©cnica</option>
                                            <option value="Deslocamento" {% if servico.tipo_servico == 'deslocamento' %}selected{% endif %}>üöó Deslocamento</option>
                                            <option value="Outros" {% if servico.tipo_servico == 'outros' %}selected{% endif %}>üìã Outros</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary servico-quantidade" 
                                               name="servico_quantidade[]" value="{{ servico.quantidade }}" step="0.25" min="0" placeholder="1,00">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary servico-valor" 
                                               name="servico_valor[]" value="{{ servico.valor_unitario }}" placeholder="0,00">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm bg-secondary text-white servico-total" 
                                               readonly value="R$ {{ '%.2f'|format(servico.quantidade * servico.valor_unitario) }}">
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-outline-danger btn-sm w-100 btn-remover-servico">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- PRODUTOS -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-boxes"></i> Produtos/Pe√ßas Utilizados</h5>
                <button type="button" class="btn btn-outline-light btn-sm" id="btnAdicionarProduto">
                    <i class="fas fa-plus me-1"></i>Adicionar
                </button>
            </div>
            <div class="card-body">
                <!-- Cabe√ßalho dos campos -->
                <div class="row g-2 mb-2">
                    <div class="col-md-4"><small class="text-muted">Produto/Pe√ßa</small></div>
                    <div class="col-md-2"><small class="text-muted">Quantidade</small></div>
                    <div class="col-md-2"><small class="text-muted">Valor Unit.</small></div>
                    <div class="col-md-2"><small class="text-muted">Total</small></div>
                    <div class="col-md-2"><small class="text-muted">A√ß√µes</small></div>
                </div>
                
                <!-- Container para produtos din√¢micos -->
                <div id="produtosContainer">
                    {% if ordem and ordem.produtos %}
                        {% for produto in ordem.produtos %}
                            <div class="produto-item mb-3">
                                <div class="row g-2 align-items-center">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                                               name="produto_descricao[]" value="{{ produto.descricao }}" placeholder="Descri√ß√£o do produto" required>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary produto-quantidade" 
                                               name="produto_quantidade[]" value="{{ produto.quantidade }}" step="1" min="0" placeholder="1">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary produto-valor" 
                                               name="produto_valor[]" value="{{ produto.valor_unitario }}" placeholder="0,00">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm bg-secondary text-white produto-total" 
                                               readonly value="R$ {{ '%.2f'|format(produto.quantidade * produto.valor_unitario) }}">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-outline-danger btn-sm w-100 btn-remover-produto">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- TOTAIS -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-calculator"></i> Totais</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label text-white">Valor Servi√ßos</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               id="valorServicos" name="valor_servicos" readonly value="R$ 0,00">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Valor Produtos</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               id="valorProdutos" name="valor_produtos" readonly value="R$ 0,00">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Desconto</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               id="desconto" name="desconto" placeholder="0,00" value="{{ ordem.desconto if ordem else '0,00' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Valor Total</label>
                        <input type="text" class="form-control bg-success text-white" 
                               id="valorTotal" name="valor_total" readonly value="R$ 0,00">
                    </div>
                </div>
            </div>
        </div>

        <!-- BOT√ïES -->
        <div class="card bg-dark border-secondary">
            <div class="card-body text-center">
                <button type="submit" class="btn btn-success btn-lg me-2">
                    <i class="fas fa-save me-1"></i>
                    {% if ordem %}Atualizar Ordem{% else %}Criar Ordem{% endif %}
                </button>
                <a href="{{ url_for('ordem_servico.listar') }}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-times me-1"></i>Cancelar
                </a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script>
console.log('üöÄ Sistema de Ordem de Servi√ßo inicializado!');

document.addEventListener('DOMContentLoaded', function() {
    let servicoIndex = {{ (ordem.servicos|length) if ordem and ordem.servicos else 0 }};
    let produtoIndex = {{ (ordem.produtos|length) if ordem and ordem.produtos else 0 }};
    
    console.log('√çndices iniciais:', { servicoIndex, produtoIndex });
    
    // Fun√ß√£o para converter valor monet√°rio para n√∫mero
    function converterParaNumero(valor) {
        if (!valor) return 0;
        return parseFloat(valor.toString().replace(',', '.').replace(/[^\d.-]/g, '')) || 0;
    }
    
    // Fun√ß√£o para formatar n√∫mero para moeda brasileira
    function formatarMoeda(valor) {
        return 'R$ ' + parseFloat(valor).toFixed(2).replace('.', ',');
    }
    
    // Fun√ß√£o para calcular total de um item
    function calcularTotalItem(container) {
        const quantidade = container.querySelector('.servico-quantidade, .produto-quantidade');
        const valor = container.querySelector('.servico-valor, .produto-valor');
        const total = container.querySelector('.servico-total, .produto-total');
        
        if (quantidade && valor && total) {
            const qtd = converterParaNumero(quantidade.value);
            const vlr = converterParaNumero(valor.value);
            const totalCalculado = qtd * vlr;
            total.value = formatarMoeda(totalCalculado);
        }
        
        calcularTotaisGerais();
    }
    
    // Fun√ß√£o para calcular totais gerais
    function calcularTotaisGerais() {
        let totalServicos = 0;
        let totalProdutos = 0;
        
        // Somar servi√ßos
        document.querySelectorAll('.servico-total').forEach(function(campo) {
            totalServicos += converterParaNumero(campo.value);
        });
        
        // Somar produtos
        document.querySelectorAll('.produto-total').forEach(function(campo) {
            totalProdutos += converterParaNumero(campo.value);
        });
        
        const desconto = converterParaNumero(document.getElementById('desconto').value);
        const total = totalServicos + totalProdutos - desconto;
        
        document.getElementById('valorServicos').value = formatarMoeda(totalServicos);
        document.getElementById('valorProdutos').value = formatarMoeda(totalProdutos);
        document.getElementById('valorTotal').value = formatarMoeda(total);
    }
    
    // Adicionar Servi√ßo
    document.getElementById('btnAdicionarServico').addEventListener('click', function() {
        console.log('Adicionando servi√ßo...');
        
        const container = document.getElementById('servicosContainer');
        const div = document.createElement('div');
        div.className = 'servico-item mb-3';
        div.innerHTML = `
            <div class="row g-2 align-items-center">
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                           name="servico_descricao[]" placeholder="Descri√ß√£o do servi√ßo" required>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm bg-dark text-white border-secondary" name="servico_tipo[]">
                        <option value="Servi√ßo Fechado">üéØ Servi√ßo Fechado</option>
                        <option value="Hora T√©cnica">‚è±Ô∏è Hora T√©cnica</option>
                        <option value="Deslocamento">üöó Deslocamento</option>
                        <option value="Outros">üìã Outros</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary servico-quantidade" 
                           name="servico_quantidade[]" value="1" step="0.25" min="0" placeholder="1,00">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary servico-valor" 
                           name="servico_valor[]" placeholder="0,00">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm bg-secondary text-white servico-total" 
                           readonly value="R$ 0,00">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm w-100 btn-remover-servico">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(div);
        servicoIndex++;
        console.log('Servi√ßo adicionado! Total:', servicoIndex);
        
        // Adicionar eventos aos novos campos
        const novoItem = div;
        const qtdField = novoItem.querySelector('.servico-quantidade');
        const valorField = novoItem.querySelector('.servico-valor');
        
        qtdField.addEventListener('input', function() {
            calcularTotalItem(novoItem);
        });
        
        valorField.addEventListener('input', function() {
            calcularTotalItem(novoItem);
        });
    });
    
    // Adicionar Produto
    document.getElementById('btnAdicionarProduto').addEventListener('click', function() {
        console.log('Adicionando produto...');
        
        const container = document.getElementById('produtosContainer');
        const div = document.createElement('div');
        div.className = 'produto-item mb-3';
        div.innerHTML = `
            <div class="row g-2 align-items-center">
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                           name="produto_descricao[]" placeholder="Descri√ß√£o do produto" required>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary produto-quantidade" 
                           name="produto_quantidade[]" value="1" step="1" min="0" placeholder="1">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary produto-valor" 
                           name="produto_valor[]" placeholder="0,00">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm bg-secondary text-white produto-total" 
                           readonly value="R$ 0,00">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm w-100 btn-remover-produto">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(div);
        produtoIndex++;
        console.log('Produto adicionado! Total:', produtoIndex);
        
        // Adicionar eventos aos novos campos
        const novoItem = div;
        const qtdField = novoItem.querySelector('.produto-quantidade');
        const valorField = novoItem.querySelector('.produto-valor');
        
        qtdField.addEventListener('input', function() {
            calcularTotalItem(novoItem);
        });
        
        valorField.addEventListener('input', function() {
            calcularTotalItem(novoItem);
        });
    });
    
    // Event listeners para remover itens
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-remover-servico')) {
            e.target.closest('.servico-item').remove();
            calcularTotaisGerais();
        }
        if (e.target.closest('.btn-remover-produto')) {
            e.target.closest('.produto-item').remove();
            calcularTotaisGerais();
        }
    });
    
    // Event listeners para c√°lculos em itens existentes
    document.addEventListener('input', function(e) {
        if (e.target.matches('.servico-quantidade, .servico-valor')) {
            calcularTotalItem(e.target.closest('.servico-item'));
        }
        if (e.target.matches('.produto-quantidade, .produto-valor')) {
            calcularTotalItem(e.target.closest('.produto-item'));
        }
        if (e.target.id === 'desconto') {
            calcularTotaisGerais();
        }
    });
    
    // Calcular totais iniciais
    calcularTotaisGerais();
});
</script>
{% endblock %}