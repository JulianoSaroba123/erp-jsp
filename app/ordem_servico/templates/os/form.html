{% extends "base.html" %}

{% block title %}
{% if ordem %}Editar OS {{ ordem.numero }}{% else %}Nova Ordem de Servi√ßo{% endif %}
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb bg-transparent mb-0">
        <li class="breadcrumb-item">
            <a href="{{ url_for('painel.dashboard') }}" class="text-decoration-none text-light">
                <i class="fas fa-home"></i> Dashboard
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('ordem_servico.listar') }}" class="text-decoration-none text-light">
                <i class="fas fa-tools"></i> Ordens de Servi√ßo
            </a>
        </li>
        <li class="breadcrumb-item active text-warning" aria-current="page">
            <i class="fas fa-{% if ordem %}edit{% else %}plus{% endif %}"></i>
            {% if ordem %}Editar OS #{{ ordem.numero }}{% else %}Nova OS{% endif %}
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        
        <!-- INFORMA√á√ïES B√ÅSICAS -->
        <div class="mb-4 p-3 rounded-3" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);">
            <h5 class="mb-0 text-white fw-bold"><i class="fas fa-info-circle me-2"></i>Informa√ß√µes B√°sicas</h5>
        </div>
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label text-white">Cliente *</label>
                        <div class="input-group">
                            <select class="form-select bg-dark text-white border-secondary" name="cliente_id" id="cliente_select_os" required>
                                <option value="">Selecione um cliente</option>
                                {% for cliente in clientes %}
                                    {% if cliente.nome and cliente.nome.strip() %}
                                    <option value="{{ cliente.id }}" 
                                            {% if ordem and ordem.cliente_id == cliente.id %}selected{% endif %}>
                                        {{ cliente.nome }}
                                    </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <button class="btn btn-outline-info" type="button" id="btnAtualizarClientesOS" title="Atualizar lista de clientes" data-no-submit="true">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-outline-warning" type="button" id="btnRefreshClientesOS" title="Refresh for√ßado com debug" data-no-submit="true">
                                <i class="fas fa-refresh"></i>
                            </button>
                            <a href="{{ url_for('cliente.novo') }}" class="btn btn-outline-success" title="Cadastrar novo cliente" target="_blank">
                                <i class="fas fa-plus"></i>
                            </a>
                        </div>
                        <small class="text-muted">üí° Cadastrou um cliente novo? Clique em <i class="fas fa-sync-alt"></i> para atualizar ou <i class="fas fa-refresh"></i> para debug</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Solicitante</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               name="solicitante" value="{{ ordem.solicitante if ordem else '' }}" placeholder="Nome do solicitante">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">T√©cnico Respons√°vel</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               name="tecnico_responsavel" value="{{ ordem.tecnico_responsavel if ordem else '' }}" placeholder="Nome do t√©cnico">
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <label class="form-label text-white">T√≠tulo do Servi√ßo *</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               name="titulo" value="{{ ordem.titulo if ordem else '' }}" required placeholder="T√≠tulo da ordem de servi√ßo">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-white">Prioridade</label>
                        <select class="form-select bg-dark text-white border-secondary" name="prioridade">
                            <option value="baixa" {% if ordem and ordem.prioridade == 'baixa' %}selected{% endif %}>üìù Baixa</option>
                            <option value="normal" {% if ordem and ordem.prioridade == 'normal' %}selected{% elif not ordem %}selected{% endif %}>‚ö° Normal</option>
                            <option value="alta" {% if ordem and ordem.prioridade == 'alta' %}selected{% endif %}>üî• Alta</option>
                            <option value="urgente" {% if ordem and ordem.prioridade == 'urgente' %}selected{% endif %}>üö® Urgente</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-white">Status</label>
                        <select class="form-select bg-dark text-white border-secondary" name="status">
                            <option value="aberta" {% if ordem and ordem.status == 'aberta' %}selected{% elif not ordem %}selected{% endif %}>üìÇ Aberta</option>
                            <option value="iniciada" {% if ordem and ordem.status == 'iniciada' %}selected{% endif %}>‚ñ∂Ô∏è Iniciada</option>
                            <option value="em_andamento" {% if ordem and (ordem.status == 'em_andamento' or ordem.status == 'em_execucao') %}selected{% endif %}>üîÑ Em Andamento</option>
                            <option value="aguardando_cliente" {% if ordem and ordem.status == 'aguardando_cliente' %}selected{% endif %}>‚è≥ Aguardando Cliente</option>
                            <option value="concluida" {% if ordem and ordem.status == 'concluida' %}selected{% endif %}>‚úÖ Conclu√≠da</option>
                            <option value="cancelada" {% if ordem and ordem.status == 'cancelada' %}selected{% endif %}>‚ùå Cancelada</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-white">Data Prevista</label>
                        <input type="date" class="form-control bg-dark text-white border-secondary" 
                               name="data_prevista" value="{{ ordem.data_prevista.strftime('%Y-%m-%d') if ordem and ordem.data_prevista else '' }}">
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-3">
                        <label class="form-label text-white">Data de Abertura</label>
                        <input type="date" class="form-control bg-dark text-white border-secondary" 
                               name="data_abertura" value="{{ ordem.data_abertura.strftime('%Y-%m-%d') if ordem and ordem.data_abertura else '' }}">
                        <small class="text-muted">üìÖ Data em que a OS foi criada</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Data de In√≠cio</label>
                        <input type="datetime-local" class="form-control bg-dark text-white border-secondary" 
                               name="data_inicio" value="{{ ordem.data_inicio.strftime('%Y-%m-%dT%H:%M') if ordem and ordem.data_inicio else '' }}">
                        <small class="text-muted">üöÄ Data/hora que o servi√ßo come√ßou</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Data de Conclus√£o</label>
                        <input type="datetime-local" class="form-control bg-dark text-white border-secondary" 
                               name="data_conclusao" value="{{ ordem.data_conclusao.strftime('%Y-%m-%dT%H:%M') if ordem and ordem.data_conclusao else '' }}">
                        <small class="text-muted">‚úÖ Data/hora que o servi√ßo foi finalizado</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Data Vencimento Pgto</label>
                        <input type="date" class="form-control bg-dark text-white border-secondary" 
                               name="data_vencimento_pagamento" value="{{ ordem.data_vencimento_pagamento.strftime('%Y-%m-%d') if ordem and ordem.data_vencimento_pagamento else '' }}">
                        <small class="text-muted">üí∞ Vencimento do pagamento</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- DADOS DO EQUIPAMENTO -->
        <div class="mb-3 p-3 rounded-3" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);">
            <h5 class="mb-0 text-white fw-bold"><i class="fas fa-cogs me-2"></i>Dados do Equipamento</h5>
        </div>
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-12 mb-3">
                        <label class="form-label text-white">
                            <i class="fas fa-database me-2"></i>Selecionar Equipamento Cadastrado
                        </label>
                        <div class="input-group">
                            <select class="form-select bg-dark text-white border-secondary" 
                                    id="equipamento_cadastrado" 
                                    name="equipamento_cadastrado">
                                <option value="">Primeiro selecione um cliente acima</option>
                            </select>
                            <button type="button" class="btn btn-outline-warning" id="btn_recarregar_equipamentos" title="Recarregar equipamentos">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Selecione um cliente acima, depois escolha o equipamento aqui. 
                            <a href="{{ url_for('equipamento.novo') }}" target="_blank" class="text-warning">
                                <i class="fas fa-plus-circle"></i> Cadastrar novo equipamento
                            </a>
                        </small>
                    </div>
                    
                    <div class="col-md-5">
                        <label class="form-label text-white">
                            Equipamento *
                        </label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               id="equipamento" name="equipamento" value="{{ ordem.equipamento if ordem else '' }}" 
                               required placeholder="Digite o nome do equipamento"
                               autocomplete="off">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-white">Marca/Modelo</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               id="marca_modelo" name="marca_modelo" value="{{ ordem.marca_modelo if ordem else '' }}" 
                               placeholder="Marca e modelo">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">N√∫mero de S√©rie</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               id="numero_serie" name="numero_serie" value="{{ ordem.numero_serie if ordem else '' }}" 
                               placeholder="N√∫mero de s√©rie">
                    </div>
                </div>
            </div>
        </div>

        <!-- DESCRI√á√ïES T√âCNICAS -->
        <div class="mb-3 p-3 rounded-3" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);">
            <h5 class="mb-0 text-white fw-bold"><i class="fas fa-clipboard-list me-2"></i>Descri√ß√µes T√©cnicas</h5>
        </div>
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label text-white">Problema Relatado pelo Cliente</label>
                        <textarea class="form-control bg-dark text-white border-secondary" name="descricao_problema" rows="4" placeholder="O que o cliente relatou? Ex: Notebook n√£o liga, tela azul, etc.">{{ ordem.descricao_problema if ordem else '' }}</textarea>
                        <small class="text-muted">Relato inicial do cliente sobre o problema</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white">Diagn√≥stico T√©cnico</label>
                        <textarea class="form-control bg-dark text-white border-secondary" name="diagnostico_tecnico" rows="4" placeholder="An√°lise t√©cnica do problema. Ex: Fonte queimada, HD com defeito, etc.">{{ ordem.diagnostico_tecnico if ordem else '' }}</textarea>
                        <small class="text-muted">Diagn√≥stico ap√≥s an√°lise t√©cnica</small>
                    </div>
                    <div class="col-12">
                        <label class="form-label text-white">Solu√ß√£o Aplicada</label>
                        <textarea class="form-control bg-dark text-white border-secondary" name="solucao" rows="3" placeholder="O que foi feito para resolver? Ex: Substitu√≠da fonte 65W, reinstalado Windows, etc.">{{ ordem.solucao if ordem else '' }}</textarea>
                        <small class="text-muted">Procedimento realizado para solucionar o problema</small>
                    </div>
                    <div class="col-12">
                        <label class="form-label text-white">Observa√ß√µes Gerais</label>
                        <textarea class="form-control bg-dark text-white border-secondary" name="observacoes" rows="3" placeholder="Observa√ß√µes adicionais, recomenda√ß√µes, etc.">{{ ordem.observacoes if ordem else '' }}</textarea>
                        <small class="text-muted">Informa√ß√µes complementares sobre o servi√ßo</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTROLE DE TEMPO E KM -->
        <div class="mb-4 p-3 rounded-3" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);">
            <h5 class="mb-0 text-white fw-bold"><i class="fas fa-clock me-2"></i>Controle de Tempo e Deslocamento</h5>
        </div>
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label text-white">Hora Inicial</label>
                        <input type="time" class="form-control bg-dark text-white border-secondary" 
                               name="hora_inicial" value="{{ ordem.hora_inicial.strftime('%H:%M') if ordem and ordem.hora_inicial else '' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Hora Final</label>
                        <input type="time" class="form-control bg-dark text-white border-secondary" 
                               name="hora_final" value="{{ ordem.hora_final.strftime('%H:%M') if ordem and ordem.hora_final else '' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">KM Inicial</label>
                        <input type="number" class="form-control bg-dark text-white border-secondary" 
                               name="km_inicial" value="{{ ordem.km_inicial if ordem else '' }}" step="1" min="0">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">KM Final</label>
                        <input type="number" class="form-control bg-dark text-white border-secondary" 
                               name="km_final" value="{{ ordem.km_final if ordem else '' }}" step="1" min="0">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white">Total de Horas Trabalhadas</label>
                        <input type="text" class="form-control bg-info text-white" 
                               id="totalHoras" name="total_horas" readonly placeholder="Calculado automaticamente">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white">KM Total (Deslocamento)</label>
                        <input type="text" class="form-control bg-info text-white" 
                               id="totalKm" name="total_km" readonly placeholder="Calculado automaticamente">
                    </div>
                </div>
            </div>
        </div>

        <!-- ITENS DE SERVI√áO -->
        <div class="mb-4 p-3 rounded-3 d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);">
            <h5 class="mb-0 text-white fw-bold"><i class="fas fa-wrench me-2"></i>Servi√ßos Realizados</h5>
            <button type="button" class="btn btn-light btn-sm" id="btnAdicionarServico" data-no-submit="true">
                <i class="fas fa-plus me-1"></i>Adicionar Servi√ßo
            </button>
        </div>
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-body">
                <!-- Cabe√ßalho dos campos -->
                <div class="row g-2 mb-2">
                    <div class="col-md-3"><small class="text-muted">Descri√ß√£o</small></div>
                    <div class="col-md-2"><small class="text-muted">Tipo</small></div>
                    <div class="col-md-2"><small class="text-muted">Quantidade</small></div>
                    <div class="col-md-2"><small class="text-muted">Valor Unit.</small></div>
                    <div class="col-md-2"><small class="text-muted">Total</small></div>
                    <div class="col-md-1"><small class="text-muted">A√ß√µes</small></div>
                </div>
                
                <!-- Container para servi√ßos din√¢micos -->
                <div id="servicosContainer">
                    {% if ordem and ordem.servicos %}
                        {% for servico in ordem.servicos %}
                            <div class="servico-item mb-3">
                                <div class="row g-2 align-items-center">
                                    <div class="col-md-3">
                                        <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                                               name="servico_descricao[]" value="{{ servico.descricao }}" placeholder="Descri√ß√£o do servi√ßo" required>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select form-select-sm bg-dark text-white border-secondary" name="servico_tipo[]">
                                            <option value="fechado" {% if servico.tipo_servico == 'fechado' %}selected{% endif %}>üéØ Servi√ßo Fechado</option>
                                            <option value="hora" {% if servico.tipo_servico == 'hora' %}selected{% endif %}>‚è±Ô∏è Hora T√©cnica</option>
                                            <option value="deslocamento" {% if servico.tipo_servico == 'deslocamento' %}selected{% endif %}>üöó Deslocamento</option>
                                            <option value="outros" {% if servico.tipo_servico == 'outros' %}selected{% endif %}>üìã Outros</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary servico-quantidade" 
                                               name="servico_quantidade[]" value="{{ servico.quantidade }}" step="0.25" min="0" placeholder="1,00">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary servico-valor" 
                                               name="servico_valor[]" value="{{ '{:,.2f}'.format(servico.valor_unitario or 0).replace(',', 'X').replace('.', ',').replace('X', '.') }}" placeholder="0,00">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm bg-secondary text-white servico-total" 
                                               readonly value="R$ {{ '{:,.2f}'.format((servico.quantidade or 0) * (servico.valor_unitario or 0)).replace(',', 'X').replace('.', ',').replace('X', '.') }}">
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-outline-danger btn-sm w-100 btn-remover-servico">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- PRODUTOS/PE√áAS -->
        <div class="mb-4 p-3 rounded-3 d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);">
            <h5 class="mb-0 text-white fw-bold"><i class="fas fa-boxes me-2"></i>Produtos/Pe√ßas Utilizados</h5>
            <button type="button" class="btn btn-light btn-sm" id="btnAdicionarProduto" data-no-submit="true">
                <i class="fas fa-plus me-1"></i>Adicionar Produto
            </button>
        </div>
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-body">
                <!-- Cabe√ßalho dos campos -->
                <div class="row g-2 mb-2">
                    <div class="col-md-4"><small class="text-muted">Produto/Pe√ßa</small></div>
                    <div class="col-md-2"><small class="text-muted">Quantidade</small></div>
                    <div class="col-md-2"><small class="text-muted">Valor Unit.</small></div>
                    <div class="col-md-2"><small class="text-muted">Total</small></div>
                    <div class="col-md-2"><small class="text-muted">A√ß√µes</small></div>
                </div>
                
                <!-- Container para produtos din√¢micos -->
                <div id="produtosContainer">
                    {% if ordem and ordem.produtos_utilizados %}
                        {% for produto in ordem.produtos_utilizados %}
                            <div class="produto-item mb-3">
                                <div class="row g-2 align-items-center">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                                               name="produto_descricao[]" value="{{ produto.descricao }}" placeholder="Descri√ß√£o do produto" required>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary produto-quantidade" 
                                               name="produto_quantidade[]" value="{{ produto.quantidade }}" step="1" min="0" placeholder="1">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary produto-valor" 
                                               name="produto_valor[]" value="{{ '{:,.2f}'.format(produto.valor_unitario or 0).replace(',', 'X').replace('.', ',').replace('X', '.') }}" placeholder="0,00">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm bg-secondary text-white produto-total" 
                                               readonly value="R$ {{ '{:,.2f}'.format((produto.quantidade or 0) * (produto.valor_unitario or 0)).replace(',', 'X').replace('.', ',').replace('X', '.') }}">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-outline-danger btn-sm w-100 btn-remover-produto">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- TOTAIS -->
        <div class="mb-3 p-3 rounded-3" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);">
            <h5 class="mb-0 text-white fw-bold"><i class="fas fa-calculator me-2"></i>Totais</h5>
        </div>
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label text-white">Valor Servi√ßos</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               id="valorServicos" name="valor_servico" readonly value="R$ {{ '{:,.2f}'.format(ordem.valor_servico or 0).replace(',', 'X').replace('.', ',').replace('X', '.') if ordem else '0,00' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Valor Produtos</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               id="valorProdutos" name="valor_pecas" readonly value="R$ {{ '{:,.2f}'.format(ordem.valor_pecas or 0).replace(',', 'X').replace('.', ',').replace('X', '.') if ordem else '0,00' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Desconto</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               id="desconto" name="valor_desconto" placeholder="0,00" value="{{ '{:,.2f}'.format(ordem.valor_desconto or 0).replace(',', 'X').replace('.', ',').replace('X', '.') if ordem else '0,00' }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-white">Valor Total</label>
                        <input type="text" class="form-control bg-success text-white" 
                               id="valorTotal" name="valor_total" readonly value="R$ {{ '{:,.2f}'.format(ordem.valor_total or 0).replace(',', 'X').replace('.', ',').replace('X', '.') if ordem else '0,00' }}">
                    </div>
                </div>
            </div>
        </div>

        <!-- CONDI√á√ïES DE PAGAMENTO E GARANTIA -->
        <div class="mb-3 p-3 rounded-3" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);">
            <h5 class="mb-0 text-white fw-bold"><i class="fas fa-credit-card me-2"></i>Condi√ß√µes de Pagamento e Garantia</h5>
        </div>
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label text-white">Condi√ß√£o de Pagamento</label>
                        <select class="form-select bg-dark text-white border-secondary" name="condicao_pagamento">
                            <option value="a_vista" {% if not ordem or ordem.condicao_pagamento == 'a_vista' %}selected{% endif %}>üí∞ √Ä Vista</option>
                            <option value="parcelado" {% if ordem and ordem.condicao_pagamento == 'parcelado' %}selected{% endif %}>üí≥ Parcelado</option>
                            <option value="30_dias" {% if ordem and ordem.condicao_pagamento == '30_dias' %}selected{% endif %}>üìÖ 30 Dias</option>
                            <option value="entrada_saldo" {% if ordem and ordem.condicao_pagamento == 'entrada_saldo' %}selected{% endif %}>üíµ Entrada + Saldo</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">Status Pagamento</label>
                        <select class="form-select bg-dark text-white border-secondary" name="status_pagamento">
                            <option value="pendente" {% if not ordem or ordem.status_pagamento == 'pendente' %}selected{% endif %}>‚è≥ Pendente</option>
                            <option value="parcial" {% if ordem and ordem.status_pagamento == 'parcial' %}selected{% endif %}>üîÑ Parcial</option>
                            <option value="pago" {% if ordem and ordem.status_pagamento == 'pago' %}selected{% endif %}>‚úÖ Pago</option>
                            <option value="vencido" {% if ordem and ordem.status_pagamento == 'vencido' %}selected{% endif %}>‚ùå Vencido</option>
                            <option value="cancelado" {% if ordem and ordem.status_pagamento == 'cancelado' %}selected{% endif %}>üö´ Cancelado</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-white">N¬∫ Parcelas</label>
                        <input type="number" class="form-control bg-dark text-white border-secondary" 
                               name="numero_parcelas" value="{{ ordem.numero_parcelas if ordem else 1 }}" min="1" max="12">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-white">Valor Entrada</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               name="valor_entrada" value="{{ '{:,.2f}'.format(ordem.valor_entrada or 0).replace(',', 'X').replace('.', ',').replace('X', '.') if ordem else '0,00' }}" placeholder="0,00">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-white">Garantia (dias)</label>
                        <input type="number" class="form-control bg-dark text-white border-secondary" 
                               name="prazo_garantia" value="{{ ordem.prazo_garantia if ordem else 90 }}" min="0" max="365">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white">Data 1¬™ Parcela</label>
                        <input type="date" class="form-control bg-dark text-white border-secondary" 
                               name="data_primeira_parcela" value="{{ ordem.data_primeira_parcela.strftime('%Y-%m-%d') if ordem and ordem.data_primeira_parcela else '' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white">Vencimento Pagamento</label>
                        <input type="date" class="form-control bg-dark text-white border-secondary" 
                               name="data_vencimento_pagamento" value="{{ ordem.data_vencimento_pagamento.strftime('%Y-%m-%d') if ordem and ordem.data_vencimento_pagamento else '' }}">
                    </div>
                    <div class="col-12">
                        <label class="form-label text-white">Descri√ß√£o das Condi√ß√µes de Pagamento</label>
                        <textarea class="form-control bg-dark text-white border-secondary" name="descricao_pagamento" rows="2" placeholder="Descreva as condi√ß√µes espec√≠ficas de pagamento">{{ ordem.descricao_pagamento if ordem else '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- ANEXOS -->
        <div class="mb-4 p-3 rounded-3" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);">
            <h5 class="mb-0 text-white fw-bold"><i class="fas fa-paperclip me-2"></i>Anexos e Documentos</h5>
        </div>
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label text-white" for="anexos_input">Anexar Arquivos</label>
                        <input id="anexos_input" type="file" class="form-control bg-dark text-white border-secondary" 
                               name="anexos[]" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.txt">
                        <small class="text-muted">Formatos aceitos: PDF, JPG, PNG, DOC, DOCX, TXT (m√°x. 16MB)</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white">Observa√ß√µes dos Anexos</label>
                        <textarea class="form-control bg-dark text-white border-secondary" name="observacoes_anexos" rows="3" placeholder="Observa√ß√µes sobre os anexos">{{ ordem.observacoes_anexos if ordem else '' }}</textarea>
                    </div>
                </div>
                {% if ordem and ordem.anexos %}
                <hr class="border-secondary">
                <h6 class="text-white mb-3">üìé Anexos Existentes ({{ ordem.anexos|length }})</h6>
                <div class="row g-3">
                    {% for anexo in ordem.anexos %}
                    <div class="col-md-6 col-lg-4">
                        <div class="p-3 rounded-3" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                            <div class="d-flex align-items-center mb-2">
                                <i class="{{ anexo.icone }} me-2"></i>
                                <div class="flex-grow-1 min-width-0">
                                    <h6 class="mb-0 text-truncate text-white" title="{{ anexo.nome_original }}">
                                        {{ anexo.nome_original }}
                                    </h6>
                                    <small class="text-muted">{{ anexo.tamanho_formatado }}</small>
                                    {% if anexo.data_upload %}
                                    <small class="text-muted d-block">{{ anexo.data_upload.strftime('%d/%m/%Y %H:%M') }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Preview para imagens -->
                            {% if anexo.tipo_arquivo == 'image' or (anexo.mime_type and 'image' in anexo.mime_type) %}
                            <div class="mb-2">
                                <img src="{{ url_for('ordem_servico.visualizar_anexo', anexo_id=anexo.id) }}" 
                                     class="img-fluid rounded" 
                                     style="max-height: 80px; width: 100%; object-fit: cover;"
                                     alt="{{ anexo.nome_original }}">
                            </div>
                            {% endif %}
                            
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('ordem_servico.baixar_anexo', anexo_id=anexo.id) }}" 
                                   class="btn btn-outline-primary btn-sm flex-fill">
                                    <i class="fas fa-download me-1"></i> Download
                                </a>
                                {% if anexo.tipo_arquivo == 'image' or (anexo.mime_type and 'image' in anexo.mime_type) %}
                                <a href="{{ url_for('ordem_servico.visualizar_anexo', anexo_id=anexo.id) }}" 
                                   class="btn btn-outline-info btn-sm flex-fill" 
                                   target="_blank">
                                    <i class="fas fa-eye me-1"></i> Ver
                                </a>
                                {% endif %}
                                <button onclick="excluirAnexo({{ anexo.id }}, '{{ anexo.nome_original|replace("'", "\\'") }}')" 
                                        class="btn btn-outline-danger btn-sm"
                                        type="button"
                                        title="Excluir anexo">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <hr class="border-secondary">
                <div class="row g-3 mt-2">
                    <div class="col-md-8" id="preferencia_imagens_container">
                        <div class="d-flex align-items-center p-3 rounded-3" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2)); border: 1px solid rgba(102, 126, 234, 0.3);">
                            <div class="form-check form-switch me-3">
                                <input class="form-check-input" type="checkbox" role="switch" 
                                       id="incluir_imagens_relatorio" name="incluir_imagens_relatorio" value="1"
                                       style="width: 3em; height: 1.5em; cursor: pointer;"
                                       {% if (ordem and ordem.incluir_imagens_relatorio) or (request and request.form and request.form.get('incluir_imagens_relatorio')) %}checked{% endif %}>
                            </div>
                            <div>
                                <label class="form-check-label text-white fw-bold mb-0" for="incluir_imagens_relatorio" style="cursor: pointer;">
                                    <i class="fas fa-images me-2 text-info"></i>Incluir imagens no PDF
                                </label>
                                <div class="small text-muted">Quando ativado, as imagens anexadas ser√£o exibidas no relat√≥rio PDF da OS.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BOT√ïES -->
        <div class="card bg-dark border-secondary">
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-6">
                        <button type="submit" class="btn btn-success btn-lg w-100">
                            <i class="fas fa-save me-2"></i>
                            {% if ordem %}Atualizar Ordem de Servi√ßo{% else %}Criar Ordem de Servi√ßo{% endif %}
                        </button>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('ordem_servico.listar') }}" class="btn btn-secondary btn-lg w-100">
                            <i class="fas fa-arrow-left me-2"></i>Voltar
                        </a>
                    </div>
                    <div class="col-md-3">
                        {% if ordem %}
                        <a href="{{ url_for('ordem_servico.visualizar', id=ordem.id) }}" class="btn btn-info btn-lg w-100">
                            <i class="fas fa-eye me-2"></i>Visualizar
                        </a>
                        {% else %}
                        <button type="reset" class="btn btn-warning btn-lg w-100" onclick="limparFormulario()">
                            <i class="fas fa-eraser me-2"></i>Limpar
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    let servicoIndex = {{ (ordem.servicos|length) if ordem and ordem.servicos else 0 }};
    let produtoIndex = {{ (ordem.produtos_utilizados|length) if ordem and ordem.produtos_utilizados else 0 }};
    
    // Prevenir reload de p√°gina por bot√µes do formul√°rio
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Permitir apenas o submit real do formul√°rio principal
            console.log('üìù Formul√°rio sendo submetido...');
        });
    }
    
    // Prevenir comportamento padr√£o de todos os bot√µes que n√£o s√£o de submit
    document.addEventListener('click', function(e) {
        const target = e.target.closest('button');
        if (target && target.type !== 'submit' && target.form && !target.hasAttribute('data-allow-default')) {
            // Para bot√µes dentro de forms que n√£o s√£o submit, prevenir comportamento padr√£o
            if (target.id === 'btnAtualizarClientesOS' || target.id === 'btnRefreshClientesOS' || 
                target.classList.contains('btn-remover-servico') || target.classList.contains('btn-remover-produto') ||
                target.id === 'btnAdicionarServico' || target.id === 'btnAdicionarProduto') {
                e.preventDefault();
                e.stopPropagation();
                console.log('üõ°Ô∏è Comportamento padr√£o prevenido para:', target.id || target.className);
            }
        }
    });
    
    console.log('üöÄ Sistema de Ordem de Servi√ßo inicializado!');
    
    console.log('üìä √çndices iniciais:', { servicoIndex, produtoIndex });
    console.log('üìã Containers encontrados:', {
        servicosContainer: !!document.getElementById('servicosContainer'),
        produtosContainer: !!document.getElementById('produtosContainer'),
        btnAdicionarServico: !!document.getElementById('btnAdicionarServico'),
        btnAdicionarProduto: !!document.getElementById('btnAdicionarProduto')
    });
    
    // Verificar se existem itens j√° carregados
    const servicosExistentes = document.querySelectorAll('.servico-item');
    const produtosExistentes = document.querySelectorAll('.produto-item');
    console.log('üîç Itens existentes encontrados:', {
        servicos: servicosExistentes.length,
        produtos: produtosExistentes.length
    });
    
    // Fun√ß√£o para limpar formul√°rio
    window.limparFormulario = function() {
        if (confirm('Tem certeza que deseja limpar todos os campos?')) {
            document.getElementById('servicosContainer').innerHTML = '';
            document.getElementById('produtosContainer').innerHTML = '';
            calcularTotaisGerais();
            servicoIndex = 0;
            produtoIndex = 0;
        }
    }
    
    // Fun√ß√£o para converter valor monet√°rio para n√∫mero (robusta: BR e US)
    function converterParaNumero(valor) {
        if (valor === null || valor === undefined) return 0;
        let s = valor.toString().trim();
        if (s === '') return 0;

        // Remove s√≠mbolo de moeda e espa√ßos
        s = s.replace('R$', '').replace(/\s/g, '');

        // Casos:
        // 1) BR: 1.750,00 (ponto = milhar, v√≠rgula = decimal)
        // 2) US: 1,750.00 (v√≠rgula = milhar, ponto = decimal)
        // 3) Simples BR: 700,00
        // 4) Simples US: 700.00

        const hasComma = s.includes(',');
        const hasDot = s.includes('.');

        if (hasComma && hasDot) {
            // Decidir pelo padr√£o observando o separador decimal
            const lastComma = s.lastIndexOf(',');
            const lastDot = s.lastIndexOf('.');
            if (lastComma > lastDot) {
                // Ex: 1.750,00 ‚Üí BR
                // Remove pontos de milhar, troca v√≠rgula por ponto
                s = s.replace(/\./g, '').replace(',', '.');
            } else {
                // Ex: 1,750.00 ‚Üí US
                // Remove v√≠rgulas de milhar, mant√©m ponto como decimal
                s = s.replace(/,/g, '');
            }
        } else if (hasComma && !hasDot) {
            // Prov√°vel BR: 700,00
            s = s.replace(/\./g, '').replace(',', '.');
        } else {
            // Apenas ponto ou nenhum separador: tratar como decimal com ponto
            // Tamb√©m remover qualquer v√≠rgula residual (milhar) por seguran√ßa
            s = s.replace(/,/g, '');
        }

        const n = parseFloat(s);
        return isNaN(n) ? 0 : n;
    }
    
    // Fun√ß√£o para formatar n√∫mero para moeda brasileira (n√£o depende de locale)
    function formatarMoeda(valor) {
        // Garante que seja um n√∫mero v√°lido
        let num = parseFloat(valor) || 0;
        
        // Formata com 2 casas decimais
        let partes = num.toFixed(2).split('.');
        let inteiro = partes[0];
        let decimal = partes[1];
        
        // Adiciona pontos de milhar
        let formatado = '';
        let contador = 0;
        for (let i = inteiro.length - 1; i >= 0; i--) {
            if (contador > 0 && contador % 3 === 0) {
                formatado = '.' + formatado;
            }
            formatado = inteiro[i] + formatado;
            contador++;
        }
        
        return 'R$ ' + formatado + ',' + decimal;
    }
    
    // Fun√ß√£o para calcular total de um item
    function calcularTotalItem(container) {
        const quantidade = container.querySelector('.servico-quantidade, .produto-quantidade');
        const valor = container.querySelector('.servico-valor, .produto-valor');
        const total = container.querySelector('.servico-total, .produto-total');
        
        if (quantidade && valor && total) {
            const qtd = converterParaNumero(quantidade.value);
            const vlr = converterParaNumero(valor.value);
            const totalCalculado = qtd * vlr;
            total.value = formatarMoeda(totalCalculado);
        }
        
        calcularTotaisGerais();
    }
    
    // Fun√ß√£o para calcular totais gerais
    function calcularTotaisGerais() {
        let totalServicos = 0;
        let totalProdutos = 0;
        
        // Somar servi√ßos
        document.querySelectorAll('.servico-total').forEach(function(campo) {
            const valorOriginal = campo.value;
            const valorConvertido = converterParaNumero(valorOriginal);
            console.log('üîç Servi√ßo total - Original:', valorOriginal, '‚Üí Convertido:', valorConvertido);
            totalServicos += valorConvertido;
        });
        
        // Somar produtos
        document.querySelectorAll('.produto-total').forEach(function(campo) {
            const valorOriginal = campo.value;
            const valorConvertido = converterParaNumero(valorOriginal);
            console.log('üîç Produto total - Original:', valorOriginal, '‚Üí Convertido:', valorConvertido);
            totalProdutos += valorConvertido;
        });
        
        console.log('üìä Total Servi√ßos calculado:', totalServicos);
        console.log('üìä Total Produtos calculado:', totalProdutos);
        
        // Se n√£o h√° itens, manter os valores originais do formul√°rio
        const servicosExistentes = document.querySelectorAll('.servico-total').length;
        const produtosExistentes = document.querySelectorAll('.produto-total').length;
        
        if (servicosExistentes > 0) {
            document.getElementById('valorServicos').value = formatarMoeda(totalServicos);
        }
        
        if (produtosExistentes > 0) {
            document.getElementById('valorProdutos').value = formatarMoeda(totalProdutos);
        }
        
        // Recalcula total apenas se h√° itens ou se o desconto mudou
        if (servicosExistentes > 0 || produtosExistentes > 0) {
            const desconto = converterParaNumero(document.getElementById('desconto').value);
            const valorServicoAtual = converterParaNumero(document.getElementById('valorServicos').value);
            const valorProdutoAtual = converterParaNumero(document.getElementById('valorProdutos').value);
            const total = valorServicoAtual + valorProdutoAtual - desconto;
            document.getElementById('valorTotal').value = formatarMoeda(total);
        }
    }
    
    // Fun√ß√£o para recalcular total quando desconto muda
    function recalcularTotal() {
        const valorServico = converterParaNumero(document.getElementById('valorServicos').value);
        const valorProduto = converterParaNumero(document.getElementById('valorProdutos').value);
        const desconto = converterParaNumero(document.getElementById('desconto').value);
        const total = valorServico + valorProduto - desconto;
        document.getElementById('valorTotal').value = formatarMoeda(total);
    }
    
    // Adicionar Servi√ßo
    document.getElementById('btnAdicionarServico').addEventListener('click', function() {
        console.log('Adicionando servi√ßo...');
        
        const container = document.getElementById('servicosContainer');
        const div = document.createElement('div');
        div.className = 'servico-item mb-3';
        div.innerHTML = `
            <div class="row g-2 align-items-center">
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                           name="servico_descricao[]" placeholder="Descri√ß√£o do servi√ßo" required>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm bg-dark text-white border-secondary" name="servico_tipo[]">
                        <option value="fechado">üéØ Servi√ßo Fechado</option>
                        <option value="hora">‚è±Ô∏è Hora T√©cnica</option>
                        <option value="deslocamento">üöó Deslocamento</option>
                        <option value="outros">üìã Outros</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary servico-quantidade" 
                           name="servico_quantidade[]" value="1" step="0.25" min="0" placeholder="1,00">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary servico-valor" 
                           name="servico_valor[]" placeholder="0,00">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm bg-secondary text-white servico-total" 
                           readonly value="R$ 0,00">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm w-100 btn-remover-servico">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(div);
        servicoIndex++;
        console.log('Servi√ßo adicionado! Total:', servicoIndex);
        
        // Adicionar eventos aos novos campos
        const novoItem = div;
        const qtdField = novoItem.querySelector('.servico-quantidade');
        const valorField = novoItem.querySelector('.servico-valor');
        
        qtdField.addEventListener('input', function() {
            calcularTotalItem(novoItem);
        });
        
        valorField.addEventListener('input', function() {
            calcularTotalItem(novoItem);
        });
    });
    
    // Adicionar Produto
    document.getElementById('btnAdicionarProduto').addEventListener('click', function() {
        console.log('Adicionando produto...');
        
        const container = document.getElementById('produtosContainer');
        const div = document.createElement('div');
        div.className = 'produto-item mb-3';
        div.innerHTML = `
            <div class="row g-2 align-items-center">
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                           name="produto_descricao[]" placeholder="Descri√ß√£o do produto" required>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary produto-quantidade" 
                           name="produto_quantidade[]" value="1" step="1" min="0" placeholder="1">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary produto-valor" 
                           name="produto_valor[]" placeholder="0,00">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm bg-secondary text-white produto-total" 
                           readonly value="R$ 0,00">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm w-100 btn-remover-produto">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(div);
        produtoIndex++;
        console.log('Produto adicionado! Total:', produtoIndex);
        
        // Adicionar eventos aos novos campos
        const novoItem = div;
        const qtdField = novoItem.querySelector('.produto-quantidade');
        const valorField = novoItem.querySelector('.produto-valor');
        
        qtdField.addEventListener('input', function() {
            calcularTotalItem(novoItem);
        });
        
        valorField.addEventListener('input', function() {
            calcularTotalItem(novoItem);
        });
    });
    
    // Event listeners para remover itens (usando delega√ß√£o de eventos)
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-remover-servico')) {
            if (confirm('Remover este servi√ßo?')) {
                e.target.closest('.servico-item').remove();
                calcularTotaisGerais();
            }
        }
        if (e.target.closest('.btn-remover-produto')) {
            if (confirm('Remover este produto?')) {
                e.target.closest('.produto-item').remove();
                calcularTotaisGerais();
            }
        }
    });
    
    // Event listeners para c√°lculos em itens (usando delega√ß√£o de eventos)
    document.addEventListener('input', function(e) {
        if (e.target.matches('.servico-quantidade, .servico-valor')) {
            calcularTotalItem(e.target.closest('.servico-item'));
        }
        if (e.target.matches('.produto-quantidade, .produto-valor')) {
            calcularTotalItem(e.target.closest('.produto-item'));
        }
        if (e.target.id === 'desconto') {
            calcularTotaisGerais();
        }
    });
    
    // Event listener espec√≠fico para o campo desconto
    const descontoField = document.getElementById('desconto');
    if (descontoField) {
        descontoField.addEventListener('input', recalcularTotal);
    }
    
    // N√£o recalcular totais automaticamente ao carregar - manter valores do banco
    // Os valores j√° v√™m corretos do servidor
    console.log('üí∞ Valores carregados do servidor mantidos');
    
    // ===== FUNCIONALIDADE ATUALIZAR CLIENTES =====
    
    async function atualizarListaClientesOS(event) {
        // Prevenir qualquer comportamento padr√£o que possa interferir no formul√°rio
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const btnAtualizar = document.getElementById('btnAtualizarClientesOS');
        const selectCliente = document.getElementById('cliente_select_os');
        
        if (!btnAtualizar || !selectCliente) {
            console.error('‚ùå Elementos n√£o encontrados: btnAtualizar ou selectCliente');
            showToastOS('Elementos do formul√°rio n√£o encontrados!', 'error');
            return;
        }
        
        const clienteSelecionadoId = selectCliente.value;
        console.log('üîÑ Preservando sele√ß√£o atual:', clienteSelecionadoId);
        
        try {
            console.log('üîÑ Iniciando atualiza√ß√£o de clientes...');
            console.log('üë§ Cliente atualmente selecionado:', clienteSelecionadoId);
            
            // Mostrar loading
            btnAtualizar.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btnAtualizar.disabled = true;
            
            // Construir URLs para teste
            const baseUrl = window.location.origin;
            const testUrl = baseUrl + '/ordem_servico/api/test';
            const apiUrl = baseUrl + '/ordem_servico/api/clientes';
            
            console.log('üß™ Testando conectividade primeiro...');
            
            // Primeiro teste: verificar se o blueprint responde
            const testResponse = await fetch(testUrl);
            if (!testResponse.ok) {
                throw new Error(`Blueprint n√£o responde: ${testResponse.status}`);
            }
            console.log('‚úÖ Blueprint funcionando');
            
            // Segundo teste: API de clientes
            console.log('üì° Fazendo requisi√ß√£o para:', apiUrl);
            
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            });
            console.log('üì° Resposta recebida:', response.status, response.statusText);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('üìã Dados recebidos:', data);
            
            if (data.success) {
                // Debug info
                if (data.debug_info) {
                    console.log('üîç Debug Info:', data.debug_info);
                    console.log(`üìä Total no banco: ${data.debug_info.total_no_banco}`);
                    console.log(`‚úÖ Com nome v√°lido: ${data.debug_info.com_nome_valido}`);
                }
                
                // Contar clientes antes da atualiza√ß√£o
                const clientesAntes = selectCliente.options.length - 1; // -1 para excluir "Selecione um cliente"
                
                // Limpar select
                selectCliente.innerHTML = '<option value="">Selecione um cliente</option>';
                
                // Adicionar clientes atualizados
                let clientesAdicionados = 0;
                data.clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nome;
                    
                    // Manter sele√ß√£o anterior se ainda existir
                    if (clienteSelecionadoId && cliente.id == clienteSelecionadoId) {
                        option.selected = true;
                        console.log('üéØ Cliente reselectionado:', cliente.nome);
                    }
                    
                    selectCliente.appendChild(option);
                    clientesAdicionados++;
                });
                
                // Feedback visual
                btnAtualizar.classList.add('btn-success');
                btnAtualizar.classList.remove('btn-outline-info');
                setTimeout(() => {
                    btnAtualizar.classList.remove('btn-success');
                    btnAtualizar.classList.add('btn-outline-info');
                }, 2000);
                
                console.log(`‚úÖ Lista de clientes atualizada: ${clientesAdicionados} clientes (antes: ${clientesAntes})`);
                
                // Garantir que n√£o h√° reload desnecess√°rio
                const urlBeforeUpdate = window.location.href;
                const scrollPosition = window.pageYOffset;
                
                // Mostrar notifica√ß√£o com mais detalhes
                if (data.total > 0) {
                    const diferenca = clientesAdicionados - clientesAntes;
                    let mensagem = `Lista atualizada! ${data.total} clientes dispon√≠veis`;
                    if (diferenca > 0) {
                        mensagem += ` (+${diferenca} novos)`;
                    } else if (diferenca < 0) {
                        mensagem += ` (${Math.abs(diferenca)} removidos)`;
                    } else {
                        mensagem += ` (nenhuma altera√ß√£o)`;
                    }
                    showToastOS(mensagem, 'success');
                    
                    // Garantir que o foco n√£o seja perdido do formul√°rio e posi√ß√£o mantida
                    setTimeout(() => {
                        selectCliente.focus();
                        if (window.location.href !== urlBeforeUpdate) {
                            console.warn('‚ö†Ô∏è URL mudou! Restaurando...');
                            history.replaceState(null, '', urlBeforeUpdate);
                        }
                        if (window.pageYOffset !== scrollPosition) {
                            window.scrollTo(0, scrollPosition);
                        }
                    }, 100);
                } else {
                    showToastOS('Nenhum cliente ativo encontrado', 'warning');
                }
                
            } else {
                throw new Error(data.error || 'Erro desconhecido');
            }
            
        } catch (error) {
            console.error('‚ùå Erro ao atualizar clientes:', error);
            
            let errorMessage = 'Erro ao atualizar lista de clientes';
            let fallbackAction = false;
            
            if (error.message.includes('Failed to fetch')) {
                errorMessage = 'Erro de conex√£o. Servidor pode estar offline.';
                fallbackAction = true;
            } else if (error.message.includes('404')) {
                errorMessage = 'API n√£o encontrada. Recarregando p√°gina...';
                fallbackAction = true;
            } else if (error.message.includes('500')) {
                errorMessage = 'Erro interno do servidor.';
            }
            
            showToastOS(errorMessage, 'error');
            
            // Se for erro de conectividade, oferecer alternativa
            if (fallbackAction) {
                setTimeout(() => {
                    if (confirm('A funcionalidade de atualiza√ß√£o n√£o est√° dispon√≠vel. Deseja recarregar a p√°gina para ver novos clientes?')) {
                        window.location.reload();
                    } else {
                        showToastOS('üí° DICA: Recarregue a p√°gina (F5) para ver clientes cadastrados recentemente', 'info');
                    }
                }, 1000);
            }
            
            btnAtualizar.classList.add('btn-danger');
            btnAtualizar.classList.remove('btn-outline-info');
            setTimeout(() => {
                btnAtualizar.classList.remove('btn-danger');
                btnAtualizar.classList.add('btn-outline-info');
            }, 3000);
            
        } finally {
            // Restaurar bot√£o
            btnAtualizar.innerHTML = '<i class="fas fa-sync-alt"></i>';
            btnAtualizar.disabled = false;
        }
    }
    
    function showToastOS(message, type = 'info') {
        // Criar toast simples sem interferir no formul√°rio
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'warning'} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; pointer-events: auto;';
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove(); event.stopPropagation();"></button>
        `;
        
        // Garantir que o toast n√£o interfira no formul√°rio
        toast.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        document.body.appendChild(toast);
        
        // Auto remover ap√≥s 5 segundos
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }
    
    // Event listener para o bot√£o atualizar
    const btnAtualizarOS = document.getElementById('btnAtualizarClientesOS');
    if (btnAtualizarOS) {
        btnAtualizarOS.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            console.log('üîÑ Bot√£o atualizar clicado - prevenindo comportamento padr√£o');
            atualizarListaClientesOS(event);
            return false;
        });
        console.log('‚úÖ Funcionalidade de atualiza√ß√£o de clientes carregada para OS!');
    } else {
        console.error('‚ùå Bot√£o btnAtualizarClientesOS n√£o encontrado!');
    }
    
    // Event listener para o bot√£o refresh for√ßado 
    const btnRefreshOS = document.getElementById('btnRefreshClientesOS');
    if (btnRefreshOS) {
        btnRefreshOS.addEventListener('click', async function(event) {
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            console.log('üî• Bot√£o refresh clicado - prevenindo comportamento padr√£o');
            
            const selectCliente = document.getElementById('cliente_select_os');
            const clienteSelecionadoId = selectCliente.value;
            
            try {
                console.log('üî• REFRESH FOR√áADO iniciado...');
                
                btnRefreshOS.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btnRefreshOS.disabled = true;
                
                const response = await fetch(window.location.origin + '/ordem_servico/api/clientes/refresh', {
                    headers: {'Cache-Control': 'no-cache'}
                });
                
                const data = await response.json();
                console.log('üî• Dados do refresh for√ßado:', data);
                
                if (data.success) {
                    // Limpar e repopular
                    selectCliente.innerHTML = '<option value="">Selecione um cliente</option>';
                    
                    data.clientes.forEach(cliente => {
                        const option = document.createElement('option');
                        option.value = cliente.id;
                        option.textContent = cliente.nome;
                        if (clienteSelecionadoId && cliente.id == clienteSelecionadoId) {
                            option.selected = true;
                        }
                        selectCliente.appendChild(option);
                    });
                    
                    // Mostrar detalhes do debug
                    let mensagem = `üî• REFRESH: ${data.total} clientes carregados`;
                    if (data.debug_info.sem_nome_valido > 0) {
                        mensagem += ` (${data.debug_info.sem_nome_valido} ignorados)`;
                    }
                    
                    console.log(`üî• ${mensagem}`);
                    showToastOS(mensagem, 'success');
                    
                    // Log dos clientes ignorados se houver
                    if (data.ignorados && data.ignorados.length > 0) {
                        console.warn('‚ö†Ô∏è Clientes ignorados:', data.ignorados);
                        showToastOS(`‚ö†Ô∏è ${data.ignorados.length} clientes ignorados por nome inv√°lido (veja console)`, 'warning');
                    }
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('‚ùå Erro no refresh for√ßado:', error);
                showToastOS('Erro no refresh for√ßado: ' + error.message, 'error');
            } finally {
                btnRefreshOS.innerHTML = '<i class="fas fa-refresh"></i>';
                btnRefreshOS.disabled = false;
            }
        });
        console.log('‚úÖ Funcionalidade de refresh for√ßado carregada!');
    } else {
        console.error('‚ùå Bot√£o btnRefreshClientesOS n√£o encontrado!');
    }
    
    // Fun√ß√£o para calcular total de horas
    function calcularTotalHoras() {
        const horaInicial = document.querySelector('input[name="hora_inicial"]').value;
        const horaFinal = document.querySelector('input[name="hora_final"]').value;
        const totalHorasField = document.getElementById('totalHoras');
        
        if (horaInicial && horaFinal) {
            const [horaIni, minIni] = horaInicial.split(':').map(Number);
            const [horaFin, minFin] = horaFinal.split(':').map(Number);
            
            let inicialMinutos = horaIni * 60 + minIni;
            let finalMinutos = horaFin * 60 + minFin;
            
            // Se hora final for menor que inicial, assumir que passou da meia-noite
            if (finalMinutos < inicialMinutos) {
                finalMinutos += 24 * 60; // Adiciona 24 horas em minutos
            }
            
            const diffMinutos = finalMinutos - inicialMinutos;
            const horas = Math.floor(diffMinutos / 60);
            const minutos = diffMinutos % 60;
            
            totalHorasField.value = `${horas}h ${minutos.toString().padStart(2, '0')}min`;
        } else {
            totalHorasField.value = '';
        }
    }
    
    // Fun√ß√£o para calcular KM total
    function calcularTotalKm() {
        const kmInicial = parseFloat(document.querySelector('input[name="km_inicial"]').value) || 0;
        const kmFinal = parseFloat(document.querySelector('input[name="km_final"]').value) || 0;
        const totalKmField = document.getElementById('totalKm');
        
        if (kmFinal > kmInicial) {
            const totalKm = kmFinal - kmInicial;
            totalKmField.value = `${totalKm} km`;
        } else {
            totalKmField.value = '';
        }
    }
    
    // Event listeners para os campos de tempo
    document.querySelector('input[name="hora_inicial"]').addEventListener('change', calcularTotalHoras);
    document.querySelector('input[name="hora_final"]').addEventListener('change', calcularTotalHoras);
    
    // Event listeners para os campos de KM
    document.querySelector('input[name="km_inicial"]').addEventListener('input', calcularTotalKm);
    document.querySelector('input[name="km_final"]').addEventListener('input', calcularTotalKm);
    
    // Calcular valores iniciais se existirem
    calcularTotalHoras();
    calcularTotalKm();
    
    // Inicializar eventos nos itens existentes (para modo edi√ß√£o)
    function inicializarItensExistentes() {
        console.log('üîß Inicializando eventos nos itens existentes...');
        
        // Aguardar um pouco para garantir que o DOM est√° totalmente renderizado
        setTimeout(() => {
            // Inicializar servi√ßos existentes
            document.querySelectorAll('.servico-item').forEach(function(item) {
                const qtdField = item.querySelector('.servico-quantidade');
                const valorField = item.querySelector('.servico-valor');
                const removerBtn = item.querySelector('.btn-remover-servico');
                
                if (qtdField && valorField) {
                    qtdField.addEventListener('input', function() {
                        calcularTotalItem(item);
                    });
                    valorField.addEventListener('input', function() {
                        calcularTotalItem(item);
                    });
                    console.log('‚úÖ Eventos adicionados ao servi√ßo:', item.querySelector('input[name="servico_descricao[]"]').value);
                }
                
                if (removerBtn) {
                    removerBtn.addEventListener('click', function() {
                        if (confirm('Remover este servi√ßo?')) {
                            item.remove();
                            calcularTotaisGerais();
                        }
                    });
                }
            });
            
            // Inicializar produtos existentes
            document.querySelectorAll('.produto-item').forEach(function(item) {
                const qtdField = item.querySelector('.produto-quantidade');
                const valorField = item.querySelector('.produto-valor');
                const removerBtn = item.querySelector('.btn-remover-produto');
                
                if (qtdField && valorField) {
                    qtdField.addEventListener('input', function() {
                        calcularTotalItem(item);
                    });
                    valorField.addEventListener('input', function() {
                        calcularTotalItem(item);
                    });
                    console.log('‚úÖ Eventos adicionados ao produto:', item.querySelector('input[name="produto_descricao[]"]').value);
                }
                
                if (removerBtn) {
                    removerBtn.addEventListener('click', function() {
                        if (confirm('Remover este produto?')) {
                            item.remove();
                            calcularTotaisGerais();
                        }
                    });
                }
            });
            
            // Calcular totais iniciais (apenas se houver itens)
            const temServicos = document.querySelectorAll('.servico-total').length > 0;
            const temProdutos = document.querySelectorAll('.produto-total').length > 0;
            if (temServicos || temProdutos) {
                calcularTotaisGerais();
            }
            console.log('‚úÖ Eventos inicializados nos itens existentes');
        }, 250);
    }
    
    // Chamar fun√ß√£o de inicializa√ß√£o
    inicializarItensExistentes();
    
    // Debug: Verificar elementos
    console.log('üîç Debug elementos:');
    console.log('  - Bot√£o atualizar:', document.getElementById('btnAtualizarClientesOS'));
    console.log('  - Select cliente:', document.getElementById('cliente_select_os'));
    console.log('  - URL atual:', window.location.href);

    // Evitar que cliques na prefer√™ncia de imagens abram o seletor de arquivos
    const prefContainer = document.getElementById('preferencia_imagens_container');
    const anexosInput = document.getElementById('anexos_input');
    if (prefContainer && anexosInput) {
        prefContainer.addEventListener('click', function(e) {
            // N√£o deixar que o clique borbulhe para elementos que poderiam focar o input de arquivos
            e.stopPropagation();
        });
    }

    // ===== HIST√ìRICO DE EQUIPAMENTOS =====
    const clienteSelect = document.getElementById('cliente_id');
    const equipamentoInput = document.getElementById('equipamento');
    const marcaModeloInput = document.getElementById('marca_modelo');
    const numeroSerieInput = document.getElementById('numero_serie');
    const historicoIcon = document.getElementById('equipamento-historico-icon');
    const equipamentoHint = document.getElementById('equipamento-hint');
    let equipamentosCache = [];

    // Carrega equipamentos quando selecionar cliente
    if (clienteSelect) {
        clienteSelect.addEventListener('change', async function() {
            const clienteId = this.value;
            if (!clienteId) {
                limparHistoricoEquipamentos();
                return;
            }
            
            try {
                const response = await fetch(`{{ url_for('ordem_servico.api_equipamentos_cliente', cliente_id=0) }}`.replace('0', clienteId));
                const data = await response.json();
                
                if (data.success && data.equipamentos && data.equipamentos.length > 0) {
                    equipamentosCache = data.equipamentos;
                    popularHistoricoEquipamentos(data.equipamentos);
                    historicoIcon.style.display = 'inline';
                    equipamentoHint.style.display = 'block';
                    showNotification(`${data.total} equipamento(s) anterior(es) encontrado(s)`, 'info');
                } else {
                    limparHistoricoEquipamentos();
                }
            } catch (error) {
                console.error('Erro ao buscar equipamentos:', error);
                limparHistoricoEquipamentos();
            }
        });
    }

    // Auto-preenche campos ao selecionar equipamento
    if (equipamentoInput) {
        equipamentoInput.addEventListener('input', function() {
            const equipamentoSelecionado = this.value;
            const equipamento = equipamentosCache.find(e => 
                e.equipamento.toLowerCase() === equipamentoSelecionado.toLowerCase()
            );
            
            if (equipamento) {
                marcaModeloInput.value = equipamento.modelo || equipamento.marca || '';
                numeroSerieInput.value = equipamento.numero_serie || '';
                
                // Mostra notifica√ß√£o com info do hist√≥rico
                showNotification(
                    `üìã Dados preenchidos da √∫ltima OS (#${equipamento.ultima_os}) - ${equipamento.data_ultima_os}<br>` +
                    `Total de OS anteriores: ${equipamento.total_os}`,
                    'success'
                );
            }
        });
    }

    function popularHistoricoEquipamentos(equipamentos) {
        const datalist = document.getElementById('equipamentos-historico');
        datalist.innerHTML = '';
        
        equipamentos.forEach(eq => {
            const option = document.createElement('option');
            option.value = eq.equipamento;
            option.textContent = `${eq.equipamento} (${eq.total_os} OS anterior(es))`;
            datalist.appendChild(option);
        });
    }

    function limparHistoricoEquipamentos() {
        const datalist = document.getElementById('equipamentos-historico');
        datalist.innerHTML = '';
        historicoIcon.style.display = 'none';
        equipamentoHint.style.display = 'none';
        equipamentosCache = [];
    }

    // Se j√° houver cliente selecionado ao carregar, busca equipamentos
    if (clienteSelect && clienteSelect.value) {
        clienteSelect.dispatchEvent(new Event('change'));
    }
});

// Fun√ß√£o para excluir anexo
async function excluirAnexo(anexoId, nomeArquivo) {
    if (!confirm('Tem certeza que deseja excluir o anexo "' + nomeArquivo + '"?\n\nEsta a√ß√£o n√£o pode ser desfeita.')) {
        return;
    }
    
    try {
        const response = await fetch(`{{ url_for('ordem_servico.excluir_anexo', anexo_id=0) }}`.replace('0', anexoId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showNotification('Anexo exclu√≠do com sucesso!', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showNotification(data.message || 'Erro ao excluir anexo', 'error');
        }
    } catch (error) {
        console.error('Erro:', error);
        showNotification('Erro ao excluir anexo', 'error');
    }
}

// Fun√ß√£o para obter CSRF token
function getCsrfToken() {
    return document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
}

// Fun√ß√£o para mostrar notifica√ß√µes
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove ap√≥s 5 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// ===== AUTOCOMPLETE PARA CAMPOS QUE SE REPETEM =====
async function carregarAutocomplete(campo, inputId, listId) {
    try {
        const response = await fetch(`/ordem-servico/autocomplete/${campo}`);
        const valores = await response.json();
        
        // Cria ou atualiza o datalist
        let datalist = document.getElementById(listId);
        if (!datalist) {
            datalist = document.createElement('datalist');
            datalist.id = listId;
            document.body.appendChild(datalist);
        }
        
        // Limpa e adiciona op√ß√µes
        datalist.innerHTML = '';
        valores.forEach(valor => {
            const option = document.createElement('option');
            option.value = valor;
            datalist.appendChild(option);
        });
        
        // Vincula ao input
        const input = document.querySelector(`[name="${inputId}"]`);
        if (input) {
            input.setAttribute('list', listId);
            input.setAttribute('autocomplete', 'off'); // Desabilita autocomplete do navegador
        }
        
    } catch (error) {
        console.error(`Erro ao carregar autocomplete para ${campo}:`, error);
    }
}

// Carrega autocomplete ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Campos com autocomplete
    carregarAutocomplete('solicitante', 'solicitante', 'lista_solicitantes');
    carregarAutocomplete('tecnico_responsavel', 'tecnico_responsavel', 'lista_tecnicos');
    carregarAutocomplete('titulo', 'titulo', 'lista_titulos');
    carregarAutocomplete('equipamento', 'equipamento', 'lista_equipamentos');
    carregarAutocomplete('marca_modelo', 'marca_modelo', 'lista_marcas');

    // ===== INTEGRA√á√ÉO COM EQUIPAMENTOS CADASTRADOS =====
    const clienteSelectElement = document.getElementById('cliente_id');
    const equipamentoCadastradoSelect = document.getElementById('equipamento_cadastrado');
    const equipamentoInput = document.getElementById('equipamento');
    const marcaModeloInput = document.getElementById('marca_modelo');
    const numeroSerieInput = document.getElementById('numero_serie');

    // Fun√ß√£o para carregar equipamentos do cliente
    async function carregarEquipamentosCliente(clienteId) {
        console.log('[DEBUG] üîç Carregando equipamentos para cliente ID:', clienteId);
        
        if (!clienteId || !equipamentoCadastradoSelect) {
            equipamentoCadastradoSelect.innerHTML = '<option value="">Primeiro selecione um cliente acima</option>';
            return;
        }
        
        // Mostra loading
        equipamentoCadastradoSelect.innerHTML = '<option value="">üîÑ Carregando equipamentos...</option>';
        
        try {
            const url = `/equipamentos/api/por-cliente/${clienteId}`;
            console.log('[DEBUG] üì° Fazendo requisi√ß√£o para:', url);
            
            const response = await fetch(url);
            console.log('[DEBUG] üìä Status da resposta:', response.status);
            
            const data = await response.json();
            console.log('[DEBUG] üì¶ Dados recebidos:', data);
            
            // Limpa dropdown
            equipamentoCadastradoSelect.innerHTML = '<option value="">-- Selecione um equipamento --</option>';
            
            if (data.success && data.equipamentos && data.equipamentos.length > 0) {
                // Adiciona op√ß√µes ao dropdown
                data.equipamentos.forEach(eq => {
                    const option = document.createElement('option');
                    option.value = eq.id;
                    // Monta texto descritivo
                    let texto = eq.nome || eq.tipo || 'Equipamento';
                    if (eq.marca) texto += ' - ' + eq.marca;
                    if (eq.modelo) texto += ' ' + eq.modelo;
                    if (eq.numero_serie) texto += ' (S/N: ' + eq.numero_serie + ')';
                    
                    option.textContent = texto;
                    option.dataset.equipamento = JSON.stringify(eq);
                    equipamentoCadastradoSelect.appendChild(option);
                });
                
                console.log(`[DEBUG] ‚úÖ ${data.equipamentos.length} equipamentos carregados com sucesso`);
            } else {
                equipamentoCadastradoSelect.innerHTML = '<option value="">‚ùå Nenhum equipamento cadastrado para este cliente</option>';
                console.log('[DEBUG] ‚ö†Ô∏è Nenhum equipamento encontrado para o cliente');
            }
        } catch (error) {
            console.error('[DEBUG] ‚ùå Erro ao carregar equipamentos:', error);
            equipamentoCadastradoSelect.innerHTML = '<option value="">‚ùå Erro ao carregar equipamentos</option>';
        }
    }

    // Carrega equipamentos do cliente quando seleciona
    if (clienteSelectElement && equipamentoCadastradoSelect) {
        clienteSelectElement.addEventListener('change', function() {
            const clienteId = this.value;
            console.log('[DEBUG] üë§ Cliente selecionado, ID:', clienteId);
            carregarEquipamentosCliente(clienteId);
        });
        
        // Se j√° tem cliente selecionado ao carregar a p√°gina, carregar equipamentos
        if (clienteSelectElement.value) {
            console.log('[DEBUG] üîÑ Cliente j√° selecionado ao carregar p√°gina:', clienteSelectElement.value);
            carregarEquipamentosCliente(clienteSelectElement.value);
        }
    }
    
    // Bot√£o para recarregar equipamentos manualmente
    const btnRecarregar = document.getElementById('btn_recarregar_equipamentos');
    if (btnRecarregar) {
        btnRecarregar.addEventListener('click', function() {
            const clienteId = clienteSelectElement ? clienteSelectElement.value : null;
            if (clienteId) {
                console.log('[DEBUG] üîÑ Recarregando equipamentos manualmente');
                carregarEquipamentosCliente(clienteId);
            } else {
                alert('‚ö†Ô∏è Selecione um cliente primeiro!');
            }
        });
    }

    // Preenche campos automaticamente quando seleciona equipamento
    if (equipamentoCadastradoSelect) {
        equipamentoCadastradoSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            
            if (!selectedOption.value) {
                return;
            }
            
            try {
                const equipamento = JSON.parse(selectedOption.dataset.equipamento);
                
                // Preenche os campos
                equipamentoInput.value = equipamento.nome || '';
                
                // Combina marca e modelo
                let marcaModelo = '';
                if (equipamento.marca && equipamento.modelo) {
                    marcaModelo = `${equipamento.marca} ${equipamento.modelo}`;
                } else if (equipamento.marca) {
                    marcaModelo = equipamento.marca;
                } else if (equipamento.modelo) {
                    marcaModelo = equipamento.modelo;
                } else {
                    marcaModelo = 'NDA';
                }
                marcaModeloInput.value = marcaModelo;
                
                numeroSerieInput.value = equipamento.numero_serie || 'NDA';
                
                console.log('‚úÖ Campos preenchidos com equipamento:', equipamento.nome);
                
                // Feedback visual
                equipamentoInput.classList.add('border-success');
                marcaModeloInput.classList.add('border-success');
                numeroSerieInput.classList.add('border-success');
                
                setTimeout(() => {
                    equipamentoInput.classList.remove('border-success');
                    marcaModeloInput.classList.remove('border-success');
                    numeroSerieInput.classList.remove('border-success');
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Erro ao processar equipamento:', error);
            }
        });
    }
});
</script>
{% endblock %}