<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordem de Serviço {{ ordem.numero }}</title>
    <style>
        @page {
            size: A4;
            margin: 10mm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 20px;
            border: 2px solid #1a365d;
            border-radius: 10px;
            background: linear-gradient(45deg, #f8f9fa, #ffffff);
        }
        
        .logo-section {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #1a365d;
            border-radius: 5px;
            background: #f8f9fa;
        }
        
        .logo-section img {
            max-width: 70px;
            max-height: 70px;
        }
        
        .logo-placeholder {
            text-align: center;
            font-size: 10px;
            color: #1a365d;
            font-weight: bold;
        }
        
        .company-info {
            flex: 1;
            margin-left: 20px;
        }
        
        .company-name {
            font-size: 18px;
            font-weight: bold;
            color: #1a365d;
            margin-bottom: 5px;
        }
        
        .company-details {
            font-size: 11px;
            color: #666;
            line-height: 1.4;
        }
        
        .os-info {
            text-align: right;
        }
        
        .os-number {
            font-size: 24px;
            font-weight: bold;
            color: #1a365d;
            margin-bottom: 5px;
        }
        
        .os-date {
            font-size: 12px;
            color: #666;
        }
        
        .os-title {
            background: #1a365d;
            color: white;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            padding: 10px;
            margin: 10px 0;
        }
        
        .section {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .section-title {
            background: #1a365d;
            color: white;
            font-weight: bold;
            padding: 8px 15px;
            font-size: 12px;
        }
        
        .section-content {
            padding: 15px;
        }
        
        .data-row {
            display: flex;
            margin-bottom: 10px;
            gap: 15px;
        }
        
        .data-cell {
            flex: 1;
        }
        
        .data-cell-wide {
            flex: 2;
        }
        
        .data-cell-narrow {
            flex: 0.8;
        }
        
        .data-label {
            font-size: 10px;
            font-weight: bold;
            color: #1a365d;
            text-transform: uppercase;
            margin-bottom: 3px;
        }
        
        .data-value {
            border: 1px solid #ccc;
            padding: 8px;
            background: #f9f9f9;
            font-size: 11px;
            min-height: 24px;
            line-height: 1.3;
            word-wrap: break-word;
        }
        
        .data-value-large {
            min-height: 60px;
            white-space: pre-wrap;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .financial-summary {
            margin: 15px 0;
        }
        
        .financial-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 10px;
            border-bottom: 1px solid #eee;
        }
        
        .financial-row:last-child {
            border-bottom: 2px solid #1a365d;
            font-weight: bold;
            background: #f8f9fa;
        }
        
        .financial-label {
            font-weight: bold;
        }
        
        .financial-value {
            font-weight: bold;
            color: #1a365d;
        }
        
        .signatures {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
        }
        
        .signature-box {
            text-align: center;
            width: 45%;
        }
        
        .signature-line {
            border-top: 1px solid #333;
            padding-top: 5px;
            margin-top: 60px;
        }
        
        .signature-title {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .signature-name {
            font-size: 10px;
            color: #666;
        }
        
        .print-friendly {
            color: black !important;
            background: white !important;
        }
        
        /* Garantir que tudo seja visível na impressão */
        @media print {
            body {
                background: white !important;
                color: black !important;
            }
            
            .section-title, .os-title {
                background: #1a365d !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .header-top {
                border: 2px solid #1a365d !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
        
        /* Melhorar quebras de página */
        .section {
            page-break-inside: avoid;
        }
        
        /* Classe para texto bem formatado */
        .formatted-text {
            white-space: pre-line;
            line-height: 1.5;
            margin: 0;
            padding: 0;
        }
        
        .signatures {
            page-break-inside: avoid;
        }
        
        /* Estilos para status com cores */
        .status-concluida {
            color: #28a745 !important;
            font-weight: bold;
        }
        
        .status-em-andamento, .status-em_andamento, .status-em_execucao {
            color: #ffc107 !important;
            font-weight: bold;
        }
        
        .status-aberta {
            color: #17a2b8 !important;
            font-weight: bold;
        }
        
        .status-cancelada {
            color: #dc3545 !important;
            font-weight: bold;
        }
        
        .status-aguardando_pecas, .status-aguardando_cliente {
            color: #6c757d !important;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- CABEÇALHO -->
        <div class="header">
            <div class="header-top">
                <div class="logo-section">
                    {% if logo_base64 %}
                    <img src="data:image/png;base64,{{ logo_base64 }}" alt="JSP Logo">
                    {% else %}
                    <div class="logo-placeholder">
                        JSP<br>LOGO
                    </div>
                    {% endif %}
                </div>
                <div class="company-info">
                    <div class="company-name">{{ config.nome_fantasia if config and config.nome_fantasia else 'JSP ELÉTRICA INDUSTRIAL & SOLAR' }}</div>
                    <div class="company-details">
                        {% if config and config.logradouro %}
                        {{ config.logradouro }}{% if config.numero %}, {{ config.numero }}{% endif %}{% if config.bairro %} - {{ config.bairro }}{% endif %}{% if config.cidade %} - {{ config.cidade }}{% endif %}{% if config.uf %}/{{ config.uf }}{% endif %}{% if config.cep %} - CEP: {{ config.cep }}{% endif %}<br>
                        {% else %}
                        INDALECIO COSTA, 900 - CECAP - TIETÊ/SP - CEP: 18530170<br>
                        {% endif %}
                        {% if config and config.telefone %}Telefone: {{ config.telefone }}{% else %}Telefone: (15) 99670-2038{% endif %}{% if config and config.email %} | Email: {{ config.email }}{% else %} | Email: atendimento@jspeletricaindustrial.com.br{% endif %}<br>
                        CNPJ: {% if config and config.cnpj %}{{ config.cnpj }}{% else %}41.280.764/0001-65{% endif %}
                    </div>
                </div>
                <div class="os-info">
                    <div class="os-number">{{ ordem.numero }}</div>
                    <div class="os-date">{{ now().strftime('%d/%m/%Y') }}</div>
                </div>
            </div>
            <div class="os-title">ORDEM DE SERVIÇO</div>
        </div>

        <!-- DADOS DO CLIENTE -->
        <div class="section">
            <div class="section-title">DADOS DO CLIENTE</div>
            <div class="section-content">
                <div class="data-row">
                    <div class="data-cell data-cell-wide">
                        <div class="data-label">Nome/Razão Social</div>
                        <div class="data-value">{{ ordem.cliente.nome if ordem.cliente else 'Cliente não informado' }}</div>
                    </div>
                    <div class="data-cell data-cell-narrow">
                        <div class="data-label">Data Abertura</div>
                        <div class="data-value">{{ ordem.data_abertura.strftime('%d/%m/%Y') if ordem.data_abertura else 'N/A' }}</div>
                    </div>
                </div>
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">CPF/CNPJ</div>
                        <div class="data-value">{{ ordem.cliente.cpf_cnpj if ordem.cliente and ordem.cliente.cpf_cnpj else 'N/A' }}</div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">Telefone</div>
                        <div class="data-value">{{ ordem.cliente.telefone if ordem.cliente and ordem.cliente.telefone else 'N/A' }}</div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">Email</div>
                        <div class="data-value">{{ ordem.cliente.email if ordem.cliente and ordem.cliente.email else 'N/A' }}</div>
                    </div>
                </div>
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Endereço</div>
                        <div class="data-value">{{ ordem.cliente.endereco if ordem.cliente and ordem.cliente.endereco else 'N/A' }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DADOS DA SOLICITAÇÃO -->
        <div class="section">
            <div class="section-title">DADOS DA SOLICITAÇÃO</div>
            <div class="section-content">
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Solicitante</div>
                        <div class="data-value">{{ ordem.solicitante if ordem.solicitante else 'N/A' }}</div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">Status</div>
                        <div class="data-value status-{{ ordem.status if ordem.status else 'default' }}">
                            {% if ordem.status == 'em_andamento' or ordem.status == 'em_execucao' %}
                                🟡 Em Andamento
                            {% elif ordem.status == 'concluida' %}
                                🟢 Concluída
                            {% elif ordem.status == 'aberta' %}
                                🔵 Aberta
                            {% elif ordem.status == 'cancelada' %}
                                🔴 Cancelada
                            {% elif ordem.status == 'aguardando_pecas' %}
                                ⚫ Aguardando Peças
                            {% elif ordem.status == 'aguardando_cliente' %}
                                ⚫ Aguardando Cliente
                            {% else %}
                                ⭐ {{ ordem.status|title if ordem.status else 'N/A' }}
                            {% endif %}
                        </div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">Prioridade</div>
                        <div class="data-value">{{ ordem.prioridade if ordem.prioridade else 'Normal' }}</div>
                    </div>
                </div>
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Equipamento</div>
                        <div class="data-value">{{ ordem.equipamento if ordem.equipamento else 'N/A' }}</div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">Marca/Modelo</div>
                        <div class="data-value">{{ ordem.marca_modelo if ordem.marca_modelo else 'N/A' }}</div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">Número de Série</div>
                        <div class="data-value">{{ ordem.numero_serie if ordem.numero_serie else 'N/A' }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DESCRIÇÃO DOS SERVIÇOS REALIZADOS -->
        <div class="section">
            <div class="section-title">DESCRIÇÃO DOS SERVIÇOS REALIZADOS</div>
            <div class="section-content">
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Problema Relatado pelo Cliente</div>
                        <div class="data-value data-value-large formatted-text">{{ ordem.descricao_problema if ordem.descricao_problema else (ordem.defeito_relatado if ordem.defeito_relatado else (ordem.descricao if ordem.descricao else (ordem.titulo if ordem.titulo else ''))) }}</div>
                    </div>
                </div>
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Diagnóstico Técnico</div>
                        <div class="data-value data-value-large formatted-text">{{ ordem.diagnostico_tecnico if ordem.diagnostico_tecnico else '' }}</div>
                    </div>
                </div>
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Solução Aplicada</div>
                        <div class="data-value data-value-large formatted-text">{{ ordem.solucao if ordem.solucao else '' }}</div>
                    </div>
                </div>
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Observações Gerais</div>
                        <div class="data-value data-value-large formatted-text">{{ ordem.observacoes if ordem.observacoes else '' }}</div>
                    </div>
                </div>
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Técnico Responsável</div>
                        <div class="data-value">{{ ordem.tecnico_responsavel if ordem.tecnico_responsavel else 'N/A' }}</div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">Data de Início</div>
                        <div class="data-value">{{ ordem.data_inicio.strftime('%d/%m/%Y às %H:%M') if ordem.data_inicio else 'N/A' }}</div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">Data de Conclusão</div>
                        <div class="data-value">{{ ordem.data_conclusao.strftime('%d/%m/%Y às %H:%M') if ordem.data_conclusao else 'N/A' }}</div>
                    </div>
                </div>
            </div>
        </div>

        {% if ordem.incluir_imagens_relatorio and ordem.anexos and ordem.anexos|length > 0 %}
        <!-- IMAGENS ANEXADAS -->
        <div class="section">
            <div class="section-title">IMAGENS ANEXADAS</div>
            <div class="section-content">
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    {% for anexo in ordem.anexos %}
                        {% if anexo.tipo_arquivo == 'image' or (anexo.mime_type and 'image' in anexo.mime_type) %}
                            <div style="flex: 1 1 45%; border: 1px solid #ddd; border-radius: 6px; padding: 8px; background: #fff;">
                                <div style="font-size: 10px; font-weight: bold; margin-bottom: 6px; color: #333;">{{ anexo.nome_original }}</div>
                                {# WeasyPrint precisa de caminho absoluto com prefixo file:/// e barras #}
                                <img src="file:///{{ anexo.caminho | replace('\\', '/') }}" alt="{{ anexo.nome_original }}" style="width: 100%; height: auto; max-height: 360px; object-fit: contain;"/>
                                <div style="font-size: 9px; color: #666; margin-top: 4px;">{{ anexo.tamanho_formatado }}</div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- SERVIÇOS EXECUTADOS -->
        <div class="section">
            <div class="section-title">SERVIÇOS EXECUTADOS</div>
            <div class="section-content">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #1a365d; color: white;">
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Item</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Descrição</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Qtd</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Vl Unit.</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Vl Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if ordem.servicos and ordem.servicos|length > 0 %}
                            {% for servico in ordem.servicos %}
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">{{ loop.index }}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">{{ servico.descricao }}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">{{ servico.quantidade }}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">R$ {{ "%.2f"|format(servico.valor_unitario) }}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">R$ {{ "%.2f"|format(servico.valor_total) }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" style="border: 1px solid #ddd; padding: 8px; text-align: center;">Nenhum serviço cadastrado</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- RESUMO FINANCEIRO -->
        <div class="section">
            <div class="section-title">RESUMO FINANCEIRO</div>
            <div class="section-content">
                <div class="financial-summary">
                    <div class="financial-row">
                        <span class="financial-label">Valor dos Serviços:</span>
                        <span class="financial-value">R$ {{ "%.2f"|format(ordem.valor_servico|float) if ordem.valor_servico else "0,00" }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Valor das Peças:</span>
                        <span class="financial-value">R$ {{ "%.2f"|format(ordem.valor_pecas|float) if ordem.valor_pecas else "0,00" }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">SUBTOTAL:</span>
                        <span class="financial-value">R$ {{ "%.2f"|format((ordem.valor_servico|float + ordem.valor_pecas|float) if (ordem.valor_servico and ordem.valor_pecas) else 0) }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">TOTAL A PAGAR:</span>
                        <span class="financial-value">R$ {{ "%.2f"|format(ordem.valor_total|float) if ordem.valor_total else "0,00" }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- DADOS BANCÁRIOS -->
        <div class="section">
            <div class="section-title">DADOS BANCÁRIOS</div>
            <div class="section-content">
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Banco</div>
                        <div class="data-value">{{ config.banco if config and config.banco else 'Banco do Brasil' }}</div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">Agência</div>
                        <div class="data-value">{{ config.agencia if config and config.agencia else '0001-9' }}</div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">Conta Corrente</div>
                        <div class="data-value">{{ config.conta if config and config.conta else '12345-6' }}</div>
                    </div>
                </div>
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Favorecido</div>
                        <div class="data-value data-value-large">{{ config.razao_social if config and config.razao_social else 'JSP ELÉTRICA INDUSTRIAL LTDA' }}</div>
                    </div>
                </div>
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">CNPJ</div>
                        <div class="data-value">{{ config.cnpj if config and config.cnpj else '00.000.000/0001-00' }}</div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">PIX</div>
                        <div class="data-value">{{ config.pix if config and config.pix else (config.cnpj if config and config.cnpj else 'CNPJ') }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONDIÇÕES DE PAGAMENTO -->
        <div class="section">
            <div class="section-title">CONDIÇÕES DE PAGAMENTO</div>
            <div class="section-content">
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Forma de Pagamento</div>
                        <div class="data-value">{{ ordem.condicao_pagamento if ordem.condicao_pagamento else 'À vista' }}</div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">Parcelas</div>
                        <div class="data-value">{{ ordem.numero_parcelas if ordem.numero_parcelas else '1x' }}</div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">Vencimento</div>
                        <div class="data-value">{{ ordem.data_vencimento_pagamento.strftime('%d/%m/%Y') if ordem.data_vencimento_pagamento else 'À vista' }}</div>
                    </div>
                </div>
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Observações de Pagamento</div>
                        <div class="data-value data-value-large formatted-text">{{ ordem.descricao_pagamento if ordem.descricao_pagamento else 'Pagamento à vista na entrega do serviço' }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DADOS BANCÁRIOS -->
        <div class="section">
            <div class="section-title">🏦 DADOS BANCÁRIOS 🏦</div>
            <div class="section-content">
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Banco</div>
                        <div class="data-value">{{ config.banco if config and config.banco else 'Banco do Brasil' }}</div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">Agência</div>
                        <div class="data-value">{{ config.agencia if config and config.agencia else '0001-9' }}</div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">Conta Corrente</div>
                        <div class="data-value">{{ config.conta if config and config.conta else '12345-6' }}</div>
                    </div>
                </div>
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Favorecido</div>
                        <div class="data-value data-value-large">{{ config.razao_social if config and config.razao_social else 'JSP ELÉTRICA INDUSTRIAL LTDA' }}</div>
                    </div>
                </div>
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">CNPJ</div>
                        <div class="data-value">{{ config.cnpj if config and config.cnpj else '00.000.000/0001-00' }}</div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">PIX</div>
                        <div class="data-value">{{ config.pix if config and config.pix else (config.cnpj if config and config.cnpj else 'CNPJ') }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GARANTIA DOS SERVIÇOS -->
        <div class="section">
            <div class="section-title">GARANTIA DOS SERVIÇOS</div>
            <div class="section-content">
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Prazo de Garantia</div>
                        <div class="data-value">{{ ordem.prazo_garantia if ordem.prazo_garantia else '90 dias (padrão)' }}</div>
                    </div>
                    <div class="data-cell">
                        <div class="data-label">Cobertura</div>
                        <div class="data-value">Serviços executados e peças utilizadas</div>
                    </div>
                </div>
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Condições da Garantia</div>
                        <div class="data-value data-value-large formatted-text">{{ ordem.condicoes_garantia if ordem.condicoes_garantia else '' }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TERMOS E CONDIÇÕES -->
        <div class="section">
            <div class="section-title">TERMOS E CONDIÇÕES</div>
            <div class="section-content">
                <div class="data-row">
                    <div class="data-cell">
                        <div class="data-label">Condições Gerais</div>
                        <div class="data-value data-value-large formatted-text">
1. Este documento é válido como comprovante de serviço executado.

2. A garantia é válida apenas para defeitos relacionados ao serviço executado.

3. Não cobre danos causados por mau uso, acidentes ou desgaste natural.

4. Cliente declara estar ciente das condições do serviço.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ASSINATURAS -->
        <div class="signatures">
            <div class="signature-box">
                <div class="signature-line">
                    <div class="signature-title">Assinatura do Técnico</div>
                    <div class="signature-name">{{ ordem.responsavel if ordem.responsavel else 'JSP ELÉTRICA INDUSTRIAL' }}</div>
                </div>
            </div>
            <div class="signature-box">
                <div class="signature-line">
                    <div class="signature-title">Assinatura do Cliente</div>
                    <div class="signature-name">{{ ordem.cliente.nome if ordem.cliente else '' }}</div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
